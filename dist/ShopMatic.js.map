{
  "version": 3,
  "sources": ["../ShopMatic/js/modules/Card.js", "../ShopMatic/js/modules/utils.js", "../ShopMatic/js/modules/ProductService.js", "../ShopMatic/js/modules/StorageService.js", "../ShopMatic/js/modules/Notifications.js", "../ShopMatic/js/modules/Renderer.js", "../ShopMatic/js/modules/Cart/MiniCart.js", "../ShopMatic/js/modules/Cart/CartBase.js", "../ShopMatic/js/modules/Cart/CartUI.js", "../ShopMatic/js/modules/Cart/CartModule.js", "../ShopMatic/js/modules/FavoritesModule.js", "../ShopMatic/js/modules/WishlistModule.js", "../ShopMatic/js/modules/Gallery.js", "../ShopMatic/js/modules/ProductPage.js", "../ShopMatic/js/modules/ViewedItemsModule.js", "../ShopMatic/js/modules/Catalog/FilterController.js", "../ShopMatic/js/modules/Catalog/CatalogView.js", "../ShopMatic/js/modules/Catalog/CatalogController.js", "../ShopMatic/js/modules/Checkout/CheckoutView.js", "../ShopMatic/js/modules/Checkout/CheckoutController.js", "../ShopMatic/js/ShopMatic.js"],
  "sourcesContent": ["/**\r\n * Card UI helper for ShopMatic \u2014 refactored\r\n * Author: Calista Verner\r\n * Refactor: Calista + assistant\r\n * Version: 1.3.1-refactor\r\n *\r\n * \u0421\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0430 \u0438\u0441\u0445\u043E\u0434\u043D\u0430\u044F \u043B\u043E\u0433\u0438\u043A\u0430 \u0438 \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u044B\u0435 \u0442\u043E\u0447\u043A\u0438 \u0438\u043D\u0442\u0435\u0433\u0440\u0430\u0446\u0438\u0438.\r\n */\r\nexport class Card {\r\n  static UI_MESSAGES = Object.freeze({\r\n    PRODUCT_LIMIT_DEFAULT: '\u0423 \u0432\u0430\u0441 \u0443\u0436\u0435 \u043C\u0430\u043A\u0441\u0438\u043C\u0443\u043C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0435',\r\n    PRODUCT_LIMIT_REACHED: '\u0412\u044B \u0434\u043E\u0441\u0442\u0438\u0433\u043B\u0438 \u043C\u0430\u043A\u0441\u0438\u043C\u0430\u043B\u044C\u043D\u043E\u0433\u043E \u043A\u043E\u043B\u0438\u0447\u0435\u0441\u0442\u0432\u0430 \u044D\u0442\u043E\u0433\u043E \u0442\u043E\u0432\u0430\u0440\u0430',\r\n    NO_STOCK_TEXT: '\u0422\u043E\u0432\u0430\u0440\u0430 \u043D\u0435\u0442 \u0432 \u043D\u0430\u043B\u0438\u0447\u0438\u0438',\r\n    CANNOT_ADD_NO_STOCK: '\u041D\u0435\u0432\u043E\u0437\u043C\u043E\u0436\u043D\u043E \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C: \u043D\u0435\u0442 \u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E\u0433\u043E \u043E\u0441\u0442\u0430\u0442\u043A\u0430.',\r\n    ADDED_PARTIAL: '\u0412 \u043A\u043E\u0440\u0437\u0438\u043D\u0443 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E {added} \u0448\u0442. (\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E {available}).',\r\n    FAVORITES_UNAVAILABLE: '\u041C\u043E\u0434\u0443\u043B\u044C \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D.',\r\n\tPRODUCT_LEFT: '\u041E\u0441\u0442\u0430\u0442\u043E\u043A: {left}'\r\n  });\r\n\r\n  constructor(shopMatic = {}) {\r\n    this.shopMatic = shopMatic;\r\n    // WeakMap: container -> { clickHandler, inputHandler }\r\n    this._delegationHandlers = new WeakMap();\r\n    // Backwards-compat: some code expects shopMatic._delegationHandlers as Map\r\n    if (!this.shopMatic._delegationHandlers) this.shopMatic._delegationHandlers = new Map();\r\n\r\n    this._limitMsgClass = 'product-limit-msg';\r\n  }\r\n\r\n  _msg(key, vars = {}) {\r\n    const pool = (this.constructor && this.constructor.UI_MESSAGES) || {};\r\n    const tpl = pool[key] ?? '';\r\n    return String(tpl).replace(/\\{([^}]+)\\}/g, (m, k) =>\r\n      Object.prototype.hasOwnProperty.call(vars, k) ? String(vars[k]) : m\r\n    );\r\n  }\r\n\r\n  _sel(root, selector) {\r\n    return root?.querySelector?.(selector) ?? null;\r\n  }\r\n\r\n  _toggleDisabled(el, disabled) {\r\n    if (!el) return;\r\n    el.disabled = !!disabled;\r\n    if (el.toggleAttribute) el.toggleAttribute('aria-disabled', !!disabled);\r\n  }\r\n\r\n  _createLimitMsg(text) {\r\n    const d = document.createElement('div');\r\n    d.className = this._limitMsgClass;\r\n    d.textContent = text;\r\n    // leave styling to CSS; small inline fallback\r\n    d.style.cssText = 'transition:opacity .25s ease;opacity:0;';\r\n    return d;\r\n  }\r\n\r\n  _clampQty(rawVal, min = 1, max = Infinity) {\r\n    let v = parseInt(rawVal ?? '', 10);\r\n    if (isNaN(v) || v < min) v = min;\r\n    if (v > max) v = max;\r\n    return v;\r\n  }\r\n\r\n  _getIdFromElement(el) {\r\n    if (!el?.getAttribute) return null;\r\n    const attrs = ['data-product-id', 'data-id', 'data-name', 'data-cart-id', 'data-item-id'];\r\n    for (const a of attrs) {\r\n      const v = el.getAttribute(a);\r\n      if (v) return v;\r\n    }\r\n    return el?.dataset?.productId || el?.dataset?.id || el?.dataset?.name || null;\r\n  }\r\n\r\n  _getCardSelectors(card) {\r\n    return {\r\n      leftNum: this._sel(card, '.leftNum'),\r\n      stock: this._sel(card, '.stock'),\r\n      buyBtn: this._sel(card, '[data-role=\"buy\"], [data-action=\"buy\"], .btn-buy'),\r\n      incrBtn: this._sel(card, '[data-role=\"qty-plus\"], .qty-incr, [data-action=\"qty-incr\"]'),\r\n      decrBtn: this._sel(card, '[data-role=\"qty-minus\"], .qty-decr, [data-action=\"qty-decr\"]'),\r\n      qtyInput: this._sel(card, '[data-role=\"qty-input\"], .qty-input, input[type=\"number\"]'),\r\n      controlsWrapper: this._sel(card, '.card-controls') || card\r\n    };\r\n  }\r\n\r\n  _computeAvailableStock(id) {\r\n    if (!id) return 0;\r\n    try {\r\n      const prod = this.shopMatic?.productService?.findById?.(id);\r\n      if (prod && typeof prod.then === 'function') return 0;\r\n      const totalStock = Number(prod?.stock || 0);\r\n      const inCartQty = this._findCartQtyById(id);\r\n      return Math.max(0, totalStock - inCartQty);\r\n    } catch (e) {\r\n      return 0;\r\n    }\r\n  }\r\n\r\n  _findCartQtyById(id) {\r\n    try {\r\n      const cartModule = this.shopMatic?.cart;\r\n      const cartArray = Array.isArray(cartModule?.cart) ? cartModule.cart : (Array.isArray(cartModule) ? cartModule : []);\r\n      if (!Array.isArray(cartArray)) return 0;\r\n      const keys = ['id', 'productId', 'name', 'cartId', 'itemId'];\r\n      for (const it of cartArray) {\r\n        if (!it) continue;\r\n        for (const k of keys) {\r\n          if (it[k] != null && String(it[k]) === String(id)) return Number(it.qty ?? it.quantity ?? 0) || 0;\r\n        }\r\n        if (String(it) === String(id)) return Number(it.qty ?? 0) || 0;\r\n      }\r\n    } catch (e) { /* ignore */ }\r\n    return 0;\r\n  }\r\n\r\n  _syncCardControlsState(card) {\r\n    if (!card) return;\r\n    const id = this._getIdFromElement(card);\r\n    if (!id) return;\r\n\r\n    const s = this._getCardSelectors(card);\r\n    const available = this._computeAvailableStock(id);\r\n    const hasAvailable = available > 0;\r\n\r\n    requestAnimationFrame(() => {\r\n      if (s.leftNum) s.leftNum.textContent = String(available);\r\n      if (s.stock) {\r\n        s.stock.textContent = String(this._msg('PRODUCT_LEFT', { left: available }));\r\n        if (hasAvailable) s.stock.removeAttribute?.('hidden'); else s.stock.setAttribute?.('hidden', 'true');\r\n      }\r\n\r\n      this._toggleDisabled(s.buyBtn, !hasAvailable);\r\n\r\n      if (s.qtyInput) {\r\n        if (!hasAvailable) {\r\n          s.qtyInput.value = '0';\r\n          s.qtyInput.disabled = true;\r\n          s.qtyInput.setAttribute('aria-disabled', 'true');\r\n        } else {\r\n          s.qtyInput.disabled = false;\r\n          s.qtyInput.removeAttribute?.('aria-disabled');\r\n          const val = this._clampQty(s.qtyInput.value || '1', 1, available);\r\n          s.qtyInput.value = String(val);\r\n        }\r\n      }\r\n\r\n      const curVal = s.qtyInput ? Math.max(0, parseInt(s.qtyInput.value || '0', 10)) : 0;\r\n      this._toggleDisabled(s.incrBtn, !hasAvailable || curVal >= available);\r\n      this._toggleDisabled(s.decrBtn, curVal <= 1);\r\n\r\n      const existing = card.querySelector?.(`.${this._limitMsgClass}`);\r\n      if (!hasAvailable) {\r\n        if (!existing) {\r\n          const msg = this._createLimitMsg(this._msg('PRODUCT_LIMIT_DEFAULT'));\r\n          (s.controlsWrapper || card).appendChild(msg);\r\n          requestAnimationFrame(() => (msg.style.opacity = '1'));\r\n        }\r\n      } else if (existing) {\r\n        existing.style.opacity = '0';\r\n        setTimeout(() => existing?.parentNode?.removeChild(existing), 300);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Attach delegated listeners to container. Safe: duplicates are ignored.\r\n   */\r\n  _bindCardDelegation(container = this.shopMatic?.root) {\r\n    if (!container) return;\r\n    if (!this.shopMatic._delegationHandlers) this.shopMatic._delegationHandlers = new Map();\r\n    if (this.shopMatic._delegationHandlers.has(container)) return; // already attached\r\n\r\n    const findQtyControls = (el) => ({\r\n      input: el?.querySelector?.('[data-role=\"qty-input\"], .qty-input, input[type=\"number\"]'),\r\n      incr: el?.querySelector?.('[data-role=\"qty-plus\"], .qty-incr, [data-action=\"qty-incr\"]'),\r\n      decr: el?.querySelector?.('[data-role=\"qty-minus\"], .qty-decr, [data-action=\"qty-decr\"]'),\r\n      buy: el?.querySelector?.('[data-role=\"buy\"], [data-action=\"buy\"], .btn-buy')\r\n    });\r\n\r\n    // single declaration for clampAndApplyQty (no duplicates)\r\n    const clampAndApplyQty = (inputEl, id) => {\r\n      if (!inputEl) return;\r\n      const available = this._computeAvailableStock(id);\r\n      const v = this._clampQty(inputEl.value || '1', 1, Math.max(0, available));\r\n      inputEl.value = String(v);\r\n\r\n      const parent = inputEl.closest('[data-product-id], [data-id], [data-name], .cart-row, li') || inputEl.parentElement;\r\n      const { incr, buy } = findQtyControls(parent);\r\n      if (incr) this._toggleDisabled(incr, Math.max(0, available) === 0 || v >= available);\r\n      if (buy) this._toggleDisabled(buy, Math.max(0, available) === 0);\r\n      return v;\r\n    };\r\n\r\n    const clickHandler = (ev) => {\r\n      const t = ev.target;\r\n      const card = t.closest?.('[data-product-id], [data-id], [data-name], [data-cart-id], [data-item-id]') || null;\r\n      const idFromCard = this._getIdFromElement(card);\r\n\r\n      // favorite toggle\r\n      const favBtn = t.closest?.('[data-role=\"fav\"], .fav-btn');\r\n      if (favBtn && container.contains(favBtn)) {\r\n        ev.stopPropagation();\r\n        const id = this._getIdFromElement(favBtn.closest('[data-product-id], [data-id], [data-name], [data-cart-id], [data-item-id]')) || idFromCard;\r\n        try {\r\n          if (!this.shopMatic?.favorites) throw new Error('no favorites');\r\n          const res = this.shopMatic.favorites.toggle(id);\r\n          this.shopMatic.renderer?.updateProductCardFavState?.(container, id, this.shopMatic.favorites.isFavorite?.(id));\r\n          if (typeof this.shopMatic._updateWishUI === 'function') {\r\n            try { this.shopMatic._updateWishUI(); } catch (_) { /* ignore */ }\r\n          }\r\n          const icon = favBtn.querySelector?.('i');\r\n          if (icon) {\r\n            icon.classList.add('animate-pop');\r\n            setTimeout(() => icon.classList.remove('animate-pop'), 380);\r\n          }\r\n          if (res && typeof res.then === 'function') res.catch(() => {});\r\n        } catch (err) {\r\n          this.shopMatic?.notifications?.show?.(this._msg('FAVORITES_UNAVAILABLE'), { type: 'error' });\r\n        }\r\n        return;\r\n      }\r\n\r\n      // buy button\r\n      const buyBtn = t.closest?.('[data-role=\"buy\"], [data-action=\"buy\"], .btn-buy');\r\n      if (buyBtn && container.contains(buyBtn)) {\r\n        ev.stopPropagation();\r\n        const id = this._getIdFromElement(buyBtn.closest('[data-product-id], [data-id], [data-name]')) || idFromCard;\r\n        const { input } = findQtyControls(card);\r\n        const desired = input ? Math.max(1, parseInt(input.value || '1', 10)) : 1;\r\n        const available = this._computeAvailableStock(id);\r\n        if (available <= 0) {\r\n          this.shopMatic.notifications?.show?.(this._msg('CANNOT_ADD_NO_STOCK'), { duration: this.shopMatic.opts?.notificationDuration });\r\n          this.shopMatic._syncAllCardsControls?.();\r\n          return;\r\n        }\r\n        const qtyToAdd = Math.min(desired, available);\r\n        if (qtyToAdd < desired) {\r\n          this.shopMatic.notifications?.show?.(this._msg('ADDED_PARTIAL', { added: qtyToAdd, available }), { duration: (this.opts?.notificationDuration || this.shopMatic.opts?.notificationDuration) });\r\n        }\r\n        const res = this.shopMatic.cart?.add?.(id, qtyToAdd);\r\n        if (res && typeof res.then === 'function') {\r\n          res.then(() => this._syncCardControlsState(card)).catch(() => this._syncCardControlsState(card));\r\n        } else {\r\n          this._syncCardControlsState(card);\r\n        }\r\n        return;\r\n      }\r\n\r\n      // decrement qty\r\n      const decrBtn = t.closest?.('[data-role=\"qty-minus\"], .qty-decr, [data-action=\"qty-decr\"]');\r\n      if (decrBtn && container.contains(decrBtn)) {\r\n        ev.stopPropagation();\r\n        const row = decrBtn.closest('[data-product-id], [data-id], [data-name], .cart-row') || decrBtn.closest('li') || decrBtn.parentElement;\r\n        const id = this._getIdFromElement(row) || idFromCard;\r\n        const { input, incr } = findQtyControls(row);\r\n        if (!input) return;\r\n        let newVal = Math.max(1, parseInt(input.value || '1', 10) - 1);\r\n        const available = this._computeAvailableStock(id);\r\n        const maxStock = Number.isFinite(available) ? Math.max(0, available) : 0;\r\n        if (newVal > maxStock) newVal = maxStock;\r\n        input.value = String(newVal);\r\n        if (incr) this._toggleDisabled(incr, maxStock === 0 || newVal >= maxStock);\r\n        const changeRes = this.shopMatic.changeQty?.(id, newVal);\r\n        if (changeRes && typeof changeRes.then === 'function') changeRes.catch(() => {});\r\n        this._syncCardControlsState(row);\r\n        return;\r\n      }\r\n\r\n      // increment qty\r\n      const incrBtn = t.closest?.('[data-role=\"qty-plus\"], .qty-incr, [data-action=\"qty-incr\"]');\r\n      if (incrBtn && container.contains(incrBtn)) {\r\n        ev.stopPropagation();\r\n        const row = incrBtn.closest('[data-product-id], [data-id], [data-name], .cart-row') || incrBtn.closest('li') || incrBtn.parentElement;\r\n        const id = this._getIdFromElement(row) || idFromCard;\r\n        const { input } = findQtyControls(row);\r\n        if (!input) return;\r\n        const available = this._computeAvailableStock(id);\r\n        const maxStock = Number.isFinite(available) ? Math.max(0, available) : 0;\r\n        let newVal = Math.min(maxStock, parseInt(input.value || '1', 10) + 1);\r\n        if (isNaN(newVal) || newVal < 1) newVal = 1;\r\n        input.value = String(newVal);\r\n        this._toggleDisabled(incrBtn, maxStock === 0 || newVal >= maxStock);\r\n        const { buy } = findQtyControls(row);\r\n        if (buy) this._toggleDisabled(buy, maxStock === 0);\r\n        const changeRes = this.shopMatic.changeQty?.(id, newVal);\r\n        if (changeRes && typeof changeRes.then === 'function') changeRes.catch(() => {});\r\n        this._syncCardControlsState(row);\r\n        return;\r\n      }\r\n    };\r\n\r\n    const inputHandler = (ev) => {\r\n      const input = ev.target;\r\n      if (!input?.matches?.('[data-role=\"qty-input\"], .qty-input, input[type=\"number\"]')) return;\r\n      const row = input.closest('[data-product-id], [data-id], [data-name], .cart-row') || input.parentElement;\r\n      const id = this._getIdFromElement(row);\r\n      const clamped = clampAndApplyQty(input, id);\r\n      if (clamped !== undefined) {\r\n        const changeRes = this.shopMatic.changeQty?.(id, clamped);\r\n        if (changeRes && typeof changeRes.then === 'function') changeRes.catch(() => {});\r\n        this._syncCardControlsState(row);\r\n      }\r\n    };\r\n\r\n    // attach listeners and keep references (WeakMap + shopMatic Map for compat)\r\n    try {\r\n      container.addEventListener('click', clickHandler, { passive: true });\r\n      container.addEventListener('input', inputHandler);\r\n      const handlers = { clickHandler, inputHandler };\r\n      this._delegationHandlers.set(container, handlers);\r\n      this.shopMatic._delegationHandlers.set(container, handlers);\r\n    } catch (e) {\r\n      if (this.shopMatic?.opts?.debug) console.error('[Card] attach listeners failed', e);\r\n    }\r\n  }\r\n\r\n  destroyDelegation(container = null) {\r\n    try {\r\n      if (!this.shopMatic._delegationHandlers) return;\r\n\r\n      if (container) {\r\n        const h = this.shopMatic._delegationHandlers.get(container);\r\n        if (h) {\r\n          try { container.removeEventListener('click', h.clickHandler); } catch (_) {}\r\n          try { container.removeEventListener('input', h.inputHandler); } catch (_) {}\r\n          this.shopMatic._delegationHandlers.delete(container);\r\n        }\r\n        try { this._delegationHandlers.delete(container); } catch (_) {}\r\n        return;\r\n      }\r\n\r\n      for (const [cont, h] of Array.from(this.shopMatic._delegationHandlers.entries())) {\r\n        try { cont.removeEventListener('click', h.clickHandler); } catch (_) {}\r\n        try { cont.removeEventListener('input', h.inputHandler); } catch (_) {}\r\n        this.shopMatic._delegationHandlers.delete(cont);\r\n      }\r\n      this._delegationHandlers = new WeakMap();\r\n    } catch (e) {\r\n      if (this.shopMatic?.opts?.debug) console.error('[Card] destroyDelegation failed', e);\r\n    }\r\n  }\r\n\r\n  _syncAllCardsIn(container = this.shopMatic?.root) {\r\n    if (!container) return;\r\n    const cards = container.querySelectorAll?.('[data-product-id], [data-id], [data-name], .product-card, .catalog-item') || [];\r\n    for (const c of cards) {\r\n      try { this._syncCardControlsState(c); } catch (_) {}\r\n    }\r\n  }\r\n}", "// shopmatic/utils.js\r\nexport function escapeHtml(s) {\r\n  return String(s == null ? '' : s)\r\n    .replace(/&/g, '&amp;')\r\n    .replace(/</g, '&lt;')\r\n    .replace(/>/g, '&gt;')\r\n    .replace(/\"/g, '&quot;')\r\n    .replace(/'/g, '&#39;');\r\n}\r\n\r\nexport function debounce(fn, ms = 200) {\r\n  let t = null;\r\n  return (...args) => {\r\n    clearTimeout(t);\r\n    t = setTimeout(() => fn.apply(this, args), ms);\r\n  };\r\n}\r\n\r\n/**\r\n * \u0412\u043E\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u0442 \u043F\u0440\u0430\u0432\u0438\u043B\u044C\u043D\u043E\u0435 \u0441\u043B\u043E\u0432\u043E \u0432 \u0437\u0430\u0432\u0438\u0441\u0438\u043C\u043E\u0441\u0442\u0438 \u043E\u0442 \u0447\u0438\u0441\u043B\u0430\r\n * @param {number} n \u2014 \u0447\u0438\u0441\u043B\u043E\r\n * @param {string[]} forms \u2014 \u043C\u0430\u0441\u0441\u0438\u0432 \u0438\u0437 \u0442\u0440\u0451\u0445 \u0444\u043E\u0440\u043C [1, 2, 5]\r\n * \u041F\u0440\u0438\u043C\u0435\u0440: pluralize(5, ['\u0442\u043E\u0432\u0430\u0440', '\u0442\u043E\u0432\u0430\u0440\u0430', '\u0442\u043E\u0432\u0430\u0440\u043E\u0432']) \u2192 \"\u0442\u043E\u0432\u0430\u0440\u043E\u0432\"\r\n */\r\nexport function pluralize(n, forms) {\r\n  n = Math.abs(n) % 100;\r\n  const n1 = n % 10;\r\n  if (n > 10 && n < 20) return forms[2];\r\n  if (n1 > 1 && n1 < 5) return forms[1];\r\n  if (n1 === 1) return forms[0];\r\n  return forms[2];\r\n}\r\n\r\n\r\nexport function computeDiscountPercent(p) {\r\n  if (!p || typeof p.oldPrice !== 'number') return 0;\r\n  if (p.oldPrice <= p.price) return 0;\r\n  const percent = Math.round(((p.oldPrice - p.price) / p.oldPrice) * 100);\r\n  return Math.max(0, percent);\r\n}\r\n/**\r\n * \u0424\u043E\u0440\u043C\u0430\u0442\u0438\u0440\u0443\u0435\u0442 \u0446\u0435\u043D\u0443 \u0441 \u0443\u0447\u0435\u0442\u043E\u043C \u0432\u0430\u043B\u044E\u0442\u044B.\r\n * @param {number} amount \u0421\u0443\u043C\u043C\u0430, \u043A\u043E\u0442\u043E\u0440\u0443\u044E \u043D\u0443\u0436\u043D\u043E \u043E\u0442\u0444\u043E\u0440\u043C\u0430\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C.\r\n * @param {string} currency \u041A\u043E\u0434 \u0432\u0430\u043B\u044E\u0442\u044B (\u043D\u0430\u043F\u0440\u0438\u043C\u0435\u0440, 'USD', 'EUR', 'RUB').\r\n * @returns {string} \u041E\u0442\u0444\u043E\u0440\u043C\u0430\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u0430\u044F \u0441\u0442\u0440\u043E\u043A\u0430 \u0441 \u0446\u0435\u043D\u043E\u0439.\r\n */\r\nexport function formatPrice(amount, currency = 'RUB') {\r\n  // \u0423\u0431\u0435\u0434\u0438\u043C\u0441\u044F, \u0447\u0442\u043E \u0441\u0443\u043C\u043C\u0430 \u044F\u0432\u043B\u044F\u0435\u0442\u0441\u044F \u0447\u0438\u0441\u043B\u043E\u043C\r\n  if (isNaN(amount) || amount === null) {\r\n    throw new Error('Invalid amount');\r\n  }\r\n\r\n  // \u041E\u043F\u0440\u0435\u0434\u0435\u043B\u0438\u043C \u043D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0438 \u0434\u043B\u044F \u0432\u0430\u043B\u044E\u0442\u044B\r\n  const options = {\r\n    style: 'currency',\r\n    currency: currency.toUpperCase(),\r\n    minimumFractionDigits: 2,  // \u043E\u0442\u043E\u0431\u0440\u0430\u0436\u0430\u0442\u044C \u043C\u0438\u043D\u0438\u043C\u0443\u043C 2 \u0437\u043D\u0430\u043A\u0430 \u043F\u043E\u0441\u043B\u0435 \u0437\u0430\u043F\u044F\u0442\u043E\u0439\r\n    maximumFractionDigits: 2   // \u043E\u0442\u043E\u0431\u0440\u0430\u0436\u0430\u0442\u044C \u043C\u0430\u043A\u0441\u0438\u043C\u0443\u043C 2 \u0437\u043D\u0430\u043A\u0430 \u043F\u043E\u0441\u043B\u0435 \u0437\u0430\u043F\u044F\u0442\u043E\u0439\r\n  };\r\n\r\n  // \u0424\u043E\u0440\u043C\u0430\u0442\u0438\u0440\u0443\u0435\u043C \u0441\u0443\u043C\u043C\u0443 \u0441 \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u043D\u0438\u0435\u043C Intl.NumberFormat\r\n  const formatter = new Intl.NumberFormat('ru-RU', options);\r\n  return formatter.format(amount);\r\n}\r\n\r\n/**\r\n * Message formatter utility\r\n *\r\n * Supports template variables like:\r\n *   _msg('added', {count: 3})\r\n *   // if UI_MESSAGES.added = \"\u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E {count} \u0442\u043E\u0432\u0430\u0440\u043E\u0432\"\r\n *   // => \"\u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E 3 \u0442\u043E\u0432\u0430\u0440\u043E\u0432\"\r\n *\r\n * Can be used standalone or bound to a class with static UI_MESSAGES.\r\n *\r\n * @param {string} key - message key to fetch from UI_MESSAGES\r\n * @param {object} vars - optional replacements for {placeholders}\r\n * @param {object} [ctx] - optional context (class or instance with .UI_MESSAGES)\r\n * @returns {string}\r\n */\r\nexport function _msg(key, vars = {}, ctx = null) {\r\n  const pool =\r\n    (ctx && ctx.UI_MESSAGES) ||\r\n    (ctx && ctx.constructor && ctx.constructor.UI_MESSAGES) ||\r\n    (this && this.constructor && this.constructor.UI_MESSAGES) ||\r\n    {};\r\n  let tpl = pool[key] ?? '';\r\n  return String(tpl).replace(/\\{([^}]+)\\}/g, (m, k) =>\r\n    Object.prototype.hasOwnProperty.call(vars, k) ? String(vars[k]) : m\r\n  );\r\n}\r\n\r\n\r\n/**\r\n * makeSpecHtmlPreview: \u043F\u0440\u0438\u043D\u0438\u043C\u0430\u0435\u0442 JSON-\u0441\u0442\u0440\u043E\u043A\u0443 \u0438\u043B\u0438 \u043E\u0431\u044A\u0435\u043A\u0442 \u0438 \u0432\u043E\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u0442 \u0431\u0435\u0437\u043E\u043F\u0430\u0441\u043D\u044B\u0439 HTML\r\n * @param {string|object} specs\r\n * @returns {string}\r\n */\r\nexport function makeSpecHtmlPreview(specs) {\r\n  if (arguments.length === 0 || specs == null) return '';\r\n\r\n  let data = specs;\r\n  if (typeof specs === 'string') {\r\n    specs = specs.trim();\r\n    if (!specs) return '';\r\n    try {\r\n      data = JSON.parse(specs);\r\n    } catch {\r\n      return '';\r\n    }\r\n  }\r\n  if (typeof data !== 'object' || Array.isArray(data) || !Object.keys(data).length) {\r\n    return '';\r\n  }\r\n  let html = '<strong>\u041E\u0441\u043D\u043E\u0432\u043D\u044B\u0435 \u0445\u0430\u0440\u0430\u043A\u0442\u0435\u0440\u0438\u0441\u0442\u0438\u043A\u0438:</strong><div class=\"specsBlock\">';\r\n  for (const [key, value] of Object.entries(data)) {\r\n    html += `<div class=\"specsEntry\">\r\n  <div class=\"specsTitle\">${escapeHtml(key)}</div>\r\n  <div class=\"separator\" aria-hidden=\"true\"></div>\r\n  <div class=\"specsValue\">${escapeHtml(value)}</div>\r\n</div>\r\n`;\r\n  }\r\n  html += '</div>';\r\n  return html;\r\n}\r\n", "import { escapeHtml as _escapeHtml } from './utils.js';\r\n\r\n/**\r\n * ProductService\r\n * @author Calista Verner\r\n *\r\n * \u042D\u0442\u043E\u0442 \u043A\u043B\u0430\u0441\u0441 \u0438\u043D\u043A\u0430\u043F\u0441\u0443\u043B\u0438\u0440\u0443\u0435\u0442 \u043B\u043E\u0433\u0438\u043A\u0443 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0438 \u043D\u043E\u0440\u043C\u0430\u043B\u0438\u0437\u0430\u0446\u0438\u0438\r\n * \u043F\u0440\u043E\u0434\u0443\u043A\u0442\u043E\u0432, \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0439 \u0438 \u0431\u0440\u0435\u043D\u0434\u043E\u0432. \u041E\u043F\u0442\u0438\u043C\u0438\u0437\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u0430\u044F \u0432\u0435\u0440\u0441\u0438\u044F\r\n * \u0441\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u0442 \u043F\u0440\u0435\u0436\u043D\u0438\u0439 \u0438\u043D\u0442\u0435\u0440\u0444\u0435\u0439\u0441 (\u043F\u0443\u0431\u043B\u0438\u0447\u043D\u044B\u0435 \u043C\u0435\u0442\u043E\u0434\u044B \u0438 \u043F\u043E\u043B\u044F),\r\n * \u0443\u043F\u0440\u043E\u0449\u0430\u0435\u0442 \u0432\u043D\u0443\u0442\u0440\u0435\u043D\u043D\u0438\u0435 \u043F\u0440\u043E\u0446\u0435\u0441\u0441\u044B \u0438 \u043F\u043E\u0432\u044B\u0448\u0430\u0435\u0442 \u0447\u0438\u0442\u0430\u0435\u043C\u043E\u0441\u0442\u044C. \u0418\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u044E\u0442\u0441\u044F\r\n * \u0432\u0441\u043F\u043E\u043C\u043E\u0433\u0430\u0442\u0435\u043B\u044C\u043D\u044B\u0435 \u043C\u0435\u0442\u043E\u0434\u044B \u0434\u043B\u044F \u0441\u043E\u043A\u0440\u0430\u0449\u0435\u043D\u0438\u044F \u0434\u0443\u0431\u043B\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F \u0438 \u043E\u0431\u0435\u0441\u043F\u0435\u0447\u0435\u043D\u0438\u044F\r\n * \u0435\u0434\u0438\u043D\u043E\u043E\u0431\u0440\u0430\u0437\u0438\u044F.\r\n */\r\nexport class ProductService {\r\n  /**\r\n   * \u0421\u0442\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438\u0435 \u0442\u0435\u043A\u0441\u0442\u043E\u0432\u044B\u0435 \u0441\u043E\u043E\u0431\u0449\u0435\u043D\u0438\u044F \u0434\u043B\u044F \u0432\u044B\u0432\u043E\u0434\u0430 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044E\r\n   * @type {Readonly<Record<string,string>>}\r\n   */\r\n  static UI_MESSAGES = Object.freeze({\r\n    ERROR_NO_ENGINE: '\u0418\u043D\u0442\u0435\u0433\u0440\u0430\u0446\u0438\u044F \u0441 \u0431\u0435\u043A\u0435\u043D\u0434\u043E\u043C \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430',\r\n    ERROR_TIMEOUT: '\u0417\u0430\u043F\u0440\u043E\u0441 \u043F\u0440\u043E\u0434\u0443\u043A\u0442\u0430 \u043F\u0440\u0435\u0432\u044B\u0441\u0438\u043B \u0432\u0440\u0435\u043C\u044F \u043E\u0436\u0438\u0434\u0430\u043D\u0438\u044F',\r\n    LOAD_PRODUCTS_ERROR: '\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0441\u043F\u0438\u0441\u043A\u0430 \u0442\u043E\u0432\u0430\u0440\u043E\u0432',\r\n    FETCH_BY_ID_ERROR: '\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u043E\u043B\u0443\u0447\u0435\u043D\u0438\u044F \u0434\u0430\u043D\u043D\u044B\u0445 \u0442\u043E\u0432\u0430\u0440\u0430',\r\n    FETCH_CATEGORIES_ERROR: '\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u043E\u043B\u0443\u0447\u0435\u043D\u0438\u044F \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0439',\r\n    FILL_CATEGORIES_WARN: 'ProductService.fillCategories: \u043E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0437\u0430\u043F\u043E\u043B\u043D\u0435\u043D\u0438\u0438 select',\r\n    ALL_CATEGORIES_OPTION: '\u0412\u0441\u0435 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438',\r\n    ALL_BRANDS_OPTION: '\u0412\u0441\u0435 \u0431\u0440\u0435\u043D\u0434\u044B',\r\n    SUBSCRIBE_ARG_ERROR: 'subscribe \u043E\u0436\u0438\u0434\u0430\u0435\u0442 \u0444\u0443\u043D\u043A\u0446\u0438\u044E',\r\n    UPSERT_ERROR: '\u041E\u0448\u0438\u0431\u043A\u0430 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u0438\u044F/\u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u044F \u0442\u043E\u0432\u0430\u0440\u0430'\r\n  });\r\n\r\n  /**\r\n   * @param {any} foxEngine \u042D\u043A\u0437\u0435\u043C\u043F\u043B\u044F\u0440 \u0434\u0432\u0438\u0436\u043A\u0430 \u043E\u0442\u043F\u0440\u0430\u0432\u043A\u0438 \u0437\u0430\u043F\u0440\u043E\u0441\u043E\u0432\r\n   * @param {Object} [opts]\r\n   * @param {Object} [opts.endpoints] \u041F\u0435\u0440\u0435\u043E\u043F\u0440\u0435\u0434\u0435\u043B\u0435\u043D\u0438\u044F \u0438\u043C\u0451\u043D \u044D\u043D\u0434\u043F\u043E\u0438\u043D\u0442\u043E\u0432\r\n   * @param {number} [opts.timeoutMs] \u0422\u0430\u0439\u043C\u0430\u0443\u0442 \u0437\u0430\u043F\u0440\u043E\u0441\u043E\u0432 \u0432 \u043C\u0438\u043B\u043B\u0438\u0441\u0435\u043A\u0443\u043D\u0434\u0430\u0445\r\n   * @param {boolean} [opts.debug] \u0412\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u043B\u043E\u0433\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435\r\n   */\r\n  constructor(foxEngine, opts = {}) {\r\n    if (!foxEngine) throw new TypeError('ProductService requires foxEngine');\r\n    this.foxEngine = foxEngine;\r\n    // \u0434\u0435\u0441\u0442\u0440\u0443\u043A\u0442\u0443\u0440\u0438\u0437\u0430\u0446\u0438\u044F \u043D\u0430\u0441\u0442\u0440\u043E\u0435\u043A \u0441 \u0434\u0435\u0444\u043E\u043B\u0442\u0430\u043C\u0438\r\n    const {\r\n      endpoints = {\r\n        products: 'getProducts',\r\n        productById: 'getProduct',\r\n        categories: 'getCategories',\r\n        brands: 'getBrands'\r\n      },\r\n      timeoutMs = 7000,\r\n      debug = false\r\n    } = opts;\r\n    this.opts = { endpoints, timeoutMs, debug };\r\n    /** @type {Array<any>} */\r\n    this.products = [];\r\n    /** @type {Map<string,any>} */\r\n    this._productMap = new Map();\r\n    /** @type {Map<string,string>} */\r\n    this._categoriesMap = new Map();\r\n    /** @type {Map<string,string>} */\r\n    this._brandsMap = new Map();\r\n    /** @type {Set<Function>} */\r\n    this._subscribers = new Set();\r\n  }\r\n\r\n  /* ---------------------- utils ---------------------- */\r\n\r\n  /**\r\n   * \u041F\u043E\u0434\u0441\u0442\u0430\u043D\u043E\u0432\u043A\u0430 \u0437\u043D\u0430\u0447\u0435\u043D\u0438\u0439 \u0432 \u0441\u0442\u0440\u043E\u043A\u0443 \u0441\u043E\u043E\u0431\u0449\u0435\u043D\u0438\u0439\r\n   * @param {string} key\r\n   * @param {Record<string,string|number>} vars\r\n   * @returns {string}\r\n   */\r\n  _msg(key, vars = {}) {\r\n    const tpl = (this.constructor && this.constructor.UI_MESSAGES && this.constructor.UI_MESSAGES[key]) || '';\r\n    return String(tpl).replace(/\\{([^}]+)\\}/g, (m, k) => Object.prototype.hasOwnProperty.call(vars, k) ? String(vars[k]) : m);\r\n  }\r\n\r\n  /**\r\n   * \u041D\u043E\u0440\u043C\u0430\u043B\u0438\u0437\u0443\u0435\u0442 \u0438\u0434\u0435\u043D\u0442\u0438\u0444\u0438\u043A\u0430\u0442\u043E\u0440 \u0432 \u0441\u0442\u0440\u043E\u043A\u0443\r\n   * @param {any} v\r\n   * @returns {string}\r\n   */\r\n  _normalizeId(v) {\r\n    if (v === undefined || v === null) return '';\r\n    return String(v).trim();\r\n  }\r\n\r\n  /**\r\n   * \u041B\u043E\u0433\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u0432 debug \u0440\u0435\u0436\u0438\u043C\u0435\r\n   * @param {...any} args\r\n   */\r\n  _log(...args) {\r\n    if (!this.opts.debug) return;\r\n    const logger = typeof this.foxEngine.log === 'function' ? this.foxEngine.log.bind(this.foxEngine) : console.debug;\r\n    try { logger(...args); } catch (e) { console.debug(...args); }\r\n  }\r\n\r\n  /**\r\n   * \u0411\u0435\u0437\u043E\u043F\u0430\u0441\u043D\u044B\u0439 \u0432\u044B\u0437\u043E\u0432 \u0443\u0434\u0430\u043B\u0451\u043D\u043D\u043E\u0433\u043E \u043C\u0435\u0442\u043E\u0434\u0430 \u0441 \u0442\u0430\u0439\u043C\u0430\u0443\u0442\u043E\u043C\r\n   * @param {any} payload\r\n   * @param {string} expect\r\n   * @returns {Promise<any>}\r\n   */\r\n  async _safeCall(payload = {}, expect = 'JSON') {\r\n    const call = this.foxEngine.sendPostAndGetAnswer(payload, expect);\r\n    const timeout = Number(this.opts.timeoutMs) || 7000;\r\n    if (!timeout || timeout <= 0) return call;\r\n    return Promise.race([\r\n      call,\r\n      new Promise((_, rej) => setTimeout(() => rej(new Error(this._msg('ERROR_TIMEOUT'))), timeout))\r\n    ]);\r\n  }\r\n\r\n  /**\r\n   * \u0418\u0437\u0432\u043B\u0435\u043A\u0430\u0435\u0442 \u043C\u0430\u0441\u0441\u0438\u0432 \u0438\u0437 \u043E\u0442\u0432\u0435\u0442\u0430 \u0431\u0435\u043A\u0435\u043D\u0434\u0430 \u043F\u043E \u043F\u0440\u0435\u0434\u043F\u043E\u0447\u0442\u0438\u0442\u0435\u043B\u044C\u043D\u043E\u043C\u0443 \u0441\u043F\u0438\u0441\u043A\u0443 \u043A\u043B\u044E\u0447\u0435\u0439.\r\n   * @param {any} res\r\n   * @param {Array<string>} prefer\r\n   * @returns {Array<any>}\r\n   */\r\n  _extractArray(res, prefer = ['items', 'products', 'data', 'categories', 'brands', 'list']) {\r\n    if (!res) return [];\r\n    if (Array.isArray(res)) return res;\r\n    if (typeof res !== 'object') return [];\r\n    for (const k of prefer) if (Array.isArray(res[k])) return res[k];\r\n    for (const k of Object.keys(res)) if (Array.isArray(res[k])) return res[k];\r\n    return [res];\r\n  }\r\n\r\n  /**\r\n   * \u0417\u0430\u043F\u0438\u0441\u044B\u0432\u0430\u0435\u0442 \u0437\u043D\u0430\u0447\u0435\u043D\u0438\u0435 \u0432 \u043A\u0430\u0440\u0442\u0443, \u0435\u0441\u043B\u0438 \u043A\u043B\u044E\u0447 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u0435\u0442 \u0438 \u043D\u0435 \u0431\u044B\u043B \u0437\u0430\u043F\u0438\u0441\u0430\u043D \u0440\u0430\u043D\u0435\u0435 (\u0438\u043B\u0438 \u0435\u0441\u043B\u0438 overwrite=true)\r\n   * @param {Map<string,any>} map\r\n   * @param {string} key\r\n   * @param {any} value\r\n   * @param {boolean} [overwrite=false]\r\n   */\r\n  _setCache(map, key, value, overwrite = false) {\r\n    if (!key) return;\r\n    if (overwrite || !map.has(key)) map.set(key, value);\r\n  }\r\n\r\n  /**\r\n   * \u0423\u0432\u0435\u0434\u043E\u043C\u043B\u044F\u0435\u0442 \u0432\u0441\u0435\u0445 \u043F\u043E\u0434\u043F\u0438\u0441\u0447\u0438\u043A\u043E\u0432 \u043E\u0431 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u044F\u0445\r\n   * @param {Object} change\r\n   */\r\n  _notifySubscribers(change = { type: 'set', changedIds: [] }) {\r\n    for (const fn of this._subscribers) {\r\n      try { fn(change); } catch (e) { this._log('subscriber error', e); }\r\n    }\r\n  }\r\n\r\n  /* ---------------------- normalization helpers ---------------------- */\r\n\r\n  /**\r\n   * \u0420\u0430\u0437\u0431\u0438\u0440\u0430\u0435\u0442 \u0438 \u043D\u043E\u0440\u043C\u0430\u043B\u0438\u0437\u0443\u0435\u0442 \u043F\u043E\u043B\u044F \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438 \u0438\u0437 \u0441\u044B\u0440\u043E\u0433\u043E \u043F\u0440\u043E\u0434\u0443\u043A\u0442\u0430\r\n   * @param {Object} raw\r\n   * @returns {{ key: string, name: string }}\r\n   */\r\n  _parseCategory(raw) {\r\n    const rawCat = raw.category ?? raw.cat ?? raw.categoryId ?? '';\r\n    const key = this._normalizeId(rawCat);\r\n    const name = String(raw.categoryName ?? raw.categoryFullname ?? '').trim();\r\n    return { key, name };\r\n  }\r\n\r\n  /**\r\n   * \u0420\u0430\u0437\u0431\u0438\u0440\u0430\u0435\u0442 \u0438 \u043D\u043E\u0440\u043C\u0430\u043B\u0438\u0437\u0443\u0435\u0442 \u043F\u043E\u043B\u044F \u0431\u0440\u0435\u043D\u0434\u0430 \u0438\u0437 \u0441\u044B\u0440\u043E\u0433\u043E \u043F\u0440\u043E\u0434\u0443\u043A\u0442\u0430\r\n   * @param {Object} raw\r\n   * @returns {{ key: string, name: string }}\r\n   */\r\n  _parseBrand(raw) {\r\n    let rawBrand = raw.brand ?? raw.brandId ?? '';\r\n    if (typeof rawBrand === 'object') rawBrand = rawBrand.id ?? rawBrand.key ?? rawBrand.name ?? '';\r\n    const key = this._normalizeId(rawBrand);\r\n    const name = String(raw.brandName ?? raw.brandFullname ?? '').trim();\r\n    return { key, name };\r\n  }\r\n\r\n  /**\r\n   * \u0413\u0430\u0440\u0430\u043D\u0442\u0438\u0440\u0443\u0435\u0442 \u043D\u0430\u043B\u0438\u0447\u0438\u0435 \u0447\u0435\u043B\u043E\u0432\u0435\u0447\u0435\u0441\u043A\u0438\u0445 \u0438\u043C\u0451\u043D \u0434\u043B\u044F \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438 \u0438 \u0431\u0440\u0435\u043D\u0434\u0430 (\u0430\u0441\u0438\u043D\u0445\u0440\u043E\u043D\u043D\u043E)\r\n   * @param {string} categoryKey\r\n   * @param {string} brandKey\r\n   * @param {string} fallbackCategory\r\n   * @param {string} fallbackBrand\r\n   * @returns {Promise<[string,string]>}\r\n   */\r\n  async _resolveBrandAndCategoryNames(categoryKey, brandKey, fallbackCategory = '', fallbackBrand = '') {\r\n    const ensureBrandName = async () => {\r\n      if (!brandKey) return '';\r\n      const fetched = await this.fetchBrandNameById(brandKey);\r\n      return fetched;\r\n    };\r\n    const ensureCatName = async () => {\r\n      if (!categoryKey) return '';\r\n      const fetched = await this.fetchCatById(categoryKey);\r\n      return fetched;\r\n    };\r\n    const [brandNameResolved, catNameResolved] = await Promise.all([ensureBrandName(), ensureCatName()]);\r\n    const finalBrandName = fallbackBrand || brandNameResolved || brandKey;\r\n    const finalCatName = fallbackCategory || catNameResolved || categoryKey;\r\n    return [finalCatName, finalBrandName];\r\n  }\r\n\r\n  /**\r\n   * \u041D\u043E\u0440\u043C\u0430\u043B\u0438\u0437\u0443\u0435\u0442 \u043E\u0434\u043D\u0443 \u0437\u0430\u043F\u0438\u0441\u044C \u043F\u0440\u043E\u0434\u0443\u043A\u0442\u0430. \u041F\u043E\u043F\u043E\u043B\u043D\u044F\u0435\u0442 \u043A\u044D\u0448 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0439 \u0438 \u0431\u0440\u0435\u043D\u0434\u043E\u0432.\r\n   * @param {any} raw\r\n   * @returns {Promise<Object|null>}\r\n   */\r\n  async _normalizeProduct(raw) {\r\n    if (!raw || typeof raw !== 'object') return null;\r\n    const name = this._normalizeId(raw.name ?? raw.id ?? raw.title ?? raw.fullname ?? raw.sku);\r\n    if (!name) return null;\r\n    const title = String(raw.fullname ?? raw.title ?? raw.name ?? '').trim();\r\n    const price = Number(raw.price ?? raw.cost ?? 0);\r\n    const oldPrice = Number(raw.oldPrice ?? raw.price_old ?? 0);\r\n    const stock = Number(raw.stock ?? raw.count ?? raw.qty ?? 0);\r\n    const picture = String(raw.picture ?? raw.image ?? raw.img ?? '/assets/no-image.png');\r\n    const { key: categoryKey, name: categoryNameInput } = this._parseCategory(raw);\r\n    const { key: brandKey, name: brandNameInput } = this._parseBrand(raw);\r\n    const [resolvedCatName, resolvedBrandName] = await this._resolveBrandAndCategoryNames(categoryKey, brandKey, categoryNameInput, brandNameInput);\r\n    // \u043E\u0431\u043D\u043E\u0432\u0438\u0442\u044C \u043A\u044D\u0448\u0438 \u043E\u043A\u043E\u043D\u0447\u0430\u0442\u0435\u043B\u044C\u043D\u044B\u043C\u0438 \u0437\u043D\u0430\u0447\u0435\u043D\u0438\u044F\u043C\u0438\r\n    if (categoryKey && resolvedCatName) this._setCache(this._categoriesMap, categoryKey, resolvedCatName);\r\n    if (brandKey && resolvedBrandName) this._setCache(this._brandsMap, brandKey, resolvedBrandName);\r\n    return {\r\n      _raw: raw,\r\n      name,\r\n      fullname: title,\r\n      title,\r\n      price,\r\n      oldPrice,\r\n      stock,\r\n      picture,\r\n      category: categoryKey,\r\n      categoryName: resolvedCatName,\r\n      brand: brandKey,\r\n      brandName: resolvedBrandName,\r\n      short: raw.short ?? raw.description ?? '',\r\n      specs: raw.specs ?? raw.properties ?? raw.attributes ?? {}\r\n    };\r\n  }\r\n\r\n  /* ---------------------- products API ---------------------- */\r\n\r\n  /**\r\n   * \u0412\u043E\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u0442 \u0441\u043F\u0438\u0441\u043E\u043A \u043F\u0440\u043E\u0434\u0443\u043A\u0442\u043E\u0432. \u041F\u043E \u0443\u043C\u043E\u043B\u0447\u0430\u043D\u0438\u044E \u0432\u043E\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u0442 \u043A\u043E\u043F\u0438\u044E.\r\n   * @param {Object} [param0]\r\n   * @param {boolean} [param0.clone=true]\r\n   * @returns {Array<any>}\r\n   */\r\n  getProducts({ clone = true } = {}) {\r\n    return clone ? this.products.map((p) => Object.assign({}, p)) : this.products;\r\n  }\r\n\r\n  /**\r\n   * \u041D\u0430\u0445\u043E\u0434\u0438\u0442 \u043F\u0440\u043E\u0434\u0443\u043A\u0442 \u043F\u043E \u043D\u043E\u0440\u043C\u0430\u043B\u0438\u0437\u043E\u0432\u0430\u043D\u043D\u043E\u043C\u0443 id\r\n   * @param {any} id\r\n   * @returns {any|null}\r\n   */\r\n  findById(id) {\r\n    const sid = this._normalizeId(id);\r\n    return sid ? (this._productMap.get(sid) || null) : null;\r\n  }\r\n\r\n  /**\r\n   * \u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u0442 \u0441\u043F\u0438\u0441\u043E\u043A \u0442\u043E\u0432\u0430\u0440\u043E\u0432. \u041C\u043E\u0436\u043D\u043E \u0443\u043A\u0430\u0437\u0430\u0442\u044C force=true \u0434\u043B\u044F \u043F\u0440\u0438\u043D\u0443\u0434\u0438\u0442\u0435\u043B\u044C\u043D\u043E\u0433\u043E \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u044F.\r\n   * @param {Object} [options]\r\n   * @param {boolean} [options.force=false]\r\n   * @param {any} [options.request=null] \u041F\u0435\u0440\u0435\u043E\u043F\u0440\u0435\u0434\u0435\u043B\u0435\u043D\u0438\u0435 \u0437\u0430\u043F\u0440\u043E\u0441\u0430\r\n   * @returns {Promise<Array<any>>}\r\n   */\r\n  async loadProductsSimple({ force = false, request = null } = {}) {\r\n    //if (this.products.length && !force && !request) return this.getProducts();\r\n    const defaultEndpoint = this.opts.endpoints.products;\r\n    let endpoint = defaultEndpoint;\r\n    let payload = { sysRequest: endpoint };\r\n    if (request) {\r\n      if (typeof request === 'string') {\r\n        endpoint = request;\r\n        payload.sysRequest = endpoint;\r\n      } else {\r\n        const { endpoint: reqEndpoint, sysRequest: reqSys, payload: reqPayload, params: reqParams, ...extra } = request;\r\n        endpoint = reqEndpoint ?? reqSys ?? defaultEndpoint;\r\n        payload = Object.assign({}, reqParams ?? {}, reqPayload ?? {}, extra ?? {}, { sysRequest: endpoint });\r\n      }\r\n    }\r\n    try {\r\n      const res = await this._safeCall(payload, 'JSON');\r\n      const items = this._extractArray(res, ['items', 'products', 'data']);\r\n      const normalized = await Promise.all(items.map((i) => this._normalizeProduct(i)).filter(Boolean));\r\n      this.products = normalized;\r\n      this._rebuildMaps();\r\n      // ensure simple category/brand keys exist in maps (\u0434\u043B\u044F \u0444\u0438\u043B\u044C\u0442\u0440\u043E\u0432)\r\n      for (const p of this.products) {\r\n        if (p.category && !this._categoriesMap.has(p.category)) this._categoriesMap.set(p.category, p.categoryName || p.category);\r\n        if (p.brand && !this._brandsMap.has(p.brand)) this._brandsMap.set(p.brand, p.brandName);\r\n      }\r\n      this._notifySubscribers({ type: 'reload', changedIds: this.products.map((p) => p.name) });\r\n      return this.getProducts();\r\n    } catch (err) {\r\n      this._log(this._msg('LOAD_PRODUCTS_ERROR'), err);\r\n      this.products = this.products || [];\r\n      this._rebuildMaps();\r\n      return this.getProducts();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u0442 \u043F\u0440\u043E\u0434\u0443\u043A\u0442 \u043F\u043E ID (\u0435\u0441\u043B\u0438 \u043D\u0435\u0442 \u0432 \u043A\u0435\u0448\u0435).\r\n   * @param {any} id\r\n   * @returns {Promise<any|null>}\r\n   */\r\n  async fetchById(id) {\r\n    const sid = this._normalizeId(id);\r\n    if (!sid) return null;\r\n    const existing = this.findById(sid);\r\n    if (existing) return existing;\r\n    const endpoint = this.opts.endpoints.productById;\r\n    try {\r\n      const res = await this._safeCall({ sysRequest: endpoint, id: sid }, 'JSON');\r\n      const items = this._extractArray(res, ['product', 'items', 'products', 'data']);\r\n      const raw = items.length ? items[0] : res.product ?? res;\r\n      if (!raw) return null;\r\n      const normalized = await this._normalizeProduct(raw);\r\n      if (!normalized) return null;\r\n      this.products.push(normalized);\r\n      this._productMap.set(normalized.name, normalized);\r\n      if (normalized.category) this._setCache(this._categoriesMap, normalized.category, normalized.categoryName || normalized.category);\r\n      if (normalized.brand) this._setCache(this._brandsMap, normalized.brand, normalized.brandName || normalized.brand);\r\n      this._notifySubscribers({ type: 'add', changedIds: [normalized.name] });\r\n      return normalized;\r\n    } catch (err) {\r\n      this._log(this._msg('FETCH_BY_ID_ERROR'), err);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \u0417\u0430\u043C\u0435\u043D\u044F\u0435\u0442 \u0442\u0435\u043A\u0443\u0449\u0438\u0439 \u0441\u043F\u0438\u0441\u043E\u043A \u043F\u0440\u043E\u0434\u0443\u043A\u0442\u043E\u0432 \u043D\u043E\u0432\u044B\u043C \u043C\u0430\u0441\u0441\u0438\u0432\u043E\u043C. \u0414\u0430\u043D\u043D\u044B\u0435 \u043F\u0440\u0435\u0434\u0432\u0430\u0440\u0438\u0442\u0435\u043B\u044C\u043D\u043E \u043D\u043E\u0440\u043C\u0430\u043B\u0438\u0437\u0443\u044E\u0442\u0441\u044F.\r\n   * @param {Array<any>} rawProducts\r\n   * @returns {Promise<boolean>}\r\n   */\r\n  async setProducts(rawProducts = []) {\r\n    const arr = Array.isArray(rawProducts) ? rawProducts : [];\r\n    try {\r\n      const normalized = await Promise.all(arr.map((r) => this._normalizeProduct(r)).filter(Boolean));\r\n      this.products = normalized;\r\n      this._rebuildMaps();\r\n      for (const p of this.products) {\r\n        if (p.category && !this._categoriesMap.has(p.category)) this._categoriesMap.set(p.category, p.categoryName || p.category);\r\n        if (p.brand && !this._brandsMap.has(p.brand)) this._brandsMap.set(p.brand, p.brandName || p.brand);\r\n      }\r\n      this._notifySubscribers({ type: 'set', changedIds: this.products.map((p) => p.name) });\r\n      return true;\r\n    } catch (err) {\r\n      this._log(this._msg('LOAD_PRODUCTS_ERROR'), err);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \u041F\u0435\u0440\u0435\u0441\u0442\u0440\u0430\u0438\u0432\u0430\u0435\u0442 \u0432\u043D\u0443\u0442\u0440\u0435\u043D\u043D\u0438\u0435 \u043A\u0430\u0440\u0442\u044B \u043F\u043E \u0442\u0435\u043A\u0443\u0449\u0435\u043C\u0443 \u043C\u0430\u0441\u0441\u0438\u0432\u0443 \u043F\u0440\u043E\u0434\u0443\u043A\u0442\u043E\u0432\r\n   */\r\n  _rebuildMaps() {\r\n    this._productMap.clear();\r\n    for (const p of this.products) {\r\n      if (!p || !p.name) continue;\r\n      const key = this._normalizeId(p.name);\r\n      this._productMap.set(key, p);\r\n      if (p.brand) this._setCache(this._brandsMap, p.brand, p.brandName || p.brand);\r\n      if (p.category) this._setCache(this._categoriesMap, p.category, p.categoryName || p.category);\r\n    }\r\n  }\r\n\r\n  /* ---------------------- categories / brands (fetch helpers) ---------------------- */\r\n\r\n  /**\r\n   * \u0417\u0430\u043F\u0440\u0430\u0448\u0438\u0432\u0430\u0435\u0442 \u0441\u043F\u0438\u0441\u043E\u043A \u0441\u0443\u0449\u043D\u043E\u0441\u0442\u0435\u0439 (brands | categories) \u0441 \u0431\u044D\u043A\u0435\u043D\u0434\u0430\r\n   * @param {string} entity\r\n   * @returns {Promise<Array<any>>}\r\n   */\r\n  async fetchList(entity) {\r\n    const endpoint = this.opts.endpoints[entity];\r\n    const res = await this._safeCall({ sysRequest: endpoint }, 'JSON');\r\n    return this._extractArray(res, [entity, 'data', 'items', 'list']);\r\n  }\r\n\r\n  /**\r\n   * \u041F\u043E\u043B\u0443\u0447\u0430\u0435\u0442 \u0441\u0443\u0449\u043D\u043E\u0441\u0442\u044C \u043F\u043E id (brand \u0438\u043B\u0438 category)\r\n   * @param {string} entity\r\n   * @param {any} id\r\n   * @returns {Promise<any|null>}\r\n   */\r\n  async fetchEntityById(entity, id) {\r\n    const endpoint = this.opts.endpoints[`${entity}`];\r\n    const sid = this._normalizeId(id);\r\n    if (!sid) return null;\r\n    const res = await this._safeCall({ sysRequest: endpoint, id: sid }, 'JSON');\r\n    const arr = this._extractArray(res, [entity, 'data', 'items']);\r\n    if (Array.isArray(arr) && arr.length) {\r\n      const found = arr.find((x) => {\r\n        if (!x) return false;\r\n        const candidates = [x.id, x.key, x.name, x.code].map((v) => this._normalizeId(v)).filter(Boolean);\r\n        return candidates.includes(sid);\r\n      });\r\n      return found;\r\n    }\r\n    return res;\r\n  }\r\n\r\n  /**\r\n   * \u0417\u0430\u043F\u0440\u0430\u0448\u0438\u0432\u0430\u0435\u0442 \u0438 \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u0442 \u0441\u043F\u0438\u0441\u043E\u043A \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0439\r\n   * @returns {Promise<Array<{name:string, fullname:string}>>}\r\n   */\r\n  async fetchCategories() {\r\n    try {\r\n      const arr = await this.fetchList('categories');\r\n      const out = arr.map((c) => {\r\n        if (!c) return null;\r\n        if (typeof c === 'string') return { name: c, fullname: c };\r\n        return { name: c.name ?? c.id ?? '', fullname: c.fullname ?? c.name ?? c.title ?? '' };\r\n      }).filter(Boolean);\r\n      for (const c of out) this._setCache(this._categoriesMap, String(c.name).trim(), String(c.fullname).trim() || String(c.name).trim());\r\n      return out.length ? out : Array.from(this._categoriesMap.entries()).map(([name, fullname]) => ({ name, fullname }));\r\n    } catch (err) {\r\n      this._log(this._msg('FETCH_CATEGORIES_ERROR'), err);\r\n      return Array.from(this._categoriesMap.entries()).map(([name, fullname]) => ({ name, fullname }));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \u0417\u0430\u043F\u0440\u0430\u0448\u0438\u0432\u0430\u0435\u0442 \u0438 \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u0442 \u0441\u043F\u0438\u0441\u043E\u043A \u0431\u0440\u0435\u043D\u0434\u043E\u0432\r\n   * @returns {Promise<Array<{id:string, name:string, fullname:string}>>}\r\n   */\r\n  async fetchBrands() {\r\n    try {\r\n      const arr = await this.fetchList('brands');\r\n      const out = arr.map((b) => {\r\n        if (!b) return null;\r\n        if (typeof b === 'string') {\r\n          const id = this._normalizeId(b);\r\n          return { id, name: b, fullname: b };\r\n        }\r\n        const id = this._normalizeId(b.id ?? b.key ?? b.name ?? '');\r\n        if (!id) return null;\r\n        const name = String(b.name ?? b.fullname ?? b.title ?? b.label ?? id).trim();\r\n        const fullname = String(b.fullname ?? name).trim() || name || id;\r\n        return { id, name, fullname };\r\n      }).filter(Boolean);\r\n      for (const b of out) this._setCache(this._brandsMap, b.id, b.fullname || b.name);\r\n      // complement with brands found in products\r\n      for (const p of this.products) {\r\n        const bid = this._normalizeId(p.brand);\r\n        if (!bid) continue;\r\n        if (!this._brandsMap.has(bid)) this._brandsMap.set(bid, p.brandName || p.brand || bid);\r\n      }\r\n      return out.length ? out : Array.from(this._brandsMap.entries()).map(([id, fullname]) => ({ id, name: fullname, fullname }));\r\n    } catch (err) {\r\n      this._log('ProductService.fetchBrands failed', err);\r\n      // fallback: derive from products\r\n      const map = new Map();\r\n      for (const p of this.products) {\r\n        const bid = this._normalizeId(p.brand);\r\n        if (!bid) continue;\r\n        const name = p.brandName || p.brand || bid;\r\n        if (!map.has(bid)) map.set(bid, name);\r\n        if (!this._brandsMap.has(bid)) this._brandsMap.set(bid, name);\r\n      }\r\n      return Array.from(map.entries()).map(([id, name]) => ({ id, name, fullname: name }));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \u041F\u043E\u043B\u0443\u0447\u0438\u0442\u044C \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u0431\u0440\u0435\u043D\u0434\u0430 \u043F\u043E id \u0438\u0437 \u043A\u0435\u0448\u0430 \u0438\u043B\u0438 \u0438\u0437 \u043F\u0440\u043E\u0434\u0443\u043A\u0442\u0430\r\n   * @param {any} id\r\n   * @returns {string}\r\n   */\r\n  getBrandNameById(id) {\r\n    const sid = this._normalizeId(id);\r\n    if (!sid) return '';\r\n    if (this._brandsMap.has(sid)) return this._brandsMap.get(sid);\r\n    for (const p of this.products) {\r\n      const bid = this._normalizeId(p.brand);\r\n      if (bid === sid) {\r\n        const nm = p.brandName || p.brand || bid;\r\n        this._brandsMap.set(sid, nm);\r\n        return nm;\r\n      }\r\n    }\r\n    return '';\r\n  }\r\n\r\n  /**\r\n   * \u0410\u0441\u0438\u043D\u0445\u0440\u043E\u043D\u043D\u043E \u0437\u0430\u043F\u0440\u0430\u0448\u0438\u0432\u0430\u0435\u0442 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u0431\u0440\u0435\u043D\u0434\u0430 \u043F\u043E id \u0441 \u0431\u044D\u043A\u0435\u043D\u0434\u0430\r\n   * @param {any} id\r\n   * @returns {Promise<string>}\r\n   */\r\n  async fetchBrandNameById(id) {\r\n    const sid = this._normalizeId(id);\r\n    if (!sid) return '';\r\n    try {\r\n      const item = await this.fetchEntityById('brands', sid);\r\n      if (!item) return '';\r\n      const bid = this._normalizeId(item.name) || sid;\r\n      const fullname = String(item.fullname).trim() || bid;\r\n      this._brandsMap.set(bid, fullname);\r\n      return fullname;\r\n    } catch (err) {\r\n      this._log('ProductService.fetchBrandNameById failed', err);\r\n      return this.getBrandNameById(sid);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \u041F\u043E\u043B\u0443\u0447\u0438\u0442\u044C \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438 \u043F\u043E id \u0438\u0437 \u043A\u0435\u0448\u0430 \u0438\u043B\u0438 \u0438\u0437 \u043F\u0440\u043E\u0434\u0443\u043A\u0442\u0430\r\n   * @param {any} id\r\n   * @returns {string}\r\n   */\r\n  getCatNameById(id) {\r\n    const sid = this._normalizeId(id);\r\n    if (!sid) return '';\r\n    if (this._categoriesMap.has(sid)) return this._categoriesMap.get(sid);\r\n    for (const p of this.products) {\r\n      const cid = this._normalizeId(p.category);\r\n      if (cid === sid) {\r\n        const nm = p.categoryName || cid;\r\n        this._categoriesMap.set(sid, nm);\r\n        return nm;\r\n      }\r\n    }\r\n    return '';\r\n  }\r\n\r\n  /**\r\n   * \u0410\u0441\u0438\u043D\u0445\u0440\u043E\u043D\u043D\u043E \u0437\u0430\u043F\u0440\u0430\u0448\u0438\u0432\u0430\u0435\u0442 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438 \u043F\u043E id \u0441 \u0431\u044D\u043A\u0435\u043D\u0434\u0430\r\n   * @param {any} id\r\n   * @returns {Promise<string>}\r\n   */\r\n  async fetchCatById(id) {\r\n    const sid = this._normalizeId(id);\r\n    if (!sid) return '';\r\n    try {\r\n      const item = await this.fetchEntityById('categories', sid);\r\n      if (!item) return '';\r\n      const cid = this._normalizeId(item.name) || sid;\r\n      const fullname = String(item.fullname).trim() || cid;\r\n      this._categoriesMap.set(cid, fullname);\r\n      return fullname;\r\n    } catch (err) {\r\n      this._log('ProductService.fetchCatById failed', err);\r\n      return this.getCatNameById(sid);\r\n    }\r\n  }\r\n\r\n  /* ---------------------- fill select generic ---------------------- */\r\n\r\n  /**\r\n   * \u0423\u043D\u0438\u0432\u0435\u0440\u0441\u0430\u043B\u044C\u043D\u044B\u0439 \u043D\u0430\u043F\u043E\u043B\u043D\u0438\u0442\u0435\u043B\u044C <select> \u043D\u0430 \u043E\u0441\u043D\u043E\u0432\u0435 \u0441\u043F\u0438\u0441\u043A\u0430 \u0441\u0443\u0449\u043D\u043E\u0441\u0442\u0435\u0439 \u0438 \u0434\u0430\u043D\u043D\u044B\u0445 \u0438\u0437 products.\r\n   * \u0414\u0443\u0431\u043B\u0438\u043A\u0430\u0442\u044B \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u044F\u044E\u0442\u0441\u044F \u043F\u043E \u00AB\u0441\u043B\u0430\u0433\u0443\u00BB, \u0441\u0442\u0440\u043E\u043A\u0430 'undefined' \u0441\u0447\u0438\u0442\u0430\u0435\u0442\u0441\u044F \u043F\u0443\u0441\u0442\u043E\u0439.\r\n   * option.value \u0440\u0430\u0432\u0435\u043D id (\u0435\u0441\u043B\u0438 \u0435\u0441\u0442\u044C) \u043B\u0438\u0431\u043E name; data-id = \u043E\u0440\u0438\u0433\u0438\u043D\u0430\u043B\u044C\u043D\u044B\u0439 id (\u0435\u0441\u043B\u0438 \u0435\u0441\u0442\u044C),\r\n   * data-fullname = fullname, data-name = name.\r\n   *\r\n   * @param {HTMLElement|string|null} selectEl\r\n   * @param {Object} param1\r\n   * @param {string} param1.entity (\u043D\u0430\u043F\u0440\u0438\u043C\u0435\u0440, 'categories' \u0438\u043B\u0438 'brands')\r\n   * @param {string} param1.productProp (\u043D\u0430\u043F\u0440\u0438\u043C\u0435\u0440, 'category' \u0438\u043B\u0438 'brand')\r\n   * @param {boolean} [param1.includeAllOption=true]\r\n   * @param {boolean} [param1.onlyFromProducts=false]\r\n   * @param {boolean} [param1.sort=true]\r\n   * @param {string} [param1.allMsgKey='ALL_CATEGORIES_OPTION']\r\n   * @returns {Promise<boolean>}\r\n   */\r\n/**\r\n * \u0423\u043D\u0438\u0432\u0435\u0440\u0441\u0430\u043B\u044C\u043D\u044B\u0439 \u043D\u0430\u043F\u043E\u043B\u043D\u0438\u0442\u0435\u043B\u044C <select> \u043D\u0430 \u043E\u0441\u043D\u043E\u0432\u0435 \u0441\u043F\u0438\u0441\u043A\u0430 \u0441\u0443\u0449\u043D\u043E\u0441\u0442\u0435\u0439 \u0438 \u0434\u0430\u043D\u043D\u044B\u0445 \u0438\u0437 products.\r\n * \u0414\u0443\u0431\u043B\u0438\u043A\u0430\u0442\u044B \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u044F\u044E\u0442\u0441\u044F \u043F\u043E \u00AB\u0441\u043B\u0430\u0433\u0443\u00BB, \u0441\u0442\u0440\u043E\u043A\u0430 'undefined' \u0441\u0447\u0438\u0442\u0430\u0435\u0442\u0441\u044F \u043F\u0443\u0441\u0442\u043E\u0439.\r\n * option.value \u0440\u0430\u0432\u0435\u043D id (\u0435\u0441\u043B\u0438 \u0435\u0441\u0442\u044C) \u043B\u0438\u0431\u043E name; data-id = \u043E\u0440\u0438\u0433\u0438\u043D\u0430\u043B\u044C\u043D\u044B\u0439 id (\u0435\u0441\u043B\u0438 \u0435\u0441\u0442\u044C),\r\n * data-fullname = fullname, data-name = name.\r\n *\r\n * @param {HTMLElement|string|null} selectEl\r\n * @param {Object} param1\r\n * @param {string} param1.entity (\u043D\u0430\u043F\u0440\u0438\u043C\u0435\u0440, 'categories' \u0438\u043B\u0438 'brands')\r\n * @param {string} param1.productProp (\u043D\u0430\u043F\u0440\u0438\u043C\u0435\u0440, 'category' \u0438\u043B\u0438 'brand')\r\n * @param {boolean} [param1.includeAllOption=true]\r\n * @param {boolean} [param1.onlyFromProducts=false]\r\n * @param {boolean} [param1.sort=true]\r\n * @param {string} [param1.allMsgKey='ALL_CATEGORIES_OPTION']\r\n * @param {string} [param1.selected=\"\"] \u0437\u043D\u0430\u0447\u0435\u043D\u0438\u0435, \u043A\u043E\u0442\u043E\u0440\u043E\u0435 \u0434\u043E\u043B\u0436\u043D\u043E \u0431\u044B\u0442\u044C \u0432\u044B\u0431\u0440\u0430\u043D\u043E\r\n * @returns {Promise<boolean>}\r\n */\r\nasync _fillSelectGeneric(\r\n  selectEl,\r\n  {\r\n    entity = 'categories',\r\n    productProp = 'category',\r\n    includeAllOption = true,\r\n    onlyFromProducts = false,\r\n    sort = true,\r\n    allMsgKey = 'ALL_CATEGORIES_OPTION',\r\n    selected = \"\"          // <--- \u0432\u043E\u0442 \u043E\u043D\r\n  } = {}\r\n) {\r\n  if (typeof selectEl === 'string') selectEl = document.querySelector(selectEl);\r\n  if (!selectEl) return false;\r\n\r\n  const slug = (str) => String(str).toLowerCase().replace(/\\s+/g, '');\r\n  const collected = new Map();\r\n\r\n  const add = (id, name, fullname) => {\r\n    const safeName = name && name.toLowerCase() !== 'undefined' ? name : '';\r\n    const safeFullname = fullname && fullname.toLowerCase() !== 'undefined' ? fullname : '';\r\n    const human = safeFullname || safeName || id;\r\n    if (!human) return;\r\n    const key = slug(human);\r\n    const entry = collected.get(key) || { id: '', name: '', fullname: '' };\r\n    if (!entry.id && id) entry.id = id;\r\n    if (!entry.name && safeName) entry.name = safeName;\r\n    if (!entry.fullname && safeFullname) entry.fullname = safeFullname;\r\n    collected.set(key, entry);\r\n  };\r\n\r\n  // 1) fetch list unless onlyFromProducts\r\n  if (!onlyFromProducts) {\r\n    const list = await this.fetchList(entity).catch((e) => {\r\n      this._log(`fetchList(${entity}) failed`, e);\r\n      return [];\r\n    });\r\n    for (const it of list) {\r\n      if (!it) continue;\r\n      if (typeof it === 'string') {\r\n        add(it, it, it);\r\n      } else {\r\n        const id = this._normalizeId(it.id ?? it.key ?? it.name);\r\n        const name = it.name != null ? String(it.name).trim() : '';\r\n        const fullname = it.fullname != null ? String(it.fullname).trim() : '';\r\n        add(id, name, fullname);\r\n\r\n        if (entity === 'brands') {\r\n          const nm = (fullname && fullname.toLowerCase() !== 'undefined') ? fullname : name;\r\n          if (id && nm) this._brandsMap.set(id, nm);\r\n        }\r\n        if (entity === 'categories') {\r\n          const nm = (fullname && fullname.toLowerCase() !== 'undefined') ? fullname : name;\r\n          if (id && nm) this._categoriesMap.set(id, nm);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  // 2) include items from products\r\n  if (!onlyFromProducts) {\r\n    for (const p of this.products) {\r\n      const id = this._normalizeId(p[productProp]);\r\n      const name = p[`${productProp}Name`] != null ? String(p[`${productProp}Name`]).trim() : '';\r\n      const fullname = p[`${productProp}Fullname`] != null ? String(p[`${productProp}Fullname`]).trim() : '';\r\n      add(id, name, fullname);\r\n\r\n      if (entity === 'brands') {\r\n        const nm = (fullname && fullname.toLowerCase() !== 'undefined') ? fullname : name;\r\n        if (id && nm) this._brandsMap.set(id, nm);\r\n      }\r\n      if (entity === 'categories') {\r\n        const nm = (fullname && fullname.toLowerCase() !== 'undefined') ? fullname : name;\r\n        if (id && nm) this._categoriesMap.set(id, nm);\r\n      }\r\n    }\r\n  }\r\n\r\n  let rows = Array.from(collected.values());\r\n  if (sort) {\r\n    rows.sort((a, b) => String(a.fullname || a.name).localeCompare(String(b.fullname || b.name)));\r\n  }\r\n\r\n  selectEl.innerHTML = '';\r\n\r\n  if (includeAllOption) {\r\n    const opt = document.createElement('option');\r\n    opt.value = '';\r\n    opt.textContent = this._msg(allMsgKey);\r\n\r\n    // \u0435\u0441\u043B\u0438 selected === \"\" (\u043F\u043E \u0443\u043C\u043E\u043B\u0447\u0430\u043D\u0438\u044E) \u2014 \u0432\u044B\u0434\u0435\u043B\u044F\u0435\u043C \"\u0412\u0441\u0435\"\r\n    if (selected === '' || selected == null) {\r\n      opt.selected = true;\r\n    }\r\n\r\n    selectEl.appendChild(opt);\r\n  }\r\n\r\n  for (const r of rows) {\r\n    const o = document.createElement('option');\r\n    o.value = r.name; // \u0435\u0441\u043B\u0438 \u0445\u043E\u0447\u0435\u0448\u044C \u2014 \u043C\u043E\u0436\u043D\u043E \u043F\u043E\u043C\u0435\u043D\u044F\u0442\u044C \u043D\u0430 r.id\r\n    if (r.id) o.dataset.id = r.id;\r\n    if (r.fullname && r.fullname.toLowerCase() !== 'undefined') o.dataset.fullname = r.fullname;\r\n    o.dataset.name = r.name || '';\r\n    o.textContent = r.fullname || r.name || r.id;\r\n\r\n    // \u0435\u0441\u043B\u0438 \u0437\u043D\u0430\u0447\u0435\u043D\u0438\u0435 \u0441\u043E\u0432\u043F\u0430\u043B\u043E \u0441 selected \u2014 \u0441\u0442\u0430\u0432\u0438\u043C \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u044B\u043C\r\n    if (selected !== '' && String(o.value) === String(selected)) {\r\n      o.selected = true;\r\n    }\r\n\r\n    selectEl.appendChild(o);\r\n  }\r\n\r\n  return true;\r\n}\r\n\r\n\r\n  /**\r\n   * \u0417\u0430\u043F\u043E\u043B\u043D\u044F\u0435\u0442 select \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u044F\u043C\u0438\r\n   * @param {HTMLElement|string} selectEl\r\n   * @param {Object} opts\r\n   * @returns {Promise<boolean>}\r\n   */\r\n  async fillCategories(selectEl, opts = {}) {\r\n    return this._fillSelectGeneric(selectEl, Object.assign({\r\n      entity: 'categories',\r\n      productProp: 'category',\r\n      allMsgKey: 'ALL_CATEGORIES_OPTION'\r\n    }, opts));\r\n  }\r\n\r\n  /**\r\n   * \u0417\u0430\u043F\u043E\u043B\u043D\u044F\u0435\u0442 select \u0431\u0440\u0435\u043D\u0434\u0430\u043C\u0438\r\n   * @param {HTMLElement|string} selectEl\r\n   * @param {Object} opts\r\n   * @returns {Promise<boolean>}\r\n   */\r\n  async fillBrands(selectEl, opts = {}) {\r\n    return this._fillSelectGeneric(selectEl, Object.assign({\r\n      entity: 'brands',\r\n      productProp: 'brand',\r\n      allMsgKey: 'ALL_BRANDS_OPTION'\r\n    }, opts));\r\n  }\r\n\r\n  /* ---------------------- misc ---------------------- */\r\n\r\n  /**\r\n   * \u041F\u043E\u0434\u043F\u0438\u0441\u044B\u0432\u0430\u0435\u0442\u0441\u044F \u043D\u0430 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u044F. \u0412\u043E\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u0442 \u0444\u0443\u043D\u043A\u0446\u0438\u044E \u0434\u043B\u044F \u043E\u0442\u043F\u0438\u0441\u043A\u0438.\r\n   * @param {Function} fn\r\n   * @returns {Function}\r\n   */\r\n  subscribe(fn) {\r\n    if (typeof fn !== 'function') throw new TypeError(this._msg('SUBSCRIBE_ARG_ERROR'));\r\n    this._subscribers.add(fn);\r\n    return () => this._subscribers.delete(fn);\r\n  }\r\n\r\n  /**\r\n   * \u0414\u043E\u0431\u0430\u0432\u043B\u044F\u0435\u0442 \u0438\u043B\u0438 \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u0442 \u043F\u0440\u043E\u0434\u0443\u043A\u0442. \u0412\u043E\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u0442 \u043D\u043E\u0440\u043C\u0430\u043B\u0438\u0437\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u043E\u0431\u044A\u0435\u043A\u0442\r\n   * @param {any} raw\r\n   * @returns {Promise<any|null>}\r\n   */\r\n  async upsertProduct(raw) {\r\n    try {\r\n      const normalized = await this._normalizeProduct(raw);\r\n      if (!normalized || !normalized.name) return null;\r\n      const existing = this.findById(normalized.name);\r\n      if (existing) {\r\n        Object.assign(existing, normalized);\r\n        this._productMap.set(existing.name, existing);\r\n        this._setCache(this._categoriesMap, existing.category, existing.categoryName || existing.category);\r\n        this._setCache(this._brandsMap, existing.brand, existing.brandName || existing.brand);\r\n        this._notifySubscribers({ type: 'update', changedIds: [existing.name] });\r\n        return existing;\r\n      }\r\n      this.products.push(normalized);\r\n      this._productMap.set(normalized.name, normalized);\r\n      this._setCache(this._categoriesMap, normalized.category, normalized.categoryName || normalized.category);\r\n      this._setCache(this._brandsMap, normalized.brand, normalized.brandName || normalized.brand);\r\n      this._notifySubscribers({ type: 'add', changedIds: [normalized.name] });\r\n      return normalized;\r\n    } catch (err) {\r\n      this._log(this._msg('UPSERT_ERROR'), err);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \u0421\u043E\u0437\u0434\u0430\u0451\u0442 \u0438 \u0434\u0438\u0441\u043F\u0430\u0442\u0447\u0438\u0442 \u0441\u043E\u0431\u044B\u0442\u0438\u0435 storage, \u0447\u0442\u043E\u0431\u044B \u044D\u043C\u0443\u043B\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u0435 localStorage\r\n   * @param {string} key\r\n   * @param {string|null} oldValue\r\n   * @param {string|null} newValue\r\n   */\r\n  _dispatchLocalStorageEvent(key, oldValue, newValue) {\r\n    const ev = new StorageEvent('storage', { key, oldValue, newValue, url: location.href, storageArea: localStorage });\r\n    window.dispatchEvent(ev);\r\n  }\r\n\r\n  /**\r\n   * \u041E\u0447\u0438\u0449\u0430\u0435\u0442 \u043A\u0435\u0448\u0438 \u043F\u0440\u043E\u0434\u0443\u043A\u0442\u043E\u0432, \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0439 \u0438\u043B\u0438 \u0431\u0440\u0435\u043D\u0434\u043E\u0432\r\n   * @param {Object} param0\r\n   * @param {boolean} [param0.products=false]\r\n   * @param {boolean} [param0.categories=false]\r\n   * @param {boolean} [param0.brands=false]\r\n   */\r\n  clearCache({ products = false, categories = false, brands = false } = {}) {\r\n    if (products) {\r\n      this.products = [];\r\n      this._productMap.clear();\r\n    }\r\n    if (categories) this._categoriesMap.clear();\r\n    if (brands) this._brandsMap.clear();\r\n  }\r\n}", "export class StorageService {\r\n  /**\r\n   * @param {Object} shopMatic - \u0433\u043B\u0430\u0432\u043D\u044B\u0439 \u0441\u0435\u0440\u0432\u0438\u0441, \u043E\u0436\u0438\u0434\u0430\u0435\u0442\u0441\u044F \u043F\u043E\u043B\u0435 productService\r\n   * @param {Object} opts\r\n   * @param {string} [opts.storageKey]\r\n   * @param {string} [opts.favStorageKey]\r\n   * @param {string} [opts.viewedStorageKey]\r\n   * @param {number} [opts.maxViewedItems]\r\n   * @param {number} [opts.defaultConcurrency]\r\n   */\r\n  constructor(shopMatic, opts = {}) {\r\n    this.shopMatic = shopMatic;\r\n    this.storageKey = opts.storageKey ?? 'gribkov_cart_v1';\r\n    this.favStorageKey = opts.favStorageKey ?? 'gribkov_favs_v1';\r\n    this.viewedStorageKey = opts.viewedStorageKey ?? 'gribkov_viewed_v1';\r\n    this.maxViewedItems = Number(opts.maxViewedItems ?? 20);\r\n    this.defaultConcurrency = Math.max(1, Number(opts.defaultConcurrency ?? 6));\r\n  }\r\n\r\n  // -----------------------\r\n  // === Helpers / utils ===\r\n  // -----------------------\r\n\r\n  _storageAvailable() {\r\n    try {\r\n      const k = '__storage_test__';\r\n      localStorage.setItem(k, '1');\r\n      localStorage.removeItem(k);\r\n      return true;\r\n    } catch {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  _safeSetItem(key, value) {\r\n    try {\r\n      if (!this._storageAvailable()) return false;\r\n      localStorage.setItem(key, JSON.stringify(value));\r\n      return true;\r\n    } catch (e) {\r\n      console.warn(`StorageService._safeSetItem error for key=\"${key}\"`, e);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  _safeGetItem(key) {\r\n    try {\r\n      if (!this._storageAvailable()) return null;\r\n      const raw = localStorage.getItem(key);\r\n      if (!raw) return null;\r\n      const parsed = JSON.parse(raw);\r\n      return Array.isArray(parsed) ? parsed : null;\r\n    } catch (e) {\r\n      console.warn(`StorageService._safeGetItem error for key=\"${key}\"`, e);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  _normalizeCartItem(input = {}) {\r\n    return {\r\n      name: String(input.name ?? ''),\r\n      fullname: input.fullname ?? '',\r\n      price: Number(input.price ?? 0),\r\n      qty: Number(input.qty ?? 0),\r\n      picture: input.picture ?? '',\r\n      stock: Number(input.stock ?? 0),\r\n      specs: input.specs ?? {}\r\n    };\r\n  }\r\n\r\n  _normalizeFavItem(input) {\r\n    // favs can be strings or objects\r\n    if (typeof input === 'string') {\r\n      return { name: input, fullname: '', price: 0, stock: 0 };\r\n    }\r\n    return {\r\n      name: String(input.name ?? ''),\r\n      fullname: input.fullname ?? '',\r\n      price: Number(input.price ?? 0),\r\n      stock: Number(input.stock ?? 0)\r\n    };\r\n  }\r\n\r\n  _getKeyFromItem(it) {\r\n    if (!it) return '';\r\n    if (typeof it === 'string') return String(it).trim();\r\n    return String(it.name ?? it.id ?? it.productId ?? it._missingId ?? '').trim();\r\n  }\r\n\r\n  /**\r\n   * Batch-process generic items: fetch product data by key and augment items with\r\n   * { available, missing, stock, fullname?, price? }.\r\n   *\r\n   * @param {Array} items - \u043C\u0430\u0441\u0441\u0438\u0432 \u043D\u043E\u0440\u043C\u0430\u043B\u0438\u0437\u043E\u0432\u0430\u043D\u043D\u044B\u0445 \u043E\u0431\u044A\u0435\u043A\u0442\u043E\u0432 (\u043D\u043E \u043C\u043E\u0436\u0435\u0442 \u0431\u044B\u0442\u044C \u0438 \u0441\u0442\u0440\u043E\u043A\u0430\u043C\u0438)\r\n   * @param {Object} options - { concurrency }\r\n   * @param {Function} onMissingCallback - optional (key) => void\r\n   */\r\n  async _loadWithAvailability(items, options = {}, onMissingCallback) {\r\n    try {\r\n      if (!Array.isArray(items) || items.length === 0) return items || [];\r\n\r\n      const ps = this.shopMatic?.productService;\r\n      const concurrency = Math.max(1, Number(options.concurrency ?? this.defaultConcurrency));\r\n\r\n      // if no productService \u2014 just mark availability from item.stock\r\n      if (!ps || typeof ps.fetchById !== 'function') {\r\n        return items.map((item) => {\r\n          const key = this._getKeyFromItem(item);\r\n          const stock = Number((item && item.stock) ?? 0);\r\n          return Object.assign({}, (typeof item === 'string' ? { name: item } : item), {\r\n            available: stock > 0,\r\n            missing: !key,\r\n            stock\r\n          });\r\n        });\r\n      }\r\n\r\n      const results = [];\r\n      for (let i = 0; i < items.length; i += concurrency) {\r\n        const batch = items.slice(i, i + concurrency);\r\n        const promises = batch.map(async (rawItem) => {\r\n          const out = Object.assign({}, (typeof rawItem === 'string' ? { name: rawItem } : rawItem));\r\n          const key = this._getKeyFromItem(rawItem);\r\n\r\n          if (!key) {\r\n            out.available = false;\r\n            out.missing = true;\r\n            out.stock = 0;\r\n            return out;\r\n          }\r\n\r\n          try {\r\n            const product = await ps.fetchById(key);\r\n\r\n            if (!product) {\r\n              // product not found \u2014 allow callback to handle (e.g. remove favorite)\r\n              console.warn(`StorageService: no product response for id=\"${key}\"`);\r\n              if (typeof onMissingCallback === 'function') {\r\n                try { onMissingCallback(key); } catch (e) { /* swallow */ }\r\n              }\r\n              out.available = false;\r\n              out.missing = true;\r\n              out.stock = 0;\r\n              return out;\r\n            }\r\n\r\n            const prodStock = Number(product.stock ?? product._stock ?? product.count ?? product.qty ?? 0);\r\n            out.stock = Number(out.stock || prodStock || 0);\r\n            out.available = prodStock > 0;\r\n            out.missing = false;\r\n\r\n            if (!out.fullname && (product.fullname || product.title || product.name)) {\r\n              out.fullname = product.fullname ?? product.title ?? product.name;\r\n            }\r\n            if ((!out.price || out.price === 0) && (product.price != null)) {\r\n              out.price = Number(product.price);\r\n            }\r\n            return out;\r\n          } catch (e) {\r\n            console.warn(`StorageService: fetchById failed for id=\"${key}\"`, e);\r\n            out.available = false;\r\n            out.missing = true;\r\n            out.stock = 0;\r\n            return out;\r\n          }\r\n        });\r\n\r\n        // use allSettled to be resilient against single-promise rejections\r\n        const settled = await Promise.allSettled(promises);\r\n        for (const s of settled) {\r\n          if (s.status === 'fulfilled') results.push(s.value);\r\n          else {\r\n            // if something unexpectedly rejected \u2014 push a safe fallback\r\n            results.push({ available: false, missing: true, stock: 0 });\r\n          }\r\n        }\r\n      }\r\n\r\n      return results;\r\n    } catch (e) {\r\n      console.warn('StorageService._loadWithAvailability error', e);\r\n      return items || [];\r\n    }\r\n  }\r\n\r\n  // -----------------------\r\n  // === Cart methods ===\r\n  // -----------------------\r\n\r\n  /**\r\n   * \u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u0442 \u043A\u043E\u0440\u0437\u0438\u043D\u0443 (\u043C\u0430\u0441\u0441\u0438\u0432 \u043E\u0431\u044A\u0435\u043A\u0442\u043E\u0432) \u0432 localStorage \u0432 \u043D\u043E\u0440\u043C\u0430\u043B\u0438\u0437\u043E\u0432\u0430\u043D\u043D\u043E\u043C \u0432\u0438\u0434\u0435.\r\n   * @param {Array} cartArr\r\n   * @returns {boolean} \u0443\u0441\u043F\u0435\u0445\r\n   */\r\n  saveCart(cartArr) {\r\n    try {\r\n      const normalized = (Array.isArray(cartArr) ? cartArr : []).map(i => this._normalizeCartItem(i));\r\n      return this._safeSetItem(this.storageKey, normalized);\r\n    } catch (e) {\r\n      console.warn('StorageService.saveCart error', e);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u0442 \u043A\u043E\u0440\u0437\u0438\u043D\u0443 (\u0435\u0441\u043B\u0438 \u0435\u0441\u0442\u044C) \u0438\u043B\u0438 null.\r\n   * @returns {Array|null}\r\n   */\r\n  loadCart() {\r\n    return this._safeGetItem(this.storageKey);\r\n  }\r\n\r\n  /**\r\n   * \u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u0442 \u043A\u043E\u0440\u0437\u0438\u043D\u0443 \u0438 \u0430\u0441\u0438\u043D\u0445\u0440\u043E\u043D\u043D\u043E \u0434\u043E\u043F\u043E\u043B\u043D\u044F\u0435\u0442 \u0434\u0430\u043D\u043D\u044B\u043C\u0438 \u043D\u0430\u043B\u0438\u0447\u0438\u044F \u0447\u0435\u0440\u0435\u0437 productService.fetchById\r\n   * @param {Object} options { concurrency }\r\n   * @returns {Promise<Array>}\r\n   */\r\n  async loadCartWithAvailability(options = {}) {\r\n    const rawCart = this.loadCart();\r\n    if (!Array.isArray(rawCart) || rawCart.length === 0) return rawCart || [];\r\n    return this._loadWithAvailability(rawCart, options);\r\n  }\r\n\r\n  // -----------------------\r\n  // === Favorites methods ===\r\n  // -----------------------\r\n\r\n  /**\r\n   * \u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u0442 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435 \u2014 \u043F\u0440\u0438\u043D\u0438\u043C\u0430\u0435\u0442 Set/Array/Iterable.\r\n   * @param {Iterable} setLike\r\n   * @returns {boolean}\r\n   */\r\n  saveFavs(setLike) {\r\n    try {\r\n      const arr = Array.from(setLike ?? []);\r\n      return this._safeSetItem(this.favStorageKey, arr);\r\n    } catch (e) {\r\n      console.warn('StorageService.saveFavs error', e);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  loadFavs() {\r\n    return this._safeGetItem(this.favStorageKey);\r\n  }\r\n\r\n  /**\r\n   * \u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u0442 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435 \u0438 \u043F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u0442 \u043D\u0430\u043B\u0438\u0447\u0438\u0435 \u0432 \u043A\u0430\u0442\u0430\u043B\u043E\u0433\u0435 \u0430\u043D\u0430\u043B\u043E\u0433\u0438\u0447\u043D\u043E \u043A\u043E\u0440\u0437\u0438\u043D\u0435.\r\n   * \u041F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442 \u044D\u043B\u0435\u043C\u0435\u043D\u0442\u044B \u0432\u0438\u0434\u0430 string \u0438\u043B\u0438 object.\r\n   * @param {Object} options { concurrency }\r\n   */\r\n  async loadFavsWithAvailability(options = {}) {\r\n    const rawFavs = this.loadFavs();\r\n    if (!Array.isArray(rawFavs) || rawFavs.length === 0) return rawFavs || [];\r\n\r\n    // \u041F\u043E\u0434\u0433\u043E\u0442\u043E\u0432\u0438\u043C \u043D\u043E\u0440\u043C\u0430\u043B\u0438\u0437\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u043C\u0430\u0441\u0441\u0438\u0432, \u0441\u043E\u0445\u0440\u0430\u043D\u044F\u044F \u0438\u0441\u0445\u043E\u0434\u043D\u044B\u0439 \u043F\u0440\u0435\u0434\u043C\u0435\u0442 (\u0441\u0442\u0440\u043E\u043A\u0430 \u0438\u043B\u0438 \u043E\u0431\u044A\u0435\u043A\u0442)\r\n    const normalized = rawFavs.map(item => (typeof item === 'string' ? item : this._normalizeFavItem(item)));\r\n\r\n    // \u0415\u0441\u043B\u0438 productService \u0443\u043C\u0435\u0435\u0442 \u0443\u0434\u0430\u043B\u044F\u0442\u044C \u043E\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u044E\u0449\u0438\u0435 favorites, \u043F\u0435\u0440\u0435\u0434\u0430\u0434\u0438\u043C callback\r\n    const onMissing = (key) => {\r\n      try {\r\n        const ps = this.shopMatic?.productService;\r\n        if (ps && typeof ps.removeFavoriteById === 'function') {\r\n          ps.removeFavoriteById(key);\r\n        }\r\n      } catch (e) {\r\n        // \u043D\u0435 \u0444\u0435\u0439\u043B\u0438\u043C \u043E\u0441\u043D\u043E\u0432\u043D\u0443\u044E \u043E\u043F\u0435\u0440\u0430\u0446\u0438\u044E\r\n        console.warn('StorageService: onMissing callback failed for', key, e);\r\n      }\r\n    };\r\n\r\n    return this._loadWithAvailability(normalized, options, onMissing);\r\n  }\r\n\r\n  // -----------------------\r\n  // === Viewed items ===\r\n  // -----------------------\r\n\r\n  /**\r\n   * \u0414\u043E\u0431\u0430\u0432\u043B\u044F\u0435\u0442 \u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440\u0435\u043D\u043D\u044B\u0439 \u0442\u043E\u0432\u0430\u0440 (\u043D\u043E\u0440\u043C\u0430\u043B\u0438\u0437\u0443\u0435\u0442, \u0443\u0431\u0438\u0440\u0430\u0435\u0442 \u0434\u0443\u0431\u043B\u0438\u043A\u0430\u0442\u044B, \u043E\u0433\u0440\u0430\u043D\u0438\u0447\u0438\u0432\u0430\u0435\u0442 \u0434\u043B\u0438\u043D\u0443).\r\n   * @param {Object} product\r\n   */\r\n  addViewed(product) {\r\n    try {\r\n      if (!product || !product.name) return;\r\n      const item = {\r\n        name: String(product.name ?? ''),\r\n        fullname: product.fullname ?? '',\r\n        price: Number(product.price ?? 0),\r\n        picture: product.picture ?? '',\r\n        stock: Number(product.stock ?? 0),\r\n        viewedAt: Date.now()\r\n      };\r\n\r\n      const viewed = this.loadViewed() ?? [];\r\n      const filtered = viewed.filter(p => p.name !== item.name);\r\n      filtered.unshift(item);\r\n      const limited = filtered.slice(0, this.maxViewedItems);\r\n\r\n      this._safeSetItem(this.viewedStorageKey, limited);\r\n\t  this.shopMatic.viewedModule.sync();\r\n    } catch (e) {\r\n      console.warn('StorageService.addViewed error', e);\r\n    }\r\n  }\r\n\r\n  loadViewed() {\r\n    return this._safeGetItem(this.viewedStorageKey);\r\n  }\r\n\r\n  clearViewed() {\r\n    try {\r\n      if (!this._storageAvailable()) return;\r\n      localStorage.removeItem(this.viewedStorageKey);\r\n\t  this.shopMatic.viewedModule.sync();\r\n    } catch (e) {\r\n      console.warn('StorageService.clearViewed error', e);\r\n    }\r\n  }\r\n}\r\n", "/*\r\n * shopmatic/NotificationsOptimized.js\r\n *\r\n * Optimized notifications manager for ShopMatic with CyberLife style and\r\n * built-in progress bar. This version extends the existing Notifications\r\n * manager by adding a loading bar that shrinks over the notification\r\n * lifetime, integrates pause/resume behaviour with the timer, and\r\n * supports a modern CyberLife aesthetic via external CSS (see\r\n * notifications_detroit.css).\r\n *\r\n * Author: Calista Verner (modifications by optimization)\r\n * Version: 1.4.0\r\n * Date: 2025-10-24\r\n * License: MIT\r\n */\r\n\r\nexport class Notifications {\r\n  static UI_MESSAGES = Object.freeze({\r\n    CLOSE_BUTTON_LABEL: '\u0417\u0430\u043A\u0440\u044B\u0442\u044C \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u0435',\r\n    REASON_TIMEOUT: 'timeout',\r\n    REASON_MANUAL: 'manual',\r\n    REASON_KEYBOARD: 'keyboard',\r\n    REASON_CLEARED: 'cleared',\r\n    REASON_EVICTED: 'evicted'\r\n  });\r\n\r\n  _msg(key, vars = {}) {\r\n    const pool = (this.constructor && this.constructor.UI_MESSAGES) || {};\r\n    let tpl = pool[key] ?? '';\r\n    return String(tpl).replace(/\\{([^}]+)\\}/g, (m, k) =>\r\n      Object.prototype.hasOwnProperty.call(vars, k) ? String(vars[k]) : m\r\n    );\r\n  }\r\n\r\n  constructor(opts = {}) {\r\n    // Default settings extended with progress bar option\r\n    this.opts = Object.assign({\r\n      duration: 3000,\r\n      position: { right: 20, bottom: 20 },\r\n      maxVisible: 5,\r\n      pauseOnHover: true,\r\n      dismissible: true,\r\n      allowHtml: false,\r\n      containerClass: 'shop-notifications',\r\n      notificationClass: 'shop-notification',\r\n      ariaLive: 'polite',\r\n      showProgressBar: true // display loading bar by default\r\n    }, opts);\r\n\r\n    this._container = null;\r\n    this._idCounter = 1;\r\n    this._timers = new Map();\r\n    this._resolvers = new Map();\r\n  }\r\n\r\n  show(message, opts = {}) {\r\n    if (!message && message !== 0) return null;\r\n    const cfg = Object.assign({}, this.opts, opts);\r\n    const id = `notif_${this._idCounter++}`;\r\n    const container = this._ensureContainer(cfg);\r\n    this._enforceMaxVisible(container, cfg.maxVisible);\r\n\r\n    const note = document.createElement('div');\r\n    note.className = `${cfg.notificationClass} ${cfg.notificationClass}--${cfg.type || 'info'}`.trim();\r\n    note.setAttribute('data-notification-id', id);\r\n    note.tabIndex = 0;\r\n    note.style.pointerEvents = 'auto';\r\n    note.setAttribute('role', (cfg.type === 'error' || cfg.ariaLive === 'assertive') ? 'alert' : 'status');\r\n    note.setAttribute('aria-live', opts.ariaLive ?? cfg.ariaLive);\r\n    note.setAttribute('aria-atomic', 'true');\r\n\r\n    // Icon mapping\r\n    const ICONS = {\r\n      success: 'fa-solid fa-check',\r\n      warning: 'fa-solid fa-triangle-exclamation',\r\n      error: 'fa-solid fa-hexagon-exclamation',\r\n      info: 'fa-solid fa-info'\r\n    };\r\n    const typeKey = (cfg.type && String(cfg.type)) ? String(cfg.type) : 'info';\r\n    const iconClass = ICONS[typeKey] || ICONS.info;\r\n\r\n    // Create icon element\r\n    const iconEl = document.createElement('i');\r\n    iconEl.className = `${iconClass} ${cfg.notificationClass}__icon notif-icon notif-icon--${typeKey}`;\r\n    iconEl.setAttribute('aria-hidden', 'true');\r\n\r\n    // Content element\r\n    const content = document.createElement('div');\r\n    content.className = `${cfg.notificationClass}__content`;\r\n    if (message instanceof Node) {\r\n      content.appendChild(message);\r\n    } else {\r\n      if (cfg.allowHtml || opts.allowHtml) {\r\n        content.innerHTML = String(message);\r\n      } else {\r\n        content.textContent = String(message);\r\n      }\r\n    }\r\n\r\n    note.appendChild(iconEl);\r\n    note.appendChild(content);\r\n\r\n    // Dismiss button if enabled\r\n    if (cfg.dismissible) {\r\n      const btn = document.createElement('button');\r\n      btn.type = 'button';\r\n      btn.className = `${cfg.notificationClass}__close`;\r\n      btn.setAttribute('aria-label', this._msg('CLOSE_BUTTON_LABEL'));\r\n      btn.innerHTML = '&times;';\r\n      btn.addEventListener('click', (e) => { e.stopPropagation(); dismiss(); });\r\n      note.appendChild(btn);\r\n    }\r\n\r\n    // Progress bar element (insert before close button so it sits at bottom)\r\n    let progress = null;\r\n    let parentWidth = 0;\r\n    if (cfg.showProgressBar) {\r\n      progress = document.createElement('div');\r\n      progress.className = `${cfg.notificationClass}__progress`;\r\n      note.appendChild(progress);\r\n    }\r\n\r\n    // Timer management\r\n    let remainingDuration = Number(cfg.duration) || 0;\r\n    let startTs = Date.now();\r\n    let timeoutId = null;\r\n\r\n    const clearTimer = () => {\r\n      if (timeoutId) {\r\n        clearTimeout(timeoutId);\r\n        timeoutId = null;\r\n      }\r\n      if (this._timers.has(id)) this._timers.delete(id);\r\n    };\r\n    const startTimer = (dur) => {\r\n      clearTimer();\r\n      if (dur <= 0) return;\r\n      startTs = Date.now();\r\n      timeoutId = setTimeout(() => performRemove(this.constructor.UI_MESSAGES.REASON_TIMEOUT), dur);\r\n      this._timers.set(id, timeoutId);\r\n    };\r\n    const pauseTimer = () => {\r\n      if (!cfg.pauseOnHover) return;\r\n      if (!timeoutId) return;\r\n      const elapsed = Date.now() - startTs;\r\n      remainingDuration = Math.max(0, remainingDuration - elapsed);\r\n      clearTimer();\r\n      // Pause progress bar by freezing current width\r\n      if (progress) {\r\n        const parent = progress.parentNode;\r\n        if (parent) parentWidth = parent.clientWidth;\r\n        const currentWidth = progress.getBoundingClientRect().width;\r\n        const pct = parentWidth ? (currentWidth / parentWidth) * 100 : 0;\r\n        progress.style.transition = 'none';\r\n        progress.style.width = `${pct}%`;\r\n      }\r\n    };\r\n    const resumeTimer = () => {\r\n      if (!cfg.pauseOnHover) return;\r\n      // Resume timer with remaining duration\r\n      startTimer(remainingDuration);\r\n      // Resume progress bar transition\r\n      if (progress) {\r\n        // Ensure parent width is up to date\r\n        const parent = progress.parentNode;\r\n        parentWidth = parent ? parent.clientWidth : parentWidth;\r\n        // Set transition for remaining time and animate to 0\r\n        progress.style.transition = `width ${remainingDuration}ms linear`;\r\n        progress.style.width = '0%';\r\n      }\r\n    };\r\n\r\n    note.classList.add('is-entering');\r\n    container.appendChild(note);\r\n    // Trigger CSS enter transition\r\n    requestAnimationFrame(() => {\r\n      note.classList.remove('is-entering');\r\n      note.classList.add('is-visible');\r\n      // Start progress bar animation on next tick\r\n      if (progress) {\r\n        // Get parent width now\r\n        parentWidth = progress.parentNode ? progress.parentNode.clientWidth : 0;\r\n        progress.style.transition = 'none';\r\n        progress.style.width = '100%';\r\n        // Start shrinking after a frame\r\n        requestAnimationFrame(() => {\r\n          progress.style.transition = `width ${remainingDuration}ms linear`;\r\n          progress.style.width = '0%';\r\n        });\r\n      }\r\n    });\r\n\r\n    const performRemove = (reason = this.constructor.UI_MESSAGES.REASON_MANUAL) => {\r\n      if (!note.parentNode) return resolveAndCleanup(reason);\r\n      note.classList.remove('is-visible');\r\n      note.classList.add('is-leaving');\r\n      clearTimer();\r\n      setTimeout(() => {\r\n        if (note && note.parentNode) note.parentNode.removeChild(note);\r\n        resolveAndCleanup(reason);\r\n      }, 320);\r\n    };\r\n\r\n    const resolveAndCleanup = (reason = this.constructor.UI_MESSAGES.REASON_MANUAL) => {\r\n      const resolver = this._resolvers.get(id);\r\n      if (resolver) {\r\n        try { resolver({ id, reason }); } catch (e) {}\r\n      }\r\n      this._resolvers.delete(id);\r\n      const t = this._timers.get(id);\r\n      if (t) { clearTimeout(t); this._timers.delete(id); }\r\n      if (typeof cfg.onClose === 'function') {\r\n        try { cfg.onClose({ id, reason }); } catch (e) {}\r\n      }\r\n    };\r\n\r\n    const promise = new Promise((resolve) => { this._resolvers.set(id, resolve); });\r\n    const dismiss = (reason = this.constructor.UI_MESSAGES.REASON_MANUAL) => performRemove(reason);\r\n\r\n    // Hover events for pause/resume\r\n    if (cfg.pauseOnHover) {\r\n      note.addEventListener('mouseenter', pauseTimer);\r\n      note.addEventListener('mouseleave', resumeTimer);\r\n    }\r\n    // Keyboard dismiss\r\n    note.addEventListener('keydown', (ev) => {\r\n      if (ev.key === 'Escape' || ev.key === 'Esc') {\r\n        ev.preventDefault();\r\n        dismiss(this.constructor.UI_MESSAGES.REASON_KEYBOARD);\r\n      }\r\n    });\r\n\r\n    // Start the timer\r\n    remainingDuration = Number(cfg.duration) || 0;\r\n    if (remainingDuration > 0) startTimer(remainingDuration);\r\n\r\n    return { id, dismiss, promise };\r\n  }\r\n\r\n  clearAll() {\r\n    if (!this._container) return;\r\n    const notes = Array.from(this._container.querySelectorAll(`.${this.opts.notificationClass}`));\r\n    notes.forEach(n => {\r\n      const id = n.getAttribute('data-notification-id');\r\n      n.classList.remove('is-visible');\r\n      n.classList.add('is-leaving');\r\n      setTimeout(() => { if (n.parentNode) n.parentNode.removeChild(n); }, 320);\r\n      const resolver = this._resolvers.get(id);\r\n      if (resolver) {\r\n        try { resolver({ id, reason: this.constructor.UI_MESSAGES.REASON_CLEARED }); } catch (e) {}\r\n        this._resolvers.delete(id);\r\n      }\r\n      const t = this._timers.get(id);\r\n      if (t) { clearTimeout(t); this._timers.delete(id); }\r\n    });\r\n  }\r\n\r\n  _ensureContainer(cfg = {}) {\r\n    if (this._container) return this._container;\r\n    const cont = document.createElement('div');\r\n    cont.className = cfg.containerClass || this.opts.containerClass;\r\n    document.body.appendChild(cont);\r\n    this._container = cont;\r\n    return cont;\r\n  }\r\n\r\n  _enforceMaxVisible(container, max) {\r\n    try {\r\n      const nodes = container.querySelectorAll(`.${this.opts.notificationClass}`);\r\n      const overflow = nodes.length - (max - 1);\r\n      if (overflow > 0) {\r\n        const toRemove = Array.from(nodes).slice(0, overflow);\r\n        toRemove.forEach(n => {\r\n          const id = n.getAttribute('data-notification-id');\r\n          n.classList.remove('is-visible');\r\n          n.classList.add('is-leaving');\r\n          setTimeout(() => { if (n.parentNode) n.parentNode.removeChild(n); }, 320);\r\n          const resolver = this._resolvers.get(id);\r\n          if (resolver) { try { resolver({ id, reason: this.constructor.UI_MESSAGES.REASON_EVICTED }); } catch (e) {} }\r\n          this._resolvers.delete(id);\r\n        });\r\n      }\r\n    } catch (e) { /* ignore */ }\r\n  }\r\n}", "import { escapeHtml as _escapeHtml, makeSpecHtmlPreview, formatPrice, computeDiscountPercent } from './utils.js';\r\n\r\n/**\r\n * Renderer\r\n * \u0423\u043B\u0443\u0447\u0448\u0435\u043D\u043D\u0430\u044F \u0432\u0435\u0440\u0441\u0438\u044F \u0440\u0435\u043D\u0434\u0435\u0440\u0430 \u043A\u0430\u0440\u0442\u043E\u0447\u0435\u043A/\u043A\u043E\u0440\u0437\u0438\u043D\u044B/\u043C\u0438\u043D\u0438-\u043A\u0430\u0440\u0442\u043E\u0447\u0435\u043A\r\n * @author Calista Verner\r\n *\r\n * \u0414\u0430\u043D\u043D\u043E\u0435 \u043F\u0435\u0440\u0435\u043E\u0441\u043C\u044B\u0441\u043B\u0435\u043D\u0438\u0435 \u043D\u0430\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u043E \u043D\u0430 \u0443\u043B\u0443\u0447\u0448\u0435\u043D\u0438\u0435 \u041E\u041E\u041F-\u043E\u0440\u0433\u0430\u043D\u0438\u0437\u0430\u0446\u0438\u0438 \u043A\u043E\u0434\u0430,\r\n * \u043E\u043F\u0442\u0438\u043C\u0438\u0437\u0430\u0446\u0438\u044E \u043F\u0440\u043E\u0446\u0435\u0441\u0441\u043E\u0432 \u043F\u043E\u0441\u0442\u0440\u043E\u0435\u043D\u0438\u044F DOM \u0438 \u0443\u043C\u0435\u043D\u044C\u0448\u0435\u043D\u0438\u0435 \u043F\u043E\u0432\u0442\u043E\u0440\u044F\u044E\u0449\u0438\u0445\u0441\u044F\r\n * \u0443\u0447\u0430\u0441\u0442\u043A\u043E\u0432 \u043B\u043E\u0433\u0438\u043A\u0438. \u0412 \u0447\u0430\u0441\u0442\u043D\u043E\u0441\u0442\u0438, \u0432\u0432\u0435\u0434\u0435\u043D\u044B \u0432\u0441\u043F\u043E\u043C\u043E\u0433\u0430\u0442\u0435\u043B\u044C\u043D\u044B\u0435 \u043C\u0435\u0442\u043E\u0434\u044B \u0434\u043B\u044F\r\n * \u043F\u043E\u0434\u0433\u043E\u0442\u043E\u0432\u043A\u0438 \u0434\u0430\u043D\u043D\u044B\u0445, \u0444\u043E\u0440\u043C\u0430\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F \u0446\u0435\u043D, \u043F\u043E\u0441\u0442\u0440\u043E\u0435\u043D\u0438\u044F fallback-\u0440\u0430\u0437\u043C\u0435\u0442\u043A\u0438\r\n * \u0438 \u043D\u043E\u0440\u043C\u0430\u043B\u0438\u0437\u0430\u0446\u0438\u0438 \u0432\u0445\u043E\u0434\u043D\u044B\u0445 \u0434\u0430\u043D\u043D\u044B\u0445. \u0411\u043B\u0430\u0433\u043E\u0434\u0430\u0440\u044F \u044D\u0442\u043E\u043C\u0443 \u043E\u0441\u043D\u043E\u0432\u043D\u044B\u0435 \u043C\u0435\u0442\u043E\u0434\u044B\r\n * \u0441\u0442\u0430\u043D\u043E\u0432\u044F\u0442\u0441\u044F \u0431\u043E\u043B\u0435\u0435 \u043A\u043E\u043C\u043F\u0430\u043A\u0442\u043D\u044B\u043C\u0438, \u043B\u0435\u0433\u043A\u043E \u0447\u0438\u0442\u0430\u0435\u043C\u044B\u043C\u0438 \u0438 \u0440\u0430\u0441\u0448\u0438\u0440\u044F\u0435\u043C\u044B\u043C\u0438.\r\n */\r\nexport class Renderer {\r\n  /**\r\n   * @param {Object} options\r\n   * @param {Object|null} options.foxEngine\r\n   * @param {Object|null} options.productService\r\n   * @param {Object|null} options.favorites\r\n   */\r\n  constructor({ foxEngine = null, productService = null, favorites = null } = {}) {\r\n    this.foxEngine = foxEngine;\r\n    this.productService = productService;\r\n    this.favorites = favorites;\r\n  }\r\n\r\n  // -----------------------\r\n  // Helpers\r\n  // -----------------------\r\n\r\n  /**\r\n   * \u0411\u0435\u0437\u043E\u043F\u0430\u0441\u043D\u044B\u0439 JSON.parse \u0441 fallback'\u043E\u043C\r\n   * @param {string|any} value\r\n   * @param {any} fallback\r\n   * @returns {any}\r\n   */\r\n  safeParseJSON(value, fallback = []) {\r\n    if (value == null) return fallback;\r\n    if (typeof value !== 'string') return value;\r\n    try {\r\n      const parsed = JSON.parse(value);\r\n      return parsed === null ? fallback : parsed;\r\n    } catch (_) {\r\n      return fallback;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \u041D\u043E\u0440\u043C\u0430\u043B\u0438\u0437\u043E\u0432\u0430\u043D\u043D\u043E\u0435 \u043F\u0440\u0435\u0434\u0441\u0442\u0430\u0432\u043B\u0435\u043D\u0438\u0435 \u0441\u043F\u0438\u0441\u043A\u0430 \u043A\u0430\u0440\u0442\u0438\u043D\u043E\u043A.\r\n   * \u041F\u0440\u0438\u043D\u0438\u043C\u0430\u0435\u0442 \u0441\u0442\u0440\u043E\u043A\u0443 \u0438\u043B\u0438 \u043C\u0430\u0441\u0441\u0438\u0432 \u0438 \u0432\u043E\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u0442 \u043C\u0430\u0441\u0441\u0438\u0432 \u0441\u0442\u0440\u043E\u043A.\r\n   * @param {string|Array} picture\r\n   * @returns {Array<string>}\r\n   */\r\n  _getImageArray(picture) {\r\n    const arr = this.safeParseJSON(picture, []);\r\n    return Array.isArray(arr) ? arr.map(String) : [];\r\n  }\r\n\r\n  /**\r\n   * \u0412\u043E\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u0442 \u043F\u0435\u0440\u0432\u0443\u044E \u043A\u0430\u0440\u0442\u0438\u043D\u043A\u0443 \u0438\u0437 \u043F\u043E\u043B\u044F picture \u0438\u043B\u0438 \u0434\u0435\u0444\u043E\u043B\u0442\r\n   * @param {string|Array} picture\r\n   * @returns {string}\r\n   */\r\n  getFirstImage(picture) {\r\n    const arr = this._getImageArray(picture);\r\n    return Array.isArray(arr) && arr.length ? String(arr[0]) : '/assets/no-image.png';\r\n  }\r\n\r\n  /**\r\n   * \u0423\u043D\u0438\u0444\u0438\u0446\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u043E\u0435 \u0444\u043E\u0440\u043C\u0430\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u0446\u0435\u043D\u044B. \u041F\u044B\u0442\u0430\u0435\u0442\u0441\u044F \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u044C\r\n   * \u0433\u043B\u043E\u0431\u0430\u043B\u044C\u043D\u0443\u044E \u0444\u0443\u043D\u043A\u0446\u0438\u044E formatPrice, \u0435\u0441\u043B\u0438 \u043E\u043D\u0430 \u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430, \u0438\u043D\u0430\u0447\u0435\r\n   * \u043F\u043E\u0434\u0441\u0442\u0430\u0432\u043B\u044F\u0435\u0442 \u043B\u043E\u043A\u0430\u043B\u0438\u0437\u043E\u0432\u0430\u043D\u043D\u043E\u0435 \u0437\u043D\u0430\u0447\u0435\u043D\u0438\u0435. \u041D\u0430 \u0441\u043B\u0443\u0447\u0430\u0439 \u043B\u044E\u0431\u043E\u0439 \u043E\u0448\u0438\u0431\u043A\u0438\r\n   * \u0432\u043E\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u0442 \u0438\u0441\u0445\u043E\u0434\u043D\u043E\u0435 \u0437\u043D\u0430\u0447\u0435\u043D\u0438\u0435 \u0432 \u0441\u0442\u0440\u043E\u043A\u043E\u0432\u043E\u043C \u0432\u0438\u0434\u0435.\r\n   *\r\n   * @param {number|string|null} value\r\n   * @returns {string}\r\n   */\r\n  _formatPrice(value) {\r\n    try {\r\n      if (typeof formatPrice === 'function') return formatPrice(value ?? 0);\r\n      const num = Number(value ?? 0);\r\n      return Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB' }).format(num);\r\n    } catch (_) {\r\n      return String(value ?? '');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \u0411\u0435\u0437\u043E\u043F\u0430\u0441\u043D\u043E\u0435 \u044D\u043A\u0440\u0430\u043D\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u0434\u043B\u044F \u0441\u0435\u043B\u0435\u043A\u0442\u043E\u0440\u0430 (fallback \u0435\u0441\u043B\u0438 CSS.escape \u043E\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442)\r\n   * @param {string} val\r\n   * @returns {string}\r\n   */\r\n  escapeForAttribute(val) {\r\n    try {\r\n      if (typeof CSS !== 'undefined' && typeof CSS.escape === 'function') return CSS.escape(String(val));\r\n    } catch (_) { /* ignore */ }\r\n    return String(val).replace(/\"/g, '\\\\\"');\r\n  }\r\n\r\n  /**\r\n   * \u041B\u043E\u0433\u0433\u0435\u0440, \u043F\u0430\u0434\u0430\u0435\u0442 \u0431\u0435\u0437\u043E\u043F\u0430\u0441\u043D\u043E \u0435\u0441\u043B\u0438 foxEngine \u043E\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442\r\n   * @param {string} msg\r\n   * @param {string} level\r\n   */\r\n  _log(msg, level = 'INFO') {\r\n    try { this.foxEngine?.log?.(`Renderer: ${msg}`, level); } catch (_) { /* noop */ }\r\n  }\r\n\r\n  // -----------------------\r\n  // Template rendering\r\n  // -----------------------\r\n\r\n  /**\r\n   * \u0423\u043D\u0438\u0444\u0438\u0446\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0440\u0435\u043D\u0434\u0435\u0440 via foxEngine template cache.\r\n   * \u0415\u0441\u043B\u0438 \u0448\u0430\u0431\u043B\u043E\u043D \u043E\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442 \u0438\u043B\u0438 \u0440\u0435\u043D\u0434\u0435\u0440 \u043F\u0430\u0434\u0430\u0435\u0442 \u2014 \u0432\u043E\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u0442 \u043F\u0443\u0441\u0442\u0443\u044E \u0441\u0442\u0440\u043E\u043A\u0443.\r\n   * @param {string} tplName\r\n   * @param {Object} data\r\n   * @returns {Promise<string>}\r\n   */\r\n  async renderTemplate(tplName, data = {}) {\r\n    if (!this.foxEngine || !this.foxEngine.templateCache) return '';\r\n    const tpl = this.foxEngine.templateCache[tplName];\r\n    if (!tpl) return '';\r\n    try {\r\n      // replaceTextInTemplate \u043C\u043E\u0436\u0435\u0442 \u0431\u044B\u0442\u044C \u0430\u0441\u0438\u043D\u0445\u0440\u043E\u043D\u043D\u044B\u043C\r\n      return await this.foxEngine.replaceTextInTemplate(tpl, data);\r\n    } catch (e) {\r\n      try { this.foxEngine?.log?.(`Renderer.renderTemplate ${tplName} error: ${e}`, 'ERROR'); } catch (_) {}\r\n      return '';\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \u0421\u043E\u0437\u0434\u0430\u0451\u0442 \u044D\u043B\u0435\u043C\u0435\u043D\u0442 DOM \u0438\u0437 HTML \u0441\u0442\u0440\u043E\u043A\u0438 (\u0432\u043E\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u0442 \u043F\u0435\u0440\u0432\u044B\u0439 \u044D\u043B\u0435\u043C\u0435\u043D\u0442)\r\n   * @param {string} html\r\n   * @returns {Element}\r\n   */\r\n  createElementFromHTML(html = '') {\r\n    const wrapper = document.createElement('div');\r\n    wrapper.innerHTML = String(html).trim();\r\n    return wrapper.firstElementChild || wrapper;\r\n  }\r\n\r\n  // -----------------------\r\n  // Data normalization\r\n  // -----------------------\r\n\r\n  /**\r\n   * \u041D\u043E\u0440\u043C\u0430\u043B\u0438\u0437\u0443\u0435\u0442 \u0434\u0430\u043D\u043D\u044B\u0435 \u043F\u0440\u043E\u0434\u0443\u043A\u0442\u0430 \u0432 \u0435\u0434\u0438\u043D\u044B\u0439 \u043E\u0431\u044A\u0435\u043A\u0442 \u0434\u043B\u044F \u0448\u0430\u0431\u043B\u043E\u043D\u0430 \u0432\u0435\u0440\u0442\u0438\u043A\u0430\u043B\u044C\u043D\u043E\u0439 \u043A\u0430\u0440\u0442\u043E\u0447\u043A\u0438.\r\n   * @param {Object} prod\r\n   * @returns {Object}\r\n   */\r\n  _createCardData(prod = {}) {\r\n    const id = String(prod.name ?? prod.id ?? prod.productId ?? '');\r\n    const imgArray = this._getImageArray(prod.picture);\r\n    const firstImg = imgArray.length ? imgArray[0] : '/assets/no-image.png';\r\n    const priceText = this._formatPrice(prod.price ?? 0);\r\n    const hasOldPrice = (prod.oldPrice && Number(prod.oldPrice) > 0);\r\n    const specsHtml = (typeof makeSpecHtmlPreview === 'function') ? makeSpecHtmlPreview(prod.specs || {}) : '';\r\n    return {\r\n      id,\r\n      fullname: prod.fullname ?? prod.title ?? prod.name ?? '',\r\n      imgArray,\r\n      img: firstImg,\r\n      short: prod.short ?? '',\r\n      price: priceText,\r\n      oldPrice: hasOldPrice ? this._formatPrice(prod.oldPrice) : '',\r\n      badgeText: (Number(prod.stock) > 0) ? '\u0412 \u043D\u0430\u043B\u0438\u0447\u0438\u0438' : '\u041F\u043E\u0434 \u0437\u0430\u043A\u0430\u0437',\r\n      stock: Number.isFinite(Number(prod.stock)) ? Number(prod.stock) : 0,\r\n      specsHtml\r\n    };\r\n  }\r\n\r\n  /**\r\n   * \u041D\u043E\u0440\u043C\u0430\u043B\u0438\u0437\u0443\u0435\u0442 \u0434\u0430\u043D\u043D\u044B\u0435 \u044D\u043B\u0435\u043C\u0435\u043D\u0442\u0430 \u043A\u043E\u0440\u0437\u0438\u043D\u044B \u0434\u043B\u044F \u0433\u043E\u0440\u0438\u0437\u043E\u043D\u0442\u0430\u043B\u044C\u043D\u043E\u0433\u043E \u0441\u043F\u0438\u0441\u043A\u0430.\r\n   * \u0412\u043E\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u0442 \u043E\u0431\u044A\u0435\u043A\u0442 \u0441 \u0432\u044B\u0447\u0438\u0441\u043B\u0435\u043D\u043D\u044B\u043C\u0438 \u043F\u043E\u043B\u044F\u043C\u0438, \u0433\u043E\u0442\u043E\u0432\u044B\u043C\u0438 \u0434\u043B\u044F \u0448\u0430\u0431\u043B\u043E\u043D\u0430 \u0438\u043B\u0438 fallback.\r\n   * @param {Object} item\r\n   * @returns {Object}\r\n   */\r\n  _normalizeCartItem(item = {}) {\r\n    const id = String(item.name ?? item.id ?? item.productId ?? '').trim();\r\n    const fullname = String(item.fullname ?? item.title ?? item.name ?? '').trim();\r\n    const imageArray = this._getImageArray(item.picture);\r\n    const picture = imageArray.length ? imageArray[0] : '/assets/no-image.png';\r\n    const priceNum = Number(item.price ?? 0);\r\n    const qtyNum = Number.isFinite(Number(item.qty)) ? Number(item.qty) : 1;\r\n    const stockNum = Number.isFinite(Number(item.stock)) ? Number(item.stock) : 0;\r\n    const specsHtml = (typeof makeSpecHtmlPreview === 'function') ? makeSpecHtmlPreview(item.specs || {}) : '';\r\n    const priceFormatted = this._formatPrice(priceNum);\r\n    const totalPriceFormatted = this._formatPrice(priceNum * qtyNum);\r\n    return {\r\n      id,\r\n      fullname,\r\n      picture,\r\n      priceNum,\r\n      qtyNum,\r\n      stockNum,\r\n      specsHtml,\r\n      priceFormatted,\r\n      totalPriceFormatted\r\n    };\r\n  }\r\n\r\n  // -----------------------\r\n  // Fallback builders\r\n  // -----------------------\r\n\r\n  /**\r\n   * \u041F\u043E\u0441\u0442\u0440\u043E\u0435\u043D\u0438\u0435 fallback HTML \u0434\u043B\u044F \u0432\u0435\u0440\u0442\u0438\u043A\u0430\u043B\u044C\u043D\u043E\u0439 \u043A\u0430\u0440\u0442\u043E\u0447\u043A\u0438 \u043F\u0440\u0438 \u043E\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0438\u0438 \u0448\u0430\u0431\u043B\u043E\u043D\u0430.\r\n   * @param {Object} data\r\n   * @returns {string}\r\n   */\r\n  _buildVerticalCardHtml(data) {\r\n    const esc = (val) => _escapeHtml(String(val ?? ''));\r\n    const hasOldPrice = Boolean(data.oldPrice);\r\n    return `\r\n        <article class=\"card\" data-product-id=\"${esc(data.id)}\">\r\n          <div class=\"card__media\">\r\n            <img src=\"${esc(data.img)}\" alt=\"${esc(data.fullname)}\" loading=\"lazy\">\r\n          </div>\r\n          <div class=\"card__body\">\r\n            <h3 class=\"card__title\">${esc(data.fullname)}</h3>\r\n            <div class=\"card__price\">\r\n              ${esc(data.price)}${hasOldPrice ? ' <small class=\"old\">' + esc(data.oldPrice) + '</small>' : ''}\r\n            </div>\r\n            <div class=\"card__short\">${esc(data.short)}</div>\r\n            <div class=\"card__specs\">${data.specsHtml || ''}</div>\r\n            <div class=\"card__controls\">\r\n              <button data-role=\"buy\" class=\"btn\">\u0412 \u043A\u043E\u0440\u0437\u0438\u043D\u0443</button>\r\n            </div>\r\n          </div>\r\n        </article>`;\r\n  }\r\n\r\n  /**\r\n   * \u041F\u043E\u0441\u0442\u0440\u043E\u0435\u043D\u0438\u0435 fallback HTML \u0434\u043B\u044F \u0441\u0442\u0440\u043E\u043A\u0438 \u043A\u043E\u0440\u0437\u0438\u043D\u044B (\u0433\u043E\u0440\u0438\u0437\u043E\u043D\u0442\u0430\u043B\u044C\u043D\u044B\u0439 \u0440\u0435\u0436\u0438\u043C) \u043F\u0440\u0438 \u043E\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0438\u0438 \u0448\u0430\u0431\u043B\u043E\u043D\u0430.\r\n   * @param {Object} data\r\n   * @returns {string}\r\n   */\r\n  _buildHorizontalRowHtml(data) {\r\n    const esc = (s) => _escapeHtml(String(s ?? ''));\r\n    const { id, fullname, picture, priceFormatted, totalPriceFormatted, qtyNum, stockNum, specsHtml } = data;\r\n    const minQty = stockNum > 0 ? String(Math.max(1, qtyNum)) : '0';\r\n    const disabledAttr = stockNum <= 0 ? ' disabled aria-disabled=\"true\"' : '';\r\n    return `\r\n          <div class=\"cart-item\" data-id=\"${esc(id)}\">\r\n            <div class=\"cart-item__content\">\r\n              <div class=\"cart-item__image\"><img src=\"${esc(picture)}\" alt=\"${esc(fullname)}\" loading=\"lazy\"></div>\r\n              <div class=\"cart-item__details\">\r\n                <div class=\"cart-item__title\"><a href=\"#product/${encodeURIComponent(id)}\" rel=\"noopener noreferrer\">${esc(fullname)}</a></div>\r\n                ${specsHtml}\r\n              </div>\r\n              <div class=\"cart-item__right\" role=\"group\" aria-label=\"\u0423\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0438\u0435 \u0442\u043E\u0432\u0430\u0440\u043E\u043C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0435\">\r\n                <div class=\"cart-item__price\" aria-hidden=\"false\"><span class=\"price-value\">${esc(priceFormatted)}</span>\r\n                  <div class=\"price-total\">\u0418\u0442\u043E\u0433\u043E: <span class=\"price-total-value\">${esc(totalPriceFormatted)}</span></div>\r\n                </div>\r\n                <div class=\"qty-controls\" data-id=\"${esc(id)}\" role=\"group\" aria-label=\"\u041A\u043E\u043B\u0438\u0447\u0435\u0441\u0442\u0432\u043E \u0442\u043E\u0432\u0430\u0440\u0430\">\r\n                  <button class=\"qty-btn qty-decr\" type=\"button\" aria-label=\"\u0423\u043C\u0435\u043D\u044C\u0448\u0438\u0442\u044C \u043A\u043E\u043B\u0438\u0447\u0435\u0441\u0442\u0432\u043E\">\u2212</button>\r\n                  <input class=\"qty-input\" type=\"number\" value=\"${minQty}\" min=\"1\" max=\"${stockNum}\" aria-label=\"\u041A\u043E\u043B\u0438\u0447\u0435\u0441\u0442\u0432\u043E\" inputmode=\"numeric\"${disabledAttr}/>\r\n                  <button class=\"qty-btn qty-incr\" type=\"button\" aria-label=\"\u0423\u0432\u0435\u043B\u0438\u0447\u0438\u0442\u044C \u043A\u043E\u043B\u0438\u0447\u0435\u0441\u0442\u0432\u043E\">+</button>\r\n                </div>\r\n              </div>\r\n              <div class=\"cart-item__controls\">\r\n                <div class=\"cart-item__icons\">\r\n                  <button class=\"wishlist-btn fav-btn\" type=\"button\" title=\"\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435\" aria-label=\"\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435\"><i class=\"icon-heart\" aria-hidden=\"true\"></i></button>\r\n                  <button class=\"remove-btn\" type=\"button\" data-id=\"${esc(id)}\" title=\"\u0423\u0434\u0430\u043B\u0438\u0442\u044C\" aria-label=\"\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u0442\u043E\u0432\u0430\u0440\"><i class=\"fa-regular fa-xmark\" aria-hidden=\"true\"></i></button>\r\n                </div>\r\n              </div>\r\n              <div class=\"stock-warning\" aria-hidden=\"true\" style=\"display:none;\">\u0422\u043E\u0432\u0430\u0440\u0430 \u043D\u0435\u0442 \u0432 \u043D\u0430\u043B\u0438\u0447\u0438\u0438</div>\r\n            </div>\r\n          </div>`;\r\n  }\r\n\r\n  // -----------------------\r\n  // Vertical card rendering\r\n  // -----------------------\r\n\r\n  /**\r\n   * \u0421\u043E\u0437\u0434\u0430\u0451\u0442 DOM-\u044D\u043B\u0435\u043C\u0435\u043D\u0442 \u043A\u0430\u0440\u0442\u043E\u0447\u043A\u0438 \u043F\u0440\u043E\u0434\u0443\u043A\u0442\u0430 (\u0432\u0435\u0440\u0442\u0438\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u043A\u0430\u0440\u0442\u043E\u0447\u043A\u0430)\r\n   * @param {Object} product\r\n   * @returns {Promise<Element>}\r\n   */\r\n  async createCard(product = {}) {\r\n    const data = this._createCardData(product);\r\n    let html = '';\r\n    // \u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043F\u044B\u0442\u0430\u0435\u043C\u0441\u044F \u0432\u043E\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u044C\u0441\u044F \u0448\u0430\u0431\u043B\u043E\u043D\u043E\u043C\r\n    html = await this.renderTemplate('cardVertical', data);\r\n    // Fallback \u043F\u0440\u0438 \u043E\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0438\u0438 \u0448\u0430\u0431\u043B\u043E\u043D\u0430\r\n    if (!html) {\r\n      html = this._buildVerticalCardHtml(data);\r\n    }\r\n    const node = this.createElementFromHTML(html);\r\n    // Ensure data attribute presence\r\n    try { node.setAttribute && node.setAttribute('data-product-id', String(data.id)); } catch (_) {}\r\n    // attach gallery enhancement if needed\r\n    if (Array.isArray(data.imgArray) && data.imgArray.length > 1) {\r\n      try { this._attachImageGallery(node, data.imgArray); } catch (e) { this._log(`attachImageGallery error: ${e}`, 'WARN'); }\r\n    }\r\n    return node;\r\n  }\r\n\r\n  /**\r\n   * \u0414\u043E\u0431\u0430\u0432\u043B\u044F\u0435\u0442 \u043D\u0430 \u043A\u0430\u0440\u0442\u043E\u0447\u043A\u0443 \u0437\u043E\u043D\u044B \u0434\u043B\u044F \u043D\u0430\u0432\u0435\u0434\u0435\u043D\u0438\u044F \u0438 \u0442\u043E\u0447\u043A\u0438 \u0434\u043B\u044F \u043F\u0435\u0440\u0435\u043A\u043B\u044E\u0447\u0435\u043D\u0438\u044F \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439\r\n   * @param {Element} node\r\n   * @param {string[]} imgArray\r\n   */\r\n  _attachImageGallery(node, imgArray = []) {\r\n    if (!node || !Array.isArray(imgArray) || imgArray.length <= 1) return;\r\n    const media = node.querySelector && node.querySelector('.card__media');\r\n    if (!media) return;\r\n    media.classList.add('multi-image');\r\n    const overlay = document.createElement('div');\r\n    overlay.className = 'card__image-overlay';\r\n    const dots = document.createElement('div');\r\n    dots.className = 'card__image-dots';\r\n    const imgEl = media.querySelector('img');\r\n    let activeIndex = 0;\r\n    const updateImage = (index) => {\r\n      if (index < 0 || index >= imgArray.length) return;\r\n      activeIndex = index;\r\n      if (imgEl) {\r\n        imgEl.classList.add('fade');\r\n        // \u043D\u0435\u0431\u043E\u043B\u044C\u0448\u0430\u044F \u0437\u0430\u0434\u0435\u0440\u0436\u043A\u0430 \u0434\u043B\u044F \u043F\u043B\u0430\u0432\u043D\u043E\u0441\u0442\u0438 (\u0441\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C \u043F\u0440\u0435\u0436\u043D\u044E\u044E \u043B\u043E\u0433\u0438\u043A\u0443)\r\n        setTimeout(() => {\r\n          imgEl.src = imgArray[index];\r\n          imgEl.onload = () => imgEl.classList.remove('fade');\r\n        }, 120);\r\n      }\r\n      dots.querySelectorAll('.dot').forEach((d, i) => d.classList.toggle('active', i === index));\r\n    };\r\n    imgArray.forEach((_, i) => {\r\n      const zone = document.createElement('div');\r\n      zone.className = 'card__image-zone';\r\n      zone.style.setProperty('--zone-index', i);\r\n      zone.addEventListener('mouseenter', () => updateImage(i));\r\n      overlay.appendChild(zone);\r\n      const dot = document.createElement('span');\r\n      dot.className = 'dot';\r\n      if (i === 0) dot.classList.add('active');\r\n      dot.addEventListener('mouseenter', () => updateImage(i));\r\n      dots.appendChild(dot);\r\n    });\r\n    media.appendChild(overlay);\r\n    media.after(dots);\r\n  }\r\n\r\n  // -----------------------\r\n  // Vertical list rendering (animated)\r\n  // -----------------------\r\n\r\n  /**\r\n   * \u0411\u044B\u0441\u0442\u0440\u043E\u0435 \u0440\u0435\u043D\u0434\u0435\u0440\u0435\u043D\u0438\u0435 \u0432\u0435\u0440\u0442\u0438\u043A\u0430\u043B\u044C\u043D\u043E\u0439 \u043A\u043E\u043B\u043E\u043D\u043A\u0438 \u043A\u0430\u0440\u0442\u043E\u0447\u0435\u043A\r\n   * @param {Array} list\r\n   * @param {Element} rootEl\r\n   */\r\n  async _renderCartVertical(list = [], rootEl) {\r\n    if (!rootEl) return;\r\n    rootEl.innerHTML = '';\r\n    const frag = document.createDocumentFragment();\r\n    const items = Array.isArray(list) ? list : [];\r\n    // generate cards in parallel\r\n    const cards = await Promise.all(items.map((p) => this.createCard(p)));\r\n    for (const card of cards) {\r\n      if (!card) continue;\r\n      card.style.opacity = '0';\r\n      card.style.transition = 'opacity .22s ease';\r\n      frag.appendChild(card);\r\n      // animate on next frame\r\n      requestAnimationFrame(() => { card.style.opacity = '1'; });\r\n    }\r\n    rootEl.appendChild(frag);\r\n  }\r\n\r\n  // -----------------------\r\n  // Mini cart item\r\n  // -----------------------\r\n\r\n  /**\r\n   * create mini cart item HTML\r\n   * @param {Object} item\r\n   * @param {Object|null} foxEngine\r\n   * @returns {Promise<string>}\r\n   */\r\n  async _createMiniCartItemHTML(item = {}, foxEngine = null) {\r\n    const title = String(item.fullname ?? item.title ?? item.name ?? '\u0422\u043E\u0432\u0430\u0440');\r\n    const price = this._formatPrice(item.price ?? 0);\r\n    const qty = Number.isFinite(Number(item.qty)) ? Number(item.qty) : 0;\r\n    const imageArray = this._getImageArray(item.picture);\r\n    const img = String(imageArray.at ? imageArray.at(0) ?? '/assets/no-image.png' : imageArray[0] ?? '/assets/no-image.png');\r\n    const id = String(item.name ?? item.id ?? '');\r\n    if (foxEngine && foxEngine.templateCache && foxEngine.templateCache.miniCartItem) {\r\n      try {\r\n        return await foxEngine.replaceTextInTemplate(foxEngine.templateCache.miniCartItem, {\r\n          id,\r\n          img,\r\n          title,\r\n          qty,\r\n          price\r\n        });\r\n      } catch (e) {\r\n        this._log(`_createMiniCartItemHTML template error: ${e}`, 'WARN');\r\n      }\r\n    }\r\n    // fallback (safe)\r\n    return `<li class=\"cart-item\" data-id=\"${_escapeHtml(id)}\">\r\n      <div class=\"mc-thumb\"><img src=\"${_escapeHtml(img)}\" alt=\"${_escapeHtml(title)}\" loading=\"lazy\"/></div>\r\n      <div class=\"mc-body\"><div class=\"mc-name\">${_escapeHtml(title)}</div><div class=\"mc-meta\">${_escapeHtml(String(qty))} \u00D7 ${_escapeHtml(price)}</div></div>\r\n    </li>`;\r\n  }\r\n\r\n  // -----------------------\r\n  // Horizontal cart rendering\r\n  // -----------------------\r\n\r\n  /**\r\n   * \u041A\u043E\u043D\u0444\u0438\u0433\u0443\u0440\u0438\u0440\u0443\u0435\u0442 \u043F\u043E\u043B\u044F \u043A\u043E\u043B\u0438\u0447\u0435\u0441\u0442\u0432\u0430 \u0438 \u043A\u043D\u043E\u043F\u043A\u0438 \u0432 DOM-\u0443\u0437\u043B\u0435\r\n   * @param {Element} produced\r\n   * @param {number} qtyNum\r\n   * @param {number} stockNum\r\n   */\r\n  _configureQtyControls(produced, qtyNum = 1, stockNum = 0) {\r\n    if (!produced) return;\r\n    try {\r\n      const qtyInput = produced.querySelector && produced.querySelector('.qty-input');\r\n      const btnPlus = produced.querySelector && produced.querySelector('.qty-btn.qty-incr');\r\n      const btnMinus = produced.querySelector && produced.querySelector('.qty-btn.qty-decr');\r\n      if (qtyInput) {\r\n        qtyInput.setAttribute('min', '1');\r\n        qtyInput.setAttribute('max', String(stockNum));\r\n        if (stockNum <= 0) {\r\n          qtyInput.value = '0';\r\n          qtyInput.disabled = true;\r\n          qtyInput.setAttribute('aria-disabled', 'true');\r\n        } else {\r\n          let cur = parseInt(qtyInput.value || String(qtyNum), 10);\r\n          if (isNaN(cur) || cur < 1) cur = Math.max(1, qtyNum || 1);\r\n          if (cur > stockNum) cur = stockNum;\r\n          qtyInput.value = String(cur);\r\n          qtyInput.disabled = false;\r\n          qtyInput.removeAttribute('aria-disabled');\r\n        }\r\n      }\r\n      if (btnPlus) {\r\n        const disabled = stockNum <= 0 || qtyNum >= stockNum;\r\n        btnPlus.disabled = disabled;\r\n        disabled ? btnPlus.setAttribute('aria-disabled', 'true') : btnPlus.removeAttribute('aria-disabled');\r\n      }\r\n      if (btnMinus) {\r\n        const disabled = stockNum <= 0 || qtyNum <= 1;\r\n        btnMinus.disabled = disabled;\r\n        disabled ? btnMinus.setAttribute('aria-disabled', 'true') : btnMinus.removeAttribute('aria-disabled');\r\n      }\r\n      // stock warning\r\n      const stockWarning = produced.querySelector && produced.querySelector('.stock-warning');\r\n      if (stockNum <= 0) {\r\n        if (stockWarning) {\r\n          stockWarning.textContent = '\u0422\u043E\u0432\u0430\u0440\u0430 \u043D\u0435\u0442 \u0432 \u043D\u0430\u043B\u0438\u0447\u0438\u0438';\r\n          stockWarning.style.display = '';\r\n          stockWarning.setAttribute('aria-hidden', 'false');\r\n        }\r\n        produced.classList.add('out-of-stock');\r\n      } else if (stockWarning) {\r\n        stockWarning.style.display = 'none';\r\n        stockWarning.setAttribute('aria-hidden', 'true');\r\n        produced.classList.remove('out-of-stock');\r\n      }\r\n    } catch (e) {\r\n      this._log(`_configureQtyControls error: ${e}`, 'WARN');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \u042D\u0444\u0444\u0435\u043A\u0442\u0438\u0432\u043D\u043E \u0440\u0435\u043D\u0434\u0435\u0440\u0438\u0442 \u0433\u043E\u0440\u0438\u0437\u043E\u043D\u0442\u0430\u043B\u044C\u043D\u0443\u044E \u0441\u0435\u0442\u043A\u0443 \u043A\u043E\u0440\u0437\u0438\u043D\u044B (cartEl) \u0438\u0437 \u043C\u0430\u0441\u0441\u0438\u0432\u0430 cartArr.\r\n   * \u041F\u043E\u043F\u044B\u0442\u043A\u0430 in-place \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u044F, \u0438\u043D\u0430\u0447\u0435 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435 \u043D\u043E\u0432\u044B\u0445 \u0441\u0442\u0440\u043E\u043A.\r\n   * @param {Element} cartEl\r\n   * @param {Array} cartArr\r\n   */\r\n  async _renderCartHorizontal(cartEl, cartArr = []) {\r\n    if (!cartEl) return;\r\n    const arr = Array.isArray(cartArr) ? cartArr.slice() : [];\r\n    // empty state\r\n    if (!arr.length) {\r\n      cartEl.innerHTML = `\r\n        <div class=\"cart-empty\" role=\"status\" aria-live=\"polite\">\r\n          <p><i class=\"fa-regular fa-cart-shopping\" aria-hidden=\"true\"></i> \u0412\u0430\u0448\u0430 \u043A\u043E\u0440\u0437\u0438\u043D\u0430 \u043F\u0443\u0441\u0442\u0430.</p>\r\n          <a href=\"#page/catalog\" class=\"btn btn-primary\">\u041F\u0435\u0440\u0435\u0439\u0442\u0438 \u0432 \u043A\u0430\u0442\u0430\u043B\u043E\u0433</a>\r\n        </div>`;\r\n      return;\r\n    }\r\n    // map existing rows\r\n    const existingMap = new Map();\r\n    try {\r\n      const existingRows = Array.from((cartEl.querySelectorAll && cartEl.querySelectorAll('.cart-item')) || []);\r\n      for (const r of existingRows) {\r\n        try {\r\n          const did = r.getAttribute && (r.getAttribute('data-id') || r.getAttribute('data-cart-item') || r.getAttribute('data-cart-id'));\r\n          if (did) existingMap.set(String(did), r);\r\n        } catch (_) { /* ignore per-row errors */ }\r\n      }\r\n    } catch (_) { /* ignore */ }\r\n    const frag = document.createDocumentFragment();\r\n    for (const rawItem of arr) {\r\n      const data = this._normalizeCartItem(rawItem);\r\n      const existing = data.id ? existingMap.get(String(data.id)) : null;\r\n      if (existing) {\r\n        // try in-place update\r\n        try {\r\n          this._updateRowDom(existing, data);\r\n          existingMap.delete(String(data.id));\r\n          frag.appendChild(existing);\r\n          continue;\r\n        } catch (e) {\r\n          existingMap.delete(String(data.id));\r\n          this._log(`in-place update failed for ${data.id}: ${e}`, 'WARN');\r\n        }\r\n      }\r\n      // create new\r\n      let rowHtml = '';\r\n      rowHtml = await this.renderTemplate('cardHorizontal', {\r\n        id: data.id,\r\n        fullname: data.fullname,\r\n        price: data.priceFormatted,\r\n        totalPrice: data.totalPriceFormatted,\r\n        qty: data.qtyNum,\r\n        stock: data.stockNum,\r\n        picture: data.picture,\r\n        specs: data.specsHtml\r\n      });\r\n      if (!rowHtml) {\r\n        rowHtml = this._buildHorizontalRowHtml(data);\r\n      }\r\n      const produced = this.createElementFromHTML(rowHtml);\r\n      try { if (String(data.id) && produced.setAttribute) produced.setAttribute('data-id', String(data.id)); } catch (_) {}\r\n      // post-process produced: set proper input state\r\n      this._configureQtyControls(produced, data.qtyNum, data.stockNum);\r\n      frag.appendChild(produced);\r\n    }\r\n    // remove leftover nodes\r\n    for (const [key, node] of existingMap) {\r\n      try { if (node && node.parentNode) node.parentNode.removeChild(node); } catch (_) {}\r\n    }\r\n    // replace in one frame\r\n    await new Promise((resolve) => requestAnimationFrame(resolve));\r\n    cartEl.innerHTML = '';\r\n    cartEl.appendChild(frag);\r\n  }\r\n\r\n  // -----------------------\r\n  // In-place update row\r\n  // -----------------------\r\n\r\n  /**\r\n   * \u041F\u043E\u043F\u044B\u0442\u043A\u0430 \u0441\u043A\u043E\u0440\u0440\u0435\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044E\u0449\u0443\u044E DOM-\u0441\u0442\u0440\u043E\u043A\u0443 \"in-place\".\r\n   * \u041E\u0436\u0438\u0434\u0430\u0435\u0442 \u043E\u0431\u044A\u0435\u043A\u0442 \u0441 \u0443\u0436\u0435 \u0432\u044B\u0447\u0438\u0441\u043B\u0435\u043D\u043D\u044B\u043C\u0438 \u043F\u043E\u043B\u044F\u043C\u0438 \u043A\u0430\u043A \u0443 _normalizeCartItem().\r\n   * @param {Element} row\r\n   * @param {Object} data\r\n   */\r\n  _updateRowDom(row, data = {}) {\r\n    if (!row || typeof row !== 'object') return;\r\n    const {\r\n      id,\r\n      fullname,\r\n      picture,\r\n      priceFormatted,\r\n      totalPriceFormatted,\r\n      qtyNum,\r\n      stockNum,\r\n      specsHtml\r\n    } = data;\r\n    // title/link\r\n    try {\r\n      const a = row.querySelector && row.querySelector('a[href*=\"#product/\"]');\r\n      if (a && a.setAttribute) {\r\n        a.setAttribute('href', `#product/${encodeURIComponent(String(id))}`);\r\n        if (a.firstChild && a.firstChild.nodeType === 3) a.firstChild.nodeValue = fullname;\r\n        else a.textContent = fullname;\r\n      } else {\r\n        const title = row.querySelector && (row.querySelector('.cart-item__title') || row.querySelector('.cart-item__name') || row.querySelector('.cart-item__title a'));\r\n        if (title) title.textContent = fullname;\r\n      }\r\n    } catch (e) { this._log(`updateRowDom title error: ${e}`, 'WARN'); }\r\n    // image\r\n    try {\r\n      const img = row.querySelector && (row.querySelector('.cart-item__image img') || row.querySelector('img'));\r\n      if (img && img.setAttribute) {\r\n        img.setAttribute('src', String(picture));\r\n        img.setAttribute('alt', String(fullname));\r\n      }\r\n    } catch (e) { this._log(`updateRowDom image error: ${e}`, 'WARN'); }\r\n    // price / total\r\n    try {\r\n      const pv = row.querySelector && row.querySelector('.price-value');\r\n      if (pv) pv.textContent = String(priceFormatted);\r\n      const pt = row.querySelector && row.querySelector('.price-total-value');\r\n      if (pt) pt.textContent = String(totalPriceFormatted);\r\n    } catch (e) { this._log(`updateRowDom price error: ${e}`, 'WARN'); }\r\n    // qty controls and stock warning\r\n    this._configureQtyControls(row, qtyNum, stockNum);\r\n    // specs area\r\n    try {\r\n      if (specsHtml) {\r\n        const specsNode = row.querySelector && (row.querySelector('.cart-item__info') || row.querySelector('.cart-item__details'));\r\n        if (specsNode) specsNode.innerHTML = specsHtml;\r\n      }\r\n    } catch (e) { this._log(`updateRowDom specs error: ${e}`, 'WARN'); }\r\n  }\r\n\r\n  // -----------------------\r\n  // Favorite state\r\n  // -----------------------\r\n\r\n  /**\r\n   * \u041E\u0431\u043D\u043E\u0432\u0438\u0442\u044C \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u043A\u043D\u043E\u043F\u043A\u0438 \"\u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435\" \u0432 \u043A\u0430\u0440\u0442\u043E\u0447\u043A\u0435 \u0442\u043E\u0432\u0430\u0440\u0430\r\n   * @param {Element} rootEl\r\n   * @param {string} id\r\n   * @param {boolean} isFav\r\n   */\r\n  updateProductCardFavState(rootEl, id, isFav) {\r\n    if (!rootEl || !id) return;\r\n    const esc = this.escapeForAttribute(id);\r\n    const selector = `[data-product-id=\"${esc}\"]`;\r\n    const card = rootEl.querySelector && rootEl.querySelector(selector);\r\n    if (!card) return;\r\n    const favBtn = card.querySelector('.fav-btn');\r\n    if (!favBtn) return;\r\n    favBtn.setAttribute('aria-pressed', isFav ? 'true' : 'false');\r\n    favBtn.title = isFav ? '\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u043C' : '\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435';\r\n    favBtn.classList.toggle('is-fav', !!isFav);\r\n    const icon = favBtn.querySelector('i');\r\n    if (icon) {\r\n      icon.classList.remove('fa-regular', 'fa-solid');\r\n      icon.classList.add(isFav ? 'fa-solid' : 'fa-regular');\r\n      if (!icon.classList.contains('fa-heart')) icon.classList.add('fa-heart');\r\n    }\r\n  }\r\n}", "/**\r\n * MiniCart for ShopMatic \u2014 optimized and refactored\r\n * @author Calista Verner\r\n * \r\n * \u042D\u0442\u043E\u0442 \u043A\u043B\u0430\u0441\u0441 \u0438\u043D\u043A\u0430\u043F\u0441\u0443\u043B\u0438\u0440\u0443\u0435\u0442 \u043B\u043E\u0433\u0438\u043A\u0443 \u043E\u0442\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F \u043C\u0438\u043D\u0438\u2011\u043A\u043E\u0440\u0437\u0438\u043D\u044B \u0438 \u043F\u0440\u0435\u0434\u043D\u0430\u0437\u043D\u0430\u0447\u0435\u043D\r\n * \u0434\u043B\u044F \u0431\u0435\u0437\u043E\u043F\u0430\u0441\u043D\u043E\u0433\u043E \u0438 \u044D\u0444\u0444\u0435\u043A\u0442\u0438\u0432\u043D\u043E\u0433\u043E \u0440\u0435\u043D\u0434\u0435\u0440\u0438\u043D\u0433\u0430 \u0441\u043F\u0438\u0441\u043A\u0430 \u0442\u043E\u0432\u0430\u0440\u043E\u0432. \u0412 \u0434\u0430\u043D\u043D\u043E\u0439 \u0432\u0435\u0440\u0441\u0438\u0438\r\n * \u0432\u043D\u0435\u0441\u0435\u043D\u044B \u0443\u043B\u0443\u0447\u0448\u0435\u043D\u0438\u044F \u0432 \u0441\u0442\u0440\u0443\u043A\u0442\u0443\u0440\u0443 \u043A\u043E\u0434\u0430 (\u041E\u041E\u041F), \u043F\u043E\u0432\u044B\u0448\u0435\u043D\u0430 \u0447\u0438\u0442\u0430\u0435\u043C\u043E\u0441\u0442\u044C \u0438\r\n * \u043F\u0440\u043E\u0438\u0437\u0432\u043E\u0434\u0438\u0442\u0435\u043B\u044C\u043D\u043E\u0441\u0442\u044C, \u0430 \u0442\u0430\u043A\u0436\u0435 \u0443\u0441\u0442\u0440\u0430\u043D\u0435\u043D\u043E \u043F\u043E\u0432\u0442\u043E\u0440\u0435\u043D\u0438\u0435 \u043A\u043E\u0434\u0430.\r\n *\r\n * \u041E\u0441\u043D\u043E\u0432\u043D\u044B\u0435 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u044F:\r\n *  - \u0418\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u043D\u0430 \u0434\u0435\u0441\u0442\u0440\u0443\u043A\u0442\u0443\u0440\u0438\u0437\u0430\u0446\u0438\u044F \u0434\u043B\u044F \u043F\u0430\u0440\u0430\u043C\u0435\u0442\u0440\u043E\u0432 \u043A\u043E\u043D\u0441\u0442\u0440\u0443\u043A\u0442\u043E\u0440\u0430 \u0438 \u043E\u043F\u0446\u0438\u0439\r\n *  - \u0412\u0432\u0435\u0434\u0435\u043D\u044B \u0432\u0441\u043F\u043E\u043C\u043E\u0433\u0430\u0442\u0435\u043B\u044C\u043D\u044B\u0435 \u043C\u0435\u0442\u043E\u0434\u044B \u0434\u043B\u044F \u043D\u043E\u0440\u043C\u0430\u043B\u0438\u0437\u0430\u0446\u0438\u0438 \u0438 \u0445\u044D\u0448\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F \u0442\u043E\u0432\u0430\u0440\u043E\u0432\r\n *  - \u0420\u0435\u043D\u0434\u0435\u0440\u0438\u043D\u0433 \u044D\u043B\u0435\u043C\u0435\u043D\u0442\u043E\u0432 \u0440\u0430\u0437\u0431\u0438\u0442 \u043D\u0430 \u0431\u043E\u043B\u0435\u0435 \u043C\u0435\u043B\u043A\u0438\u0435 \u0448\u0430\u0433\u0438: \u0441\u0431\u043E\u0440 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044E\u0449\u0438\u0445\r\n *    \u0443\u0437\u043B\u043E\u0432, \u0438\u0445 \u043F\u0435\u0440\u0435\u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u043D\u0438\u0435, \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435 \u043D\u043E\u0432\u044B\u0445 \u0443\u0437\u043B\u043E\u0432 \u0438 \u043E\u0447\u0438\u0441\u0442\u043A\u0430 \u043B\u0438\u0448\u043D\u0438\u0445\r\n *  - \u0423\u043F\u0440\u043E\u0449\u0435\u043D\u043E \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435 fallback\u2011\u0440\u0430\u0437\u043C\u0435\u0442\u043A\u0438 \u0438 \u043F\u0435\u0440\u0435\u043D\u0435\u0441\u0435\u043D\u043E \u0432 \u043E\u0442\u0434\u0435\u043B\u044C\u043D\u044B\u0439 \u043C\u0435\u0442\u043E\u0434\r\n *  - \u0412\u043D\u0435\u0441\u0435\u043D\u044B \u043D\u0435\u0431\u043E\u043B\u044C\u0448\u0438\u0435 \u043E\u043F\u0442\u0438\u043C\u0438\u0437\u0430\u0446\u0438\u0438 \u043F\u043E \u0440\u0430\u0431\u043E\u0442\u0435 \u0441 DOM \u0438 \u043A\u0435\u0448\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044E\r\n */\r\n\r\nexport class MiniCart {\r\n  /**\r\n   * \u041E\u0431\u0449\u0438\u0435 \u0442\u0435\u043A\u0441\u0442\u043E\u0432\u044B\u0435 \u0441\u043E\u043E\u0431\u0449\u0435\u043D\u0438\u044F \u0438 \u043A\u043B\u0430\u0441\u0441\u044B \u0434\u043B\u044F UI\r\n   * @type {Readonly<Record<string,string>>}\r\n   */\r\n  static UI_MESSAGES = Object.freeze({\r\n    EMPTY_TEXT: '\u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u043F\u0443\u0441\u0442\u0430',\r\n    EMPTY_ICON_CLASS: 'fa-solid fa-cart-shopping',\r\n    SUMMARY_MORE: '\u0415\u0449\u0451 {n} \u0442\u043E\u0432\u0430\u0440{plural}\u2026 <a href=\"#page/cart\" class=\"mc-summary__link\">\u041F\u0435\u0440\u0435\u0439\u0442\u0438 \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443</a>',\r\n    FALLBACK_NAME: '\u0422\u043E\u0432\u0430\u0440',\r\n    HEADER_BASE: '\u041A\u043E\u0440\u0437\u0438\u043D\u0430'\r\n  });\r\n\r\n  /**\r\n   * \u0421\u043E\u0437\u0434\u0430\u0451\u0442 \u043D\u043E\u0432\u044B\u0439 \u043C\u0438\u043D\u0438\u2011\u043A\u0430\u0440\u0442\r\n   * @param {Object} [param0]\r\n   * @param {Object|null} [param0.renderer] \u0420\u0435\u043D\u0434\u0435\u0440\u0435\u0440 \u043A\u0430\u0440\u0442\u043E\u0447\u0435\u043A (\u043C\u043E\u0436\u0435\u0442 \u0431\u044B\u0442\u044C null)\r\n   * @param {Object|null} [param0.notifications] \u0421\u0438\u0441\u0442\u0435\u043C\u0430 \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u0439 (\u043C\u043E\u0436\u0435\u0442 \u0431\u044B\u0442\u044C null)\r\n   * @param {Object} [param0.opts] \u041D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0438 \u043E\u0442\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F\r\n   */\r\n  constructor({ renderer = null, notifications = null, opts = {} } = {}) {\r\n    this.renderer = renderer;\r\n    this.notifications = notifications;\r\n    // \u0434\u0435\u0441\u0442\u0440\u0443\u043A\u0442\u0443\u0440\u0438\u0437\u0430\u0446\u0438\u044F \u0441 \u0434\u0435\u0444\u043E\u043B\u0442\u0430\u043C\u0438\r\n    const {\r\n      emptyText = this.constructor.UI_MESSAGES.EMPTY_TEXT,\r\n      emptyIconClass = this.constructor.UI_MESSAGES.EMPTY_ICON_CLASS,\r\n      maxItems = 10,\r\n      debug = false\r\n    } = opts;\r\n    this.opts = { emptyText, emptyIconClass, maxItems, debug };\r\n    // DOM refs\r\n    this.listEl = null;\r\n    this.headerTitleEl = null;\r\n    // internal state\r\n    this._lastRenderHash = '';\r\n    this._headerBase = null;\r\n    /**\r\n     * @type {Map<string, Element>} \u043A\u0430\u0440\u0442\u0430 \u044D\u043B\u0435\u043C\u0435\u043D\u0442\u043E\u0432 \u043F\u043E idKey \u0434\u043B\u044F \u043F\u0435\u0440\u0435\u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u043D\u0438\u044F\r\n     */\r\n    this._elementsMap = new Map();\r\n    this._pendingRaf = false;\r\n    this._latestCart = null;\r\n  }\r\n\r\n  /* ---------- i18n / small utils ---------- */\r\n\r\n  /**\r\n   * \u0428\u0430\u0431\u043B\u043E\u043D\u0438\u0437\u0430\u0442\u043E\u0440 \u0441\u043E\u043E\u0431\u0449\u0435\u043D\u0438\u0439: \u0437\u0430\u043C\u0435\u043D\u044F\u0435\u0442 {variables}\r\n   * @param {string} key\r\n   * @param {Object} vars\r\n   * @returns {string}\r\n   */\r\n  _msg(key, vars = {}) {\r\n    const pool = (this.constructor && this.constructor.UI_MESSAGES) || {};\r\n    const tpl = pool[key] ?? '';\r\n    return String(tpl).replace(/\\{([^}]+)\\}/g, (m, k) =>\r\n      Object.prototype.hasOwnProperty.call(vars, k) ? String(vars[k]) : m\r\n    );\r\n  }\r\n\r\n  /**\r\n   * \u042D\u043A\u0440\u0430\u043D\u0438\u0440\u0443\u0435\u0442 \u0441\u0442\u0440\u043E\u043A\u0443 \u0434\u043B\u044F HTML\r\n   * @param {any} s\r\n   * @returns {string}\r\n   */\r\n  static _escapeHtml(s) {\r\n    return String(s ?? '')\r\n      .replace(/&/g, '&amp;')\r\n      .replace(/</g, '&lt;')\r\n      .replace(/>/g, '&gt;')\r\n      .replace(/\"/g, '&quot;')\r\n      .replace(/'/g, '&#39;');\r\n  }\r\n\r\n  /**\r\n   * \u0424\u043E\u0440\u043C\u0430\u0442\u0438\u0440\u0443\u0435\u0442 \u0446\u0435\u043D\u0443 \u0432 \u0440\u0443\u0431\u043B\u044F\u0445\r\n   * @param {number|string} num\r\n   * @returns {string}\r\n   */\r\n  _formatPrice(num) {\r\n    try {\r\n      return Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB' }).format(Number(num || 0));\r\n    } catch (e) {\r\n      return String(num || 0);\r\n    }\r\n  }\r\n\r\n  /* ---------- DOM helpers ---------- */\r\n\r\n  /**\r\n   * \u0421\u043E\u0437\u0434\u0430\u0451\u0442 DOM-\u0443\u0437\u0435\u043B \u0438\u0437 HTML-\u0441\u0442\u0440\u043E\u043A\u0438\r\n   * @param {string} html\r\n   * @returns {Element|null}\r\n   */\r\n  _createElFromHTML(html) {\r\n    try {\r\n      const wrapper = document.createElement('div');\r\n      wrapper.innerHTML = html.trim();\r\n      return wrapper.firstElementChild || null;\r\n    } catch (e) {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \u041D\u043E\u0440\u043C\u0430\u043B\u0438\u0437\u0443\u0435\u0442 \u043E\u0431\u044A\u0435\u043A\u0442 \u043A\u043E\u0440\u0437\u0438\u043D\u044B. \u0412\u043E\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u0442 \u0443\u0434\u043E\u0431\u043D\u0443\u044E \u0441\u0442\u0440\u0443\u043A\u0442\u0443\u0440\u0443 \u0434\u043B\u044F \u0440\u0435\u043D\u0434\u0435\u0440\u0438\u043D\u0433\u0430.\r\n   * @param {any} it\r\n   * @returns {{ idKey: string, qty: number, priceNum: number, name: string, picture: string, priceFormatted: string }}\r\n   */\r\n  _normalizeCartItem(it) {\r\n    const idKey = String(it?.name ?? it?.id ?? it?.productId ?? '').trim();\r\n    const qty = Number.isFinite(Number(it?.qty)) ? Number(it?.qty) : 0;\r\n    const priceNum = Number.isFinite(Number(it?.price)) ? Number(it?.price) : 0;\r\n    const name = it?.fullname || it?.title || it?.name || this.constructor.UI_MESSAGES.FALLBACK_NAME;\r\n    const picture = it?.picture || it?.image || '/assets/no-image.png';\r\n    const priceFormatted = this._formatPrice(priceNum);\r\n    return { idKey, qty, priceNum, name, picture, priceFormatted };\r\n  }\r\n\r\n  /**\r\n   * \u0412\u044B\u0447\u0438\u0441\u043B\u044F\u0435\u0442 \u0445\u044D\u0448 \u044D\u043B\u0435\u043C\u0435\u043D\u0442\u0430 \u043A\u043E\u0440\u0437\u0438\u043D\u044B \u043D\u0430 \u043E\u0441\u043D\u043E\u0432\u0435 id, qty \u0438 \u0446\u0435\u043D\u044B\r\n   * @param {string} idKey\r\n   * @param {number} qty\r\n   * @param {number} priceNum\r\n   * @returns {string}\r\n   */\r\n  _computeItemHash(idKey, qty, priceNum) {\r\n    return `${idKey}:${qty}:${priceNum}`;\r\n  }\r\n\r\n  /**\r\n   * \u0413\u0435\u043D\u0435\u0440\u0438\u0440\u0443\u0435\u0442 fallback\u2011\u0440\u0430\u0437\u043C\u0435\u0442\u043A\u0443 \u0434\u043B\u044F \u044D\u043B\u0435\u043C\u0435\u043D\u0442\u0430, \u0435\u0441\u043B\u0438 renderer \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D\r\n   * @param {Object} norm\r\n   * @returns {Element|null}\r\n   */\r\n  _renderFallbackItem(norm) {\r\n    const id = MiniCart._escapeHtml(norm.idKey);\r\n    const name = MiniCart._escapeHtml(norm.name);\r\n    const qty = MiniCart._escapeHtml(String(norm.qty));\r\n    const price = MiniCart._escapeHtml(norm.priceFormatted);\r\n    const img = MiniCart._escapeHtml(norm.picture);\r\n    const liHtml = `\r\n      <li class=\"mc-item\" data-id=\"${id}\">\r\n        <div class=\"mc-thumb\"><img src=\"${img}\" alt=\"${name}\" loading=\"lazy\" /></div>\r\n        <div class=\"mc-body\">\r\n          <div class=\"mc-name\">${name}</div>\r\n          <div class=\"mc-meta\">${qty} \u00D7 <span class=\"mc-price\">${price}</span></div>\r\n        </div>\r\n      </li>`;\r\n    return this._createElFromHTML(liHtml);\r\n  }\r\n\r\n  /**\r\n   * \u0423\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0435\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 \u043D\u0430 DOM-\u044D\u043B\u0435\u043C\u0435\u043D\u0442\u044B \u0434\u043B\u044F \u0441\u043F\u0438\u0441\u043A\u0430 \u0438 \u0437\u0430\u0433\u043E\u043B\u043E\u0432\u043A\u0430\r\n   * @param {Object} param0\r\n   * @param {HTMLElement|null} [param0.listEl]\r\n   * @param {HTMLElement|null} [param0.headerTitleEl]\r\n   */\r\n  setDomRefs({ listEl = null, headerTitleEl = null } = {}) {\r\n    if (listEl) {\r\n      this.listEl = listEl;\r\n      try {\r\n        if (!this.listEl.hasAttribute('aria-live')) this.listEl.setAttribute('aria-live', 'polite');\r\n      } catch (e) {}\r\n    }\r\n    if (headerTitleEl) {\r\n      this.headerTitleEl = headerTitleEl;\r\n      try {\r\n        this._headerBase = (this.headerTitleEl.textContent || '').replace(/\\(\\d+\\)$/, '').trim() || this.constructor.UI_MESSAGES.HEADER_BASE;\r\n      } catch (e) {\r\n        this._headerBase = this.constructor.UI_MESSAGES.HEADER_BASE;\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \u0412\u044B\u0447\u0438\u0441\u043B\u044F\u0435\u0442 \u0445\u044D\u0448 \u0434\u043B\u044F \u0432\u0441\u0435\u0433\u043E \u0441\u043F\u0438\u0441\u043A\u0430 \u0442\u043E\u0432\u0430\u0440\u043E\u0432 (id:qty:price|...)\r\n   * @param {Array<any>} cart\r\n   * @returns {string}\r\n   */\r\n  _computeHash(cart) {\r\n    if (!Array.isArray(cart) || cart.length === 0) return '';\r\n    return cart.map((i) => {\r\n      const id = String(i?.name ?? i?.id ?? i?.productId ?? '').trim();\r\n      const qty = String(Number(i?.qty || 0));\r\n      const price = String(Number(i?.price || 0));\r\n      return `${id}:${qty}:${price}`;\r\n    }).join('|');\r\n  }\r\n\r\n  /* ---------- render API ---------- */\r\n\r\n  /**\r\n   * \u041E\u0441\u043D\u043E\u0432\u043D\u0430\u044F \u0442\u043E\u0447\u043A\u0430 \u0432\u0445\u043E\u0434\u0430 \u0434\u043B\u044F \u0440\u0435\u043D\u0434\u0435\u0440\u0430. \u0412\u044B\u0437\u044B\u0432\u0430\u0435\u0442 \u0432\u043D\u0443\u0442\u0440\u0435\u043D\u043D\u0438\u0439 \u043C\u0435\u0442\u043E\u0434 \u0447\u0435\u0440\u0435\u0437 requestAnimationFrame.\r\n   * @param {Array<any>} cart\r\n   * @returns {Promise<void>}\r\n   */\r\n  async render(cart = []) {\r\n    this._latestCart = Array.isArray(cart) ? cart.slice() : [];\r\n    if (this._pendingRaf) return;\r\n    this._pendingRaf = true;\r\n    return new Promise((resolve) => {\r\n      requestAnimationFrame(async () => {\r\n        try {\r\n          await this._doRender(this._latestCart);\r\n        } catch (e) {\r\n          if (this.opts.debug) console.error('MiniCart.render error', e);\r\n        } finally {\r\n          this._pendingRaf = false;\r\n          resolve();\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * \u0412\u044B\u043F\u043E\u043B\u043D\u044F\u0435\u0442 \u0440\u0435\u0430\u043B\u044C\u043D\u044B\u0439 \u0440\u0435\u043D\u0434\u0435\u0440\u0438\u043D\u0433 \u0441\u043F\u0438\u0441\u043A\u0430 \u0442\u043E\u0432\u0430\u0440\u043E\u0432\r\n   * @param {Array<any>} cart\r\n   */\r\n  async _doRender(cart) {\r\n    if (!this.listEl) return;\r\n    const hash = this._computeHash(cart);\r\n    if (hash && hash === this._lastRenderHash) {\r\n      // \u0434\u0430\u0436\u0435 \u0435\u0441\u043B\u0438 \u0441\u0442\u0440\u0443\u043A\u0442\u0443\u0440\u0430 \u043D\u0435 \u0438\u0437\u043C\u0435\u043D\u0438\u043B\u0430\u0441\u044C, \u043E\u0431\u043D\u043E\u0432\u0438\u043C \u0437\u0430\u0433\u043E\u043B\u043E\u0432\u043E\u043A\r\n      this.updateHeader(cart.reduce((s, it) => s + Number(it.qty || 0), 0));\r\n      return;\r\n    }\r\n    this._lastRenderHash = hash;\r\n    // \u043D\u043E\u0440\u043C\u0430\u043B\u0438\u0437\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A\r\n    const normalized = Array.isArray(cart) ? cart.slice() : [];\r\n    // \u043F\u0443\u0441\u0442\u043E\u0435 \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435\r\n    if (!normalized.length) {\r\n      this._elementsMap.clear();\r\n      const li = document.createElement('li');\r\n      li.className = 'mc-item empty';\r\n      const iconCls = MiniCart._escapeHtml(this.opts.emptyIconClass);\r\n      const text = MiniCart._escapeHtml(this.opts.emptyText);\r\n      li.innerHTML = `<div class=\"mc-empty\"><span class=\"mc-empty__icon\"><i class=\"${iconCls}\" aria-hidden=\"true\"></i></span><span class=\"mc-empty__text\">${text}</span></div>`;\r\n      await new Promise((r) => requestAnimationFrame(r));\r\n      try {\r\n        this.listEl.innerHTML = '';\r\n        this.listEl.appendChild(li);\r\n      } catch (e) {\r\n        this.listEl.innerHTML = '';\r\n        this.listEl.appendChild(li);\r\n      }\r\n      this.updateHeader(0);\r\n      return;\r\n    }\r\n    // \u0441\u043E\u0431\u0440\u0430\u0442\u044C \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044E\u0449\u0438\u0435 \u044D\u043B\u0435\u043C\u0435\u043D\u0442\u044B \u0432 \u043A\u0430\u0440\u0442\u0443 (\u043A\u043B\u044E\u0447\u043E\u043C \u0441\u043B\u0443\u0436\u0438\u0442 idKey)\r\n    const existing = new Map();\r\n    for (const child of Array.from(this.listEl.children || [])) {\r\n      try {\r\n        const did = child.getAttribute && (child.getAttribute('data-id') || child.getAttribute('data-cart-item'));\r\n        if (did) existing.set(String(did), child);\r\n      } catch (e) {}\r\n    }\r\n    const frag = document.createDocumentFragment();\r\n    const max = Number.isFinite(Number(this.opts.maxItems)) ? Math.max(1, Number(this.opts.maxItems)) : Infinity;\r\n    let shown = 0;\r\n    let dropped = 0;\r\n    for (let i = 0; i < normalized.length; i++) {\r\n      if (shown >= max) {\r\n        dropped = normalized.length - i;\r\n        break;\r\n      }\r\n      const norm = this._normalizeCartItem(normalized[i] || {});\r\n      if (!norm.idKey) continue;\r\n      const itemHash = this._computeItemHash(norm.idKey, norm.qty, norm.priceNum);\r\n      let node = null;\r\n      // \u043F\u043E\u043F\u0440\u043E\u0431\u043E\u0432\u0430\u0442\u044C \u043F\u0435\u0440\u0435\u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u044C \u0438\u0437 \u043A\u0430\u0440\u0442\u044B\r\n      if (this._elementsMap.has(norm.idKey)) {\r\n        node = this._elementsMap.get(norm.idKey);\r\n        try {\r\n          const storedHash = node.getAttribute && node.getAttribute('data-mc-hash');\r\n          if (storedHash === itemHash) {\r\n            existing.delete(norm.idKey);\r\n            frag.appendChild(node);\r\n            shown++;\r\n            continue;\r\n          }\r\n        } catch (e) {\r\n          // \u0438\u0433\u043D\u043E\u0440\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0438 \u043F\u0435\u0440\u0435\u043E\u0442\u0440\u0438\u0441\u043E\u0432\u0430\u0442\u044C\r\n        }\r\n      }\r\n      // \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u043D\u043E\u0432\u044B\u0439 \u0443\u0437\u0435\u043B \u0447\u0435\u0440\u0435\u0437 renderer (\u0435\u0441\u043B\u0438 \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D)\r\n      let produced = null;\r\n      if (this.renderer && typeof this.renderer._createMiniCartItemHTML === 'function') {\r\n        try {\r\n          const out = await this.renderer._createMiniCartItemHTML(normalized[i], this.renderer.foxEngine);\r\n          if (typeof out === 'string') {\r\n            produced = this._createElFromHTML(out) || null;\r\n          } else if (out instanceof Element) {\r\n            produced = out.cloneNode(true);\r\n          } else if (out instanceof DocumentFragment) {\r\n            produced = out.firstElementChild ? out.firstElementChild.cloneNode(true) : null;\r\n          }\r\n        } catch (e) {\r\n          if (this.opts.debug) console.warn('MiniCart: renderer item failed', e);\r\n          produced = null;\r\n        }\r\n      }\r\n      // fallback\r\n      if (!produced) {\r\n        produced = this._renderFallbackItem(norm);\r\n      }\r\n      if (!produced) continue;\r\n      // \u043F\u0440\u0438\u0441\u0432\u043E\u0438\u0442\u044C \u0430\u0442\u0440\u0438\u0431\u0443\u0442\u044B \u0438 \u043A\u0435\u0448\u0438\u0440\u043E\u0432\u0430\u0442\u044C\r\n      try {\r\n        produced.setAttribute('data-id', String(norm.idKey));\r\n        produced.setAttribute('data-mc-hash', itemHash);\r\n      } catch (e) {}\r\n      try {\r\n        this._elementsMap.set(norm.idKey, produced);\r\n      } catch (e) {}\r\n      frag.appendChild(produced);\r\n      shown++;\r\n    }\r\n    // \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C summary \u0435\u0441\u043B\u0438 \u0435\u0441\u0442\u044C \u043E\u0442\u0431\u0440\u043E\u0448\u0435\u043D\u043D\u044B\u0435\r\n    if (dropped > 0) {\r\n      const summary = document.createElement('li');\r\n      summary.className = 'mc-item mc-summary';\r\n      const plural = dropped > 1 ? '\u043E\u0432' : '';\r\n      summary.innerHTML = this._msg('SUMMARY_MORE', { n: dropped, plural });\r\n      frag.appendChild(summary);\r\n    }\r\n    // \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u043B\u0438\u0448\u043D\u0438\u0435 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044E\u0449\u0438\u0435 \u0443\u0437\u043B\u044B\r\n    for (const [did, node] of existing.entries()) {\r\n      try {\r\n        if (node && node.parentNode) node.parentNode.removeChild(node);\r\n      } catch (e) {}\r\n      try {\r\n        this._elementsMap.delete(did);\r\n      } catch (_) {}\r\n    }\r\n    // \u0437\u0430\u043C\u0435\u043D\u0438\u0442\u044C DOM \u0437\u0430 \u043E\u0434\u0438\u043D \u043A\u0430\u0434\u0440\r\n    await new Promise((r) => requestAnimationFrame(r));\r\n    try {\r\n      this.listEl.innerHTML = '';\r\n      this.listEl.appendChild(frag);\r\n    } catch (e) {\r\n      try {\r\n        const tmp = document.createElement('div');\r\n        tmp.appendChild(frag.cloneNode(true));\r\n        this.listEl.innerHTML = tmp.innerHTML;\r\n      } catch (_) {\r\n        this.listEl.innerHTML = '';\r\n      }\r\n    }\r\n    // \u043E\u0431\u043D\u043E\u0432\u0438\u0442\u044C \u0437\u0430\u0433\u043E\u043B\u043E\u0432\u043E\u043A\r\n    this.updateHeader(normalized.reduce((s, it) => s + Number(it.qty || 0), 0));\r\n  }\r\n\r\n  /**\r\n   * \u041E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u0442 \u0442\u0435\u043A\u0441\u0442 \u0437\u0430\u0433\u043E\u043B\u043E\u0432\u043A\u0430 \u0441 \u0443\u0447\u0451\u0442\u043E\u043C \u043E\u0431\u0449\u0435\u0433\u043E \u043A\u043E\u043B\u0438\u0447\u0435\u0441\u0442\u0432\u0430\r\n   * @param {number} totalCount\r\n   */\r\n  updateHeader(totalCount) {\r\n    if (!this.headerTitleEl) return;\r\n    try {\r\n      if (!this._headerBase) {\r\n        this._headerBase = (this.headerTitleEl.textContent || '').replace(/\\(\\d+\\)$/, '').trim() || this.constructor.UI_MESSAGES.HEADER_BASE;\r\n      }\r\n      this.headerTitleEl.textContent = `${this._headerBase} (${Number(totalCount)})`;\r\n      this.headerTitleEl.setAttribute && this.headerTitleEl.setAttribute('aria-live', 'polite');\r\n    } catch (e) {\r\n      if (this.opts.debug) console.warn('MiniCart.updateHeader failed', e);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \u041E\u0447\u0438\u0449\u0430\u0435\u0442 \u0432\u0441\u0435 \u0432\u043D\u0443\u0442\u0440\u0435\u043D\u043D\u0438\u0435 \u0441\u0441\u044B\u043B\u043A\u0438 \u0438 \u043A\u0435\u0448\u0438\r\n   */\r\n  destroy() {\r\n    try {\r\n      this._elementsMap.clear();\r\n      this.listEl = null;\r\n      this.headerTitleEl = null;\r\n      this.renderer = null;\r\n      this.notifications = null;\r\n      this._lastRenderHash = '';\r\n      this._headerBase = null;\r\n      this._latestCart = null;\r\n      this._pendingRaf = false;\r\n    } catch (e) {\r\n      if (this.opts.debug) console.warn('MiniCart.destroy failed', e);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \u0423\u0434\u0430\u043B\u044F\u0435\u0442 \u0442\u043E\u0432\u0430\u0440 \u0438\u0437 \u043C\u0438\u043D\u0438\u2011\u043A\u043E\u0440\u0437\u0438\u043D\u044B \u043F\u043E \u0438\u0434\u0435\u043D\u0442\u0438\u0444\u0438\u043A\u0430\u0442\u043E\u0440\u0443.\r\n   * \u042D\u0442\u043E\u0442 \u043C\u0435\u0442\u043E\u0434 \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u0442 \u0432\u043D\u0443\u0442\u0440\u0435\u043D\u043D\u0438\u0439 \u0441\u043F\u0438\u0441\u043E\u043A, \u0438\u043D\u0438\u0446\u0438\u0438\u0440\u0443\u0435\u0442 \u043F\u0435\u0440\u0435\u0440\u0438\u0441\u043E\u0432\u043A\u0443\r\n   * \u0438 \u0432\u043E\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u0442 true, \u0435\u0441\u043B\u0438 \u044D\u043B\u0435\u043C\u0435\u043D\u0442 \u0431\u044B\u043B \u043D\u0430\u0439\u0434\u0435\u043D \u0438 \u0443\u0434\u0430\u043B\u0451\u043D. \u0412\u043D\u0443\u0442\u0440\u0435\u043D\u043D\u044F\u044F\r\n   * \u043A\u043E\u043B\u043B\u0435\u043A\u0446\u0438\u044F _latestCart \u0445\u0440\u0430\u043D\u0438\u0442 \u043F\u043E\u0441\u043B\u0435\u0434\u043D\u044E\u044E \u043F\u0435\u0440\u0435\u0434\u0430\u043D\u043D\u0443\u044E \u043A\u043E\u0440\u0437\u0438\u043D\u0443; \u0435\u0441\u043B\u0438\r\n   * \u043E\u043D\u0430 \u043D\u0435 \u043E\u043F\u0440\u0435\u0434\u0435\u043B\u0435\u043D\u0430, \u043C\u0435\u0442\u043E\u0434 \u043D\u0438\u0447\u0435\u0433\u043E \u043D\u0435 \u0434\u0435\u043B\u0430\u0435\u0442. \u0422\u0430\u043A\u043E\u0439 \u043F\u043E\u0434\u0445\u043E\u0434\r\n   * \u043F\u043E\u0437\u0432\u043E\u043B\u044F\u0435\u0442 \u0443\u0434\u0430\u043B\u044F\u0442\u044C \u044D\u043B\u0435\u043C\u0435\u043D\u0442\u044B \u0438\u0437 \u043C\u0438\u043D\u0438\u2011\u043A\u043E\u0440\u0437\u0438\u043D\u044B \u0431\u0435\u0437 \u043D\u0435\u043E\u0431\u0445\u043E\u0434\u0438\u043C\u043E\u0441\u0442\u0438\r\n   * \u043D\u0430\u043F\u0440\u044F\u043C\u0443\u044E \u0432\u0437\u0430\u0438\u043C\u043E\u0434\u0435\u0439\u0441\u0442\u0432\u043E\u0432\u0430\u0442\u044C \u0441 \u043C\u0435\u043D\u0435\u0434\u0436\u0435\u0440\u043E\u043C \u043A\u043E\u0440\u0437\u0438\u043D\u044B.\r\n   *\r\n   * @param {any} id \u0418\u0434\u0435\u043D\u0442\u0438\u0444\u0438\u043A\u0430\u0442\u043E\u0440 \u0442\u043E\u0432\u0430\u0440\u0430 (name/id/productId)\r\n   * @returns {boolean} true, \u0435\u0441\u043B\u0438 \u044D\u043B\u0435\u043C\u0435\u043D\u0442 \u0431\u044B\u043B \u0443\u0434\u0430\u043B\u0451\u043D, \u0438\u043D\u0430\u0447\u0435 false\r\n   */\r\n  removeCartItemById(id) {\r\n    const idStr = String(id ?? '').trim();\r\n    if (!idStr) return false;\r\n    // \u0415\u0441\u043B\u0438 \u043D\u0435\u0442 \u0441\u043E\u0445\u0440\u0430\u043D\u0451\u043D\u043D\u043E\u0439 \u043A\u043E\u0440\u0437\u0438\u043D\u044B, \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u043D\u0435\u0432\u043E\u0437\u043C\u043E\u0436\u043D\u043E\r\n    if (!Array.isArray(this._latestCart)) return false;\r\n    // \u041F\u043E\u0438\u0441\u043A \u0442\u043E\u0432\u0430\u0440\u0430 \u043F\u043E \u0438\u0434\u0435\u043D\u0442\u0438\u0444\u0438\u043A\u0430\u0442\u043E\u0440\u0443\r\n    const normalize = (it) => String(it?.name ?? it?.id ?? it?.productId ?? '').trim();\r\n    const index = this._latestCart.findIndex((it) => normalize(it) === idStr);\r\n    if (index < 0) return false;\r\n    // \u0423\u0434\u0430\u043B\u044F\u0435\u043C \u0438\u0437 \u043C\u0430\u0441\u0441\u0438\u0432\u0430\r\n    this._latestCart.splice(index, 1);\r\n    // \u0423\u0434\u0430\u043B\u044F\u0435\u043C \u043A\u0435\u0448\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 DOM-\u044D\u043B\u0435\u043C\u0435\u043D\u0442 (\u0435\u0441\u043B\u0438 \u0435\u0441\u0442\u044C)\r\n    try {\r\n      if (this._elementsMap.has(idStr)) {\r\n        const el = this._elementsMap.get(idStr);\r\n        if (el && el.parentNode) el.parentNode.removeChild(el);\r\n        this._elementsMap.delete(idStr);\r\n      }\r\n    } catch (_) {}\r\n    // \u0418\u043D\u0438\u0446\u0438\u0438\u0440\u0443\u0435\u043C \u043F\u0435\u0440\u0435\u0440\u0438\u0441\u043E\u0432\u043A\u0443\r\n    // \u041F\u043E\u0441\u043B\u0435 \u0443\u0434\u0430\u043B\u0435\u043D\u0438\u044F \u0445\u044D\u0448 \u0431\u043E\u043B\u044C\u0448\u0435 \u043D\u0435 \u0441\u043E\u0432\u043F\u0430\u0434\u0451\u0442, \u043F\u043E\u044D\u0442\u043E\u043C\u0443 _lastRenderHash \u043C\u043E\u0436\u0435\u0442 \u0431\u044B\u0442\u044C \u0441\u0431\u0440\u043E\u0448\u0435\u043D\r\n    this._lastRenderHash = '';\r\n    this.render(this._latestCart);\r\n    return true;\r\n  }\r\n}", "// Cart/CartBase.js\r\n\r\n/**\r\n * CartBase \u2014 \u00AB\u044F\u0434\u0440\u043E\u00BB \u043A\u043E\u0440\u0437\u0438\u043D\u044B \u0431\u0435\u0437 DOM:\r\n *  - \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0438 \u0438\u043D\u0434\u0435\u043A\u0441\r\n *  - \u043D\u043E\u0440\u043C\u0430\u043B\u0438\u0437\u0430\u0446\u0438\u044F id\r\n *  - \u0440\u0430\u0431\u043E\u0442\u0430 \u0441 storage \u0438 productService\r\n *  - \u0431\u0438\u0437\u043D\u0435\u0441-\u043B\u043E\u0433\u0438\u043A\u0430 add/remove/changeQty\r\n */\r\nexport class CartBase {\r\n  static UI_MESSAGES = Object.freeze({});\r\n\r\n  constructor({ storage, productService, notifications, favorites = null, opts = {} }) {\r\n    this.storage = storage;\r\n    this.productService = productService;\r\n    this.notifications = notifications;\r\n    this.favorites = favorites;\r\n\r\n    this.opts = Object.assign(\r\n      {\r\n        saveDebounceMs: 200,\r\n        debug: false,\r\n        parallelProductFetch: true,\r\n        productFetchBatchSize: 20,\r\n        stockCacheTTL: 5000\r\n      },\r\n      opts || {}\r\n    );\r\n\r\n    this.cart = [];\r\n    this._idIndex = new Map(); // id -> index\r\n    this._pendingChangedIds = new Set();\r\n    this._saveTimeout = null;\r\n\r\n    // \u0441\u043B\u0443\u0436\u0435\u0431\u043D\u043E\u0435\r\n    this._rowsSyncing = new WeakSet();\r\n    this._changeSourceMap = new Map();\r\n\r\n    this._cssEscape =\r\n      typeof CSS !== 'undefined' && typeof CSS.escape === 'function'\r\n        ? CSS.escape\r\n        : (s) => String(s).replace(/[\"\\\\]/g, '\\\\$&');\r\n  }\r\n\r\n  // --- logging / i18n ------------------------------------------------------\r\n\r\n  _logError(...args) {\r\n    if (this.opts.debug) console.error('[CartModule]', ...args);\r\n  }\r\n\r\n  _msg(key, vars = {}) {\r\n    const pool = (this.constructor && this.constructor.UI_MESSAGES) || {};\r\n    const tpl = pool[key] ?? '';\r\n    return String(tpl).replace(/\\{([^}]+)\\}/g, (m, k) =>\r\n      Object.prototype.hasOwnProperty.call(vars, k) ? String(vars[k]) : m\r\n    );\r\n  }\r\n\r\n  // --- Id normalization & index management ---------------------------------\r\n\r\n  _normalizeId(id) {\r\n    if (id === undefined || id === null) return '';\r\n    if (typeof id === 'object') {\r\n      return String(\r\n        id.id ??\r\n          id.name ??\r\n          id.productId ??\r\n          id.cartId ??\r\n          id.itemId ??\r\n          ''\r\n      ).trim();\r\n    }\r\n    return String(id).trim();\r\n  }\r\n\r\n  _normalizeIdKey(id) {\r\n    return String(this._normalizeId(id));\r\n  }\r\n\r\n  _rebuildIndex() {\r\n    this._idIndex.clear();\r\n    for (let i = 0; i < this.cart.length; i++) {\r\n      const key = this._normalizeIdKey(this.cart[i].name);\r\n      if (key) this._idIndex.set(key, i);\r\n    }\r\n  }\r\n\r\n  getCartItems() {\r\n    return this.cart;\r\n  }\r\n\r\n  _updateIndexOnInsert(id, index) {\r\n    try {\r\n      const key = this._normalizeIdKey(id);\r\n      if (!key) return;\r\n      for (const [k, idx] of Array.from(this._idIndex.entries())) {\r\n        if (idx >= index) this._idIndex.set(k, idx + 1);\r\n      }\r\n      this._idIndex.set(key, index);\r\n    } catch (e) {\r\n      this._rebuildIndex();\r\n    }\r\n  }\r\n\r\n  _updateIndexOnRemove(index) {\r\n    try {\r\n      if (index === undefined || index === null) {\r\n        this._rebuildIndex();\r\n        return;\r\n      }\r\n      let removedKey = null;\r\n      for (const [k, idx] of Array.from(this._idIndex.entries())) {\r\n        if (idx === index) {\r\n          removedKey = k;\r\n          break;\r\n        }\r\n      }\r\n      if (removedKey) this._idIndex.delete(removedKey);\r\n      for (const [k, idx] of Array.from(this._idIndex.entries())) {\r\n        if (idx > index) this._idIndex.set(k, idx - 1);\r\n      }\r\n    } catch (e) {\r\n      this._rebuildIndex();\r\n    }\r\n  }\r\n\r\n  _findCartIndexById(id) {\r\n    const sid = this._normalizeIdKey(id);\r\n    if (!sid) return -1;\r\n    const idx = this._idIndex.get(sid);\r\n    if (\r\n      typeof idx === 'number' &&\r\n      this.cart[idx] &&\r\n      this._normalizeIdKey(this.cart[idx].name) === sid\r\n    )\r\n      return idx;\r\n    // fallback\r\n    for (let i = 0; i < this.cart.length; i++) {\r\n      if (this._normalizeIdKey(this.cart[i].name) === sid) {\r\n        this._rebuildIndex();\r\n        return i;\r\n      }\r\n    }\r\n    return -1;\r\n  }\r\n\r\n  _getCartItemById(id) {\r\n    const idx = this._findCartIndexById(id);\r\n    return idx >= 0 ? this.cart[idx] : null;\r\n  }\r\n\r\n  _getCartQtyById(id) {\r\n    const it = this._getCartItemById(id);\r\n    return it ? Number(it.qty || 0) : 0;\r\n  }\r\n\r\n  _formatPrice(value) {\r\n    try {\r\n      return Intl.NumberFormat('ru-RU', {\r\n        style: 'currency',\r\n        currency: 'RUB'\r\n      }).format(Number(value || 0));\r\n    } catch (e) {\r\n      return String(value || '0');\r\n    }\r\n  }\r\n\r\n  _noteChangedId(id) {\r\n    const k = this._normalizeIdKey(id);\r\n    if (k) this._pendingChangedIds.add(k);\r\n  }\r\n\r\n  _clearPendingChanged() {\r\n    this._pendingChangedIds.clear();\r\n  }\r\n\r\n  _scheduleSave() {\r\n    if (!this.storage || typeof this.storage.saveCart !== 'function') return;\r\n    if (this._saveTimeout) clearTimeout(this._saveTimeout);\r\n    this._saveTimeout = setTimeout(() => {\r\n      try {\r\n        this.storage.saveCart(this.cart);\r\n      } catch (e) {\r\n        this._logError('saveCart failed', e);\r\n      }\r\n      this._saveTimeout = null;\r\n    }, Math.max(0, Number(this.opts.saveDebounceMs || 200)));\r\n  }\r\n\r\n  _emitUpdateEvent() {\r\n    try {\r\n      const totalCount = this.cart.reduce(\r\n        (s, it) => s + Number(it.qty || 0),\r\n        0\r\n      );\r\n      const totalSum = this.cart.reduce(\r\n        (s, it) =>\r\n          s + Number(it.price || 0) * Number(it.qty || 0),\r\n        0\r\n      );\r\n      const changedIds = Array.from(this._pendingChangedIds);\r\n      this._pendingChangedIds.clear();\r\n      const ev = new CustomEvent('cart:updated', {\r\n        detail: {\r\n          cart: this.cart.slice(),\r\n          totalCount,\r\n          totalSum,\r\n          changedIds\r\n        }\r\n      });\r\n      window.dispatchEvent(ev);\r\n    } catch (e) {\r\n      this._logError('emitUpdateEvent failed', e);\r\n    }\r\n  }\r\n\r\n  // --- product resolution helpers -----------------------------------------\r\n\r\n  _isThenable(v) {\r\n    return v && typeof v.then === 'function';\r\n  }\r\n\r\n  /**\r\n   * Try to get product via productService.findById.\r\n   * Returns either the product (sync) or a Promise that resolves to product or null.\r\n   */\r\n  _resolveProduct(id) {\r\n    try {\r\n      const svc = this.productService;\r\n      if (!svc || typeof svc.findById !== 'function') return null;\r\n      const out = svc.findById(id);\r\n      return out;\r\n    } catch (e) {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  _mergeProductToItem(item, prod, qtyAdjust = true) {\r\n    if (!item || !prod) return item;\r\n    item.price = Number(prod.price ?? item.price ?? 0);\r\n    item.stock = Number(prod.stock ?? item.stock ?? 0);\r\n    item.fullname =\r\n      prod.fullname ??\r\n      prod.title ??\r\n      prod.name ??\r\n      item.fullname;\r\n    item.picture =\r\n      prod.picture ?? prod.image ?? item.picture;\r\n    item.specs = prod.specs ?? item.specs ?? {};\r\n    if (\r\n      qtyAdjust &&\r\n      Number.isFinite(item.stock) &&\r\n      item.stock >= 0 &&\r\n      item.qty > item.stock\r\n    ) {\r\n      item.qty = Math.max(1, item.stock);\r\n      this._noteChangedId(item.name);\r\n    }\r\n    return item;\r\n  }\r\n\r\n  _normalizeCartItemFromProduct(prod, qty = 1) {\r\n    return {\r\n      name: this._normalizeId(\r\n        prod.name ??\r\n          prod.id ??\r\n          prod.title ??\r\n          prod.fullname ??\r\n          prod.productId ??\r\n          ''\r\n      ),\r\n      fullname:\r\n        prod.fullname ??\r\n        prod.title ??\r\n        prod.name ??\r\n        prod.productName ??\r\n        '',\r\n      price: Number(prod.price || 0),\r\n      qty: Number(qty || 1),\r\n      picture: prod.picture || prod.image || '',\r\n      stock: Number(prod.stock || 0),\r\n      specs: prod.specs || {}\r\n    };\r\n  }\r\n\r\n  // --- storage load --------------------------------------------------------\r\n\r\n  async loadFromStorage() {\r\n    let raw = [];\r\n    try {\r\n      raw = await (this.storage?.loadCartWithAvailability?.() ?? []);\r\n    } catch (e) {\r\n      this._logError('loadFromStorage: storage.loadCart failed', e);\r\n      raw = [];\r\n    }\r\n\r\n    this.cart = (Array.isArray(raw) ? raw : [])\r\n      .map((entry) => {\r\n        if (!entry) return null;\r\n        const name = this._normalizeId(\r\n          entry.name ??\r\n            entry.id ??\r\n            entry.title ??\r\n            entry.fullname ??\r\n            entry.productId ??\r\n            entry.cartId ??\r\n            ''\r\n        );\r\n        let qty = Number(entry.qty ?? entry.quantity ?? 1);\r\n        if (!Number.isFinite(qty) || qty < 1) qty = 1;\r\n\r\n        let syncProd = null;\r\n        try {\r\n          syncProd =\r\n            this.productService &&\r\n            typeof this.productService.findById === 'function'\r\n              ? this.productService.findById(name)\r\n              : null;\r\n        } catch (e) {\r\n          syncProd = null;\r\n        }\r\n        if (this._isThenable(syncProd)) syncProd = null;\r\n\r\n        if (syncProd) {\r\n          const stock = Number(syncProd.stock || 0);\r\n          if (stock > 0) qty = Math.min(qty, stock);\r\n          return this._normalizeCartItemFromProduct(syncProd, qty);\r\n        }\r\n\r\n        return {\r\n          name,\r\n          fullname:\r\n            entry.fullname ||\r\n            entry.title ||\r\n            entry.name ||\r\n            entry.productName ||\r\n            '\u0422\u043E\u0432\u0430\u0440',\r\n          price: Number(entry.price ?? 0),\r\n          qty,\r\n          picture:\r\n            entry.picture ||\r\n            entry.image ||\r\n            '/assets/no-image.png',\r\n          stock: Number(entry.stock ?? 0),\r\n          specs: entry.specs || {}\r\n        };\r\n      })\r\n      .filter(Boolean);\r\n\r\n    this._dedupeCart();\r\n    this._rebuildIndex();\r\n    for (const i of this.cart) this._noteChangedId(i.name);\r\n    // \u0441\u0430\u043C UI-\u0440\u0435\u043D\u0434\u0435\u0440 \u0434\u0435\u043B\u0430\u0435\u0442\u0441\u044F \u0432 CartUI.updateCartUI\r\n  }\r\n\r\n  // --- public mutations: add / remove / changeQty --------------------------\r\n\r\n  add(productId, qty = 1) {\r\n    try {\r\n      const id = this._normalizeId(productId);\r\n      if (!id) {\r\n        this._logError('add: empty productId', productId);\r\n        return false;\r\n      }\r\n\r\n      const prod = this._resolveProduct(id);\r\n      if (this._isThenable(prod)) {\r\n        // optimistic add placeholder \u2014 \u0431\u0443\u0434\u0435\u0442 \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0438\u0440\u043E\u0432\u0430\u043D \u0432 updateCartUI\r\n        return this._addRawEntry(id, qty, null);\r\n      }\r\n      return this._addRawEntry(id, qty, prod ?? null);\r\n    } catch (e) {\r\n      this._logError('add failed', e);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  _addRawEntry(id, qty, prod) {\r\n    qty = Math.max(1, parseInt(qty || 1, 10));\r\n    const key = this._normalizeId(id);\r\n    if (!key) return false;\r\n\r\n    if (prod) {\r\n      const stock = Number(prod.stock || 0);\r\n      if (stock <= 0) {\r\n        this.notifications?.show?.(this._msg('NOT_ENOUGH_STOCK'), {\r\n          type: 'warning'\r\n        });\r\n        return false;\r\n      }\r\n      if (qty > stock) {\r\n        this.notifications?.show?.(\r\n          this._msg('ONLY_X_LEFT', { stock }),\r\n          { type: 'warning' }\r\n        );\r\n        qty = stock;\r\n      }\r\n    }\r\n\r\n    const idx = this._findCartIndexById(key);\r\n    if (idx >= 0) {\r\n      const existing = this.cart[idx];\r\n      const proposed = existing.qty + qty;\r\n      const maxAllowed = prod\r\n        ? Number(prod.stock || existing.stock || 0)\r\n        : Number(existing.stock || 0);\r\n      if (maxAllowed > 0 && proposed > maxAllowed) {\r\n        this.notifications?.show?.(\r\n          this._msg('INSUFFICIENT_STOCK_ADD', {\r\n            max: maxAllowed\r\n          }),\r\n          { type: 'warning' }\r\n        );\r\n        return false;\r\n      }\r\n      existing.qty = proposed;\r\n      this._noteChangedId(key);\r\n    } else {\r\n      if (prod) {\r\n        const item = this._normalizeCartItemFromProduct(prod, qty);\r\n        this.cart.push(item);\r\n        this._updateIndexOnInsert(item.name, this.cart.length - 1);\r\n        this._noteChangedId(item.name);\r\n      } else {\r\n        const item = {\r\n          name: key,\r\n          fullname: key,\r\n          price: 0,\r\n          qty,\r\n          picture: '/assets/no-image.png',\r\n          stock: 0,\r\n          specs: {}\r\n        };\r\n        this.cart.push(item);\r\n        this._updateIndexOnInsert(item.name, this.cart.length - 1);\r\n        this._noteChangedId(item.name);\r\n      }\r\n    }\r\n\r\n    return true; // UI \u043E\u0431\u043D\u043E\u0432\u0438\u0442 CartUI.updateCartUI\r\n  }\r\n\r\n  remove(productId) {\r\n    const key = this._normalizeId(productId);\r\n    const idx = this._findCartIndexById(key);\r\n    if (idx >= 0) {\r\n      this._noteChangedId(key);\r\n      this.cart.splice(idx, 1);\r\n      this._updateIndexOnRemove(idx);\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  changeQty(productId, newQty, opts = {}) {\r\n    try {\r\n      const key = this._normalizeId(productId);\r\n      const idx = this._findCartIndexById(key);\r\n      if (idx < 0) return false;\r\n      let qty = parseInt(newQty || 1, 10);\r\n      if (isNaN(qty) || qty < 1) qty = 1;\r\n\r\n      const item = this.cart[idx];\r\n      const prod = this._resolveProduct(key);\r\n\r\n      if (this._isThenable(prod)) {\r\n        item.qty = qty; // optimistic\r\n      } else if (prod) {\r\n        const stock = Number(prod.stock || item.stock || 0);\r\n        if (stock > 0 && qty > stock) {\r\n          this.notifications?.show?.(\r\n            this._msg('INSUFFICIENT_STOCK_CHANGEQTY', {\r\n              stock\r\n            }),\r\n            { type: 'warning' }\r\n          );\r\n          qty = stock;\r\n        }\r\n        item.qty = qty;\r\n      } else {\r\n        item.qty = qty;\r\n      }\r\n\r\n      try {\r\n        if (opts && opts.sourceRow instanceof Element) {\r\n          this._changeSourceMap.set(\r\n            this._normalizeIdKey(key),\r\n            opts.sourceRow\r\n          );\r\n        }\r\n      } catch (_) {}\r\n\r\n      this._noteChangedId(key);\r\n      return true;\r\n    } catch (e) {\r\n      this._logError('changeQty failed', e);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  getCart() {\r\n    return this.cart.map((i) => Object.assign({}, i));\r\n  }\r\n\r\n  _dedupeCart() {\r\n    if (!Array.isArray(this.cart) || this.cart.length < 2) return;\r\n    const map = new Map();\r\n    for (const item of this.cart) {\r\n      const key = this._normalizeIdKey(item && item.name);\r\n      if (!key) continue;\r\n      if (!map.has(key)) {\r\n        map.set(key, Object.assign({}, item));\r\n      } else {\r\n        const existing = map.get(key);\r\n        existing.qty =\r\n          Number(existing.qty || 0) + Number(item.qty || 0);\r\n        if (item.price || item.price === 0)\r\n          existing.price = Number(item.price);\r\n        if (item.picture) existing.picture = item.picture;\r\n        if (item.fullname) existing.fullname = item.fullname;\r\n        if (Number.isFinite(Number(item.stock)))\r\n          existing.stock = Number(item.stock);\r\n        existing.specs = Object.assign(\r\n          {},\r\n          existing.specs || {},\r\n          item.specs || {}\r\n        );\r\n      }\r\n    }\r\n    const merged = Array.from(map.values()).map((it) => {\r\n      if (\r\n        Number.isFinite(it.stock) &&\r\n        it.stock >= 0 &&\r\n        Number(it.qty) > it.stock\r\n      ) {\r\n        it.qty = Math.max(1, it.stock);\r\n      } else {\r\n        it.qty = Math.max(1, Number(it.qty || 1));\r\n      }\r\n      return it;\r\n    });\r\n    this.cart = merged;\r\n    this._rebuildIndex();\r\n  }\r\n\r\n  /**\r\n   * \u041F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u0442 \u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E\u0441\u0442\u044C \u0442\u043E\u0432\u0430\u0440\u0430 \u043F\u043E \u0435\u0433\u043E item.\r\n   */\r\n  isAvailable(item) {\r\n    const stock = Number(item.stock);\r\n    const qtyInCart = this._getCartQtyById(item.name);\r\n    return stock > 0 && qtyInCart < stock;\r\n  }\r\n\r\n  // --- utilities for tests / reset / destroy -------------------------------\r\n\r\n  clear() {\r\n    for (const i of this.cart) this._noteChangedId(i.name);\r\n    this.cart = [];\r\n    this._rebuildIndex();\r\n  }\r\n\r\n  _setCartForTest(cartArray) {\r\n    this.cart = Array.isArray(cartArray)\r\n      ? cartArray.map((i) => Object.assign({}, i))\r\n      : [];\r\n    this._rebuildIndex();\r\n    this.cart.forEach((i) => this._noteChangedId(i.name));\r\n  }\r\n\r\n  _destroyBase() {\r\n    if (this._saveTimeout) {\r\n      clearTimeout(this._saveTimeout);\r\n      this._saveTimeout = null;\r\n      try {\r\n        if (this.storage?.saveCart) this.storage.saveCart(this.cart);\r\n      } catch (e) {\r\n        this._logError('final save failed on destroy', e);\r\n      }\r\n    }\r\n  }\r\n}\r\n", "// Cart/CartUI.js\r\n\r\nimport { MiniCart } from './MiniCart.js';\r\nimport { CartBase } from './CartBase.js';\r\n\r\n/**\r\n * CartUI \u2014 UI-\u043D\u0430\u0434\u0441\u0442\u0440\u043E\u0439\u043A\u0430 \u043D\u0430\u0434 CartBase:\r\n *  - DOM-refs\r\n *  - miniCart\r\n *  - updateCartUI\r\n *  - \u043B\u0438\u0441\u0442\u0435\u043D\u0435\u0440\u044B \u0433\u0440\u0438\u0434\u0430\r\n */\r\nexport class CartUI extends CartBase {\r\n  constructor({ storage, productService, renderer, notifications, favorites = null, opts = {} }) {\r\n    super({ storage, productService, notifications, favorites, opts });\r\n\r\n    this.renderer = renderer;\r\n\r\n    // DOM refs\r\n    this.headerCartNum = null;\r\n    this.mobileCartNum = null;\r\n    this.cartGrid = null;\r\n    this.cartCountInline = null;\r\n    this.cartTotal = null;\r\n    this.miniCartTotal = null;\r\n\r\n    this.miniCart = new MiniCart({\r\n      renderer: this.renderer,\r\n      notifications: this.notifications,\r\n      opts: opts.miniCart || {}\r\n    });\r\n\r\n    // grid listeners\r\n    this._gridHandler = null;\r\n    this._gridInputHandler = null;\r\n    this._gridListenersAttachedTo = null;\r\n  }\r\n\r\n  // ---------------------------------------------------------------------------\r\n  // DOM refs\r\n  // ---------------------------------------------------------------------------\r\n\r\n  setDomRefs({\r\n    headerCartNum,\r\n    mobileCartNum,\r\n    miniCartList,\r\n    miniCartHeaderTitle,\r\n    cartGrid,\r\n    cartCountInline,\r\n    cartTotal,\r\n    miniCartTotal\r\n  } = {}) {\r\n    this.headerCartNum = headerCartNum || this.headerCartNum;\r\n    this.mobileCartNum = mobileCartNum || this.mobileCartNum;\r\n    this.cartGrid = cartGrid || this.cartGrid;\r\n    this.cartCountInline = cartCountInline || this.cartCountInline;\r\n    this.cartTotal = cartTotal || this.cartTotal;\r\n    this.miniCartTotal = miniCartTotal || this.miniCartTotal;\r\n\r\n    if (miniCartList || miniCartHeaderTitle) {\r\n      this.miniCart.setDomRefs({\r\n        listEl: miniCartList,\r\n        headerTitleEl: miniCartHeaderTitle\r\n      });\r\n    }\r\n\r\n    if (this.cartGrid) this._attachGridListeners();\r\n  }\r\n\r\n  // ---------------------------------------------------------------------------\r\n  // \u0412\u0441\u043F\u043E\u043C\u043E\u0433\u0430\u0442\u0435\u043B\u044C\u043D\u044B\u0435 \u043C\u0435\u0442\u043E\u0434\u044B \u0434\u043B\u044F \u0440\u0435\u043D\u0434\u0435\u0440\u0438\u043D\u0433\u0430\r\n  // ---------------------------------------------------------------------------\r\n\r\n  _hasGridRenderer() {\r\n    return !!(this.cartGrid && this.renderer);\r\n  }\r\n\r\n  async _renderItemsToTemp(items) {\r\n    const tmp = document.createElement('div');\r\n    if (typeof this.renderer.renderCards === 'function') {\r\n      await this.renderer.renderCards(tmp, items, this.renderer.foxEngine);\r\n    } else if (typeof this.renderer._renderCartHorizontal === 'function') {\r\n      await this.renderer._renderCartHorizontal(tmp, items);\r\n    } else {\r\n      throw new Error('renderer API missing render function');\r\n    }\r\n    return tmp;\r\n  }\r\n\r\n  async _renderFullGrid() {\r\n    if (!this._hasGridRenderer()) return;\r\n    if (typeof this.renderer._renderCartHorizontal !== 'function') return;\r\n\r\n    await this.renderer._renderCartHorizontal(this.cartGrid, this.cart);\r\n    this._attachGridListeners();\r\n  }\r\n\r\n  _findRowFromElement(el) {\r\n    if (!el) return null;\r\n    let node = el;\r\n    while (node && node !== document.documentElement) {\r\n      if (node.classList && node.classList.contains('cart-item')) return node;\r\n      node = node.parentElement;\r\n    }\r\n    return null;\r\n  }\r\n\r\n  _getIdFromRow(row) {\r\n    if (!row) return '';\r\n    try {\r\n      let id =\r\n        row.getAttribute &&\r\n        (row.getAttribute('data-id') || row.getAttribute('data-cart-item'));\r\n      if (id) return this._normalizeIdKey(id);\r\n\r\n      const qc = row.querySelector && row.querySelector('.qty-controls[data-id]');\r\n      if (qc) return this._normalizeIdKey(qc.getAttribute('data-id'));\r\n\r\n      const rb = row.querySelector && row.querySelector('.remove-btn[data-id]');\r\n      if (rb) return this._normalizeIdKey(rb.getAttribute('data-id'));\r\n\r\n      const a = row.querySelector && row.querySelector('a[href*=\"#product/\"]');\r\n      if (a && a.getAttribute('href')) {\r\n        const href = a.getAttribute('href');\r\n        const m = href.match(/#product\\/([^\\/\\?#]+)/);\r\n        if (m) return this._normalizeIdKey(m[1]);\r\n      }\r\n\r\n      const anyData =\r\n        row.querySelector &&\r\n        row.querySelector('[data-id],[data-product-id],[data-cart-id]');\r\n      if (anyData) {\r\n        return this._normalizeIdKey(\r\n          anyData.getAttribute('data-id') ||\r\n            anyData.getAttribute('data-product-id') ||\r\n            anyData.getAttribute('data-cart-id')\r\n        );\r\n      }\r\n    } catch (e) {\r\n      this._logError('_getIdFromRow failed', e);\r\n    }\r\n    return '';\r\n  }\r\n\r\n  _showLimitMsg(row, text = null) {\r\n    if (!row) return;\r\n    try {\r\n      const controls =\r\n        row.querySelector && (row.querySelector('.cart-item__aside') || row);\r\n      if (!controls) return;\r\n      const msgText =\r\n        typeof text === 'string' && text.length\r\n          ? text\r\n          : this._msg('PRODUCT_LIMIT_DEFAULT');\r\n      let m = row.querySelector('.product-limit-msg');\r\n      if (!m) {\r\n        m = document.createElement('div');\r\n        m.className = 'product-limit-msg';\r\n        m.textContent = msgText;\r\n        controls.appendChild(m);\r\n        requestAnimationFrame(() => {\r\n          m.style.opacity = '1';\r\n        });\r\n      } else {\r\n        m.textContent = msgText;\r\n        m.style.opacity = '1';\r\n      }\r\n    } catch (e) {\r\n      this._logError('_showLimitMsg failed', e);\r\n    }\r\n  }\r\n\r\n  _hideLimitMsg(row) {\r\n    if (!row) return;\r\n    try {\r\n      const m = row.querySelector && row.querySelector('.product-limit-msg');\r\n      if (!m) return;\r\n      m.style.opacity = '0';\r\n      setTimeout(() => {\r\n        const el = row.querySelector && row.querySelector('.product-limit-msg');\r\n        if (el && el.parentNode) el.parentNode.removeChild(el);\r\n      }, 320);\r\n    } catch (e) {\r\n      this._logError('_hideLimitMsg failed', e);\r\n    }\r\n  }\r\n\r\n  _updateFavButtonState(row, id) {\r\n    if (!row || !id || !this.favorites) return;\r\n    try {\r\n      const favBtn = row.querySelector && row.querySelector('.fav-btn');\r\n      if (!favBtn) return;\r\n      let isFav = false;\r\n      try {\r\n        if (typeof this.favorites.isFavorite === 'function') {\r\n          isFav = !!this.favorites.isFavorite(id);\r\n        } else if (Array.isArray(this.favorites.getAll && this.favorites.getAll())) {\r\n          isFav = this.favorites.getAll().indexOf(id) >= 0;\r\n        }\r\n      } catch (e) {\r\n        isFav = false;\r\n      }\r\n      favBtn.classList.toggle('is-fav', isFav);\r\n      favBtn.setAttribute('aria-pressed', String(isFav));\r\n      const icon = favBtn.querySelector && favBtn.querySelector('i');\r\n      if (icon) icon.classList.toggle('active', isFav);\r\n    } catch (e) {\r\n      this._logError('_updateFavButtonState failed', e);\r\n    }\r\n  }\r\n\r\n  _ensureStockWarning(row) {\r\n    let stockWarning = row.querySelector && row.querySelector('.stock-warning');\r\n    if (!stockWarning) {\r\n      stockWarning = document.createElement('div');\r\n      stockWarning.className = 'stock-warning';\r\n      stockWarning.style.cssText =\r\n        'color:#c62828;font-size:13px;margin-top:6px;display:none;';\r\n      const right = row.querySelector('.cart-item__aside') || row;\r\n      right.appendChild(stockWarning);\r\n    }\r\n    return stockWarning;\r\n  }\r\n\r\n  _findAllRowsByIdInGrid(id) {\r\n    if (!this.cartGrid || !id) return [];\r\n    const esc = this._cssEscape(String(id));\r\n    const nodes = [];\r\n    try {\r\n      const q = this.cartGrid.querySelectorAll(`[data-id=\"${esc}\"]`);\r\n      if (q && q.length) {\r\n        for (const n of q) nodes.push(this._findRowFromElement(n) || n);\r\n      } else {\r\n        const rows =\r\n          this.cartGrid.querySelectorAll &&\r\n          this.cartGrid.querySelectorAll('.cart-item');\r\n        if (rows) {\r\n          for (const r of rows) {\r\n            try {\r\n              if (this._getIdFromRow(r) === this._normalizeIdKey(id)) nodes.push(r);\r\n            } catch (_) {}\r\n          }\r\n        }\r\n      }\r\n    } catch (e) {\r\n      const rows =\r\n        this.cartGrid.querySelectorAll &&\r\n        this.cartGrid.querySelectorAll('.cart-item');\r\n      if (rows) {\r\n        for (const r of rows) {\r\n          try {\r\n            if (this._getIdFromRow(r) === this._normalizeIdKey(id)) nodes.push(r);\r\n          } catch (_) {}\r\n        }\r\n      }\r\n    }\r\n    const uniq = [];\r\n    for (const n of nodes) if (n && uniq.indexOf(n) < 0) uniq.push(n);\r\n    return uniq;\r\n  }\r\n\r\n  _applyProducedRowSafely(id, produced, existingRow) {\r\n    if (!this.cartGrid || !produced) return;\r\n    const existingRows = this._findAllRowsByIdInGrid(id);\r\n    try {\r\n      if (existingRows.length > 0) {\r\n        const first = existingRows[0];\r\n        if (first && first.parentNode) {\r\n          try {\r\n            first.parentNode.replaceChild(produced, first);\r\n          } catch (e) {\r\n            this.cartGrid.appendChild(produced);\r\n          }\r\n        } else {\r\n          this.cartGrid.appendChild(produced);\r\n        }\r\n        for (let i = 1; i < existingRows.length; i++) {\r\n          const node = existingRows[i];\r\n          try {\r\n            if (node && node.parentNode) node.parentNode.removeChild(node);\r\n          } catch (_) {}\r\n        }\r\n      } else if (existingRow && existingRow.parentNode) {\r\n        try {\r\n          existingRow.parentNode.replaceChild(produced, existingRow);\r\n        } catch (e) {\r\n          this.cartGrid.appendChild(produced);\r\n        }\r\n      } else {\r\n        this.cartGrid.appendChild(produced);\r\n      }\r\n    } catch (e) {\r\n      try {\r\n        this.cartGrid.appendChild(produced);\r\n      } catch (_) {}\r\n    }\r\n  }\r\n\r\n  // ---------------------------------------------------------------------------\r\n  // \u0421\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u044F \u0441\u0442\u0440\u043E\u043A\u0438 \u0441 \u043C\u043E\u0434\u0435\u043B\u044C\u044E\r\n  // ---------------------------------------------------------------------------\r\n\r\n  _resolveStockAndQty(row, item, qtyInput) {\r\n    let stock = Number.isFinite(Number(item?.stock)) ? Number(item.stock) : NaN;\r\n    if (!Number.isFinite(stock)) {\r\n      const ds = row.getAttribute && row.getAttribute('data-stock');\r\n      stock = ds !== null ? Number(ds) : NaN;\r\n    }\r\n    if (!Number.isFinite(stock)) {\r\n      const modelItem = item?.name ? this._getCartItemById(item.name) : null;\r\n      stock = modelItem ? Number(modelItem.stock || 0) : 0;\r\n    }\r\n\r\n    let qty = Number.isFinite(Number(item?.qty)) ? Number(item.qty) : NaN;\r\n    if (!Number.isFinite(qty)) {\r\n      if (qtyInput) {\r\n        const v = parseInt(qtyInput.value || '0', 10);\r\n        qty = Number.isFinite(v) ? v : NaN;\r\n      }\r\n      if (!Number.isFinite(qty)) {\r\n        const modelItem = item?.name ? this._getCartItemById(item.name) : null;\r\n        qty = modelItem ? Number(modelItem.qty || 0) : 0;\r\n      }\r\n    }\r\n\r\n    if (!Number.isFinite(stock)) stock = 0;\r\n    if (!Number.isFinite(qty)) qty = 0;\r\n\r\n    return { stock, qty };\r\n  }\r\n\r\n  _syncRowControls(row, item) {\r\n    if (!row) return;\r\n    if (this._rowsSyncing.has(row)) return;\r\n\r\n    try {\r\n      this._rowsSyncing.add(row);\r\n\r\n      const qtyInput = row.querySelector && row.querySelector('.qty-input');\r\n      const btnPlus =\r\n        row.querySelector &&\r\n        (row.querySelector('.qty-btn.qty-incr') ||\r\n          row.querySelector('[data-action=\"qty-incr\"]') ||\r\n          row.querySelector('[data-role=\"qty-plus\"]'));\r\n      const btnMinus =\r\n        row.querySelector &&\r\n        (row.querySelector('.qty-btn.qty-decr') ||\r\n          row.querySelector('[data-action=\"qty-decr\"]') ||\r\n          row.querySelector('[data-role=\"qty-minus\"]'));\r\n\r\n      const { stock, qty: rawQty } = this._resolveStockAndQty(row, item, qtyInput);\r\n      let qty = rawQty;\r\n\r\n      const stockWarning = this._ensureStockWarning(row);\r\n\r\n      // qty input\r\n      if (qtyInput) {\r\n        qtyInput.setAttribute('min', '1');\r\n        qtyInput.setAttribute('max', String(stock));\r\n        if (stock <= 0) {\r\n          qtyInput.value = '0';\r\n          qtyInput.disabled = true;\r\n          qtyInput.setAttribute('aria-disabled', 'true');\r\n        } else {\r\n          if (qty > stock) qty = stock;\r\n          qtyInput.value = String(Math.max(1, qty));\r\n          qtyInput.disabled = false;\r\n          qtyInput.removeAttribute('aria-disabled');\r\n        }\r\n      }\r\n\r\n      // minus\r\n      if (btnMinus) {\r\n        const disabled = stock <= 0 || qty <= 1;\r\n        btnMinus.disabled = disabled;\r\n        btnMinus.toggleAttribute && btnMinus.toggleAttribute('aria-disabled', disabled);\r\n        btnMinus.classList.toggle('disabled', disabled);\r\n      }\r\n\r\n      // plus + \u043B\u0438\u043C\u0438\u0442\r\n      if (btnPlus) {\r\n        const disabled = stock <= 0 || qty >= stock;\r\n        btnPlus.disabled = disabled;\r\n        btnPlus.toggleAttribute && btnPlus.toggleAttribute('aria-disabled', disabled);\r\n        btnPlus.classList.toggle('disabled', disabled);\r\n\r\n        if (stock > 0 && qty >= stock) {\r\n          this._showLimitMsg(row, this._msg('PRODUCT_LIMIT_REACHED'));\r\n        } else {\r\n          this._hideLimitMsg(row);\r\n        }\r\n      } else {\r\n        this._hideLimitMsg(row);\r\n      }\r\n\r\n      // out-of-stock visuals\r\n      if (stock <= 0) {\r\n        stockWarning.textContent = this._msg('NO_STOCK_TEXT');\r\n        stockWarning.style.display = '';\r\n        stockWarning.setAttribute('aria-hidden', 'false');\r\n        row.classList.add('out-of-stock');\r\n        if (btnPlus) {\r\n          btnPlus.disabled = true;\r\n          btnPlus.setAttribute && btnPlus.setAttribute('aria-disabled', 'true');\r\n          btnPlus.classList.add('disabled');\r\n        }\r\n        if (btnMinus) {\r\n          btnMinus.disabled = true;\r\n          btnMinus.setAttribute && btnMinus.setAttribute('aria-disabled', 'true');\r\n          btnMinus.classList.add('disabled');\r\n        }\r\n        if (qtyInput) {\r\n          qtyInput.value = '0';\r\n          qtyInput.disabled = true;\r\n          qtyInput.setAttribute && qtyInput.setAttribute('aria-disabled', 'true');\r\n        }\r\n        this._hideLimitMsg(row);\r\n      } else {\r\n        stockWarning.style.display = 'none';\r\n        stockWarning.setAttribute('aria-hidden', 'true');\r\n        row.classList.remove('out-of-stock');\r\n      }\r\n\r\n      // \u043B\u0435\u043D\u0438\u0432\u043E\u0435 \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435 \u043E\u0434\u043D\u043E\u0433\u043E \u0442\u043E\u0432\u0430\u0440\u0430\r\n      this._refreshSingleProductForRow(row);\r\n    } catch (e) {\r\n      this._logError('_syncRowControls failed', e);\r\n    } finally {\r\n      try {\r\n        this._rowsSyncing.delete(row);\r\n      } catch (_) {}\r\n    }\r\n  }\r\n\r\n  _refreshSingleProductForRow(row) {\r\n    try {\r\n      const id = this._getIdFromRow(row);\r\n      if (!id || !this.productService || typeof this.productService.findById !== 'function') {\r\n        return;\r\n      }\r\n      const prod = this._resolveProduct(id);\r\n      if (this._isThenable(prod)) {\r\n        prod\r\n          .then((resolved) => {\r\n            if (!resolved) return;\r\n            const existing = this._getCartItemById(id);\r\n            if (!existing) return;\r\n            this._mergeProductToItem(existing, resolved, true);\r\n            const mainRow = this._findRowFromElement(row) || row;\r\n            this._syncRowControls(mainRow, existing);\r\n          })\r\n          .catch((err) => this._logError('single product refresh failed', err));\r\n      } else if (prod) {\r\n        const existing = this._getCartItemById(id);\r\n        if (!existing) return;\r\n        this._mergeProductToItem(existing, prod, true);\r\n        const mainRow = this._findRowFromElement(row) || row;\r\n        this._syncRowControls(mainRow, existing);\r\n      }\r\n    } catch (e) {\r\n      this._logError('_syncRowControls product refresh failed', e);\r\n    }\r\n  }\r\n\r\n  // ---------------------------------------------------------------------------\r\n  // \u041E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435 \u0434\u0430\u043D\u043D\u044B\u0445 \u043F\u0435\u0440\u0435\u0434 UI\r\n  // ---------------------------------------------------------------------------\r\n\r\n  async _refreshProducts(overrideIdKey) {\r\n    if (!this.productService || typeof this.productService.findById !== 'function') {\r\n      return;\r\n    }\r\n\r\n    if (overrideIdKey) {\r\n      const id = overrideIdKey;\r\n      const item = this._getCartItemById(id);\r\n      if (!item) return;\r\n\r\n      try {\r\n        const prod = this._resolveProduct(id);\r\n        if (this._isThenable(prod)) {\r\n          const resolved = await prod.catch(() => null);\r\n          if (resolved) this._mergeProductToItem(item, resolved, true);\r\n        } else if (prod) {\r\n          this._mergeProductToItem(item, prod, true);\r\n        }\r\n      } catch (e) {\r\n        this._logError('single product fetch failed', e);\r\n      }\r\n      return;\r\n    }\r\n\r\n    const tasks = this.cart.map((item) => {\r\n      const id = this._normalizeId(item.name);\r\n      try {\r\n        const prod = this._resolveProduct(id);\r\n        if (this._isThenable(prod)) {\r\n          return prod\r\n            .then((res) => ({ id, res }))\r\n            .catch((err) => ({ id, res: null, err }));\r\n        }\r\n        return Promise.resolve({ id, res: prod || null });\r\n      } catch (e) {\r\n        return Promise.resolve({ id, res: null, err: e });\r\n      }\r\n    });\r\n\r\n    try {\r\n      if (this.opts.parallelProductFetch) {\r\n        const settled = await Promise.allSettled(tasks);\r\n        for (const r of settled) {\r\n          if (r.status === 'fulfilled' && r.value?.res) {\r\n            const id = r.value.id;\r\n            const resolved = r.value.res;\r\n            const idx = this._findCartIndexById(id);\r\n            if (idx >= 0) {\r\n              this._mergeProductToItem(this.cart[idx], resolved, true);\r\n            }\r\n          } else if (r.status === 'rejected') {\r\n            this._logError('product fetch failed', r.reason);\r\n          }\r\n        }\r\n      } else {\r\n        for (const t of tasks) {\r\n          try {\r\n            const r = await t;\r\n            if (r?.res) {\r\n              const idx = this._findCartIndexById(r.id);\r\n              if (idx >= 0) {\r\n                this._mergeProductToItem(this.cart[idx], r.res, true);\r\n              }\r\n            }\r\n          } catch (e) {\r\n            this._logError('sequential product refresh failed', e);\r\n          }\r\n        }\r\n      }\r\n    } catch (e) {\r\n      this._logError('updateCartUI (product fetch) failed', e);\r\n    }\r\n  }\r\n\r\n  _calculateTotals() {\r\n    let totalCount = 0;\r\n    let totalSum = 0;\r\n    for (const it of this.cart) {\r\n      totalCount += Number(it.qty || 0);\r\n      totalSum += Number(it.price || 0) * Number(it.qty || 0);\r\n    }\r\n    return { totalCount, totalSum };\r\n  }\r\n\r\n  _updateBadges(totalCount) {\r\n    try {\r\n      if (this.headerCartNum) {\r\n        this.headerCartNum.textContent = String(totalCount);\r\n        this.headerCartNum.style.display = totalCount > 0 ? 'inline-flex' : 'none';\r\n        this.headerCartNum.setAttribute('aria-hidden', totalCount > 0 ? 'false' : 'true');\r\n\r\n        if (this.mobileCartNum) {\r\n          this.mobileCartNum.textContent = String(totalCount);\r\n          this.mobileCartNum.style.display = totalCount > 0 ? 'inline-flex' : 'none';\r\n          this.mobileCartNum.setAttribute('aria-hidden', totalCount > 0 ? 'false' : 'true');\r\n        }\r\n      }\r\n    } catch (e) {\r\n      this._logError('headerCartNum update failed', e);\r\n    }\r\n\r\n    try {\r\n      if (this.miniCart && typeof this.miniCart.updateHeader === 'function') {\r\n        this.miniCart.updateHeader(totalCount);\r\n      }\r\n    } catch (e) {\r\n      this._logError('miniCart.updateHeader failed', e);\r\n    }\r\n  }\r\n\r\n  async _renderMiniCart() {\r\n    try {\r\n      if (this.miniCart && typeof this.miniCart.render === 'function') {\r\n        const maybe = this.miniCart.render(this.cart);\r\n        if (this._isThenable(maybe)) {\r\n          await maybe.catch((err) => this._logError('miniCart.render failed', err));\r\n        }\r\n      }\r\n    } catch (e) {\r\n      this._logError('miniCart.render threw', e);\r\n    }\r\n  }\r\n\r\n  _updateTotalsUI(totalCount, totalSum) {\r\n    try {\r\n      if (this.cartTotal) this.cartTotal.textContent = this._formatPrice(totalSum);\r\n      if (this.miniCartTotal) this.miniCartTotal.textContent = this._formatPrice(totalSum);\r\n      if (this.cartCountInline) this.cartCountInline.textContent = String(totalCount);\r\n    } catch (e) {\r\n      this._logError('totals update failed', e);\r\n    }\r\n  }\r\n\r\n  async _updateGridSingle(overrideIdKey) {\r\n    const id = String(overrideIdKey);\r\n    this._pendingChangedIds.delete(id);\r\n    const esc = this._cssEscape(String(id));\r\n\r\n    let targetRow = null;\r\n    try {\r\n      targetRow = this.cartGrid.querySelector(`[data-id=\"${esc}\"]`);\r\n    } catch (_) {\r\n      targetRow = null;\r\n    }\r\n    targetRow = this._findRowFromElement(targetRow) || targetRow;\r\n    const item = this._getCartItemById(id);\r\n\r\n    if (!item) {\r\n      // \u0443\u0434\u0430\u043B\u0451\u043D \u0438\u0437 \u043C\u043E\u0434\u0435\u043B\u0438 \u2014 \u0433\u0430\u0441\u0438\u043C \u0441\u0442\u0440\u043E\u043A\u0438\r\n      const rows = this._findAllRowsByIdInGrid(id);\r\n      for (const r of rows) {\r\n        try {\r\n          if (r.parentNode) r.parentNode.removeChild(r);\r\n        } catch (_) {}\r\n      }\r\n      if (this.cart.length === 0) {\r\n        await this._renderFullGrid();\r\n      } else {\r\n        this._attachGridListeners();\r\n      }\r\n      return;\r\n    }\r\n\r\n    // \u043F\u0435\u0440\u0435\u0440\u0435\u043D\u0434\u0435\u0440 \u043E\u0434\u0438\u043D\u043E\u0447\u043D\u043E\u0439 \u0441\u0442\u0440\u043E\u043A\u0438\r\n    let producedRow = null;\r\n    try {\r\n      const tmp = await this._renderItemsToTemp([item]);\r\n      producedRow = tmp.querySelector('.cart-item') || tmp.firstElementChild;\r\n    } catch (err) {\r\n      this._logError('renderer.render failed (fast-path)', err);\r\n      producedRow = null;\r\n    }\r\n\r\n    if (!producedRow || !producedRow.cloneNode) {\r\n      await this._renderFullGrid();\r\n      return;\r\n    }\r\n\r\n    const clone = producedRow.cloneNode(true);\r\n    clone.setAttribute && clone.setAttribute('data-id', String(id));\r\n\r\n    if (targetRow && targetRow.parentNode) {\r\n      try {\r\n        targetRow.parentNode.replaceChild(clone, targetRow);\r\n      } catch (e) {\r\n        try {\r\n          targetRow.parentNode.appendChild(clone);\r\n        } catch (_) {}\r\n      }\r\n    } else {\r\n      const rows = this._findAllRowsByIdInGrid(id);\r\n      if (rows.length > 0) {\r\n        try {\r\n          rows[0].parentNode.replaceChild(clone, rows[0]);\r\n        } catch (e) {\r\n          try {\r\n            this.cartGrid.appendChild(clone);\r\n          } catch (_) {}\r\n        }\r\n        for (let i = 1; i < rows.length; i++) {\r\n          try {\r\n            if (rows[i].parentNode) rows[i].parentNode.removeChild(rows[i]);\r\n          } catch (_) {}\r\n        }\r\n      } else {\r\n        try {\r\n          this.cartGrid.appendChild(clone);\r\n        } catch (_) {}\r\n      }\r\n    }\r\n\r\n    const mainRow = this._findRowFromElement(clone) || clone;\r\n    if (mainRow && item) this._syncRowControls(mainRow, item);\r\n    if (mainRow) this._updateFavButtonState(mainRow, id);\r\n\r\n    try {\r\n      const src = this._changeSourceMap.get(id);\r\n      if (src instanceof Element) {\r\n        const q = mainRow.querySelector && mainRow.querySelector('.qty-input');\r\n        if (q) q.focus();\r\n      }\r\n    } catch (_) {}\r\n    try {\r\n      this._changeSourceMap.delete(id);\r\n    } catch (_) {}\r\n\r\n    this._attachGridListeners();\r\n  }\r\n\r\n  async _updateGridPartial(changedIdsSnapshot) {\r\n    const changedIds = changedIdsSnapshot;\r\n    if (!changedIds.length) {\r\n      await this._renderFullGrid();\r\n      return;\r\n    }\r\n\r\n    const tasks = changedIds.map(async (id) => {\r\n      const item = this._getCartItemById(id);\r\n      if (!item) return { id, removed: true };\r\n      try {\r\n        const tmp = await this._renderItemsToTemp([item]);\r\n        const produced = tmp.querySelector('.cart-item') || tmp.firstElementChild;\r\n        return { id, produced, item };\r\n      } catch (err) {\r\n        return { id, error: err };\r\n      }\r\n    });\r\n\r\n    const settled = await Promise.allSettled(tasks);\r\n    let hadFailure = false;\r\n    const apply = [];\r\n\r\n    for (const r of settled) {\r\n      if (r.status === 'fulfilled' && r.value) {\r\n        if (r.value.error) {\r\n          hadFailure = true;\r\n          this._logError('partial render task error', r.value.error);\r\n        } else {\r\n          apply.push(r.value);\r\n        }\r\n      } else {\r\n        hadFailure = true;\r\n        this._logError('partial render promise rejected', r);\r\n      }\r\n    }\r\n\r\n    await new Promise((resolve) => requestAnimationFrame(resolve));\r\n\r\n    for (const c of apply) {\r\n      try {\r\n        if (c.removed) {\r\n          const rows = this._findAllRowsByIdInGrid(c.id);\r\n          for (const rr of rows) {\r\n            try {\r\n              if (rr.parentNode) rr.parentNode.removeChild(rr);\r\n            } catch (_) {}\r\n          }\r\n          continue;\r\n        }\r\n        if (!c.produced) {\r\n          hadFailure = true;\r\n          continue;\r\n        }\r\n        const produced = c.produced.cloneNode(true);\r\n        if (produced.setAttribute) produced.setAttribute('data-id', String(c.id));\r\n        this._applyProducedRowSafely(c.id, produced, c.existingRow);\r\n        const mainRow = this._findRowFromElement(produced) || produced;\r\n        if (c.item) this._syncRowControls(mainRow, c.item);\r\n        this._updateFavButtonState(mainRow, c.id);\r\n      } catch (e) {\r\n        hadFailure = true;\r\n        this._logError('applyChange failed', e);\r\n      }\r\n    }\r\n\r\n    if (hadFailure) {\r\n      await this._renderFullGrid();\r\n    } else if (this.cart.length === 0) {\r\n      await this._renderFullGrid();\r\n    } else {\r\n      this._attachGridListeners();\r\n    }\r\n  }\r\n\r\n  _finalSyncRows(changedIdsSnapshot) {\r\n    try {\r\n      if (!this.cartGrid || !changedIdsSnapshot.length) return;\r\n\r\n      for (const id of changedIdsSnapshot) {\r\n        const esc = this._cssEscape(String(id));\r\n        let row = null;\r\n        try {\r\n          row = this.cartGrid.querySelector(`[data-id=\"${esc}\"]`);\r\n        } catch (err) {\r\n          row = null;\r\n        }\r\n        const mainRow = this._findRowFromElement(row) || row;\r\n        const item = this._getCartItemById(id);\r\n        if (mainRow && item) {\r\n          this._syncRowControls(mainRow, item);\r\n          this._updateFavButtonState(mainRow, id);\r\n        } else if (mainRow) {\r\n          this._updateFavButtonState(mainRow, id);\r\n        }\r\n      }\r\n    } catch (e) {\r\n      this._logError('final sync failed', e);\r\n    }\r\n  }\r\n\r\n  // ---------------------------------------------------------------------------\r\n  // \u041E\u0441\u043D\u043E\u0432\u043D\u043E\u0439 UI-\u0430\u043F\u0434\u0435\u0439\u0442\r\n  // ---------------------------------------------------------------------------\r\n\r\n  async updateCartUI(targetId = null) {\r\n    const overrideIdKey = targetId ? this._normalizeIdKey(targetId) : null;\r\n    const changedIdsSnapshot = overrideIdKey\r\n      ? [String(overrideIdKey)]\r\n      : Array.from(this._pendingChangedIds);\r\n\r\n    // dedupe & index\r\n    this._dedupeCart();\r\n    this._rebuildIndex();\r\n\r\n    // 1) \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435 \u0434\u0430\u043D\u043D\u044B\u0445 \u0442\u043E\u0432\u0430\u0440\u0430\r\n    await this._refreshProducts(overrideIdKey);\r\n\r\n    // 2) totals\r\n    const { totalCount, totalSum } = this._calculateTotals();\r\n\r\n    // 3) \u0448\u0430\u043F\u043A\u0430 / \u0431\u0435\u0439\u0434\u0436\u0438\r\n    this._updateBadges(totalCount);\r\n\r\n    // 4) miniCart\r\n    await this._renderMiniCart();\r\n\r\n    // 5) \u0433\u0440\u0438\u0434\r\n    try {\r\n      if (this._hasGridRenderer()) {\r\n        if (overrideIdKey) {\r\n          await this._updateGridSingle(overrideIdKey);\r\n        } else {\r\n          await this._updateGridPartial(changedIdsSnapshot);\r\n        }\r\n      }\r\n    } catch (e) {\r\n      this._logError('cart grid update failed, attempting full render', e);\r\n      try {\r\n        await this._renderFullGrid();\r\n      } catch (er) {\r\n        this._logError('full render fallback failed', er);\r\n      }\r\n    }\r\n\r\n    // 6) totals UI\r\n    this._updateTotalsUI(totalCount, totalSum);\r\n\r\n    // 7) \u0444\u0438\u043D\u0430\u043B\u044C\u043D\u044B\u0439 sync \u0441\u0442\u0440\u043E\u043A\r\n    this._finalSyncRows(changedIdsSnapshot);\r\n\r\n    // 8) persistence + \u0441\u043E\u0431\u044B\u0442\u0438\u0435\r\n    this._scheduleSave();\r\n    this._emitUpdateEvent();\r\n\r\n    return { cart: this.getCart(), totalCount, totalSum };\r\n  }\r\n\r\n  // ---------------------------------------------------------------------------\r\n  // Grid listeners\r\n  // ---------------------------------------------------------------------------\r\n\r\n  _attachGridListeners() {\r\n    if (!this.cartGrid) return;\r\n    if (this._gridListenersAttachedTo && this._gridListenersAttachedTo !== this.cartGrid) {\r\n      this._detachGridListeners();\r\n    }\r\n    if (this._gridHandler) return;\r\n\r\n    this._gridHandler = (ev) => this._handleGridClick(ev);\r\n    this._gridInputHandler = (ev) => this._handleGridInput(ev);\r\n\r\n    try {\r\n      this.cartGrid.addEventListener('click', this._gridHandler);\r\n      this.cartGrid.addEventListener('change', this._gridInputHandler);\r\n      this._gridListenersAttachedTo = this.cartGrid;\r\n    } catch (e) {\r\n      this._logError('_attachGridListeners failed', e);\r\n    }\r\n  }\r\n\r\n  _handleGridClick(ev) {\r\n    const target = ev.target;\r\n    const row = this._findRowFromElement(target);\r\n    if (!row) return;\r\n    const id = this._getIdFromRow(row);\r\n    if (!id) return;\r\n\r\n    const closest = (sel) => (target.closest && target.closest(sel)) || null;\r\n\r\n    const fav = closest('.fav-btn, [data-role=\"fav\"]');\r\n    if (fav) {\r\n      ev.preventDefault();\r\n      this._handleFavClick(id, row);\r\n      return;\r\n    }\r\n\r\n    const plus = closest('.qty-btn.qty-incr, [data-action=\"qty-incr\"], [data-role=\"qty-plus\"]');\r\n    if (plus) {\r\n      ev.preventDefault();\r\n      this._handlePlusClick(id, row);\r\n      return;\r\n    }\r\n\r\n    const minus = closest('.qty-btn.qty-decr, [data-action=\"qty-decr\"], [data-role=\"qty-minus\"]');\r\n    if (minus) {\r\n      ev.preventDefault();\r\n      this._handleMinusClick(id, row);\r\n      return;\r\n    }\r\n\r\n    const rem = closest('.remove-btn, [data-action=\"remove\"], [data-role=\"remove\"]');\r\n    if (rem) {\r\n      ev.preventDefault();\r\n      this._handleRemoveClick(id);\r\n    }\r\n  }\r\n\r\n  _handleGridInput(ev) {\r\n    const input = ev.target;\r\n    if (!input) return;\r\n    if (\r\n      !(\r\n        input.matches &&\r\n        (input.matches('.qty-input') ||\r\n          input.matches('[data-role=\"qty-input\"]') ||\r\n          input.matches('input[type=\"number\"]'))\r\n      )\r\n    ) {\r\n      return;\r\n    }\r\n\r\n    const row = this._findRowFromElement(input);\r\n    if (!row) return;\r\n    const id = this._getIdFromRow(row);\r\n    if (!id) return;\r\n\r\n    let v = parseInt(input.value, 10);\r\n    if (isNaN(v) || v < 1) v = 1;\r\n    const max = parseInt(input.getAttribute('max') || '0', 10);\r\n    if (Number.isFinite(max) && max > 0 && v > max) v = max;\r\n\r\n    if (this.changeQty(id, v, { sourceRow: row })) {\r\n      this.updateCartUI(id);\r\n    }\r\n  }\r\n\r\n  _handleFavClick(id, row) {\r\n    if (!this.favorites) {\r\n      this.notifications?.show?.(this._msg('FAVORITES_UNAVAILABLE'), { type: 'error' });\r\n      return;\r\n    }\r\n    try {\r\n      let res;\r\n      if (typeof this.favorites.toggle === 'function') {\r\n        res = this.favorites.toggle(id);\r\n      } else if (\r\n        typeof this.favorites.add === 'function' &&\r\n        typeof this.favorites.remove === 'function'\r\n      ) {\r\n        const now =\r\n          typeof this.favorites.isFavorite === 'function'\r\n            ? !!this.favorites.isFavorite(id)\r\n            : false;\r\n        res = now ? this.favorites.remove(id) : this.favorites.add(id);\r\n      }\r\n\r\n      const favBtnEl = row.querySelector && row.querySelector('.fav-btn');\r\n      const isFavNow =\r\n        typeof this.favorites.isFavorite === 'function'\r\n          ? !!this.favorites.isFavorite(id)\r\n          : false;\r\n      if (favBtnEl) {\r\n        favBtnEl.classList.toggle('is-fav', isFavNow);\r\n        favBtnEl.setAttribute('aria-pressed', String(isFavNow));\r\n      }\r\n\r\n      const wishEl = document.getElementById && document.getElementById('wishNum');\r\n      try {\r\n        if (wishEl && typeof this.favorites.getCount === 'function') {\r\n          wishEl.textContent = String(this.favorites.getCount());\r\n        }\r\n      } catch (_) {}\r\n\r\n      if (res && this._isThenable(res)) {\r\n        res\r\n          .then(() => {\r\n            const finalFav =\r\n              typeof this.favorites.isFavorite === 'function'\r\n                ? !!this.favorites.isFavorite(id)\r\n                : false;\r\n            if (favBtnEl) favBtnEl.classList.toggle('is-fav', finalFav);\r\n            if (wishEl && typeof this.favorites.getCount === 'function') {\r\n              wishEl.textContent = String(this.favorites.getCount());\r\n            }\r\n          })\r\n          .catch((err) => this._logError('favorites operation failed', err));\r\n      }\r\n    } catch (e) {\r\n      this._logError('fav handling failed', e);\r\n    }\r\n  }\r\n\r\n  _handlePlusClick(id, row) {\r\n    const item = this._getCartItemById(id);\r\n    if (!item) return;\r\n    const stock = Number(item.stock || 0);\r\n    if (stock <= 0) {\r\n      this.notifications?.show?.(this._msg('PRODUCT_OUT_OF_STOCK'), { type: 'warning' });\r\n      this._syncRowControls(row, item);\r\n      return;\r\n    }\r\n    if (item.qty < stock) {\r\n      if (this.changeQty(id, item.qty + 1, { sourceRow: row })) {\r\n        this.updateCartUI(id);\r\n      }\r\n    } else {\r\n      this.notifications?.show?.(this._msg('REACHED_MAX_STOCK_LIMIT_NOTIFY'), {\r\n        type: 'warning'\r\n      });\r\n    }\r\n  }\r\n\r\n  _handleMinusClick(id, row) {\r\n    const item = this._getCartItemById(id);\r\n    if (!item) return;\r\n    if (item.qty > 1 && this.changeQty(id, item.qty - 1, { sourceRow: row })) {\r\n      this.updateCartUI(id);\r\n    }\r\n  }\r\n\r\n  _handleRemoveClick(id) {\r\n    if (this.remove(id)) {\r\n      this.updateCartUI(id);\r\n    }\r\n  }\r\n\r\n  _detachGridListeners() {\r\n    if (!this._gridListenersAttachedTo) return;\r\n    try {\r\n      this._gridListenersAttachedTo.removeEventListener('click', this._gridHandler);\r\n      this._gridListenersAttachedTo.removeEventListener('change', this._gridInputHandler);\r\n    } catch (e) {\r\n      this._logError('_detachGridListeners error', e);\r\n    }\r\n    this._gridHandler = null;\r\n    this._gridInputHandler = null;\r\n    this._gridListenersAttachedTo = null;\r\n  }\r\n\r\n  // ---------------------------------------------------------------------------\r\n  // Destroy\r\n  // ---------------------------------------------------------------------------\r\n\r\n  destroy() {\r\n    this._detachGridListeners();\r\n    try {\r\n      if (this.miniCart?.destroy) this.miniCart.destroy();\r\n    } catch (e) {\r\n      this._logError('miniCart.destroy failed', e);\r\n    }\r\n    this._destroyBase();\r\n  }\r\n}", "// Cart/CartModule.js\r\n\r\nimport { CartUI } from './CartUI.js';\r\n\r\n/**\r\n * CartModule \u2014 \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u044B\u0439 \u0444\u0430\u0441\u0430\u0434 \u0434\u043B\u044F \u043E\u0441\u0442\u0430\u043B\u044C\u043D\u043E\u0433\u043E \u043A\u043E\u0434\u0430.\r\n * \u0421\u043D\u0430\u0440\u0443\u0436\u0438 API \u043E\u0441\u0442\u0430\u0451\u0442\u0441\u044F \u043F\u0440\u0435\u0436\u043D\u0438\u043C, \u0432\u043D\u0443\u0442\u0440\u0438 \u2014 \u0440\u0430\u0437\u0434\u0435\u043B\u0435\u043D\u043E \u043F\u043E \u0441\u043B\u043E\u044F\u043C.\r\n */\r\nexport class CartModule extends CartUI {\r\n  static UI_MESSAGES = Object.freeze({\r\n    NOT_ENOUGH_STOCK: '\u041D\u0435\u0434\u043E\u0441\u0442\u0430\u0442\u043E\u0447\u043D\u043E \u0442\u043E\u0432\u0430\u0440\u0430 \u043D\u0430 \u0441\u043A\u043B\u0430\u0434\u0435.',\r\n    ONLY_X_LEFT: '\u0412 \u043D\u0430\u043B\u0438\u0447\u0438\u0438 \u0442\u043E\u043B\u044C\u043A\u043E {stock} \u0448\u0442.',\r\n    ADDED_TO_CART_HTML:\r\n      '\u0422\u043E\u0432\u0430\u0440 ({title}) x{qty} \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443 <a href=\"#page/cart\">\u041F\u0435\u0440\u0435\u0439\u0442\u0438 \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443</a>',\r\n    ADDED_TO_CART_PLAIN:\r\n      '\u0422\u043E\u0432\u0430\u0440 \"{title}\" x{qty} \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443.',\r\n    FAVORITES_UNAVAILABLE: '\u041C\u043E\u0434\u0443\u043B\u044C \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D.',\r\n    INSUFFICIENT_STOCK_ADD:\r\n      '\u041D\u0435\u0434\u043E\u0441\u0442\u0430\u0442\u043E\u0447\u043D\u043E \u043D\u0430 \u0441\u043A\u043B\u0430\u0434\u0435. \u0414\u043E\u0441\u0442\u0443\u043F\u043D\u043E: {max}.',\r\n    INSUFFICIENT_STOCK_CHANGEQTY:\r\n      '\u041D\u0435\u0434\u043E\u0441\u0442\u0430\u0442\u043E\u0447\u043D\u043E \u043D\u0430 \u0441\u043A\u043B\u0430\u0434\u0435. \u0414\u043E\u0441\u0442\u0443\u043F\u043D\u043E: {stock}.',\r\n    PRODUCT_OUT_OF_STOCK: '\u0422\u043E\u0432\u0430\u0440 \u043E\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442 \u043D\u0430 \u0441\u043A\u043B\u0430\u0434\u0435.',\r\n    REACHED_MAX_STOCK_LIMIT_NOTIFY:\r\n      '\u0414\u043E\u0441\u0442\u0438\u0433\u043D\u0443\u0442 \u043C\u0430\u043A\u0441\u0438\u043C\u0430\u043B\u044C\u043D\u044B\u0439 \u043B\u0438\u043C\u0438\u0442 \u043F\u043E \u043E\u0441\u0442\u0430\u0442\u043A\u0443.',\r\n    PRODUCT_LIMIT_DEFAULT: '\u0423 \u0432\u0430\u0441 \u0443\u0436\u0435 \u043C\u0430\u043A\u0441\u0438\u043C\u0443\u043C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0435',\r\n    PRODUCT_LIMIT_REACHED:\r\n      '\u0412\u044B \u0434\u043E\u0441\u0442\u0438\u0433\u043B\u0438 \u043C\u0430\u043A\u0441\u0438\u043C\u0430\u043B\u044C\u043D\u043E\u0433\u043E \u043A\u043E\u043B\u0438\u0447\u0435\u0441\u0442\u0432\u0430 \u044D\u0442\u043E\u0433\u043E \u0442\u043E\u0432\u0430\u0440\u0430',\r\n    NO_STOCK_TEXT: '\u0422\u043E\u0432\u0430\u0440\u0430 \u043D\u0435\u0442 \u0432 \u043D\u0430\u043B\u0438\u0447\u0438\u0438'\r\n  });\r\n\r\n  constructor({ storage, productService, renderer, notifications, favorites = null, opts = {} }) {\r\n    super({ storage, productService, renderer, notifications, favorites, opts });\r\n  }\r\n\r\n  /**\r\n   * \u041F\u0435\u0440\u0435\u043E\u043F\u0440\u0435\u0434\u0435\u043B\u044F\u0435\u043C add/remove/changeQty \u0447\u0442\u043E\u0431\u044B \u0441\u0440\u0430\u0437\u0443 \u0434\u0435\u0440\u0433\u0430\u0442\u044C updateCartUI\r\n   * (\u043F\u043E\u0432\u0435\u0434\u0435\u043D\u0438\u0435 \u043A\u0430\u043A \u0443 \u0441\u0442\u0430\u0440\u043E\u0439 \u0432\u0435\u0440\u0441\u0438\u0438 CartModule).\r\n   */\r\n  add(productId, qty = 1) {\r\n    const ok = super.add(productId, qty);\r\n    if (!ok) return false;\r\n\r\n    const id = this._normalizeId(productId);\r\n    const prod = this._resolveProduct(id);\r\n\r\n    // \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u0435 \u043E \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u0438\u0438\r\n    try {\r\n      const title =\r\n        prod && (prod.fullname || prod.title)\r\n          ? prod.fullname || prod.title\r\n          : id;\r\n      try {\r\n        this.notifications?.show?.(\r\n          this._msg('ADDED_TO_CART_HTML', { title, qty }),\r\n          { type: 'success', allowHtml: true }\r\n        );\r\n      } catch (_) {\r\n        this.notifications?.show?.(\r\n          this._msg('ADDED_TO_CART_PLAIN', { title, qty }),\r\n          { type: 'success' }\r\n        );\r\n      }\r\n    } catch (e) {\r\n      this._logError('notifications.show failed on add', e);\r\n    }\r\n\r\n    return this.updateCartUI();\r\n  }\r\n\r\n  remove(productId) {\r\n    const ok = super.remove(productId);\r\n    if (!ok) return false;\r\n    return this.updateCartUI(productId);\r\n  }\r\n\r\n  changeQty(productId, newQty, opts = {}) {\r\n    const ok = super.changeQty(productId, newQty, opts);\r\n    if (!ok) return false;\r\n    return this.updateCartUI(productId);\r\n  }\r\n\r\n  async loadFromStorage() {\r\n    await super.loadFromStorage();\r\n    return this.updateCartUI();\r\n  }\r\n\r\n  clear() {\r\n    super.clear();\r\n    return this.updateCartUI();\r\n  }\r\n\r\n  _setCartForTest(cartArray) {\r\n    super._setCartForTest(cartArray);\r\n    return this.updateCartUI();\r\n  }\r\n}\r\n", "/**\r\n * FavoritesModule for ShopMatic\r\n *\r\n * @author Calista Verner\r\n * Version: 1.4.0\r\n * Date: 2025-11-04\r\n * License: MIT\r\n *\r\n * Responsibilities:\r\n *  - manage favorites list (preserve insertion order, O(1) lookup)\r\n *  - persist to provided storage, with optional debounce\r\n *  - enforce optional maximum and overflow behaviour\r\n *  - subscribe/unsubscribe model for UI updates\r\n *  - optional cross-tab sync via window.storage events\r\n *\r\n */\r\nexport class FavoritesModule {\r\n  constructor({ storage, opts = {} } = {}) {\r\n    if (!storage || typeof storage.loadFavs !== 'function' || typeof storage.saveFavs !== 'function') {\r\n      throw new Error('FavoritesModule requires storage with loadFavs() and saveFavs() methods');\r\n    }\r\n\r\n    this.storage = storage;\r\n    this._max = Math.max(0, Number.isFinite(opts.max) ? Math.floor(opts.max) : 0);\r\n    this._overflow = opts.overflow === 'drop_oldest' ? 'drop_oldest' : 'reject';\r\n    this._sync = opts.sync !== undefined ? Boolean(opts.sync) : true;\r\n    this._saveDebounceMs = Math.max(0, Number.isFinite(opts.saveDebounceMs) ? opts.saveDebounceMs : 200);\r\n    this._storageKey = opts.storageKey || this.storage.favStorageKey || this.storage.storageKey || null;\r\n    this._list = [];\r\n    this._set = new Set();\r\n    this._subs = new Set();\r\n    this._saveTimer = null;\r\n    this._destroyed = false;\r\n    this._onStorageEvent = this._onStorageEvent.bind(this);\r\n\r\n    if (Array.isArray(opts.initial) && opts.initial.length) {\r\n      this.importFromArray(opts.initial, { replace: true, persist: false });\r\n    }\r\n\r\n    if (this._sync && typeof window !== 'undefined' && window.addEventListener) {\r\n      window.addEventListener('storage', this._onStorageEvent);\r\n    }\r\n  }\r\n\r\n  // --- Internal Helpers ---\r\n\r\n  /**\r\n   * Emit an event to all subscribers.\r\n   * @private\r\n   */\r\n  _emit(event) {\r\n    const payload = {\r\n      type: event.type,\r\n      id: event.id || null,\r\n      reason: event.reason || null,\r\n      list: this.exportToArray(),\r\n      count: this.getCount(),\r\n    };\r\n    for (const cb of this._subs) {\r\n      try {\r\n        cb(payload);\r\n      } catch (e) {\r\n        console.warn('FavoritesModule subscriber error', e);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Schedule the save to storage with debounce.\r\n   * @private\r\n   */\r\n  _scheduleSave() {\r\n    if (this._saveDebounceMs <= 0) {\r\n      this._doSave();\r\n      return;\r\n    }\r\n    if (this._saveTimer) clearTimeout(this._saveTimer);\r\n    this._saveTimer = setTimeout(() => {\r\n      this._saveTimer = null;\r\n      this._doSave();\r\n    }, this._saveDebounceMs);\r\n  }\r\n\r\n  /**\r\n   * Perform the actual save to storage.\r\n   * @private\r\n   */\r\n  async _doSave() {\r\n    try {\r\n      const result = this.storage.saveFavs(this._list);\r\n      if (result && typeof result.then === 'function') await result;\r\n    } catch (e) {\r\n      console.warn('FavoritesModule: save to storage failed', e);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Normalize an ID into a string.\r\n   * @private\r\n   */\r\n  _normalizeId(id) {\r\n    if (id === null || id === undefined) return null;\r\n    const candidate = id?.name || id?.id || id?.productId || id?._missingId || id;\r\n    const str = String(candidate).trim();\r\n    return str === '' ? null : str;\r\n  }\r\n\r\n  /**\r\n   * Apply truncation when exceeding max limit.\r\n   * @private\r\n   */\r\n  _applyMaxTruncate() {\r\n    if (this._max <= 0 || this._list.length <= this._max) return false;\r\n    this._list = this._list.slice(-this._max);\r\n    this._set = new Set(this._list);\r\n    return true;\r\n  }\r\n\r\n  // --- Public Methods ---\r\n\r\n  /**\r\n   * Load favorites from storage and update the internal list.\r\n   */\r\n  async loadFromStorage() {\r\n    try {\r\n      const raw = await (this.storage.loadFavsWithAvailability ? this.storage.loadFavsWithAvailability() : this.storage.loadFavs());\r\n      const normalized = this._normalizeList(raw);\r\n      this._list = normalized;\r\n      this._set = new Set(normalized);\r\n\r\n      if (this._applyMaxTruncate()) this._scheduleSave();\r\n      this._emit({ type: 'load', id: null });\r\n      return this.exportToArray();\r\n    } catch (e) {\r\n      console.warn('FavoritesModule.loadFromStorage error', e);\r\n      return this.exportToArray();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Save the current list immediately.\r\n   */\r\n  saveToStorage() {\r\n    if (this._destroyed) return;\r\n    if (this._saveTimer) clearTimeout(this._saveTimer);\r\n    this._saveTimer = null;\r\n    this._doSave();\r\n  }\r\n\r\n  /**\r\n   * Check if an ID is in favorites.\r\n   */\r\n  has(id) {\r\n    return this.isFavorite(id);\r\n  }\r\n\r\n  /**\r\n   * Check if an ID is in favorites.\r\n   */\r\n  isFavorite(id) {\r\n    return this._set.has(this._normalizeId(id));\r\n  }\r\n\r\n  /**\r\n   * Get all favorite IDs as an array.\r\n   */\r\n  getAll() {\r\n    return [...this._list];\r\n  }\r\n\r\n  /**\r\n   * Get the number of favorites.\r\n   */\r\n  getCount() {\r\n    return this._list.length;\r\n  }\r\n\r\n  /**\r\n   * Add an item to favorites.\r\n   */\r\n  add(id) {\r\n    if (this._destroyed) return false;\r\n    const sid = this._normalizeId(id);\r\n    if (!sid || this._set.has(sid)) return false;\r\n\r\n    if (this._max > 0 && this._list.length >= this._max) {\r\n      if (this._overflow === 'drop_oldest') {\r\n        const removed = this._list.shift();\r\n        if (removed !== undefined) this._set.delete(removed);\r\n      } else {\r\n        this._emit({ type: 'limit', id: sid, reason: 'limit_reached' });\r\n        return false;\r\n      }\r\n    }\r\n\r\n    this._list.push(sid);\r\n    this._set.add(sid);\r\n    this._scheduleSave();\r\n    this._emit({ type: 'add', id: sid });\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Remove an item from favorites.\r\n   */\r\n  remove(id) {\r\n    if (this._destroyed) return false;\r\n    const sid = this._normalizeId(id);\r\n    if (!sid || !this._set.has(sid)) return false;\r\n\r\n    this._list = this._list.filter(x => x !== sid);\r\n    this._set.delete(sid);\r\n    this._scheduleSave();\r\n    this._emit({ type: 'remove', id: sid });\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Toggle an item's presence in favorites.\r\n   */\r\n  toggle(id) {\r\n    if (this._destroyed) return false;\r\n    return this.isFavorite(id) ? this.remove(id) : this.add(id);\r\n  }\r\n\r\n  /**\r\n   * Clear all favorites.\r\n   */\r\n  clear() {\r\n    if (this._destroyed) return;\r\n    if (!this._list.length) return;\r\n\r\n    this._list = [];\r\n    this._set.clear();\r\n    this._scheduleSave();\r\n    this._emit({ type: 'clear', id: null });\r\n  }\r\n\r\n  /**\r\n   * Import a list of IDs into the favorites.\r\n   */\r\n  importFromArray(arr = [], { replace = false, persist = true } = {}) {\r\n    if (!Array.isArray(arr)) return this.exportToArray();\r\n\r\n    const normalized = this._normalizeList(arr);\r\n    if (replace) {\r\n      this._list = normalized.slice(-this._max);\r\n      this._set = new Set(this._list);\r\n    } else {\r\n      normalized.forEach(sid => {\r\n        if (!this._set.has(sid)) {\r\n          if (this._max > 0 && this._list.length >= this._max) {\r\n            if (this._overflow === 'drop_oldest') {\r\n              const removed = this._list.shift();\r\n              if (removed !== undefined) this._set.delete(removed);\r\n            } else {\r\n              return;\r\n            }\r\n          }\r\n          this._list.push(sid);\r\n          this._set.add(sid);\r\n        }\r\n      });\r\n    }\r\n    if (persist) this._scheduleSave();\r\n    this._emit({ type: 'import', id: null });\r\n    return this.exportToArray();\r\n  }\r\n\r\n  /**\r\n   * Normalize and deduplicate a list of IDs.\r\n   * @private\r\n   */\r\n  _normalizeList(arr) {\r\n    const seen = new Set();\r\n    return arr.reduce((normalized, el) => {\r\n      const sid = this._normalizeId(el);\r\n      if (sid && !seen.has(sid)) {\r\n        seen.add(sid);\r\n        normalized.push(sid);\r\n      }\r\n      return normalized;\r\n    }, []);\r\n  }\r\n\r\n  /**\r\n   * Return a copy of the favorites array.\r\n   */\r\n  exportToArray() {\r\n    return [...this._list];\r\n  }\r\n\r\n  /**\r\n   * Subscribe to favorites events.\r\n   */\r\n  subscribe(cb, { immediate = true } = {}) {\r\n    if (typeof cb !== 'function') throw new Error('subscribe requires a function');\r\n    this._subs.add(cb);\r\n    if (immediate) {\r\n      cb({ type: 'load', id: null, list: this.exportToArray(), count: this.getCount() });\r\n    }\r\n    return () => this._subs.delete(cb);\r\n  }\r\n\r\n  /**\r\n   * Respond to storage events (cross-tab sync).\r\n   * @private\r\n   */\r\n  async _onStorageEvent(e) {\r\n    const favKey = this._storageKey || (this.storage && this.storage.favStorageKey) || null;\r\n    if (e?.key === favKey) {\r\n      const prev = this.exportToArray();\r\n      await this.loadFromStorage();\r\n      const curr = this.exportToArray();\r\n      if (prev.length !== curr.length || prev.some((v, i) => v !== curr[i])) {\r\n        this._emit({ type: 'sync', id: null });\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Destroy the module and clear all timers and listeners.\r\n   */\r\n  destroy() {\r\n    if (this._destroyed) return;\r\n    this._destroyed = true;\r\n    if (this._saveTimer) clearTimeout(this._saveTimer);\r\n    if (this._sync && window.removeEventListener) {\r\n      window.removeEventListener('storage', this._onStorageEvent);\r\n    }\r\n    this._subs.clear();\r\n  }\r\n\r\n  /**\r\n   * Iterate over the favorites list (yields IDs).\r\n   */\r\n  [Symbol.iterator]() {\r\n    return this._list[Symbol.iterator]();\r\n  }\r\n\r\n  /**\r\n   * Return a new Set containing all favorites.\r\n   */\r\n  toSet() {\r\n    return new Set(this._set);\r\n  }\r\n}", "/**\r\n * WishlistModule (class)\r\n * @author Calista Verner\r\n * Version: 1.0.0\r\n */\r\nexport class WishlistModule {\r\n  constructor(opts = {}) {\r\n    this.globalConfig = (typeof window !== 'undefined' && window.FAV_API_CONFIG) ? window.FAV_API_CONFIG : {};\r\n    this.foxEngine = (typeof window !== 'undefined' && window.foxEngine) ? window.foxEngine : (opts.foxEngine || null);\r\n\r\n    // merge config\r\n    const cfg = Object.assign({}, this.globalConfig, opts);\r\n    this.config = {\r\n      storageKey: (this.foxEngine && this.foxEngine.shopMatic && this.foxEngine.shopMatic.FAV_KEY) || cfg.storageKey || 'gribkov_favs_v1',\r\n      api: {\r\n        enabled: cfg.enabled ?? (!!(cfg.baseUrl || (this.foxEngine && this.foxEngine.shopMatic && this.foxEngine.shopMatic.apiBase))),\r\n        baseUrl: cfg.baseUrl ?? (this.foxEngine && this.foxEngine.shopMatic && this.foxEngine.shopMatic.apiBase) ?? '/api',\r\n        endpoints: Object.assign({\r\n          list: '/favorites',\r\n          add: '/favorites',\r\n          remove: '/favorites/{id}',\r\n          clear: '/favorites/clear',\r\n          product: '/products/{id}'\r\n        }, (cfg.endpoints || {})),\r\n        getHeaders: cfg.getHeaders || (() => {\r\n          try {\r\n            if (this.foxEngine && this.foxEngine.auth && this.foxEngine.auth.getToken) {\r\n              const t = this.foxEngine.auth.getToken();\r\n              if (t) return { 'Authorization': `Bearer ${t}` };\r\n            }\r\n            if (typeof this.globalConfig.getAuthToken === 'function') {\r\n              const t = this.globalConfig.getAuthToken();\r\n              if (t) return { [this.globalConfig.authHeader || 'Authorization']: t };\r\n            }\r\n          } catch(_) {}\r\n          return { 'Content-Type': 'application/json' };\r\n        }),\r\n        fetchOptions: cfg.fetchOptions || { credentials: 'same-origin' },\r\n        debug: cfg.debug ?? false,\r\n        optimisticRemoveDelayMs: cfg.optimisticRemoveDelayMs ?? 180\r\n      },\r\n      selectors: {\r\n        grid: '#wishlist-grid',\r\n        count: '#fav-count',\r\n        clearBtn: '#clear-wishlist',\r\n        backBtn: '#back-to-shop'\r\n      },\r\n      ui: {\r\n        loadingText: '\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430...',\r\n        emptyTitle: '\u0421\u043F\u0438\u0441\u043E\u043A \u0436\u0435\u043B\u0430\u0435\u043C\u043E\u0433\u043E \u043F\u0443\u0441\u0442',\r\n        emptyBody: '\u0414\u043E\u0431\u0430\u0432\u044C\u0442\u0435 \u0442\u043E\u0432\u0430\u0440\u044B \u0432 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435 \u043D\u0430 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0435 \u043A\u0430\u0442\u0430\u043B\u043E\u0433\u0430 \u2014 \u043E\u043D\u0438 \u043F\u043E\u044F\u0432\u044F\u0442\u0441\u044F \u0437\u0434\u0435\u0441\u044C.',\r\n        removedError: '\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0443\u0434\u0430\u043B\u0435\u043D\u0438\u0438 \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E',\r\n        removeFailedRefresh: '\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E \u2014 \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u044E \u0441\u043F\u0438\u0441\u043E\u043A',\r\n        cleared: '\u0421\u043F\u0438\u0441\u043E\u043A \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E \u043E\u0447\u0438\u0449\u0435\u043D!',\r\n        clearConfirm: '\u041E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u0441\u043F\u0438\u0441\u043E\u043A \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E?',\r\n        clearCascadeDelay: 50\r\n      },\r\n      debounceMs: cfg.debounceMs ?? 120,\r\n      availabilityDebounceMs: cfg.availabilityDebounceMs ?? 40\r\n    };\r\n\r\n    // DOM refs (resolved on init)\r\n    this.grid = null;\r\n    this.countEl = null;\r\n    this.clearBtn = null;\r\n    this.backBtn = null;\r\n\r\n    // timers / handlers\r\n    this._refreshTimer = null;\r\n    this._cartUpdateTimer = null;\r\n    this._storageHandler = this._onStorageEvent.bind(this);\r\n    this._cartHandler = this._onCartUpdated.bind(this);\r\n    this._clearHandler = null;\r\n    this._backHandler = null;\r\n    this._gridClickHandler = null;\r\n\r\n    this._destroyed = false;\r\n  }\r\n\r\n  /* ---------- logging ---------- */\r\n  _log(...args) { if (this.config.api.debug) console.info('[Wishlist]', ...args); }\r\n  _error(...args) { if (this.config.api.debug) console.error('[Wishlist]', ...args); }\r\n\r\n  /* ---------- helpers ---------- */\r\n  _normalizeIdRaw(id) {\r\n    if (id === undefined || id === null) return '';\r\n    if (typeof id === 'object') return String(id.id ?? id.name ?? id.productId ?? id.cartId ?? id.itemId ?? '').trim();\r\n    return String(id).trim();\r\n  }\r\n  _normalizeKey(id) { return String(this._normalizeIdRaw(id)); }\r\n\r\n  notify(text, opts = {}) {\r\n    try {\r\n      if (this.foxEngine && this.foxEngine.notifications && typeof this.foxEngine.notifications.show === 'function') {\r\n        return this.foxEngine.notifications.show(text, opts);\r\n      }\r\n      if (this.foxEngine && this.foxEngine.shopMatic && this.foxEngine.shopMatic.notifications && typeof this.foxEngine.shopMatic.notifications.show === 'function') {\r\n        return this.foxEngine.shopMatic.notifications.show(text, opts);\r\n      }\r\n    } catch (e) { this._error('notify hook failed', e); }\r\n    if (opts.type === 'error') alert(text);\r\n  }\r\n\r\n  async _apiFetch(path, init = {}) {\r\n    const base = (this.config.api.baseUrl || '/').replace(/\\/$/, '');\r\n    const url = (path && path.startsWith('http')) ? path : `${base}/${String(path).replace(/^\\//, '')}`;\r\n    const headers = Object.assign({}, (this.config.api.getHeaders ? this.config.api.getHeaders() : {}), init.headers || {});\r\n    const merged = Object.assign({}, this.config.api.fetchOptions || {}, init, { headers });\r\n    this._log('apiFetch', url, merged);\r\n    const res = await fetch(url, merged);\r\n    if (!res.ok) {\r\n      const txt = await res.text().catch(()=>null);\r\n      const err = new Error(`API ${res.status} ${res.statusText}${txt ? ' \u2014 ' + txt.slice(0,200) : ''}`);\r\n      err.response = res;\r\n      throw err;\r\n    }\r\n    const ct = res.headers.get('content-type') || '';\r\n    if (ct.includes('application/json')) return await res.json();\r\n    return await res.text();\r\n  }\r\n\r\n  /* ---------- DOM helpers & animations ---------- */\r\n  _findNodesByKey(idKey) {\r\n    if (!this.grid) return [];\r\n    const nodes = Array.from(this.grid.querySelectorAll('[data-product-id]'));\r\n    return nodes.filter(n => this._normalizeKey(n.getAttribute('data-product-id') || '') === this._normalizeKey(idKey));\r\n  }\r\n\r\n  _appleRemoveAnimation(node, opts = {}) {\r\n    return new Promise(resolve => {\r\n      if (!node || !node.parentNode) return resolve(false);\r\n      try {\r\n        if (typeof node.animate === 'function') {\r\n          const keyframes = [\r\n            { transform: 'scale(1) translateY(0)', opacity: 1, filter: 'blur(0px)' },\r\n            { transform: 'scale(0.98) translateY(-6px)', opacity: 0.8, filter: 'blur(2px)', offset: 0.4 },\r\n            { transform: 'scale(0.9) translateY(-20px)', opacity: 0, filter: 'blur(6px)' }\r\n          ];\r\n          const timing = { duration: opts.duration || 600, easing: opts.easing || 'cubic-bezier(.22,.61,.36,1)', fill: 'forwards' };\r\n          const prevZ = node.style.zIndex;\r\n          node.style.zIndex = 9999;\r\n          const anim = node.animate(keyframes, timing);\r\n          anim.onfinish = () => { node.style.zIndex = prevZ; node.remove(); resolve(true); };\r\n          anim.oncancel = anim.onfinish;\r\n          return;\r\n        }\r\n        node.style.transition = 'all 0.6s cubic-bezier(.22,.61,.36,1)';\r\n        node.style.opacity = '0';\r\n        node.style.transform = 'translateY(-20px) scale(0.9)';\r\n        node.style.filter = 'blur(4px)';\r\n        setTimeout(() => { try { node.remove(); } catch(_){}; resolve(true); }, 600);\r\n      } catch (e) {\r\n        try { node.remove(); } catch(_) {}\r\n        resolve(true);\r\n      }\r\n    });\r\n  }\r\n\r\n  async _removeNodeElem(node) {\r\n    if (!node || !node.parentNode) return false;\r\n    if (node.dataset.removing === '1') return false;\r\n    node.dataset.removing = '1';\r\n    const ok = await this._appleRemoveAnimation(node).catch(()=>true);\r\n    try { delete node.dataset.removing; } catch(_) {}\r\n    // pulse counter\r\n    try {\r\n      if (this.countEl && typeof this.countEl.animate === 'function') {\r\n        this.countEl.animate([{ transform: 'scale(1)' }, { transform: 'scale(1.08)' }, { transform: 'scale(1)' }], { duration: 360, easing: 'cubic-bezier(.2,.9,.2,1)' });\r\n      } else if (this.countEl) {\r\n        this.countEl.style.transition = 'transform 180ms ease';\r\n        this.countEl.style.transform = 'scale(1.06)';\r\n        setTimeout(()=> { if (this.countEl) this.countEl.style.transform = ''; }, 180);\r\n      }\r\n    } catch (_) {}\r\n    return ok;\r\n  }\r\n\r\n  async removeNodeById(id) {\r\n    if (!id) return;\r\n    const key = this._normalizeKey(id);\r\n    const nodes = this._findNodesByKey(key);\r\n    if (!nodes.length) return;\r\n    await Promise.all(nodes.map(n => this._removeNodeElem(n)));\r\n    this.recalcCount();\r\n  }\r\n\r\n  async removeNodesByIds(ids = []) {\r\n    const uniq = Array.isArray(ids) ? Array.from(new Set(ids.map(this._normalizeKey.bind(this)))) : [];\r\n    const promises = [];\r\n    for (const k of uniq) {\r\n      const nodes = this._findNodesByKey(k);\r\n      for (const n of nodes) promises.push(this._removeNodeElem(n));\r\n    }\r\n    if (promises.length) await Promise.all(promises);\r\n    this.recalcCount();\r\n  }\r\n\r\n  recalcCount() {\r\n    try {\r\n      if (!this.countEl) return;\r\n      if (!this.grid) { this.countEl.textContent = '\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u043C: 0'; return; }\r\n      const cards = Array.from(this.grid.querySelectorAll('[data-product-id]'));\r\n      const set = new Set(cards.map(c => this._normalizeKey(c.getAttribute('data-product-id') || '')));\r\n      const n = set.size;\r\n      this.countEl.textContent = n > 0 ? `\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u043C: ${n}` : '\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u043C \u043F\u0443\u0441\u0442\u043E';\r\n    } catch (e) { this._error('recalcCount failed', e); }\r\n  }\r\n\r\n  _dispatchLocalStorageEvent(key, oldValue, newValue) {\r\n    try {\r\n      const ev = new StorageEvent('storage', { key, oldValue, newValue, url: location.href, storageArea: localStorage });\r\n      window.dispatchEvent(ev);\r\n    } catch (e) {\r\n      try { window.dispatchEvent(new CustomEvent('favorites:changed', { detail: { key, oldValue, newValue } })); } catch(_) {}\r\n    }\r\n  }\r\n\r\n  normalizeFavoritesArray(arr) {\r\n    return (Array.isArray(arr) ? arr : []).map(entry => {\r\n      if (!entry) return null;\r\n      if (typeof entry === 'string' || typeof entry === 'number') {\r\n        const sid = String(entry);\r\n        return { _missingId: sid, name: sid, fullname: sid, price: null, picture: '', stock: 0, short: '\u0422\u043E\u0432\u0430\u0440 (\u0434\u0430\u043D\u043D\u044B\u0435 \u043E\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u044E\u0442)' };\r\n      }\r\n      const id = this._normalizeIdRaw(entry.name ?? entry.id ?? entry.productId ?? entry.title ?? entry.fullname ?? entry._missingId ?? '');\r\n      return {\r\n        _missingId: entry._missingId ?? '',\r\n        name: id || '',\r\n        fullname: entry.fullname ?? entry.title ?? entry.name ?? id,\r\n        price: (entry.price != null) ? entry.price : (entry.cost != null ? entry.cost : null),\r\n        oldPrice: entry.oldPrice ?? entry.previousPrice ?? null,\r\n        picture: entry.picture ?? entry.image ?? entry.img ?? '',\r\n        stock: entry.stock,\r\n        short: entry.short ?? entry.summary ?? entry.description ?? '',\r\n        raw: entry\r\n      };\r\n    }).filter(Boolean);\r\n  }\r\n\r\n  /* ---------- remove / optimistic remove ---------- */\r\n  async removeFromFav(id) {\r\n    const key = this._normalizeIdRaw(id);\r\n    if (!key) return false;\r\n\r\n    // shopMatic integration\r\n    try {\r\n      if (this.foxEngine && this.foxEngine.shopMatic && typeof this.foxEngine.shopMatic.removeFavorite === 'function') {\r\n        await Promise.resolve(this.foxEngine.shopMatic.removeFavorite(key));\r\n        this._log('removed via shopMatic', key);\r\n        await this.removeNodeById(key);\r\n        return true;\r\n      }\r\n    } catch (e) { this._error('shopMatic.removeFavorite failed', e); }\r\n\r\n    // API\r\n    if (this.config.api.enabled) {\r\n      try {\r\n        const path = this.config.api.endpoints.remove.replace('{id}', encodeURIComponent(key));\r\n        try {\r\n          await this._apiFetch(path, { method: 'DELETE' });\r\n        } catch {\r\n          await this._apiFetch(path, { method: 'POST', body: JSON.stringify({ id: key }) });\r\n        }\r\n        this._log('removed via API', key);\r\n        await this.removeNodeById(key);\r\n        return true;\r\n      } catch (e) { this._error('API removeFromFav failed', e); }\r\n    }\r\n\r\n    // fallback localStorage\r\n    try {\r\n      const raw = localStorage.getItem(this.config.storageKey);\r\n      if (!raw) {\r\n        await this.removeNodeById(key);\r\n        return true;\r\n      }\r\n      let arr = JSON.parse(raw) || [];\r\n      arr = arr.filter(x => this._normalizeKey(x) !== this._normalizeKey(key));\r\n      const old = localStorage.getItem(this.config.storageKey);\r\n      localStorage.setItem(this.config.storageKey, JSON.stringify(arr));\r\n      this._dispatchLocalStorageEvent(this.config.storageKey, old, JSON.stringify(arr));\r\n      this._log('removed from localStorage', key);\r\n      await this.removeNodeById(key);\r\n      return true;\r\n    } catch (e) {\r\n      this._error('removeFromFav fallback failed', e);\r\n      this.notify(this.config.ui.removedError, { type: 'error' });\r\n      return false;\r\n    }\r\n  }\r\n\r\n  async optimisticRemoveUI(id, node) {\r\n    if (!id) return;\r\n    try {\r\n      if (node && node.parentNode) {\r\n        const animPromise = this._removeNodeElem(node);\r\n        const backendPromise = this.removeFromFav(id);\r\n        const res = await Promise.all([animPromise, backendPromise]).catch(()=>[true,false]);\r\n        const ok = Array.isArray(res) ? Boolean(res[1]) : Boolean(res);\r\n        if (!ok) throw new Error('remove returned false');\r\n        this._log('optimistic remove succeeded', id);\r\n      } else {\r\n        const ok = await this.removeFromFav(id);\r\n        if (!ok) {\r\n\t\t\tthrow new Error('remove returned false');\r\n\t\t}\r\n      }\r\n    } catch (e) {\r\n      this._error('optimisticRemoveUI failed', e);\r\n      this.notify(this.config.ui.removeFailedRefresh, { type: 'error' });\r\n      this.refresh(true);\r\n    }\r\n\tthis.recalcCount();\r\n\tthis.removeFromFav(id);\r\n  }\r\n\r\n  /* ---------- availability refresh (cart updates) ---------- */\r\n  scheduleAvailabilityRefresh(delay = this.config.availabilityDebounceMs) {\r\n    if (this._cartUpdateTimer) clearTimeout(this._cartUpdateTimer);\r\n    this._cartUpdateTimer = setTimeout(() => {\r\n      this._cartUpdateTimer = null;\r\n      this.updateAllCardAvailability();\r\n    }, delay);\r\n  }\r\n\r\n  updateAllCardAvailability() {\r\n    try {\r\n      if (!this.grid) return;\r\n      const cards = Array.from(this.grid.querySelectorAll('[data-product-id]'));\r\n      if (!cards.length) return;\r\n\r\n      // use integrated card API if present\r\n      const cardApi = this.foxEngine && this.foxEngine.shopMatic && this.foxEngine.shopMatic.card ? this.foxEngine.shopMatic.card : null;\r\n      const useSync = cardApi && typeof cardApi._syncCardControlsState === 'function';\r\n\r\n      // build cart map\r\n      let cartItems = [];\r\n      try {\r\n        if (this.foxEngine && this.foxEngine.shopMatic && this.foxEngine.shopMatic.cart) {\r\n          const cart = this.foxEngine.shopMatic.cart;\r\n          if (typeof cart.getCart === 'function') cartItems = cart.getCart() || [];\r\n          else if (Array.isArray(cart.cart)) cartItems = cart.cart;\r\n        }\r\n      } catch(_) { cartItems = []; }\r\n      const cartMap = new Map();\r\n      for (const it of cartItems) {\r\n        try {\r\n          const k = this._normalizeKey(it.name ?? it.id ?? it.productId ?? it.cartId ?? '');\r\n          cartMap.set(k, Number(it.qty || it.quantity || 0));\r\n        } catch (_) {}\r\n      }\r\n\r\n      for (const card of cards) {\r\n        try {\r\n          if (useSync) {\r\n            try { cardApi._syncCardControlsState(card); continue; } catch (e) { /* fallback */ }\r\n          }\r\n\r\n          const pidRaw = card.getAttribute('data-product-id') || card.getAttribute('data-id') || card.dataset?.productId || '';\r\n          const pid = this._normalizeKey(pidRaw);\r\n\r\n          // find stock via productService if available\r\n          let stock = NaN;\r\n          try {\r\n            if (this.foxEngine && this.foxEngine.shopMatic && this.foxEngine.shopMatic.productService && typeof this.foxEngine.shopMatic.productService.findById === 'function') {\r\n              const prod = this.foxEngine.shopMatic.productService.findById(pidRaw) || this.foxEngine.shopMatic.productService.findById(pid) || null;\r\n              if (prod) stock = Number(prod.stock ?? prod._stock ?? prod.count ?? 0);\r\n            }\r\n          } catch (_) { stock = NaN; }\r\n          if (!Number.isFinite(stock)) {\r\n            const ds = card.getAttribute && card.getAttribute('data-stock');\r\n            stock = ds !== null ? Number(ds) : NaN;\r\n          }\r\n          if (!Number.isFinite(stock)) stock = 0;\r\n\r\n          const inCartQty = cartMap.get(pid) || 0;\r\n          const available = Math.max(0, Number(stock) - Number(inCartQty));\r\n\r\n          const buyBtn = card.querySelector && (card.querySelector('[data-role=\"buy\"], [data-action=\"buy\"], .btn-buy'));\r\n          const incrBtn = card.querySelector && (card.querySelector('[data-role=\"qty-plus\"], .qty-incr, [data-action=\"qty-incr\"]'));\r\n          const decrBtn = card.querySelector && (card.querySelector('[data-role=\"qty-minus\"], .qty-decr, [data-action=\"qty-decr\"]'));\r\n          const qtyInput = card.querySelector && (card.querySelector('[data-role=\"qty-input\"], .qty-input, input[type=\"number\"]'));\r\n          const leftNum = card.querySelector && card.querySelector('.leftNum');\r\n\r\n          if (leftNum) leftNum.textContent = String(available);\r\n          if (buyBtn) {\r\n            buyBtn.disabled = available <= 0;\r\n            buyBtn.toggleAttribute && buyBtn.toggleAttribute('aria-disabled', available <= 0);\r\n          }\r\n          if (incrBtn && qtyInput) {\r\n            const currentVal = Math.max(0, parseInt(qtyInput.value || '0', 10));\r\n            const disableIncr = !available || currentVal >= available;\r\n            incrBtn.disabled = disableIncr;\r\n            incrBtn.toggleAttribute && incrBtn.toggleAttribute('aria-disabled', disableIncr);\r\n          }\r\n          if (qtyInput) {\r\n            if (!available) {\r\n              qtyInput.disabled = true;\r\n              qtyInput.setAttribute && qtyInput.setAttribute('aria-disabled', 'true');\r\n              qtyInput.value = '0';\r\n            } else {\r\n              qtyInput.disabled = false;\r\n              qtyInput.removeAttribute && qtyInput.removeAttribute('aria-disabled');\r\n              let val = parseInt(qtyInput.value || '1', 10);\r\n              val = isNaN(val) || val < 1 ? 1 : Math.min(val, available);\r\n              qtyInput.value = String(val);\r\n            }\r\n          }\r\n          if (decrBtn && qtyInput) {\r\n            const v = parseInt(qtyInput.value || '0', 10);\r\n            const disabled = v <= 1;\r\n            decrBtn.disabled = disabled;\r\n            decrBtn.toggleAttribute && decrBtn.toggleAttribute('aria-disabled', disabled);\r\n          }\r\n        } catch (e) { this._error('updateAllCardAvailability: card update failed', e); }\r\n      }\r\n    } catch (e) { this._error('updateAllCardAvailability failed', e); }\r\n  }\r\n\r\n  _onStorageEvent(e) {\r\n    try {\r\n      if (!e) return;\r\n      if (e.key !== this.config.storageKey && e.key !== null) return;\r\n      let newIds = [];\r\n      try {\r\n        const raw = localStorage.getItem(this.config.storageKey);\r\n        if (raw) {\r\n          const arr = JSON.parse(raw);\r\n          if (Array.isArray(arr)) newIds = arr.map(String).map(s => this._normalizeKey(s));\r\n        }\r\n      } catch(_) { newIds = []; }\r\n\r\n      const domIds = Array.from(this.grid ? this.grid.querySelectorAll('[data-product-id]') : []).map(c => this._normalizeKey(c.getAttribute('data-product-id') || '')).filter(Boolean);\r\n      const toRemove = domIds.filter(d => !newIds.includes(d));\r\n      if (toRemove.length) this.removeNodesByIds(toRemove);\r\n      else this.refresh(true);\r\n    } catch (e) { this._error('storage listener error', e); this.refresh(true); }\r\n  }\r\n\r\n  _onCartUpdated(/*ev*/) {\r\n    // debounce to batch frequent updates\r\n    this.scheduleAvailabilityRefresh(this.config.availabilityDebounceMs);\r\n  }\r\n\r\n  /* ---------- render ---------- */\r\n  async renderGrid() {\r\n    if (!this.grid) return;\r\n    this.grid.innerHTML = '';\r\n    let items = [];\r\n    try {\r\n      items = (this.foxEngine && this.foxEngine.shopMatic && typeof this.foxEngine.shopMatic.getFavorites === 'function')\r\n        ? this.foxEngine.shopMatic.getFavorites()\r\n        : [];\r\n    } catch (e) { this._error('renderGrid fetchFavorites failed', e); items = []; }\r\n\r\n    const dedup = new Map();\r\n    for (const p of items) {\r\n      const key = this._normalizeKey(p && (p.name || p._missingId || p.id || p.productId));\r\n\t  //let product = await this.foxEngine.shopMatic.productService.fetchById(key);\r\n\t  //console.log(product.name);\r\n\t  //if(!product.name) {\r\n\t //  console.log('Removing unexisting product '+key+' from wishlist!');\r\n\t//\t  this.removeFromFav(key);\r\n\t  //}\r\n      if (!key) continue;\r\n      if (!dedup.has(key)) dedup.set(key, p);\r\n      else {\r\n        const existing = dedup.get(key);\r\n        existing.qty = Math.max(existing.qty || 1, p.qty || existing.qty || 1);\r\n      }\r\n    }\r\n    const uniqueItems = Array.from(dedup.values());\r\n\r\n    if (this.countEl) this.countEl.textContent = (uniqueItems && uniqueItems.length) ? `\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u043C: ${uniqueItems.length}` : '\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u043C \u043F\u0443\u0441\u0442\u043E';\r\n\r\n    if (!uniqueItems || uniqueItems.length === 0) {\r\n      this.grid.innerHTML = `<div class=\"empty\" role=\"status\"><h3>${this.config.ui.emptyTitle}</h3><p>${this.config.ui.emptyBody}</p></div>`;\r\n      return;\r\n    }\r\n\r\n    // try integrated renderer first\r\n    try {\r\n      if (this.foxEngine && this.foxEngine.shopMatic && this.foxEngine.shopMatic.renderer && typeof this.foxEngine.shopMatic.renderer._renderCartVertical === 'function') {\r\n        this.foxEngine.shopMatic.renderer._renderCartVertical(items, this.grid);\r\n      } else {\r\n        // fallback simple cards\r\n        const frag = document.createDocumentFragment();\r\n        for (const it of uniqueItems) {\r\n          const id = this._normalizeIdRaw(it.name || it._missingId || '');\r\n          const card = document.createElement('div');\r\n          card.className = 'wish-card';\r\n          card.setAttribute('data-product-id', id);\r\n          card.innerHTML = `\r\n            <div class=\"wish-thumb\"><img src=\"${this._escapeAttr(it.picture || '/assets/no-image.png')}\" alt=\"${this._escapeAttr(it.fullname || it.name || id)}\" loading=\"lazy\"></div>\r\n            <div class=\"wish-body\">\r\n              <div class=\"wish-name\">${this._escapeHtml(it.fullname || it.name || id)}</div>\r\n              <div class=\"wish-meta\">${(it.price != null) ? this._escapeHtml(String(it.price) + ' \u20BD') : ''}</div>\r\n              <button class=\"wish-remove\" data-action=\"fav-remove\" aria-label=\"\u0423\u0434\u0430\u043B\u0438\u0442\u044C\">\u0423\u0434\u0430\u043B\u0438\u0442\u044C</button>\r\n            </div>`;\r\n          frag.appendChild(card);\r\n        }\r\n        this.grid.appendChild(frag);\r\n      }\r\n    } catch (e) { this._error('renderGrid renderer failed', e); }\r\n\r\n    // bind card delegation (if renderer created cards)\r\n    try {\r\n      if (this.foxEngine && this.foxEngine.shopMatic && this.foxEngine.shopMatic.card && typeof this.foxEngine.shopMatic.card._bindCardDelegation === 'function') {\r\n        this.foxEngine.shopMatic.card._bindCardDelegation(this.grid);\r\n      }\r\n    } catch (_) {}\r\n\r\n    // small delay to sync states and availability\r\n    setTimeout(() => {\r\n      for (const card of this.grid.querySelectorAll('[data-product-id]')) {\r\n        try {\r\n          if (this.foxEngine && this.foxEngine.shopMatic && this.foxEngine.shopMatic.card && typeof this.foxEngine.shopMatic.card._syncCardControlsState === 'function') {\r\n            this.foxEngine.shopMatic.card._syncCardControlsState(card);\r\n          }\r\n          const pid = card.getAttribute('data-product-id');\r\n          if (this.foxEngine && this.foxEngine.shopMatic && this.foxEngine.shopMatic.renderer && typeof this.foxEngine.shopMatic.renderer.updateProductCardFavState === 'function') {\r\n            this.foxEngine.shopMatic.renderer.updateProductCardFavState(this.grid, pid, (this.foxEngine.shopMatic.isFavorite && this.foxEngine.shopMatic.isFavorite(pid)));\r\n          }\r\n        } catch (_) {}\r\n      }\r\n      this.scheduleAvailabilityRefresh(60);\r\n    }, 300);\r\n  }\r\n\r\n  _escapeHtml(s='') {\r\n    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#39;');\r\n  }\r\n  _escapeAttr(s=''){ return this._escapeHtml(s); }\r\n\r\n  /* ---------- UI helpers ---------- */\r\n  _setButtonLoading(btn, loading) {\r\n    if (!btn) return;\r\n    try {\r\n      btn.disabled = !!loading;\r\n      if (loading) {\r\n        btn.setAttribute('aria-busy','true');\r\n        btn.dataset.origText = btn.innerHTML;\r\n        btn.innerHTML = '<span style=\"display:inline-flex;align-items:center;gap:8px;\"><i class=\"fa fa-spinner fa-spin\" aria-hidden=\"true\"></i> \u041E\u0431\u0440\u0430\u0431\u043E\u0442\u043A\u0430...</span>';\r\n      } else {\r\n        btn.removeAttribute('aria-busy');\r\n        if (btn.dataset.origText) { btn.innerHTML = btn.dataset.origText; delete btn.dataset.origText; }\r\n      }\r\n    } catch (e) { this._error('setButtonLoading failed', e); }\r\n  }\r\n\r\n  decrementCount() {\r\n    try {\r\n      if (!this.countEl) return;\r\n      const txt = (this.countEl.textContent || '').match(/\\d+/);\r\n      if (txt && txt[0]) {\r\n        const v = Math.max(0, parseInt(txt[0],10)-1);\r\n        this.countEl.textContent = v > 0 ? `\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u043C: ${v}` : '\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u043C \u043F\u0443\u0441\u0442\u043E';\r\n        try {\r\n          if (typeof this.countEl.animate === 'function') {\r\n            this.countEl.animate([{ transform:'scale(1)' },{ transform:'scale(1.08)' },{ transform:'scale(1)'}], { duration:360, easing:'cubic-bezier(.2,.9,.2,1)' });\r\n          }\r\n        } catch(_) {}\r\n      } else this.refresh(true);\r\n    } catch (e) { this._error('decrementCount failed', e); }\r\n  }\r\n\r\n  /* ---------- lifecycle: init / refresh / destroy ---------- */\r\n  init() {\r\n    if (this._destroyed) return;\r\n    const sel = this.config.selectors;\r\n    this.grid = document.querySelector(sel.grid);\r\n    this.countEl = document.querySelector(sel.count);\r\n    this.clearBtn = document.querySelector(sel.clearBtn);\r\n    this.backBtn = document.querySelector(sel.backBtn);\r\n\r\n    if (this.countEl) this.countEl.textContent = this.config.ui.loadingText;\r\n\r\n    // Clear button\r\n    if (this.clearBtn) {\r\n      this._clearHandler = async () => {\r\n        if (!confirm(this.config.ui.clearConfirm)) return;\r\n        this._setButtonLoading(this.clearBtn, true);\r\n        const preNodes = this.grid ? Array.from(this.grid.querySelectorAll('[data-product-id]')) : [];\r\n        try {\r\n          if (!preNodes.length) {\r\n            this.notify(this.config.ui.cleared, { type: 'success' });\r\n            this._setButtonLoading(this.clearBtn, false);\r\n            return;\r\n          }\r\n          const ids = Array.from(new Set(preNodes.map(n => n.getAttribute('data-product-id')))).filter(Boolean);\r\n          const tasks = [];\r\n          for (let i = 0; i < ids.length; i++) {\r\n            const id = ids[i];\r\n            const node = this._findNodesByKey(id)[0];\r\n            const delay = i * this.config.ui.clearCascadeDelay;\r\n            const p = new Promise(res => {\r\n              setTimeout(async () => {\r\n                try { if (node) await this._removeNodeElem(node); await this.removeFromFav(id); res(true); } catch (e) { res(false); }\r\n              }, delay);\r\n            });\r\n            tasks.push(p);\r\n          }\r\n          await Promise.all(tasks);\r\n          await this.refresh(true);\r\n          this.notify(this.config.ui.cleared, { type: 'success' });\r\n        } catch (e) {\r\n          this._error('clear button failed', e);\r\n          this.notify('\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u0441\u043F\u0438\u0441\u043E\u043A \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E', { type: 'error' });\r\n        } finally {\r\n          this._setButtonLoading(this.clearBtn, false);\r\n        }\r\n      };\r\n      this.clearBtn.addEventListener('click', this._clearHandler);\r\n    }\r\n\r\n    // Back button\r\n    if (this.backBtn) {\r\n      this._backHandler = () => { if (document.referrer) location.href = document.referrer; else history.back(); };\r\n      this.backBtn.addEventListener('click', this._backHandler);\r\n    }\r\n\r\n    // storage & cart listeners\r\n    window.addEventListener('storage', this._storageHandler);\r\n    window.addEventListener('cart:updated', this._cartHandler);\r\n\r\n    // delegate remove button in grid (fallback cards)\r\n    this._gridClickHandler = (ev) => {\r\n      const t = ev.target;\r\n      const rem = t.closest && t.closest('[data-role=\"fav\"], .wish-remove');\r\n      if (rem && this.grid && this.grid.contains(rem)) {\r\n        ev.stopPropagation();\r\n        const card = rem.closest && rem.closest('[data-product-id]');\r\n        const id = card ? (card.getAttribute('data-product-id') || '') : '';\r\n        this.optimisticRemoveUI(id, card);\r\n      }\r\n    };\r\n    if (this.grid) this.grid.addEventListener('click', this._gridClickHandler);\r\n\r\n    // initial render\r\n    this.refresh(true);\r\n  }\r\n\r\n  refresh(force = false) {\r\n    if (this._destroyed) return;\r\n    if (this._refreshTimer) clearTimeout(this._refreshTimer);\r\n    this._refreshTimer = setTimeout(() => {\r\n      this._refreshTimer = null;\r\n      this.renderGrid().catch(e => this._error('renderGrid failed', e));\r\n    }, force ? 0 : this.config.debounceMs);\r\n  }\r\n\r\n  destroy() {\r\n    if (this._destroyed) return;\r\n    this._destroyed = true;\r\n    try {\r\n      window.removeEventListener('storage', this._storageHandler);\r\n      window.removeEventListener('cart:updated', this._cartHandler);\r\n      if (this.clearBtn && this._clearHandler) this.clearBtn.removeEventListener('click', this._clearHandler);\r\n      if (this.backBtn && this._backHandler) this.backBtn.removeEventListener('click', this._backHandler);\r\n      if (this.grid && this._gridClickHandler) this.grid.removeEventListener('click', this._gridClickHandler);\r\n    } catch (e) { /* ignore */ }\r\n    // clear refs & timers\r\n    this.grid = null; this.countEl = null; this.clearBtn = null; this.backBtn = null;\r\n    if (this._refreshTimer) { clearTimeout(this._refreshTimer); this._refreshTimer = null; }\r\n    if (this._cartUpdateTimer) { clearTimeout(this._cartUpdateTimer); this._cartUpdateTimer = null; }\r\n  }\r\n}\r\n", "/**\r\n * Enhanced and optimized version of the Gallery class.\r\n * @author Calista Verner\r\n *\r\n * This implementation focuses on improving performance and reducing memory\r\n * overhead by adopting event delegation for thumbnail interaction and\r\n * guarding against multiple listener registrations. It also includes\r\n * minor fixes and quality of life improvements such as preventing\r\n * duplicate navigation bindings and more robust cleanup in destroy().\r\n */\r\n\r\n/**\r\n * Optimized Gallery class.\r\n * \u041F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442:\r\n *  - \u0441\u0432\u0430\u0439\u043F\u044B\r\n *  - \u043C\u043E\u0434\u0430\u043B\u044C\u043D\u043E\u0435 \u043E\u043A\u043D\u043E\r\n *  - \u043F\u0440\u0435\u0432\u044C\u044E (thumbnails) \u0441 \u0434\u0435\u043B\u0435\u0433\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435\u043C \u0441\u043E\u0431\u044B\u0442\u0438\u0439\r\n */\r\nexport class Gallery {\r\n  constructor(rootEl, images = [], options = {}) {\r\n    if (!rootEl) throw new Error('Gallery root element required');\r\n\r\n    const defaults = {\r\n      thumbContainerSelector: '.gallery-thumbs',\r\n      thumbSelector: '[data-thumb]',\r\n      mainSelector: '#product-main-image',\r\n      mainFrameSelector: '.main-frame',\r\n      modalId: 'galleryModal',\r\n      circular: true,\r\n      preloadAdjacent: 1,\r\n      swipeThreshold: 40,\r\n      transitionMs: 180,\r\n      renderThumbs: true,\r\n      placeholder: '',\r\n      nav: true,\r\n      navPrevClass: 'gallery-nav-prev',\r\n      navNextClass: 'gallery-nav-next',\r\n      navWrapperClass: 'gallery-nav',\r\n      thumbScrollClass: 'gallery-thumb-scroll',\r\n      thumbScrollIconClass: 'fa fa-chevron-down',\r\n      animation: 'slide'\r\n    };\r\n\r\n    this.options = Object.assign({}, defaults, options);\r\n    this.root = rootEl;\r\n\r\n    this.mainImg   = this.root.querySelector(this.options.mainSelector);\r\n    this.mainFrame = this.root.querySelector(this.options.mainFrameSelector);\r\n\r\n    this.modal    = document.getElementById(this.options.modalId) || null;\r\n    this.modalImg = this.modal ? this.modal.querySelector('.gallery-main-img') : null;\r\n\r\n    this._listeners      = new Map();\r\n    this._listenerId     = 0;\r\n    this._thumbContainer = this.root.querySelector(this.options.thumbContainerSelector) || null;\r\n    this._thumbs         = [];\r\n    this.images          = [];\r\n    this.current         = 0;\r\n    this._prevIndex      = -1;\r\n    this._animating      = false;\r\n    this._animDuration   = Math.max(40, Number(this.options.transitionMs) || 180);\r\n    this._tmpImage       = null;\r\n\r\n    this._thumbScrollBtn      = null;\r\n    this._thumbScrollObserver = null;\r\n    this._thumbScrollRAF      = null;\r\n    this._thumbScrollAttached = false;\r\n\r\n    this._drag = {\r\n      active: false,\r\n      pointerId: null,\r\n      startX: 0,\r\n      startY: 0,\r\n      lastDX: 0,\r\n      targetIndex: null,\r\n      direction: null,\r\n      moved: false\r\n    };\r\n    this._pointerHandlers = {};\r\n    this._suppressClick = false;\r\n    this._clickSuppressMs = 250;\r\n    this._suppressClickTimer = null;\r\n\r\n    this._navInitialized = false;\r\n    this._thumbHandlersBound = false;\r\n\r\n    // mainFrame \u0431\u0430\u0437\u043E\u0432\u0430\u044F \u043F\u043E\u0434\u0433\u043E\u0442\u043E\u0432\u043A\u0430\r\n    if (this.mainFrame) {\r\n      const csPos = window.getComputedStyle(this.mainFrame).position;\r\n      if (csPos === 'static' || !csPos) this.mainFrame.style.position = 'relative';\r\n      this.mainFrame.style.overflow = 'hidden';\r\n      if (!this.mainFrame.style.zIndex) this.mainFrame.style.zIndex = '0';\r\n      try { this.mainFrame.style.touchAction = this.mainFrame.style.touchAction || 'pan-y'; } catch (e) {}\r\n    }\r\n\r\n    // mainImg \u0431\u0430\u0437\u043E\u0432\u044B\u0435 \u0441\u0442\u0438\u043B\u0438\r\n    if (this.mainImg) {\r\n      const objFit = this.mainImg.style.objectFit || 'contain';\r\n      this.mainImg.style.objectFit = objFit;\r\n      this.mainImg.style.transition = `transform ${this._animDuration}ms ease, opacity ${Math.floor(this._animDuration / 2)}ms ease`;\r\n      this.mainImg.style.transform = 'translateX(0)';\r\n      this.mainImg.style.zIndex = '1';\r\n      this.mainImg.draggable = false;\r\n      this.mainImg.style.willChange = 'transform, opacity';\r\n    }\r\n\r\n    this._bound = {\r\n      _onMainClick: (e) => this._onMainClick(e),\r\n      _onRootKey:   (e) => this._onRootKey(e)\r\n    };\r\n\r\n    this._bindHandlers();\r\n\r\n    if (images != null) {\r\n      this.setImages(images, {\r\n        showFirst: true,\r\n        renderThumbs: this.options.renderThumbs\r\n      });\r\n    }\r\n  }\r\n\r\n  // --- generic listener helpers -------------------------------------------\r\n\r\n  _addListener(el, evt, fn, opts = {}) {\r\n    if (!el || !fn) return null;\r\n    const id = ++this._listenerId;\r\n    el.addEventListener(evt, fn, opts);\r\n    this._listeners.set(id, { el, evt, fn, opts });\r\n    return id;\r\n  }\r\n\r\n  _removeListener(id) {\r\n    const rec = this._listeners.get(id);\r\n    if (!rec) return;\r\n    try { rec.el.removeEventListener(rec.evt, rec.fn, rec.opts); } catch (e) {}\r\n    this._listeners.delete(id);\r\n  }\r\n\r\n  _removeAllListeners() {\r\n    for (const id of this._listeners.keys()) this._removeListener(id);\r\n  }\r\n\r\n  // --- images normalization ------------------------------------------------\r\n\r\n  _normalizeImages(images) {\r\n    if (images == null) return [];\r\n    if (typeof images === 'string') {\r\n      const s = images.trim();\r\n      if (!s) return [];\r\n      try { return this._normalizeImages(JSON.parse(s)); }\r\n      catch (_) { return this._normalizeImages([s]); }\r\n    }\r\n\r\n    if (!Array.isArray(images) && typeof images === 'object') {\r\n      if (Array.isArray(images.images)) return this._normalizeImages(images.images);\r\n      const maybe = ['gallery', 'files', 'pictures', 'photos'];\r\n      for (const k of maybe) {\r\n        if (Array.isArray(images[k])) return this._normalizeImages(images[k]);\r\n      }\r\n      const single = this._extractSrc(images);\r\n      return single ? [{ id: null, src: single, thumb: single, alt: '' }] : [];\r\n    }\r\n\r\n    if (Array.isArray(images)) {\r\n      const out = [];\r\n      for (let i = 0; i < images.length; i++) {\r\n        const norm = this._normalizeImageItem(images[i], i);\r\n        if (norm && norm.src) out.push(norm);\r\n      }\r\n      const seen = new Set();\r\n      const unique = [];\r\n      for (const it of out) {\r\n        if (!seen.has(it.src)) {\r\n          seen.add(it.src);\r\n          unique.push(it);\r\n        }\r\n      }\r\n      return unique;\r\n    }\r\n\r\n    return [];\r\n  }\r\n\r\n  _normalizeImageItem(item, idx = 0) {\r\n    if (!item && item !== 0) return null;\r\n\r\n    if (typeof item === 'string') {\r\n      const s = item.trim();\r\n      return s ? { id: null, src: s, thumb: s, alt: '' } : null;\r\n    }\r\n\r\n    if (Array.isArray(item)) {\r\n      for (const it of item) {\r\n        const n = this._normalizeImageItem(it, idx);\r\n        if (n && n.src) return n;\r\n      }\r\n      return null;\r\n    }\r\n\r\n    if (typeof item === 'object') {\r\n      const fields = ['src', 'url', 'path', 'file', 'location', 'image'];\r\n      const thumbFields = ['thumb', 'thumbnail', 'preview'];\r\n\r\n      let src = '';\r\n      for (const f of fields) {\r\n        if (item[f]) {\r\n          src = this._extractSrc(item[f]);\r\n          if (src) break;\r\n        }\r\n      }\r\n\r\n      if (!src) {\r\n        const numericKeys = Object.keys(item)\r\n          .filter(k => String(Number(k)) === k)\r\n          .sort((a, b) => Number(a) - Number(b));\r\n        for (const k of numericKeys) {\r\n          const c = this._extractSrc(item[k]);\r\n          if (c) { src = c; break; }\r\n        }\r\n      }\r\n\r\n      let thumb = '';\r\n      for (const f of thumbFields) {\r\n        if (item[f]) {\r\n          thumb = this._extractSrc(item[f]);\r\n          if (thumb) break;\r\n        }\r\n      }\r\n      if (!thumb) thumb = src || '';\r\n\r\n      if (!src) return null;\r\n\r\n      const alt = item.alt || item.title || item.name || '';\r\n      const id  = item.id ?? item.key ?? null;\r\n      return { id, src, thumb, alt };\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  _extractSrc(val) {\r\n    if (val == null) return '';\r\n    if (typeof val === 'string') {\r\n      const s = val.trim();\r\n      if (!s) return '';\r\n      if (s[0] === '[' || s[0] === '{') {\r\n        try { return this._extractSrc(JSON.parse(s)); }\r\n        catch (_) { return s; }\r\n      }\r\n      return s;\r\n    }\r\n    if (Array.isArray(val)) {\r\n      for (const v of val) {\r\n        const c = this._extractSrc(v);\r\n        if (c) return c;\r\n      }\r\n      return '';\r\n    }\r\n    if (typeof val === 'object') {\r\n      const fields = ['src', 'url', 'path', 'file', 'location', 'thumb', 'thumbnail'];\r\n      for (const f of fields) {\r\n        if (val[f]) {\r\n          const c = this._extractSrc(val[f]);\r\n          if (c) return c;\r\n        }\r\n      }\r\n      const ks = Object.keys(val).sort((a, b) => Number(a) - Number(b));\r\n      for (const k of ks) {\r\n        if (!isNaN(Number(k))) {\r\n          const c = this._extractSrc(val[k]);\r\n          if (c) return c;\r\n        }\r\n      }\r\n      return '';\r\n    }\r\n    return '';\r\n  }\r\n\r\n  // --- thumbnails ----------------------------------------------------------\r\n\r\n  renderThumbs() {\r\n    if (!this._thumbContainer) return;\r\n\r\n    this._unbindThumbHandlers();\r\n    this._thumbContainer.innerHTML = '';\r\n\r\n    const frag = document.createDocumentFragment();\r\n    const placeholder = this.options.placeholder || '';\r\n\r\n    this.images.forEach((it, i) => {\r\n      const btn = document.createElement('button');\r\n      btn.type = 'button';\r\n      btn.className = 'gallery-thumb';\r\n      btn.setAttribute('aria-label', it.alt || `\u0418\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 ${i + 1}`);\r\n      btn.dataset.index = String(i);\r\n      btn.setAttribute('role', 'button');\r\n      btn.tabIndex = 0;\r\n\r\n      const img = document.createElement('img');\r\n      img.loading = 'lazy';\r\n      img.decoding = 'async';\r\n      img.src = it.thumb || it.src || placeholder;\r\n      img.alt = it.alt || '';\r\n\r\n      btn.appendChild(img);\r\n      frag.appendChild(btn);\r\n    });\r\n\r\n    this._thumbContainer.appendChild(frag);\r\n    this._collectThumbs();\r\n    this._bindThumbHandlers();\r\n    if (this.images.length) this._markActive(this.current);\r\n    this._ensureThumbScroll();\r\n  }\r\n\r\n  _collectThumbs() {\r\n    if (this._thumbContainer) {\r\n      this._thumbs = Array.from(this._thumbContainer.querySelectorAll('.gallery-thumb'));\r\n      if (!this._thumbs.length) {\r\n        this._thumbs = Array.from(this.root.querySelectorAll(this.options.thumbSelector));\r\n      }\r\n    } else {\r\n      this._thumbs = Array.from(this.root.querySelectorAll(this.options.thumbSelector));\r\n    }\r\n  }\r\n\r\n  _normalizeThumbSrcs() {\r\n    const placeholder = this.options.placeholder || '';\r\n    this._thumbs.forEach((t, i) => {\r\n      const imgData = this.images[i];\r\n      if (!imgData) return;\r\n\r\n      const expected = imgData.thumb || imgData.src || placeholder;\r\n      let img = t.querySelector('img');\r\n      t.dataset.index = String(i);\r\n\r\n      if (img) {\r\n        if (!img.src || img.src !== expected) img.src = expected;\r\n        if (!img.alt) img.alt = imgData.alt || '';\r\n      } else {\r\n        img = document.createElement('img');\r\n        img.loading = 'lazy';\r\n        img.decoding = 'async';\r\n        img.src = expected;\r\n        img.alt = imgData.alt || '';\r\n        t.appendChild(img);\r\n      }\r\n    });\r\n  }\r\n\r\n  setImages(images, { showFirst = true, renderThumbs = true } = {}) {\r\n    this._unbindThumbHandlers();\r\n    this.images = this._normalizeImages(images);\r\n\r\n    if (renderThumbs && this._thumbContainer) {\r\n      this.renderThumbs();\r\n    } else {\r\n      this._collectThumbs();\r\n      this._normalizeThumbSrcs();\r\n      this._bindThumbHandlers();\r\n    }\r\n\r\n    if (this.images.length && showFirst) {\r\n      this.show(0, { emit: false });\r\n    }\r\n  }\r\n\r\n  refresh() {\r\n    this._unbindThumbHandlers();\r\n    this._collectThumbs();\r\n    this._normalizeThumbSrcs();\r\n    this._bindThumbHandlers();\r\n    this._ensureThumbScroll();\r\n  }\r\n\r\n  // --- navigation / show ---------------------------------------------------\r\n\r\n  _getDirection(prev, index) {\r\n    const n = this.images.length;\r\n    if (!Number.isFinite(prev) || prev < 0 || prev === index || n <= 1) return 'none';\r\n    if (!this.options.circular) return index > prev ? 'right' : 'left';\r\n\r\n    const forward  = (index - prev + n) % n;\r\n    const backward = (prev - index + n) % n;\r\n    return forward <= backward ? 'right' : 'left';\r\n  }\r\n\r\n  show(indexOrThumb, options = {}) {\r\n    if (!this.images.length) return;\r\n\r\n    let index;\r\n    if (typeof indexOrThumb === 'number') {\r\n      index = this._clampIndex(indexOrThumb);\r\n    } else if (indexOrThumb?.dataset?.index) {\r\n      const di = Number(indexOrThumb.dataset.index);\r\n      index = Number.isFinite(di) ? this._clampIndex(di) : this._clampIndex(this._thumbs.indexOf(indexOrThumb));\r\n    } else {\r\n      index = this._clampIndex(0);\r\n    }\r\n\r\n    const item = this.images[index];\r\n    const src  = item?.src;\r\n    if (!src) return;\r\n\r\n    if (index === this.current && this.mainImg && this.mainImg.src === src) return;\r\n\r\n    const prevIndex = this.current;\r\n    const direction = this._getDirection(this._prevIndex >= 0 ? this._prevIndex : prevIndex, index);\r\n\r\n    this._prevIndex = prevIndex;\r\n    this.current = index;\r\n\r\n    this._thumbs.forEach((t, i) => {\r\n      const is = i === index;\r\n      t.classList.toggle('active', is);\r\n      if (is) t.setAttribute('aria-current', 'true');\r\n      else    t.removeAttribute('aria-current');\r\n      t.dataset.index = String(i);\r\n    });\r\n\r\n    if (this.modal && !this.modal.hidden && this.modalImg) {\r\n      this.modalImg.src = src;\r\n    }\r\n\r\n    this._preload(index);\r\n    if (options.emit !== false) {\r\n      this._emit('gallery:change', { index, src, item });\r\n    }\r\n\r\n    this._markActive(index);\r\n    this._ensureThumbVisible(index);\r\n\r\n    if (!this.mainImg || !this.mainFrame || direction === 'none' || this.options.animation !== 'slide') {\r\n      this._simpleSwap(src, index, item);\r\n      return;\r\n    }\r\n\r\n    if (this._animating) {\r\n      if (this._tmpImage?.parentNode) this._tmpImage.parentNode.removeChild(this._tmpImage);\r\n      this._animating = false;\r\n      this._tmpImage = null;\r\n      try {\r\n        this.mainImg.style.transform = 'translateX(0)';\r\n        this.mainImg.style.opacity = '1';\r\n      } catch (e) {}\r\n    }\r\n\r\n    this._doAnimatedSwap(index, direction);\r\n  }\r\n\r\n  _simpleSwap(src, index, item) {\r\n    if (!this.mainImg) return;\r\n\r\n    this.mainImg.classList.add('is-loading');\r\n\r\n    const onLoad = () => {\r\n      this.mainImg.classList.remove('is-loading');\r\n      this.mainImg.removeEventListener('load', onLoad);\r\n      this._emit('gallery:loaded', { index, src });\r\n    };\r\n\r\n    const onError = () => {\r\n      this.mainImg.classList.remove('is-loading');\r\n      this.mainImg.removeEventListener('error', onError);\r\n      if (this.options.placeholder) this.mainImg.src = this.options.placeholder;\r\n      this._emit('gallery:error', { index, src });\r\n    };\r\n\r\n    this.mainImg.addEventListener('load', onLoad, { once: true });\r\n    this.mainImg.addEventListener('error', onError, { once: true });\r\n\r\n    setTimeout(() => {\r\n      this.mainImg.src = src;\r\n      this.mainImg.dataset.index = String(index);\r\n      this.mainImg.alt = item.alt || '';\r\n      if (this.mainImg.complete) onLoad();\r\n    }, this.options.transitionMs);\r\n  }\r\n\r\n  _doAnimatedSwap(index, direction) {\r\n    const item = this.images[index];\r\n    const src  = item?.src;\r\n    if (!src || !this.mainImg || !this.mainFrame) return;\r\n\r\n    this.mainImg.classList.add('is-loading');\r\n    this._animating = true;\r\n\r\n    const tmp = document.createElement('img');\r\n    this._tmpImage = tmp;\r\n\r\n    tmp.decoding = 'async';\r\n    tmp.loading = 'eager';\r\n    tmp.alt = item.alt || '';\r\n    tmp.draggable = false;\r\n\r\n    Object.assign(tmp.style, {\r\n      position: 'absolute',\r\n      top: '0',\r\n      left: '0',\r\n      width: '100%',\r\n      height: '100%',\r\n      objectFit: this.mainImg.style.objectFit || 'contain',\r\n      transition: `transform ${this._animDuration}ms ease, opacity ${Math.floor(this._animDuration / 2)}ms ease`,\r\n      zIndex: '2',\r\n      opacity: '1'\r\n    });\r\n\r\n    const fromPct = direction === 'right' ? 100 : -100;\r\n    tmp.style.transform = `translateX(${fromPct}%)`;\r\n\r\n    this.mainImg.style.zIndex = '1';\r\n    this.mainImg.style.transition = `transform ${this._animDuration}ms ease, opacity ${Math.floor(this._animDuration / 2)}ms ease`;\r\n    this.mainImg.style.transform = 'translateX(0)';\r\n    this.mainImg.style.opacity = '1';\r\n\r\n    this.mainFrame.appendChild(tmp);\r\n\r\n    const cleanup = () => {\r\n      if (tmp.parentNode) tmp.parentNode.removeChild(tmp);\r\n      this.mainImg.style.transition = '';\r\n      this.mainImg.style.transform = 'translateX(0)';\r\n      this.mainImg.style.opacity = '1';\r\n      this.mainImg.src = src;\r\n      this.mainImg.dataset.index = String(index);\r\n      this.mainImg.alt = item.alt || '';\r\n      this.mainImg.classList.remove('is-loading');\r\n      this._emit('gallery:loaded', { index, src });\r\n      this._animating = false;\r\n      this._tmpImage = null;\r\n    };\r\n\r\n    const handleLoad = () => {\r\n      tmp.removeEventListener('load', handleLoad);\r\n      tmp.offsetHeight; // reflow\r\n\r\n      requestAnimationFrame(() => {\r\n        const mainTarget = direction === 'right' ? -100 : 100;\r\n        this.mainImg.style.transform = `translateX(${mainTarget}%)`;\r\n        this.mainImg.style.opacity = '0';\r\n        tmp.style.transform = 'translateX(0%)';\r\n      });\r\n\r\n      const onTransEnd = (e) => {\r\n        if (e && e.target !== tmp) return;\r\n        tmp.removeEventListener('transitionend', onTransEnd);\r\n        cleanup();\r\n      };\r\n\r\n      tmp.addEventListener('transitionend', onTransEnd);\r\n      setTimeout(() => {\r\n        if (!this._animating) return;\r\n        try { tmp.removeEventListener('transitionend', onTransEnd); } catch (e) {}\r\n        cleanup();\r\n      }, this._animDuration + 70);\r\n    };\r\n\r\n    const handleError = () => {\r\n      if (tmp.parentNode) tmp.parentNode.removeChild(tmp);\r\n      this.mainImg.classList.remove('is-loading');\r\n      if (this.options.placeholder) this.mainImg.src = this.options.placeholder;\r\n      this._emit('gallery:error', { index, src });\r\n      this._animating = false;\r\n      this._tmpImage = null;\r\n    };\r\n\r\n    tmp.addEventListener('load', handleLoad, { once: true });\r\n    tmp.addEventListener('error', handleError, { once: true });\r\n    tmp.src = src;\r\n  }\r\n\r\n  _ensureThumbVisible(index) {\r\n    if (!this._thumbContainer || !this._thumbs?.[index]) return;\r\n\r\n    const el        = this._thumbs[index];\r\n    const container = this._thumbContainer;\r\n\r\n    const elTop    = el.offsetTop;\r\n    const elBottom = elTop + el.offsetHeight;\r\n    const viewTop  = container.scrollTop;\r\n    const viewBot  = viewTop + container.clientHeight;\r\n\r\n    if (elTop < viewTop) {\r\n      container.scrollTo({ top: elTop - 8, behavior: 'smooth' });\r\n    } else if (elBottom > viewBot) {\r\n      container.scrollTo({ top: elBottom - container.clientHeight + 8, behavior: 'smooth' });\r\n    }\r\n  }\r\n\r\n  next() { this.show(this._clampIndex(this.current + 1)); }\r\n  prev() { this.show(this._clampIndex(this.current - 1)); }\r\n\r\n  openModal() {\r\n    if (!this.modal || !this.modalImg) return;\r\n\r\n    const src = this.images[this.current]?.src || this.mainImg?.src;\r\n    if (src) this.modalImg.src = src;\r\n\r\n    this._lastFocused = document.activeElement;\r\n    this.modal.hidden = false;\r\n    document.documentElement.style.overflow = 'hidden';\r\n    this._trapFocus();\r\n    this.modal.setAttribute('aria-hidden', 'false');\r\n    this._emit('gallery:open', { index: this.current, src });\r\n\r\n    if (this.options.nav) this._ensureNav();\r\n  }\r\n\r\n  closeModal() {\r\n    if (!this.modal) return;\r\n\r\n    this.modal.hidden = true;\r\n    if (this.modalImg) this.modalImg.src = '';\r\n    document.documentElement.style.overflow = '';\r\n    this._releaseFocusTrap();\r\n\r\n    if (this._lastFocused && typeof this._lastFocused.focus === 'function') {\r\n      this._lastFocused.focus();\r\n    }\r\n\r\n    this.modal.setAttribute('aria-hidden', 'true');\r\n    this._emit('gallery:close', { index: this.current });\r\n  }\r\n\r\n  destroy() {\r\n    this._removeAllListeners();\r\n\r\n    if (this._thumbScrollBtn) {\r\n      try { this._thumbScrollBtn.remove(); } catch (e) {}\r\n      this._thumbScrollBtn = null;\r\n    }\r\n\r\n    if (this._thumbScrollObserver) {\r\n      try { this._thumbScrollObserver.disconnect(); } catch (e) {}\r\n      this._thumbScrollObserver = null;\r\n    }\r\n\r\n    if (this._thumbScrollRAF) {\r\n      cancelAnimationFrame(this._thumbScrollRAF);\r\n      this._thumbScrollRAF = null;\r\n    }\r\n\r\n    if (this._suppressClickTimer) {\r\n      clearTimeout(this._suppressClickTimer);\r\n      this._suppressClickTimer = null;\r\n    }\r\n\r\n    if (this._tmpImage?.parentNode) {\r\n      try { this._tmpImage.parentNode.removeChild(this._tmpImage); } catch (e) {}\r\n    }\r\n\r\n    this._tmpImage = null;\r\n    this._thumbs = [];\r\n    this.images = [];\r\n    this.mainImg = null;\r\n    this.mainFrame = null;\r\n    this.modal = null;\r\n    this.modalImg = null;\r\n  }\r\n\r\n  // --- root handlers / bindings -------------------------------------------\r\n\r\n  _onMainClick(e) {\r\n    if (this._suppressClick) {\r\n      e.preventDefault();\r\n      e.stopPropagation?.();\r\n      return;\r\n    }\r\n    if (e.target.closest && e.target.closest('button, a, input')) return;\r\n    this.openModal();\r\n  }\r\n\r\n  _onRootKey(e) {\r\n    if (this.modal && !this.modal.hidden) return;\r\n    if (e.key === 'ArrowRight') this.next();\r\n    if (e.key === 'ArrowLeft') this.prev();\r\n  }\r\n\r\n  _bindHandlers() {\r\n    if (this.mainFrame) {\r\n      this._addListener(this.mainFrame, 'click', this._bound._onMainClick);\r\n    }\r\n\r\n    if (this.modal) {\r\n      const closeBtn = this.modal.querySelector('.gallery-close');\r\n      const overlay  = this.modal.querySelector('.gallery-modal-overlay');\r\n\r\n      if (closeBtn) this._addListener(closeBtn, 'click', () => this.closeModal());\r\n      if (overlay)  this._addListener(overlay, 'click', () => this.closeModal());\r\n\r\n      this._addListener(this.modal, 'keydown', (e) => {\r\n        if (this.modal.hidden) return;\r\n        if (e.key === 'Escape') this.closeModal();\r\n        if (e.key === 'ArrowRight') this.next();\r\n        if (e.key === 'ArrowLeft') this.prev();\r\n      });\r\n    }\r\n\r\n    if (this.mainFrame) this._bindPointerSwipe();\r\n\r\n    this._addListener(this.root, 'keydown', (e) => this._onRootKey(e));\r\n    if (!this.root.hasAttribute('tabindex')) this.root.setAttribute('tabindex', '0');\r\n  }\r\n\r\n  _bindThumbHandlers() {\r\n    if (this._thumbHandlersBound || !this._thumbContainer) return;\r\n\r\n    const clickHandler = (e) => {\r\n      const btn = e.target.closest('.gallery-thumb');\r\n      if (!btn) return;\r\n      e.preventDefault();\r\n      this.show(btn);\r\n      btn.focus();\r\n    };\r\n\r\n    const keyHandler = (e) => {\r\n      const btn = e.target.closest('.gallery-thumb');\r\n      if (!btn) return;\r\n      const i = Number(btn.dataset.index);\r\n\r\n      if (e.key === 'Enter' || e.key === ' ') {\r\n        e.preventDefault();\r\n        this.show(btn);\r\n        return;\r\n      }\r\n\r\n      if (!this._thumbs.length) return;\r\n\r\n      if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {\r\n        e.preventDefault();\r\n        const next = this._thumbs[(i + 1) % this._thumbs.length];\r\n        next && next.focus();\r\n      }\r\n\r\n      if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {\r\n        e.preventDefault();\r\n        const prev = this._thumbs[(i - 1 + this._thumbs.length) % this._thumbs.length];\r\n        prev && prev.focus();\r\n      }\r\n    };\r\n\r\n    this._thumbClickListenerId = this._addListener(this._thumbContainer, 'click', clickHandler);\r\n    this._thumbKeyListenerId   = this._addListener(this._thumbContainer, 'keydown', keyHandler);\r\n    this._thumbHandlersBound   = true;\r\n\r\n    this._thumbs.forEach((thumb) => {\r\n      if (!thumb.hasAttribute('role')) thumb.setAttribute('role', 'button');\r\n      if (!thumb.hasAttribute('tabindex')) thumb.tabIndex = 0;\r\n    });\r\n  }\r\n\r\n  _unbindThumbHandlers() {\r\n    if (!this._thumbHandlersBound) return;\r\n\r\n    if (this._thumbClickListenerId) this._removeListener(this._thumbClickListenerId);\r\n    if (this._thumbKeyListenerId)   this._removeListener(this._thumbKeyListenerId);\r\n\r\n    this._thumbClickListenerId = null;\r\n    this._thumbKeyListenerId   = null;\r\n    this._thumbHandlersBound   = false;\r\n  }\r\n\r\n  _bindPointerSwipe() {\r\n    if (!this.mainFrame) return;\r\n\r\n    const down = (e) => {\r\n      if (e.button && e.button !== 0) return;\r\n      if (this._animating) return;\r\n      if (e.target.closest && e.target.closest('button, a, input, textarea, select')) return;\r\n\r\n      this._drag.active = true;\r\n      this._drag.pointerId = e.pointerId ?? 'touch';\r\n      this._drag.startX = e.clientX;\r\n      this._drag.startY = e.clientY;\r\n      this._drag.lastDX = 0;\r\n      this._drag.targetIndex = null;\r\n      this._drag.direction = null;\r\n      this._drag.moved = false;\r\n\r\n      try {\r\n        e.currentTarget?.setPointerCapture?.(e.pointerId);\r\n      } catch (_) {}\r\n\r\n      document.body.style.userSelect = 'none';\r\n    };\r\n\r\n    const move = (e) => {\r\n      if (!this._drag.active || (e.pointerId !== undefined && e.pointerId !== this._drag.pointerId)) return;\r\n\r\n      const dx = e.clientX - this._drag.startX;\r\n      const dy = e.clientY - this._drag.startY;\r\n\r\n      if (!this._drag.moved && Math.abs(dx) > 6) this._drag.moved = true;\r\n      if (!this._drag.direction && Math.abs(dx) > 6) {\r\n        this._drag.direction = dx < 0 ? 'left' : 'right';\r\n      }\r\n\r\n      this._drag.lastDX = dx;\r\n\r\n      const width = this.mainFrame.clientWidth || this.mainImg?.clientWidth || (window.innerWidth / 2);\r\n      const sign  = dx < 0 ? -1 : 1;\r\n      const targetIdx = this._clampIndex(this.current + (sign < 0 ? 1 : -1));\r\n\r\n      if (this.images.length <= 1 || targetIdx === this.current) {\r\n        const damp = dx * 0.35;\r\n        this._applyDragTransforms(damp, null, width);\r\n        return;\r\n      }\r\n\r\n      if (this._drag.targetIndex !== targetIdx || !this._tmpImage) {\r\n        if (this._tmpImage?.parentNode) {\r\n          try { this._tmpImage.parentNode.removeChild(this._tmpImage); } catch (_) {}\r\n        }\r\n\r\n        const tmp = document.createElement('img');\r\n        this._tmpImage = tmp;\r\n\r\n        tmp.decoding = 'async';\r\n        tmp.loading = 'eager';\r\n        tmp.draggable = false;\r\n        Object.assign(tmp.style, {\r\n          position: 'absolute',\r\n          top: '0',\r\n          left: '0',\r\n          width: '100%',\r\n          height: '100%',\r\n          objectFit: this.mainImg?.style.objectFit || 'contain',\r\n          transition: 'none',\r\n          zIndex: '2',\r\n          willChange: 'transform, opacity'\r\n        });\r\n\r\n        const initialOffset = sign < 0 ? width : -width;\r\n        tmp.style.transform = `translateX(${initialOffset}px)`;\r\n\r\n        this.mainFrame.appendChild(tmp);\r\n        const candidate = this.images[targetIdx];\r\n        if (candidate?.src) tmp.src = candidate.src;\r\n\r\n        this._drag.targetIndex = targetIdx;\r\n      }\r\n\r\n      this._applyDragTransforms(dx, this._tmpImage, width);\r\n      if (Math.abs(dx) > 8) e.preventDefault?.();\r\n    };\r\n\r\n    const up = (e) => {\r\n      if (!this._drag.active || (e && e.pointerId !== undefined && e.pointerId !== this._drag.pointerId)) return;\r\n\r\n      const dx    = this._drag.lastDX;\r\n      const abs   = Math.abs(dx);\r\n      const width = this.mainFrame.clientWidth || this.mainImg?.clientWidth || (window.innerWidth / 2);\r\n\r\n      try {\r\n        e.currentTarget?.releasePointerCapture?.(e.pointerId);\r\n      } catch (_) {}\r\n\r\n      document.body.style.userSelect = '';\r\n\r\n      if (this._drag.moved) {\r\n        this._suppressClick = true;\r\n        clearTimeout(this._suppressClickTimer);\r\n        this._suppressClickTimer = setTimeout(() => {\r\n          this._suppressClick = false;\r\n          this._suppressClickTimer = null;\r\n        }, this._clickSuppressMs);\r\n      }\r\n\r\n      const sign      = dx < 0 ? -1 : 1;\r\n      const targetIdx = this._drag.targetIndex != null\r\n        ? this._drag.targetIndex\r\n        : this._clampIndex(this.current + (sign < 0 ? 1 : -1));\r\n\r\n      const threshold = Math.min(this.options.swipeThreshold, Math.round(width * 0.18));\r\n\r\n      if (this.images.length > 1 && abs > threshold && targetIdx !== this.current) {\r\n        this._animateDragToComplete(sign, targetIdx, dx, width);\r\n      } else {\r\n        this._animateDragRollback();\r\n      }\r\n\r\n      this._drag.active      = false;\r\n      this._drag.pointerId   = null;\r\n      this._drag.lastDX      = 0;\r\n      this._drag.targetIndex = null;\r\n      this._drag.direction   = null;\r\n      this._drag.moved       = false;\r\n    };\r\n\r\n    const cancel = (e) => {\r\n      if (!this._drag.active) return;\r\n\r\n      try {\r\n        e.currentTarget?.releasePointerCapture?.(e.pointerId);\r\n      } catch (_) {}\r\n\r\n      document.body.style.userSelect = '';\r\n      this._drag.active      = false;\r\n      this._drag.pointerId   = null;\r\n      this._drag.direction   = null;\r\n      this._drag.targetIndex = null;\r\n      this._drag.moved       = false;\r\n      this._animateDragRollback();\r\n    };\r\n\r\n    this._pointerHandlers.down    = down;\r\n    this._pointerHandlers.move    = move;\r\n    this._pointerHandlers.up      = up;\r\n    this._pointerHandlers.cancel  = cancel;\r\n\r\n    this._addListener(this.mainFrame, 'pointerdown', down);\r\n    this._addListener(this.mainFrame, 'pointermove', move);\r\n    this._addListener(this.mainFrame, 'pointerup', up);\r\n    this._addListener(this.mainFrame, 'pointercancel', cancel);\r\n\r\n    const touchStart = (e) => {\r\n      const t = e.touches?.[0];\r\n      if (!t) return;\r\n      down({\r\n        pointerId: 'touch',\r\n        clientX: t.clientX,\r\n        clientY: t.clientY,\r\n        currentTarget: this.mainFrame,\r\n        target: e.target,\r\n        button: 0\r\n      });\r\n    };\r\n\r\n    const touchMove = (e) => {\r\n      const t = e.touches?.[0];\r\n      if (!t) return;\r\n      move({\r\n        pointerId: 'touch',\r\n        clientX: t.clientX,\r\n        clientY: t.clientY,\r\n        currentTarget: this.mainFrame,\r\n        target: e.target,\r\n        preventDefault: () => e.preventDefault()\r\n      });\r\n    };\r\n\r\n    const touchEnd = (e) => {\r\n      const t = e.changedTouches?.[0] || null;\r\n      up({\r\n        pointerId: 'touch',\r\n        clientX: t ? t.clientX : 0,\r\n        clientY: t ? t.clientY : 0,\r\n        currentTarget: this.mainFrame,\r\n        target: e.target\r\n      });\r\n    };\r\n\r\n    this._addListener(this.mainFrame, 'touchstart', touchStart, { passive: true });\r\n    this._addListener(this.mainFrame, 'touchmove',  touchMove,  { passive: false });\r\n    this._addListener(this.mainFrame, 'touchend',   touchEnd,   { passive: true });\r\n  }\r\n\r\n  _applyDragTransforms(dx, tmpEl, width) {\r\n    if (!this.mainImg) return;\r\n\r\n    const maxOffset = width * 0.6;\r\n    const limited   = Math.abs(dx) > maxOffset ? maxOffset * Math.sign(dx) : dx;\r\n\r\n    this.mainImg.style.transition = 'none';\r\n    this.mainImg.style.transform  = `translateX(${limited}px)`;\r\n    this.mainImg.style.opacity    = String(Math.max(0.35, 1 - Math.abs(limited) / (width * 1.2)));\r\n\r\n    if (!tmpEl) return;\r\n\r\n    tmpEl.style.transition = 'none';\r\n    const sign       = limited < 0 ? 1 : -1;\r\n    const baseOffset = sign > 0 ? width : -width;\r\n    tmpEl.style.transform = `translateX(${baseOffset + limited}px)`;\r\n    tmpEl.style.opacity   = '1';\r\n  }\r\n\r\n  _animateDragRollback() {\r\n    if (!this.mainImg) return;\r\n\r\n    const dur = Math.round(this._animDuration / 1.5);\r\n    const opDur = Math.round(this._animDuration / 2);\r\n\r\n    this.mainImg.style.transition = `transform ${dur}ms ease, opacity ${opDur}ms ease`;\r\n    this.mainImg.style.transform  = 'translateX(0)';\r\n    this.mainImg.style.opacity    = '1';\r\n\r\n    if (!this._tmpImage) return;\r\n\r\n    const tmp   = this._tmpImage;\r\n    const width = this.mainFrame?.clientWidth || this.mainImg.clientWidth || (window.innerWidth / 2);\r\n    const cur   = this._getTranslateXValue(tmp);\r\n    const sign  = cur >= 0 ? 1 : -1;\r\n    const final = sign > 0 ? width : -width;\r\n\r\n    tmp.style.transition = `transform ${dur}ms ease, opacity ${opDur}ms ease`;\r\n    tmp.style.transform  = `translateX(${final}px)`;\r\n    tmp.style.opacity    = '0';\r\n\r\n    const cleanup = () => {\r\n      if (tmp.parentNode) {\r\n        try { tmp.parentNode.removeChild(tmp); } catch (e) {}\r\n      }\r\n      if (this._tmpImage === tmp) this._tmpImage = null;\r\n    };\r\n\r\n    tmp.addEventListener('transitionend', function once() {\r\n      tmp.removeEventListener('transitionend', once);\r\n      cleanup();\r\n    });\r\n\r\n    setTimeout(cleanup, dur + 120);\r\n  }\r\n\r\n  _animateDragToComplete(sign, targetIdx, dx, width) {\r\n    if (!this.mainImg || this._animating) return;\r\n\r\n    this._animating = true;\r\n    const tmp = this._tmpImage;\r\n    const dur = Math.round(this._animDuration * 0.9);\r\n    const opDur = Math.round(dur / 2);\r\n\r\n    this.mainImg.style.transition = `transform ${dur}ms cubic-bezier(.2,.9,.2,1), opacity ${opDur}ms ease`;\r\n    this.mainImg.style.transform  = `translateX(${sign < 0 ? -width : width}px)`;\r\n    this.mainImg.style.opacity    = '0';\r\n\r\n    if (tmp) {\r\n      tmp.style.transition = `transform ${dur}ms cubic-bezier(.2,.9,.2,1), opacity ${opDur}ms ease`;\r\n      tmp.style.transform  = 'translateX(0px)';\r\n      tmp.style.opacity    = '1';\r\n    }\r\n\r\n    const finish = () => {\r\n      if (tmp?.parentNode) {\r\n        try { tmp.parentNode.removeChild(tmp); } catch (e) {}\r\n      }\r\n      this._tmpImage = null;\r\n\r\n      const item = this.images[targetIdx];\r\n      if (item?.src) {\r\n        this.mainImg.src = item.src;\r\n        this.mainImg.dataset.index = String(targetIdx);\r\n        this.mainImg.alt = item.alt || '';\r\n      }\r\n\r\n      this.mainImg.style.transition = '';\r\n      this.mainImg.style.transform  = 'translateX(0)';\r\n      this.mainImg.style.opacity    = '1';\r\n\r\n      this._prevIndex = this.current;\r\n      this.current = targetIdx;\r\n      this._animating = false;\r\n\r\n      this._emit('gallery:change', { index: this.current, src: this.mainImg.src, item: this.images[this.current] });\r\n      this._emit('gallery:loaded', { index: this.current, src: this.mainImg.src });\r\n      this._markActive(this.current);\r\n      this._ensureThumbVisible(this.current);\r\n    };\r\n\r\n    let handled = false;\r\n\r\n    const onEnd = () => {\r\n      if (handled) return;\r\n      handled = true;\r\n      this.mainImg.removeEventListener('transitionend', onEnd);\r\n      finish();\r\n    };\r\n\r\n    this.mainImg.addEventListener('transitionend', onEnd);\r\n\r\n    setTimeout(() => {\r\n      if (handled) return;\r\n      handled = true;\r\n      try { this.mainImg.removeEventListener('transitionend', onEnd); } catch (e) {}\r\n      finish();\r\n    }, dur + 150);\r\n  }\r\n\r\n  _getTranslateXValue(el) {\r\n    try {\r\n      const s = getComputedStyle(el).transform;\r\n      if (!s || s === 'none') return 0;\r\n\r\n      const m = s.match(/matrix\\(([^)]+)\\)/);\r\n      if (m) {\r\n        const parts = m[1].split(',').map(p => parseFloat(p.trim()));\r\n        return parts[4] || 0;\r\n      }\r\n\r\n      const m3 = s.match(/matrix3d\\(([^)]+)\\)/);\r\n      if (m3) {\r\n        const parts = m3[1].split(',').map(p => parseFloat(p.trim()));\r\n        return parts[12] || 0;\r\n      }\r\n    } catch (e) {}\r\n\r\n    return 0;\r\n  }\r\n\r\n  // --- focus / modal nav ---------------------------------------------------\r\n\r\n  _trapFocus() {\r\n    if (!this.modal) return;\r\n\r\n    const focusables = this.modal.querySelectorAll(\r\n      'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex=\"-1\"])'\r\n    );\r\n    this._focusables = Array.from(focusables);\r\n    if (!this._focusables.length) return;\r\n\r\n    this._modalKeyHandler = (e) => {\r\n      if (e.key !== 'Tab') return;\r\n      const first = this._focusables[0];\r\n      const last  = this._focusables[this._focusables.length - 1];\r\n\r\n      if (e.shiftKey && document.activeElement === first) {\r\n        e.preventDefault();\r\n        last.focus();\r\n      } else if (!e.shiftKey && document.activeElement === last) {\r\n        e.preventDefault();\r\n        first.focus();\r\n      }\r\n    };\r\n\r\n    this.modal.addEventListener('keydown', this._modalKeyHandler);\r\n    this._focusables[0].focus();\r\n  }\r\n\r\n  _releaseFocusTrap() {\r\n    if (!this.modal || !this._modalKeyHandler) return;\r\n    this.modal.removeEventListener('keydown', this._modalKeyHandler);\r\n    this._modalKeyHandler = null;\r\n    this._focusables = null;\r\n  }\r\n\r\n  _ensureNav() {\r\n    if (!this.modal || this._navInitialized) return;\r\n\r\n    const modalContent = this.modal.querySelector('.gallery-modal-content') || this.modal;\r\n    if (!modalContent) return;\r\n\r\n    const existing = this.modal.querySelector(`.${this.options.navWrapperClass}`);\r\n\r\n    if (!existing) {\r\n      const wrap = document.createElement('div');\r\n      wrap.className = this.options.navWrapperClass;\r\n\r\n      const prev = document.createElement('button');\r\n      prev.type = 'button';\r\n      prev.className = this.options.navPrevClass;\r\n      prev.setAttribute('aria-label', '\u041F\u0440\u0435\u0434\u044B\u0434\u0443\u0449\u0435\u0435 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435');\r\n      prev.innerHTML = '<i class=\"fa fa-chevron-left\" aria-hidden=\"true\"></i>';\r\n\r\n      const next = document.createElement('button');\r\n      next.type = 'button';\r\n      next.className = this.options.navNextClass;\r\n      next.setAttribute('aria-label', '\u0421\u043B\u0435\u0434\u0443\u044E\u0449\u0435\u0435 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435');\r\n      next.innerHTML = '<i class=\"fa fa-chevron-right\" aria-hidden=\"true\"></i>';\r\n\r\n      wrap.appendChild(prev);\r\n      wrap.appendChild(next);\r\n      modalContent.appendChild(wrap);\r\n\r\n      this._navWrap = wrap;\r\n      this._navPrev = prev;\r\n      this._navNext = next;\r\n\r\n      this._addListener(prev, 'click', (e) => { e.preventDefault(); this.prev(); });\r\n      this._addListener(next, 'click', (e) => { e.preventDefault(); this.next(); });\r\n      this._addListener(prev, 'keydown', (e) => {\r\n        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); this.prev(); }\r\n      });\r\n      this._addListener(next, 'keydown', (e) => {\r\n        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); this.next(); }\r\n      });\r\n    } else {\r\n      this._navWrap = existing;\r\n      this._navPrev = this._navWrap.querySelector(`.${this.options.navPrevClass}`);\r\n      this._navNext = this._navWrap.querySelector(`.${this.options.navNextClass}`);\r\n\r\n      if (this._navPrev) {\r\n        this._addListener(this._navPrev, 'click', (e) => { e.preventDefault(); this.prev(); });\r\n      }\r\n      if (this._navNext) {\r\n        this._addListener(this._navNext, 'click', (e) => { e.preventDefault(); this.next(); });\r\n      }\r\n    }\r\n\r\n    this._navInitialized = true;\r\n  }\r\n\r\n  // --- thumb scroll helper -------------------------------------------------\r\n\r\n  _ensureThumbScroll() {\r\n    if (!this._thumbContainer) return;\r\n\r\n    if (!this._thumbScrollBtn) {\r\n      const btn = document.createElement('button');\r\n      btn.type = 'button';\r\n      btn.className = this.options.thumbScrollClass;\r\n      btn.setAttribute('aria-label', '\u041F\u0440\u043E\u043A\u0440\u0443\u0442\u0438\u0442\u044C \u043C\u0438\u043D\u0438\u0430\u0442\u044E\u0440\u044B \u0432\u043D\u0438\u0437');\r\n      btn.innerHTML = `<i class=\"${this.options.thumbScrollIconClass}\" aria-hidden=\"true\"></i>`;\r\n\r\n      this._thumbContainer.appendChild(btn);\r\n      this._thumbScrollBtn = btn;\r\n\r\n      this._thumbScrollHandler = (e) => {\r\n        e.preventDefault();\r\n        const scrollAmount = Math.max(this._thumbContainer.clientHeight * 0.85, 120);\r\n        this._thumbContainer.scrollBy({ top: scrollAmount, behavior: 'smooth' });\r\n      };\r\n      this._addListener(btn, 'click', this._thumbScrollHandler);\r\n    }\r\n\r\n    if (!this._thumbScrollAttached) {\r\n      this._addListener(this._thumbContainer, 'scroll', () => this._scheduleThumbScrollUpdate());\r\n      this._addListener(window, 'resize', () => this._scheduleThumbScrollUpdate());\r\n      this._thumbScrollAttached = true;\r\n    }\r\n\r\n    if (this._thumbScrollObserver) {\r\n      this._thumbScrollObserver.disconnect();\r\n    }\r\n\r\n    this._thumbScrollObserver = new MutationObserver(() => this._scheduleThumbScrollUpdate());\r\n    this._thumbScrollObserver.observe(this._thumbContainer, { childList: true, subtree: true });\r\n\r\n    this._scheduleThumbScrollUpdate();\r\n  }\r\n\r\n  _scheduleThumbScrollUpdate() {\r\n    if (this._thumbScrollRAF) cancelAnimationFrame(this._thumbScrollRAF);\r\n    this._thumbScrollRAF = requestAnimationFrame(() => this._updateThumbScrollState());\r\n  }\r\n\r\n  _updateThumbScrollState() {\r\n    if (!this._thumbContainer || !this._thumbScrollBtn) return;\r\n\r\n    const needsScroll =\r\n      this._thumbContainer.scrollHeight > this._thumbContainer.clientHeight + 1;\r\n\r\n    if (!needsScroll) {\r\n      this._thumbScrollBtn.hidden = true;\r\n      return;\r\n    }\r\n\r\n    const atBottom =\r\n      this._thumbContainer.scrollTop + this._thumbContainer.clientHeight >=\r\n      this._thumbContainer.scrollHeight - 2;\r\n\r\n    this._thumbScrollBtn.hidden = atBottom;\r\n  }\r\n\r\n  // --- misc helpers --------------------------------------------------------\r\n\r\n  _markActive(index) {\r\n    if (!this._thumbs?.length) return;\r\n    this._thumbs.forEach((t, i) => {\r\n      const is = i === index;\r\n      t.classList.toggle('active', is);\r\n      if (is) t.setAttribute('aria-current', 'true');\r\n      else    t.removeAttribute('aria-current');\r\n    });\r\n  }\r\n\r\n  _emit(name, detail = {}) {\r\n    try {\r\n      this.root.dispatchEvent(new CustomEvent(name, { detail }));\r\n    } catch (_) {}\r\n  }\r\n\r\n  _clampIndex(idx) {\r\n    const n = this.images.length;\r\n    if (!n) return 0;\r\n    if (this.options.circular) return ((idx % n) + n) % n;\r\n    return Math.max(0, Math.min(idx, n - 1));\r\n  }\r\n\r\n  _preload(index) {\r\n    const n = this.images.length;\r\n    if (!n || this.options.preloadAdjacent <= 0) return;\r\n\r\n    for (let d = 1; d <= this.options.preloadAdjacent; d++) {\r\n      [index + d, index - d].forEach(i => {\r\n        const j   = this._clampIndex(i);\r\n        const src = this.images[j]?.src;\r\n        if (src) {\r\n          const img = new Image();\r\n          img.src = src;\r\n        }\r\n      });\r\n    }\r\n  }\r\n}", "/*\r\n * ProductPage - optimized and improved.\r\n *\r\n * This module provides a modernized implementation of a product detail page. It\r\n * refactors the original code to use modern JavaScript features such as\r\n * destructuring, optional chaining, arrow functions, and default parameters.\r\n * Repetitive logic has been extracted into helper methods, and error\r\n * handling has been streamlined. The objective is to retain full functionality\r\n * while improving readability and maintainability.\r\n */\r\n\r\nimport { makeSpecHtmlPreview } from './utils.js';\r\nimport { Gallery } from './Gallery.js';\r\n\r\nconst DEFAULT_MESSAGES = {\r\n  addToCartDisabled: '\u041D\u0435\u0432\u043E\u0437\u043C\u043E\u0436\u043D\u043E \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C: \u043D\u0435\u0442 \u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E\u0433\u043E \u043E\u0441\u0442\u0430\u0442\u043A\u0430.',\r\n  addToCartError: '\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u0438\u0438 \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443',\r\n  favoriteAdded: '\u0422\u043E\u0432\u0430\u0440 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D \u0432 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435',\r\n  favoriteRemoved: '\u0422\u043E\u0432\u0430\u0440 \u0443\u0434\u0430\u043B\u0451\u043D \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E',\r\n  wishlistNotConfigured: '\u0412\u0438\u0448\u043B\u0438\u0441\u0442 \u043D\u0435 \u043D\u0430\u0441\u0442\u0440\u043E\u0435\u043D',\r\n  wishlistUpdated: '\u041E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u043E \u0432 \u0432\u0438\u0448\u043B\u0438\u0441\u0442\u0435',\r\n  maxAvailableTemplate: '\u041C\u0430\u043A\u0441\u0438\u043C\u0443\u043C \u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E: {count}',\r\n  itemRemovedFromCart: '\u0422\u043E\u0432\u0430\u0440 \u0443\u0434\u0430\u043B\u0451\u043D \u0438\u0437 \u043A\u043E\u0440\u0437\u0438\u043D\u044B',\r\n  favLabelAdd: '<i class=\"fa-heart fa-solid\"></i> \u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435',\r\n  favLabelIn: '<i class=\"fa-heart fa-solid active\"></i> \u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u043C',\r\n  wishlistLabelAdd: '\u0412 \u0432\u0438\u0448\u043B\u0438\u0441\u0442',\r\n  wishlistLabelIn: '\u0412 \u0432\u0438\u0448\u043B\u0438\u0441\u0442\u0435',\r\n  badgeInStock: '\u0412 \u043D\u0430\u043B\u0438\u0447\u0438\u0438',\r\n  badgeOutOfStock: '\u041F\u043E\u0434 \u0437\u0430\u043A\u0430\u0437',\r\n  addToCartButton: '\u0412 \u041A\u043E\u0440\u0437\u0438\u043D\u0443',\r\n  goToCartButton: '\u041A\u043E\u0440\u0437\u0438\u043D\u0430',\r\n};\r\n\r\nexport class ProductPage {\r\n  constructor(shop, opts = {}) {\r\n    if (!shop) throw new Error('ProductPage requires ShopMatic instance');\r\n\r\n    const {\r\n      productService,\r\n      cart,\r\n      favorites,\r\n      renderer,\r\n      notifications,\r\n      wishlistModule: wishlist,\r\n    } = shop;\r\n\r\n    this.shop = shop;\r\n    this.productService = productService;\r\n    this.cart = cart;\r\n    this.favorites = favorites;\r\n    this.renderer = renderer;\r\n    this.notifications = notifications;\r\n    this.wishlist = wishlist || null;\r\n\r\n    const {\r\n      messages = {},\r\n      debug = false,\r\n      ...rest\r\n    } = opts;\r\n\r\n    this.opts = {\r\n      templateId: null,\r\n      relatedLimit: 6,\r\n      cardTemplateKey: 'cardVertical',\r\n      ...rest,\r\n    };\r\n\r\n    this.messages = { ...DEFAULT_MESSAGES, ...messages };\r\n    this.debug = !!debug;\r\n\r\n    this._stripeTimers = new WeakMap();\r\n    this.container = null;\r\n    this.currentProductId = null;\r\n\r\n    this._bound = {\r\n      onAddClick: this._onAddClick.bind(this),\r\n      onFavClick: this._onFavClick.bind(this),\r\n      onQtyInput: this._onQtyInput.bind(this),\r\n      onQtyIncr: this._onQtyIncr.bind(this),\r\n      onQtyDecr: this._onQtyDecr.bind(this),\r\n      onWishlistClick: this._onWishlistClick.bind(this),\r\n      onBackClick: this._onBackClick.bind(this),\r\n      onCartUpdated: this._onCartUpdated.bind(this),\r\n      onBuyNowClick: this._onBuyNowClick.bind(this),\r\n    };\r\n  }\r\n\r\n  _log(...args) {\r\n    if (!this.debug) return;\r\n    try {\r\n      const msg = args.join(' ');\r\n      this.shop?.foxEngine?.log?.(`ProductPage: ${msg}`, 'DEBUG');\r\n    } catch (_) {\r\n      // eslint-disable-next-line no-console\r\n      console.debug('ProductPage:', ...args);\r\n    }\r\n  }\r\n\r\n  _initGallery() {\r\n    if (!this.container) return;\r\n    const galleryRoot = this.container.querySelector('.product-gallery');\r\n    if (!galleryRoot) return;\r\n\r\n    const product = this.productService.findById(this.currentProductId) ?? {};\r\n    let photos = [];\r\n\r\n    try {\r\n      photos = Array.isArray(product.images)\r\n        ? product.images.slice()\r\n        : JSON.parse(product.picture || '[]');\r\n    } catch {\r\n      photos = [];\r\n    }\r\n\r\n    try {\r\n      this.gallery = new Gallery(galleryRoot, photos);\r\n    } catch (err) {\r\n      console.warn('Gallery initialization failed', err);\r\n    }\r\n  }\r\n\r\n  async render(productId, container = this.shop.foxEngine.replaceData.contentBlock) {\r\n    if (!this.pageTemplate) {\r\n      const tplPath = `/templates/${this.shop.foxEngine.replaceData.template}/foxEngine/product/productPage.tpl`;\r\n      this.pageTemplate = await this.shop.foxEngine.loadTemplate(tplPath);\r\n    }\r\n\r\n    const el = typeof container === 'string' ? document.querySelector(container) : container;\r\n    if (!el) throw new Error('container element required');\r\n\r\n    this.container = el;\r\n    this.currentProductId = String(productId);\r\n\r\n    this._log('render: fetching product', productId);\r\n\r\n    let product = null;\r\n    try {\r\n      product = await this.productService.fetchById(productId);\r\n    } catch {\r\n      product = null;\r\n    }\r\n\r\n    if (!product) {\r\n      this._log('render: product not found', productId);\r\n      await this._renderNotFound();\r\n      return;\r\n    }\r\n\r\n    try {\r\n      this.cart?.loadFromStorage?.();\r\n    } catch {}\r\n\r\n    let html;\r\n    try {\r\n      html = await this._buildHtml(product);\r\n      this.container.innerHTML = html;\r\n      this._log('render: HTML injected', productId);\r\n    } catch (e) {\r\n      console.error('_buildHtml error', e);\r\n      await this._renderNotFound();\r\n      return;\r\n    }\r\n\r\n    try {\r\n      this._syncFavButton();\r\n      this._syncQtyControls();\r\n      this._syncWishlistButton();\r\n      this._bindListeners();\r\n    } catch (e) {\r\n      console.error('UI sync/bind error', e);\r\n    }\r\n\r\n    try {\r\n      await this._renderRelated(product);\r\n    } catch (e) {\r\n      console.error('_renderRelated error', e);\r\n    }\r\n  }\r\n\r\n  destroy() {\r\n    if (!this.container) return;\r\n    this._unbindListeners();\r\n    this.container = null;\r\n    this.currentProductId = null;\r\n  }\r\n\r\n  async _renderNotFound() {\r\n    if (!this.container) return;\r\n    const tplPath = `/templates/${this.shop.foxEngine.replaceData.template}/foxEngine/product/notFound.tpl`;\r\n    this.container.innerHTML = await this.shop.foxEngine.loadTemplate(tplPath);\r\n    const back = this.container.querySelector('[data-action=\"back\"]');\r\n    back?.addEventListener('click', this._bound.onBackClick);\r\n  }\r\n\r\n  async _buildHtml(p) {\r\n    try {\r\n      this.shop.storage.addViewed?.(p);\r\n    } catch {}\r\n\r\n    const cartItem = Array.isArray(this.cart?.cart)\r\n      ? this.cart.cart.find(item => String(item.name) === String(p.name))\r\n      : null;\r\n\r\n    const qtyFromCart = cartItem ? Number(cartItem.qty || 0) : 0;\r\n\r\n    const photos = Array.isArray(p.images)\r\n      ? p.images.slice()\r\n      : p.image\r\n        ? [p.image]\r\n        : p.picture\r\n          ? [p.picture]\r\n          : [];\r\n\r\n    const mainImage = photos[0] ?? p.picture ?? p.image ?? '';\r\n\r\n    const thumbsHtml = photos.length\r\n      ? photos\r\n          .map((src, i) => {\r\n            const esc = this._escapeAttr(src);\r\n            const active = i === 0 ? ' active' : '';\r\n            return `<button class=\"thumb-btn${active}\" data-thumb-index=\"${i}\" aria-label=\"thumb-${i}\"><img src=\"${esc}\" alt=\"\" loading=\"lazy\" /></button>`;\r\n          })\r\n          .join('')\r\n      : '';\r\n\r\n    try {\r\n      await this.productService.fetchCategories?.();\r\n    } catch {}\r\n\r\n    const tplData = {\r\n      name: p.name ?? '',\r\n      fullname: p.title ?? p.name ?? p.fullname ?? '',\r\n      price: this._formatPrice(p.price),\r\n      oldPrice: p.oldPrice ? this._formatPrice(p.oldPrice) : '',\r\n      short: p.short ?? '',\r\n      long: p.long ?? '',\r\n      qty: qtyFromCart > 0 ? qtyFromCart : 1,\r\n      mainImage,\r\n      images: photos,\r\n      picture: p.picture ?? mainImage,\r\n      discountPercent: '',\r\n      thumbs: thumbsHtml,\r\n      brandName: p.brandName ?? '',\r\n      categoryName: p.categoryName ? `<small>${p.categoryName}</small>` : '',\r\n      brand: p.brand ?? '',\r\n      category: p.category ?? '',\r\n      specs: typeof makeSpecHtmlPreview === 'function'\r\n        ? makeSpecHtmlPreview(p.specs || {})\r\n        : '',\r\n    };\r\n\r\n    const fox = this.shop.foxEngine;\r\n\r\n    try {\r\n      if (this.opts.templateId) {\r\n        const t = document.getElementById(this.opts.templateId);\r\n        if (t?.content) {\r\n          const raw = t.innerHTML || '';\r\n          return this._replaceTokens(raw, tplData);\r\n        }\r\n      }\r\n\r\n      if (fox?.replaceTextInTemplate) {\r\n        const replaced = await fox.replaceTextInTemplate(this.pageTemplate, tplData);\r\n        if (typeof replaced === 'string' && replaced.length) return replaced;\r\n      }\r\n    } catch (e) {\r\n      console.warn('ProductPage: template replacement failed', e);\r\n    }\r\n\r\n    const pictureToken = this._escapeAttr(tplData.picture || tplData.mainImage);\r\n    const nameToken = this._escapeAttr(tplData.name);\r\n    const fullnameHtml = escapeHtml(tplData.fullname);\r\n    const priceToken = tplData.price || '';\r\n    const oldPriceToken = tplData.oldPrice || '';\r\n    const stockToken = String(p.stock ?? p.qty ?? 0);\r\n    const qtyToken = String(tplData.qty);\r\n    const specsHtml = tplData.specs || '';\r\n    const thumbsToken = tplData.thumbs || '';\r\n    const noticesToken = '';\r\n\r\n    return this.pageTemplate\r\n      .replace(/\\{name\\}/g, nameToken)\r\n      .replace(/\\{fullname\\}/g, fullnameHtml)\r\n      .replace(/\\{picture\\}/g, pictureToken)\r\n      .replace(/\\{price\\}/g, priceToken)\r\n      .replace(/\\{oldPrice\\}/g, oldPriceToken)\r\n      .replace(/\\{stock\\}/g, stockToken)\r\n      .replace(/\\{qty\\}/g, qtyToken)\r\n      .replace(/\\{specs\\}/g, specsHtml)\r\n      .replace(/\\{thumbs\\}/g, thumbsToken)\r\n      .replace(/\\{notices\\}/g, noticesToken);\r\n  }\r\n\r\n  _bindListeners() {\r\n    if (!this.container) return;\r\n\r\n    const add = (selector, event, handler) => {\r\n      const el = this.container.querySelector(selector);\r\n      if (el) el.addEventListener(event, handler);\r\n    };\r\n\r\n    add('[data-action=\"add-to-cart\"], .add-to-cart, .btn-yellow', 'click', this._bound.onAddClick);\r\n    add('.fav-toggle', 'click', this._bound.onFavClick);\r\n    add('.wishlist-toggle', 'click', this._bound.onWishlistClick);\r\n    add('.qty-input', 'input', this._bound.onQtyInput);\r\n    add('[data-action=\"back\"]', 'click', this._bound.onBackClick);\r\n    add('[data-action=\"buy-now\"]', 'click', this._bound.onBuyNowClick);\r\n\r\n    this.container\r\n      .querySelectorAll('.qty-incr')\r\n      .forEach(btn => btn.addEventListener('click', this._bound.onQtyIncr));\r\n\r\n    this.container\r\n      .querySelectorAll('.qty-decr')\r\n      .forEach(btn => btn.addEventListener('click', this._bound.onQtyDecr));\r\n\r\n    this.container\r\n      .querySelectorAll('.thumb-btn')\r\n      .forEach(btn =>\r\n        btn.addEventListener('click', ev => {\r\n          const idx = parseInt(ev.currentTarget.getAttribute('data-thumb-index'), 10) || 0;\r\n          const product = this.productService.findById(this.currentProductId) || {};\r\n          const photos = Array.isArray(product.images) ? product.images : [];\r\n          const src = photos[idx];\r\n          const main = this.container.querySelector('.product-main-img');\r\n          if (main && src) main.src = src;\r\n        })\r\n      );\r\n\r\n    this.container\r\n      .querySelectorAll('.size-btn')\r\n      .forEach(btn =>\r\n        btn.addEventListener('click', ev => {\r\n          this.container\r\n            .querySelectorAll('.size-btn')\r\n            .forEach(b => b.classList.remove('active'));\r\n          ev.currentTarget.classList.add('active');\r\n        })\r\n      );\r\n\r\n    window.addEventListener('cart:updated', this._bound.onCartUpdated);\r\n\r\n    try {\r\n      this._initGallery();\r\n    } catch (e) {\r\n      console.warn('gallery init failed', e);\r\n    }\r\n  }\r\n\r\n  _unbindListeners() {\r\n    if (!this.container) return;\r\n\r\n    const remove = (selector, event, handler) => {\r\n      const el = this.container.querySelector(selector);\r\n      if (el) el.removeEventListener(event, handler);\r\n    };\r\n\r\n    remove('[data-action=\"add-to-cart\"], .add-to-cart, .btn-yellow', 'click', this._bound.onAddClick);\r\n    remove('.fav-toggle', 'click', this._bound.onFavClick);\r\n    remove('.wishlist-toggle', 'click', this._bound.onWishlistClick);\r\n    remove('.qty-input', 'input', this._bound.onQtyInput);\r\n    remove('[data-action=\"back\"]', 'click', this._bound.onBackClick);\r\n    remove('[data-action=\"buy-now\"]', 'click', this._bound.onBuyNowClick);\r\n\r\n    this.container\r\n      .querySelectorAll('.qty-incr')\r\n      .forEach(btn => btn.removeEventListener('click', this._bound.onQtyIncr));\r\n\r\n    this.container\r\n      .querySelectorAll('.qty-decr')\r\n      .forEach(btn => btn.removeEventListener('click', this._bound.onQtyDecr));\r\n\r\n    this.container\r\n      .querySelectorAll('.thumb-btn')\r\n      .forEach(t => t.replaceWith(t.cloneNode(true)));\r\n\r\n    this.container\r\n      .querySelectorAll('.size-btn')\r\n      .forEach(b => b.replaceWith(b.cloneNode(true)));\r\n\r\n    window.removeEventListener('cart:updated', this._bound.onCartUpdated);\r\n  }\r\n\r\n  // ===== events =====\r\n\r\n  _onAddClick() {\r\n    const pid = this.currentProductId;\r\n    if (!pid) return;\r\n\r\n    try {\r\n      const qtyEl = this.container.querySelector('.qty-input');\r\n      const qty = Math.max(1, parseInt(qtyEl?.value || '1', 10));\r\n\r\n      const available = this.cart && typeof this.cart._computeAvailableStock === 'function'\r\n        ? this.cart._computeAvailableStock(pid)\r\n        : this.productService.findById(pid)?.stock || 0;\r\n\r\n      if (available <= 0) {\r\n        this.notifications.show(this.messages.addToCartDisabled, { duration: 3000 });\r\n        return;\r\n      }\r\n\r\n      const toAdd = Math.min(qty, available);\r\n      this.cart?.add?.(pid, toAdd);\r\n      this._syncQtyControls();\r\n    } catch (err) {\r\n      console.error('_onAddClick error', err);\r\n      this.notifications.show(this.messages.addToCartError, { duration: 3000 });\r\n    }\r\n  }\r\n\r\n  _onFavClick() {\r\n    try {\r\n      const pid = this.currentProductId;\r\n      if (!pid || !this.favorites?.toggle) return;\r\n\r\n      this.favorites.toggle(pid);\r\n      this._syncFavButton();\r\n\r\n      const isFav = this.favorites.isFavorite?.(pid);\r\n      this.notifications.show(\r\n        isFav ? this.messages.favoriteAdded : this.messages.favoriteRemoved,\r\n        { duration: 1500 }\r\n      );\r\n    } catch (err) {\r\n      console.warn(err);\r\n    }\r\n  }\r\n\r\n  _onWishlistClick() {\r\n    const pid = this.currentProductId;\r\n    if (!pid) return;\r\n\r\n    if (!this.wishlist) {\r\n      this.notifications.show(this.messages.wishlistNotConfigured, { duration: 1400 });\r\n      return;\r\n    }\r\n\r\n    try {\r\n      if (this.wishlist.toggle) this.wishlist.toggle(pid);\r\n      else if (this.wishlist.add) this.wishlist.add(pid);\r\n\r\n      this._syncWishlistButton();\r\n      this.notifications.show(this.messages.wishlistUpdated, { duration: 1200 });\r\n    } catch (err) {\r\n      console.warn(err);\r\n    }\r\n  }\r\n\r\n  _onQtyInput(e) {\r\n    const qty = parseInt(e.target.value || '1', 10) || 1;\r\n    const pid = this.currentProductId;\r\n    const product = this.productService.findById(pid);\r\n    const available = product ? product.stock ?? product.qty ?? 0 : 0;\r\n\r\n    if (qty > available) {\r\n      e.target.value = String(available || 1);\r\n      const msg = this.messages.maxAvailableTemplate.replace('{count}', String(available));\r\n      this.notifications.show(msg, { duration: 1400 });\r\n    }\r\n\r\n    const cartItem = Array.isArray(this.cart?.cart)\r\n      ? this.cart.cart.find(i => String(i.name) === String(pid))\r\n      : null;\r\n\r\n    if (cartItem && typeof this.cart?.changeQty === 'function') {\r\n      const newQty = Math.max(\r\n        1,\r\n        Math.min(available || 1, parseInt(e.target.value || '1', 10))\r\n      );\r\n      try {\r\n        this.cart.changeQty(pid, newQty);\r\n      } catch (err) {\r\n        console.warn(err);\r\n      }\r\n    }\r\n\r\n    this._syncQtyControls();\r\n  }\r\n\r\n  _onQtyIncr(e) {\r\n    try {\r\n      const ctrl = e.currentTarget?.closest?.('.qty-controls') || null;\r\n      const qtyEl = ctrl?.querySelector('.qty-input') || this.container.querySelector('.qty-input');\r\n      if (!qtyEl) return;\r\n\r\n      const pid = this.currentProductId;\r\n      const product = this.productService.findById(pid);\r\n      const stock = product ? product.stock ?? product.qty ?? 0 : 0;\r\n\r\n      let cur = parseInt(qtyEl.value || '1', 10) || 1;\r\n      const target = Math.min(stock || cur + 1, cur + 1);\r\n\r\n      if (target > cur) {\r\n        qtyEl.value = String(target);\r\n        this.cart?.changeQty?.(pid, target);\r\n      }\r\n\r\n      this._syncQtyControls();\r\n      this._log('_onQtyIncr: increment', pid, '->', qtyEl?.value);\r\n    } catch (err) {\r\n      console.error('_onQtyIncr', err);\r\n    }\r\n  }\r\n\r\n  _onQtyDecr(e) {\r\n    try {\r\n      const ctrl = e.currentTarget?.closest?.('.qty-controls') || null;\r\n      const qtyEl = ctrl?.querySelector('.qty-input') || this.container.querySelector('.qty-input');\r\n      if (!qtyEl) return;\r\n\r\n      const pid = this.currentProductId;\r\n      let cur = parseInt(qtyEl.value || '1', 10) || 1;\r\n      const target = Math.max(0, cur - 1);\r\n      qtyEl.value = String(target);\r\n\r\n      if (target === 0) {\r\n        try {\r\n          if (this.cart?.remove) {\r\n            this.cart.remove(String(pid));\r\n          } else if (Array.isArray(this.cart?.cart)) {\r\n            const idx = this.cart.cart.findIndex(i => String(i.name) === String(pid));\r\n            if (idx >= 0) {\r\n              this.cart.cart.splice(idx, 1);\r\n              this.cart.save?.();\r\n            }\r\n          }\r\n\r\n          this.notifications.show(this.messages.itemRemovedFromCart, { duration: 1500 });\r\n          this._log('_onQtyDecr: removed from cart', pid);\r\n        } catch (err) {\r\n          console.warn('cart.remove threw', err);\r\n        }\r\n\r\n        window.dispatchEvent(\r\n          new CustomEvent('cart:updated', { detail: { changedIds: [pid] } })\r\n        );\r\n      } else {\r\n        try {\r\n          this.cart?.changeQty?.(String(pid), Number(target));\r\n        } catch (err) {\r\n          console.warn('cart.changeQty threw', err);\r\n        }\r\n\r\n        if (Array.isArray(this.cart?.cart)) {\r\n          const idx = this.cart.cart.findIndex(i => String(i.name) === String(pid));\r\n          if (idx >= 0) {\r\n            this.cart.cart[idx].qty = Number(target);\r\n            this.cart.save?.();\r\n            window.dispatchEvent(\r\n              new CustomEvent('cart:updated', { detail: { changedIds: [pid] } })\r\n            );\r\n          }\r\n        }\r\n      }\r\n\r\n      this._syncQtyControls();\r\n    } catch (err) {\r\n      console.error('_onQtyDecr', err);\r\n    }\r\n  }\r\n\r\n  _onBackClick() {\r\n    if (window.history && window.history.length > 1) {\r\n      window.history.back();\r\n      return;\r\n    }\r\n    if (this.container) this.container.innerHTML = '';\r\n  }\r\n\r\n  _onCartUpdated() {\r\n    this._syncQtyControls();\r\n  }\r\n\r\n  _onBuyNowClick(e) {\r\n    e.preventDefault();\r\n    if (!this.container) return;\r\n\r\n    const pid = this.currentProductId;\r\n    const product = this.productService.findById(pid);\r\n    if (!product) return;\r\n\r\n    const qtyEl = this.container.querySelector('.qty-input');\r\n    const stock = Number(product.stock ?? product.qty ?? 0) || 0;\r\n\r\n    let qty = 1;\r\n    if (qtyEl) {\r\n      const raw = Number(qtyEl.value || 1);\r\n      qty = Number.isFinite(raw) && raw > 0 ? raw : 1;\r\n    }\r\n    if (stock > 0) qty = Math.min(qty, stock);\r\n\r\n    const buyNowItem = {\r\n      id: product.id ?? product.productId ?? null,\r\n      name: product.name ?? product.fullname ?? '',\r\n      fullname: product.fullname ?? product.name ?? '',\r\n      price: Number(product.price ?? product.product_price ?? 0),\r\n      qty,\r\n      picture: (() => {\r\n        if (!product.picture) return '[]';\r\n        if (typeof product.picture === 'string') {\r\n          try {\r\n            JSON.parse(product.picture);\r\n            return product.picture;\r\n          } catch {\r\n            return JSON.stringify([product.picture]);\r\n          }\r\n        }\r\n        if (Array.isArray(product.picture)) return JSON.stringify(product.picture);\r\n        return '[]';\r\n      })(),\r\n      specs: product.specs ?? product.description ?? '',\r\n    };\r\n\r\n    location.hash = '#page/checkout';\r\n\r\n    setTimeout(() => {\r\n      if (this.shop && this.shop.checkoutPage) {\r\n        this.shop.checkoutPage.init('#test', { buyNowItem });\r\n      } else {\r\n        console.warn('[ProductPage] this.shop.checkoutPage \u043D\u0435 \u0438\u043D\u0438\u0446\u0438\u0430\u043B\u0438\u0437\u0438\u0440\u043E\u0432\u0430\u043D');\r\n      }\r\n    }, 800);\r\n  }\r\n\r\n  // ===== sync UI =====\r\n\r\n  _syncFavButton() {\r\n    if (!this.container || !this.favorites) return;\r\n\r\n    const btn = this.container.querySelector('.fav-toggle');\r\n    if (!btn) return;\r\n\r\n    const isFav = this.favorites.isFavorite?.(String(this.currentProductId)) ?? false;\r\n    btn.innerHTML = isFav ? this.messages.favLabelIn : this.messages.favLabelAdd;\r\n  }\r\n\r\n  _animateStripes(btn, duration = 1800) {\r\n    if (!btn || !(btn instanceof HTMLElement)) return;\r\n\r\n    const timers = this._stripeTimers;\r\n    const prev = timers.get(btn);\r\n    if (prev) {\r\n      clearTimeout(prev);\r\n      timers.delete(btn);\r\n    }\r\n\r\n    btn.classList.add('with-stripes', 'active');\r\n    btn.classList.remove('hidden');\r\n\r\n    const t = setTimeout(() => {\r\n      btn.classList.add('hidden');\r\n      const cleanup = setTimeout(() => {\r\n        btn.classList.remove('with-stripes', 'hidden');\r\n        timers.delete(btn);\r\n        clearTimeout(cleanup);\r\n      }, 300);\r\n      timers.delete(btn);\r\n    }, duration);\r\n\r\n    timers.set(btn, t);\r\n  }\r\n\r\n  _syncWishlistButton() {\r\n    if (!this.container || !this.wishlist) return;\r\n\r\n    const btn = this.container.querySelector('.wishlist-toggle');\r\n    if (!btn) return;\r\n\r\n    let isIn = false;\r\n    try {\r\n      isIn =\r\n        this.wishlist.isIn?.(this.currentProductId) ||\r\n        this.wishlist.has?.(this.currentProductId) ||\r\n        false;\r\n    } catch {}\r\n\r\n    btn.textContent = isIn ? this.messages.wishlistLabelIn : this.messages.wishlistLabelAdd;\r\n  }\r\n\r\n  _syncQtyControls() {\r\n    if (!this.container) return;\r\n\r\n    const pid = this.currentProductId;\r\n    const product = this.productService.findById(pid);\r\n\r\n    const stock = product ? Number(product.stock ?? product.qty ?? 0) : 0;\r\n    const stockEl = this.container.querySelector('.stock-count');\r\n    if (stockEl) stockEl.textContent = String(stock);\r\n\r\n    const controlBar = this.container.querySelector('.qty-controls');\r\n    const qtyEl = this.container.querySelector('.qty-input');\r\n    const btnPlus = this.container.querySelector('.qty-incr');\r\n    const btnMinus = this.container.querySelector('.qty-decr');\r\n\r\n    const addBtn = this.container.querySelector(\r\n      '[data-action=\"add-to-cart\"], .add-to-cart, .btn-yellow'\r\n    );\r\n    const buyNowBtn = this.container.querySelector('[data-action=\"buy-now\"]');\r\n\r\n    if (buyNowBtn && !buyNowBtn._buyBound) {\r\n      buyNowBtn.addEventListener('click', this._bound.onBuyNowClick);\r\n      buyNowBtn._buyBound = true;\r\n    }\r\n\r\n    const cartItem = Array.isArray(this.cart?.cart)\r\n      ? this.cart.cart.find(i => String(i.name) === String(pid))\r\n      : null;\r\n\r\n    const cartQty = cartItem ? Number(cartItem.qty || 0) : 0;\r\n\r\n    if (qtyEl) {\r\n      qtyEl.setAttribute('min', '1');\r\n      qtyEl.setAttribute('max', String(Math.max(1, stock)));\r\n\r\n      let cur = parseInt(\r\n        qtyEl.value || (cartQty > 0 ? String(cartQty) : '1'),\r\n        10\r\n      ) || 1;\r\n\r\n      if (cartQty > 0) {\r\n        cur = cartQty;\r\n\r\n        if (buyNowBtn) buyNowBtn.style.display = 'none';\r\n        if (controlBar) controlBar.style.display = 'flex';\r\n\r\n        if (addBtn) {\r\n          try {\r\n            addBtn.removeEventListener('click', this._bound.onAddClick);\r\n          } catch {}\r\n\r\n          addBtn.onclick = () => {\r\n            try {\r\n              this.shop.foxEngine?.page?.loadPage('cart');\r\n            } catch {}\r\n          };\r\n\r\n          addBtn.innerHTML = `\r\n            <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 12 12\"\r\n                 class=\"_1w4N_\" width=\"16\" height=\"16\">\r\n              <path fill=\"#21201F\" fill-rule=\"evenodd\"\r\n                    d=\"M0 5.752a.5.5 0 0 1 .5-.5h8.65L5.304 1.406a.5.5 0 0 1 0-.707l.342-.343a.5.5 0 0 1 .708 0L12 6.002 6.354 11.65a.5.5 0 0 1-.708 0l-.342-.343a.5.5 0 0 1 0-.707L9.15 6.752H.5a.5.5 0 0 1-.5-.5v-.5Z\"\r\n                    clip-rule=\"evenodd\"></path>\r\n            </svg> ${this.messages.goToCartButton}`;\r\n        }\r\n      } else {\r\n        if (buyNowBtn) buyNowBtn.style.display = 'flex';\r\n        if (controlBar) controlBar.style.display = 'none';\r\n\r\n        if (addBtn) {\r\n          addBtn.onclick = null;\r\n          addBtn.addEventListener('click', this._bound.onAddClick);\r\n          addBtn.innerHTML = this.messages.addToCartButton;\r\n        }\r\n      }\r\n\r\n      if (stock <= 0) {\r\n        qtyEl.value = '0';\r\n        qtyEl.disabled = true;\r\n        if (addBtn) {\r\n          addBtn.disabled = true;\r\n          addBtn.classList.add('disabled');\r\n        }\r\n      } else {\r\n        if (cur > stock) cur = stock;\r\n        qtyEl.value = String(cur);\r\n        qtyEl.disabled = false;\r\n        if (addBtn) {\r\n          addBtn.disabled = false;\r\n          addBtn.classList.remove('disabled');\r\n        }\r\n      }\r\n    }\r\n\r\n    try {\r\n      const current = qtyEl ? parseInt(qtyEl.value || '1', 10) || 1 : 1;\r\n\r\n      if (btnPlus) {\r\n        const disablePlus = stock <= 0 || current >= stock;\r\n        btnPlus.disabled = disablePlus;\r\n        if (disablePlus) btnPlus.setAttribute('aria-disabled', 'true');\r\n        else btnPlus.removeAttribute('aria-disabled');\r\n      }\r\n\r\n      if (btnMinus) {\r\n        const disableMinus = current <= 0;\r\n        btnMinus.disabled = disableMinus;\r\n        if (disableMinus) btnMinus.setAttribute('aria-disabled', 'true');\r\n        else btnMinus.removeAttribute('aria-disabled');\r\n      }\r\n    } catch {}\r\n  }\r\n\r\n  // ===== cards / related =====\r\n\r\n  async createCard(product = {}) {\r\n    const p = product || {};\r\n    const id = String(p.name ?? p.id ?? p.productId ?? '');\r\n    const priceText = this._formatPrice(p.price ?? 0);\r\n    const hasOldPrice = p.oldPrice && Number(p.oldPrice) > 0;\r\n\r\n    const badgeText =\r\n      Number(p.stock) > 0\r\n        ? this.messages.badgeInStock\r\n        : this.messages.badgeOutOfStock;\r\n\r\n    const specsHtml = makeSpecHtmlPreview\r\n      ? makeSpecHtmlPreview(p.specs || p.attributes || {})\r\n      : '';\r\n\r\n    const data = {\r\n      id,\r\n      fullname: p.fullname ?? p.title ?? p.name ?? '',\r\n      img: p.picture ?? p.image ?? '/assets/no-image.png',\r\n      short: p.short ?? '',\r\n      price: priceText,\r\n      oldPrice: hasOldPrice ? this._formatPrice(p.oldPrice) : '',\r\n      badgeText,\r\n      stock: Number.isFinite(Number(p.stock)) ? Number(p.stock) : 0,\r\n      specsHtml,\r\n    };\r\n\r\n    let html = '';\r\n    const fox = this.shop.foxEngine;\r\n\r\n    try {\r\n      if (fox?.templateCache?.[this.opts.cardTemplateKey]) {\r\n        html = await fox.replaceTextInTemplate(\r\n          fox.templateCache[this.opts.cardTemplateKey],\r\n          data\r\n        );\r\n      }\r\n    } catch (e) {\r\n      fox?.log?.('ProductPage.createCard template error: ' + e, 'ERROR');\r\n      html = '';\r\n    }\r\n\r\n    if (!html) {\r\n      const escTitle = escapeHtml(data.fullname);\r\n      const escImg = escapeHtml(data.img);\r\n      const escPrice = escapeHtml(data.price);\r\n      const escOld = escapeHtml(data.oldPrice);\r\n      const escShort = escapeHtml(data.short);\r\n      const escSpecs = data.specsHtml || '';\r\n\r\n      html = `\r\n        <article class=\"card product-card\" data-product-id=\"${escapeHtml(id)}\">\r\n          <div class=\"card__media\">\r\n            <img src=\"${escImg}\" alt=\"${escTitle}\" loading=\"lazy\">\r\n          </div>\r\n          <div class=\"card__body p-2\">\r\n            <h3 class=\"card__title small\">${escTitle}</h3>\r\n            <div class=\"card__price\">\r\n              ${escPrice}${hasOldPrice ? ' <small class=\"old\">' + escOld + '</small>' : ''}\r\n            </div>\r\n            <div class=\"card__short small text-muted\">${escShort}</div>\r\n            <div class=\"card__specs small\">${escSpecs}</div>\r\n            <div class=\"card__controls mt-2\">\r\n              <button data-role=\"buy\" class=\"btn btn-sm btn-outline-primary\">\r\n                ${this.messages.addToCartButton}\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </article>`;\r\n    }\r\n\r\n    const wrapper = document.createElement('div');\r\n    wrapper.innerHTML = html.trim();\r\n    const node = wrapper.firstElementChild || wrapper;\r\n\r\n    try {\r\n      node?.setAttribute('data-product-id', String(id));\r\n    } catch {}\r\n\r\n    return node;\r\n  }\r\n\r\n  async _renderCartVertical(list = [], rootEl) {\r\n    if (!rootEl) return;\r\n\r\n    rootEl.innerHTML = '';\r\n\r\n    const frag = document.createDocumentFragment();\r\n    const cards = await Promise.all(\r\n      (Array.isArray(list) ? list : []).map(p => this.createCard(p))\r\n    );\r\n\r\n    for (const card of cards) {\r\n      if (!card) continue;\r\n      card.style.opacity = '0';\r\n      card.style.transition = 'opacity .22s ease';\r\n      frag.append(card);\r\n      requestAnimationFrame(() => {\r\n        card.style.opacity = '1';\r\n      });\r\n    }\r\n\r\n    rootEl.append(frag);\r\n  }\r\n\r\n  updateProductCardFavState(rootEl, id, isFav) {\r\n    if (!rootEl || !id) return;\r\n\r\n    const esc = typeof CSS !== 'undefined' && CSS.escape\r\n      ? CSS.escape(String(id))\r\n      : String(id).replace(/\"/g, '\\\\\"');\r\n\r\n    const selector = `[data-product-id=\"${esc}\"]`;\r\n    const card = rootEl.querySelector(selector);\r\n    if (!card) return;\r\n\r\n    const favBtn = card.querySelector('.fav-btn, .fav-toggle, [data-role=\"fav\"]');\r\n    if (!favBtn) return;\r\n\r\n    favBtn.setAttribute('aria-pressed', isFav ? 'true' : 'false');\r\n    favBtn.title = isFav ? '\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u043C' : '\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435';\r\n    favBtn.classList.toggle('is-fav', Boolean(isFav));\r\n\r\n    const icon = favBtn.querySelector('i');\r\n    if (icon) {\r\n      icon.classList.remove('fa-regular', 'fa-solid');\r\n      icon.classList.add(isFav ? 'fa-solid' : 'fa-regular');\r\n      if (!icon.classList.contains('fa-heart')) icon.classList.add('fa-heart');\r\n    }\r\n  }\r\n\r\n  async _renderRelated(product) {\r\n    if (!this.container) return;\r\n\r\n    const relatedRoot = this.container.querySelector('[data-related]');\r\n    if (!relatedRoot) return;\r\n\r\n    try {\r\n      const all = Array.isArray(this.productService.getProducts())\r\n        ? this.productService.getProducts()\r\n        : [];\r\n\r\n      let related = all.filter(\r\n        p => p && p.id != product.id && p.category === product.category\r\n      );\r\n      if (!related.length) {\r\n        related = all.filter(p => p && p.id != product.id);\r\n      }\r\n\r\n      related = related.slice(0, this.opts.relatedLimit);\r\n\r\n      await this._renderCartVertical(related, relatedRoot);\r\n\r\n      related.forEach(p => {\r\n        const isFav = this.favorites?.isFavorite?.(String(p.id)) ?? false;\r\n        this.updateProductCardFavState(relatedRoot, p.id, isFav);\r\n      });\r\n    } catch (err) {\r\n      console.warn('renderRelated failed', err);\r\n    }\r\n  }\r\n\r\n  _replaceTokens(template, data = {}) {\r\n    return String(template).replace(/\\{\\{\\s*([^}]+)\\s*\\}\\}/g, (m, key) => {\r\n      const v = Object.prototype.hasOwnProperty.call(data, key) ? data[key] : '';\r\n      return v == null ? '' : String(v);\r\n    });\r\n  }\r\n\r\n  _formatPrice(v) {\r\n    if (v == null) return '';\r\n    if (typeof v === 'number') {\r\n      try {\r\n        return new Intl.NumberFormat('ru-RU', {\r\n          style: 'currency',\r\n          currency: 'RUB',\r\n          maximumFractionDigits: 0,\r\n        }).format(v);\r\n      } catch {\r\n        return String(v);\r\n      }\r\n    }\r\n    return String(v);\r\n  }\r\n\r\n  _escapeAttr(str) {\r\n    if (str == null) return '';\r\n    return String(str).replace(/\"/g, '&quot;');\r\n  }\r\n}\r\n\r\nfunction escapeHtml(str) {\r\n  if (str == null) return '';\r\n  return String(str)\r\n    .replace(/&/g, '&amp;')\r\n    .replace(/</g, '&lt;')\r\n    .replace(/>/g, '&gt;')\r\n    .replace(/\"/g, '&quot;');\r\n}\r\n", "/**\n * ViewedItemsModule\n * @author Calista Verner\n *\n * This module is responsible for loading and rendering a list of recently viewed\n * products into the DOM. It leverages the provided StorageService to fetch\n * stored items from localStorage and, if possible, enriches them with\n * availability information via productService.fetchById.\n * \n * Date: 2025-11-01\n * License: MIT\n */\n\nexport class ViewedItemsModule {\n  /**\n   * Create a new ViewedItemsModule.\n   *\n   * @param {Object} deps\n   * @param {StorageService} deps.storageService - Instance of StorageService.\n   * @param {Object} [deps.renderer] - Optional renderer with renderCards() and/or other methods.\n   * @param {string|HTMLElement} deps.container - DOM container or selector where items should be rendered.\n   * @param {Object} [deps.opts] - Optional configuration overrides.\n   *   maxItems: maximum number of viewed items to display (default from storageService.maxViewedItems).\n   *   concurrency: number of concurrent fetches for availability (default from storageService.defaultConcurrency).\n   *   noItemsMessage: message to display when no items were viewed.\n   */\n  constructor({ storageService, renderer = null, container, opts = {} }) {\n    if (!storageService) throw new Error('ViewedItemsModule requires a storageService.');\n    this._storage = storageService;\n    this._renderer = renderer;\n    this._container = (typeof container === 'string') ? document.querySelector(container) : container;\n    if (!this._container) {\n      throw new Error('ViewedItemsModule: container element not found.');\n    }\n    const defaults = {\n      maxItems: Number.isFinite(Number(storageService?.maxViewedItems)) ? Number(storageService.maxViewedItems) : 20,\n      concurrency: Number.isFinite(Number(storageService?.defaultConcurrency)) ? Number(storageService.defaultConcurrency) : 6,\n      noItemsMessage: '\u041D\u0435\u0442 \u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440\u0435\u043D\u043D\u044B\u0445 \u0442\u043E\u0432\u0430\u0440\u043E\u0432.'\n    };\n    this._opts = Object.assign({}, defaults, opts);\n  }\n\n  /**\n   * Load the viewed items from storage, enrich them with availability info,\n   * and render them into the container.\n   * This method is idempotent and can be called multiple times to refresh the UI.\n   */\n  async load() {\n    // Clear existing content\n    this._container.innerHTML = '';\n\n    // Fetch raw viewed items from storage\n    let raw = [];\n    try {\n      raw = this._storage.loadViewed?.() || [];\n    } catch (e) {\n      console.warn('ViewedItemsModule: failed to load viewed items', e);\n      raw = [];\n    }\n\n    // If nothing to show, render a friendly message and return\n    if (!Array.isArray(raw) || raw.length === 0) {\n      this._renderEmpty();\n      return;\n    }\n\n    // Sort by viewedAt descending (newest first) and limit the number of items\n    const itemsToLoad = raw\n      .slice() // shallow copy to avoid mutating original\n      .sort((a, b) => (b.viewedAt || 0) - (a.viewedAt || 0))\n      .slice(0, this._opts.maxItems);\n\n    // Attempt to enrich items with availability using StorageService._loadWithAvailability\n    let enriched = itemsToLoad;\n    try {\n      if (typeof this._storage._loadWithAvailability === 'function') {\n        enriched = await this._storage._loadWithAvailability(itemsToLoad, { concurrency: this._opts.concurrency });\n      }\n    } catch (e) {\n      console.warn('ViewedItemsModule: _loadWithAvailability failed', e);\n      // fall back to raw items\n      enriched = itemsToLoad;\n    }\n\n    // Render the list\n    await this._render(enriched);\n  }\n\n  /**\n   * Render the list of items into the container. If a renderer is provided, use\n   * it to render product cards; otherwise, fall back to a simple list. This\n   * method handles errors gracefully and falls back to fallback rendering if\n   * renderer fails.\n   *\n   * @param {Array} items - Array of item objects.\n   */\n  async _render(items) {\n    if (!this._container) return;\n    try {\n      // If a custom renderer exists and has renderCards, use it.\n      if (this._renderer && typeof this._renderer.renderCards === 'function') {\n        // Create a temporary container for rendering\n        const tmp = document.createElement('div');\n        const renderResult = this._renderer.renderCards(tmp, items, this._renderer.foxEngine);\n        if (renderResult && typeof renderResult.then === 'function') {\n          await renderResult;\n        }\n        // Clear existing content and append rendered content\n        this._container.innerHTML = '';\n        this._container.appendChild(tmp);\n        return;\n      }\n    } catch (e) {\n      console.warn('ViewedItemsModule: renderer.renderCards failed', e);\n      // fall through to fallback\n    }\n    // Fallback: simple list rendering\n    this._renderFallback(items);\n  }\n\n  /**\n   * Render a simple list of viewed items as an unordered list. Each list item\n   * contains a thumbnail (if available) and a link to the product page. This\n   * method does not rely on external renderer.\n   *\n   * @param {Array} items - Array of item objects.\n   */\n  _renderFallback(items) {\n    // Create list container\n    const ul = document.createElement('ul');\n    ul.className = 'viewed-items-list';\n\n    for (const it of items) {\n      const li = document.createElement('li');\n      li.className = 'viewed-item';\n\n      // Wrapper for the image and text\n      const itemContent = document.createElement('div');\n      itemContent.className = 'viewed-item__content';\n\n      // Thumbnail image\n      if (it.picture) {\n        const img = document.createElement('img');\n        img.src = String(JSON.parse(it.picture).at(0));\n        img.loading = 'lazy';\n        img.width = 80;\n        img.height = 80;\n        img.className = 'viewed-item__image';\n        itemContent.appendChild(img);\n      }\n\n      // Product link\n      const link = document.createElement('a');\n      link.href = `#product/${encodeURIComponent(it.name || '')}`;\n      link.textContent = String(it.fullname || it.name || '');\n      link.className = 'viewed-item__link';\n      itemContent.appendChild(link);\n\n      // Availability indicator (optional)\n      const available = this._storage.shopMatic.cart.isAvailable(it);\n      const status = document.createElement('span');\n      status.className = 'viewed-item__status';\n      status.textContent = available ? '\u0412 \u043D\u0430\u043B\u0438\u0447\u0438\u0438' : '\u041D\u0435\u0442 \u0432 \u043D\u0430\u043B\u0438\u0447\u0438\u0438';\n      status.style.marginLeft = '8px';\n      itemContent.appendChild(status);\n\n      // Add content to list item\n      li.appendChild(itemContent);\n\n      // Optional: Add a \"View\" button for better interaction\n      const viewButton = document.createElement('button');\n      viewButton.className = 'viewed-item__button';\n      viewButton.textContent = '\u041F\u043E\u0441\u043C\u043E\u0442\u0440\u0435\u0442\u044C';\n      viewButton.onclick = () => window.location.href = link.href;\n      li.appendChild(viewButton);\n\n      ul.appendChild(li);\n    }\n\n    // Clear container and insert list\n    this._container.innerHTML = '';\n    this._container.appendChild(ul);\n\n    // Add \"Clear History\" button\n    this._addClearHistoryButton();\n  }\n\n  /**\n   * Add \"Clear History\" button at the bottom of the list.\n   */\n  _addClearHistoryButton() {\n    const clearButtonHtml = `\n      <div class=\"clearViewed\">\n        <a href=\"javascript:void(0)\" onclick=\"foxEngine.shopMatic.storage.clearViewed()\">\u041E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u0438\u0441\u0442\u043E\u0440\u0438\u044E</a>\n      </div>\n    `;\n    this._container.insertAdjacentHTML('beforeend', clearButtonHtml);\n  }\n\n  /**\n   * Render an empty state when there are no viewed items.\n   */\n  _renderEmpty() {\n    const p = document.createElement('p');\n    p.className = 'viewed-items-empty';\n    p.textContent = String(this._opts.noItemsMessage);\n    this._container.appendChild(p);\n  }\n\n  /**\n   * Synchronize viewed items with the latest storage data and re-render.\n   */\n  async sync() {\n    await this.load(); // Reload the items from storage\n  }\n}\n", "// Catalog/FilterController.js\r\nimport { debounce } from '../utils.js';\r\n\r\n/**\r\n * \u041E\u0442\u0432\u0435\u0447\u0430\u0435\u0442 \u0437\u0430:\r\n *  - \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0444\u0438\u043B\u044C\u0442\u0440\u043E\u0432 (\u043F\u043E\u0438\u0441\u043A, \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u044F, \u0431\u0440\u0435\u043D\u0434, \u0441\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u043A\u0430)\r\n *  - \u043F\u0440\u0438\u0432\u044F\u0437\u043A\u0443 DOM-\u0441\u043E\u0431\u044B\u0442\u0438\u0439\r\n *  - \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u0435 CatalogController \u043E\u0431 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u044F\u0445\r\n *\r\n * \u0410\u0440\u0445\u0438\u0442\u0435\u043A\u0442\u0443\u0440\u0430:\r\n *  - \u043F\u043E\u043B\u044F \u043E\u043F\u0438\u0441\u0430\u043D\u044B \u0434\u0435\u043A\u043B\u0430\u0440\u0430\u0442\u0438\u0432\u043D\u043E \u0432 this._fieldsConfig\r\n *  - \u0435\u0434\u0438\u043D\u044B\u0439 \u043E\u0431\u0440\u0430\u0431\u043E\u0442\u0447\u0438\u043A \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u0439 _handleChange\r\n */\r\nexport class FilterController {\r\n  /**\r\n   * @param {Object} opts\r\n   * @param {HTMLInputElement|null}  opts.searchEl\r\n   * @param {HTMLSelectElement|null} opts.catFilterEl\r\n   * @param {HTMLSelectElement|null} opts.brandFilterEl\r\n   * @param {HTMLSelectElement|null} opts.sortEl\r\n   * @param {HTMLButtonElement|null} opts.searchBtnEl\r\n   * @param {HTMLButtonElement|null} opts.resetBtnEl\r\n   * @param {HTMLElement|null}       opts.productsCountEl\r\n   * @param {number}                 [opts.debounceMs=300]\r\n   */\r\n  constructor({\r\n    searchEl,\r\n    catFilterEl,\r\n    brandFilterEl,\r\n    sortEl,\r\n    searchBtnEl,\r\n    resetBtnEl,\r\n    productsCountEl,\r\n    debounceMs = 300\r\n  } = {}) {\r\n    this.productsCountEl = productsCountEl || null;\r\n    this.resetBtnEl = resetBtnEl || null;\r\n    this.searchBtnEl = searchBtnEl || null;\r\n\r\n    /** @type {(state: object) => void|null} */\r\n    this._onChange = null;\r\n    this._debounceMs = debounceMs;\r\n\r\n    // \u0414\u0435\u043A\u043B\u0430\u0440\u0430\u0442\u0438\u0432\u043D\u043E\u0435 \u043E\u043F\u0438\u0441\u0430\u043D\u0438\u0435 \u0432\u0441\u0435\u0445 \u043F\u043E\u043B\u0435\u0439\r\n    this._fieldsConfig = [\r\n      {\r\n        key: 'search',\r\n        el: searchEl || null,\r\n        events: ['input'],\r\n        useDebounce: true,\r\n        getValue: (el) => (el?.value || '').trim(),\r\n        setValue: (el, value) => {\r\n          if (!el) return;\r\n          el.value = value ?? '';\r\n        },\r\n        defaultValue: ''\r\n      },\r\n      {\r\n        key: 'category',\r\n        el: catFilterEl || null,\r\n        events: ['change'],\r\n        useDebounce: false,\r\n        getValue: (el) => el?.value || '',\r\n        setValue: (el, value) => {\r\n          if (!el) return;\r\n          el.value = value ?? '';\r\n        },\r\n        defaultValue: ''\r\n      },\r\n      {\r\n        key: 'brand',\r\n        el: brandFilterEl || null,\r\n        events: ['change'],\r\n        useDebounce: false,\r\n        getValue: (el) => el?.value || '',\r\n        setValue: (el, value) => {\r\n          if (!el) return;\r\n          el.value = value ?? '';\r\n        },\r\n        defaultValue: ''\r\n      },\r\n      {\r\n        key: 'sort',\r\n        el: sortEl || null,\r\n        events: ['change'],\r\n        useDebounce: false,\r\n        getValue: (el) => el?.value || '',\r\n        setValue: (el, value) => {\r\n          if (!el) return;\r\n          el.value = value ?? '';\r\n        },\r\n        // \u0434\u0435\u0444\u043E\u043B\u0442 \u0441\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u043A\u0438 \u043E\u043F\u0440\u0435\u0434\u0435\u043B\u044F\u0435\u043C \u043F\u043E\u0437\u0436\u0435 \u0432 reset()\r\n        defaultValue: ''\r\n      }\r\n    ];\r\n\r\n    // \u0418\u043D\u0438\u0446\u0438\u0430\u043B\u0438\u0437\u0438\u0440\u0443\u0435\u043C state \u0434\u0435\u0444\u043E\u043B\u0442\u0430\u043C\u0438\r\n    this._state = this._buildInitialState();\r\n\r\n    // \u0437\u0434\u0435\u0441\u044C \u0431\u0443\u0434\u0443\u0442 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u044B \u0440\u0435\u0430\u043B\u044C\u043D\u044B\u0435 \u043E\u0431\u0440\u0430\u0431\u043E\u0442\u0447\u0438\u043A\u0438 \u0434\u043B\u044F unbind()\r\n    this._fieldHandlers = new Map();\r\n\r\n    this._boundReset = this._handleReset.bind(this);\r\n    this._boundSearchBtn = this._handleSearchBtn.bind(this);\r\n  }\r\n\r\n  /* ----------------------------------------------------------------------- */\r\n  /* Public API                                                              */\r\n  /* ----------------------------------------------------------------------- */\r\n\r\n  /**\r\n   * \u041F\u043E\u0434\u043F\u0438\u0441\u0430\u0442\u044C \u043A\u043E\u043D\u0442\u0440\u043E\u043B\u043B\u0435\u0440 \u043D\u0430 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u044F \u0444\u0438\u043B\u044C\u0442\u0440\u043E\u0432\r\n   * @param {(state: object) => void} onChange\r\n   */\r\n  bind(onChange) {\r\n    this._onChange = typeof onChange === 'function' ? onChange : null;\r\n\r\n    const baseHandler = this._handleChange.bind(this);\r\n\r\n    // \u043D\u0430\u0432\u0435\u0448\u0438\u0432\u0430\u0435\u043C \u0441\u043E\u0431\u044B\u0442\u0438\u044F \u043D\u0430 \u043A\u0430\u0436\u0434\u044B\u0439 \u0444\u0438\u043B\u044C\u0442\u0440\r\n    this._fieldsConfig.forEach((cfg) => {\r\n      const { key, el, events, useDebounce } = cfg;\r\n      if (!el || !Array.isArray(events)) return;\r\n\r\n      const handler = useDebounce\r\n        ? debounce(baseHandler, this._debounceMs)\r\n        : baseHandler;\r\n\r\n      // \u0441\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C handler, \u0447\u0442\u043E\u0431\u044B \u043F\u043E\u0442\u043E\u043C \u0441\u043D\u044F\u0442\u044C\r\n      this._fieldHandlers.set(key, handler);\r\n\r\n      events.forEach((eventName) => {\r\n        el.addEventListener(eventName, handler);\r\n      });\r\n    });\r\n\r\n    // \u043A\u043D\u043E\u043F\u043A\u0430 \u043F\u043E\u0438\u0441\u043A\u0430 (\u043F\u043E \u0441\u0443\u0442\u0438 \u2014 \u0444\u043E\u0440\u0441-\u0442\u0440\u0438\u0433\u0433\u0435\u0440 \u0444\u0438\u043B\u044C\u0442\u0440\u043E\u0432)\r\n    if (this.searchBtnEl) {\r\n      this.searchBtnEl.addEventListener('click', this._boundSearchBtn);\r\n    }\r\n\r\n    // \u0441\u0431\u0440\u043E\u0441\r\n    if (this.resetBtnEl) {\r\n      this.resetBtnEl.addEventListener('click', this._boundReset);\r\n    }\r\n  }\r\n\r\n  unbind() {\r\n    // \u0441\u043D\u0438\u043C\u0430\u0435\u043C \u043E\u0431\u0440\u0430\u0431\u043E\u0442\u0447\u0438\u043A\u0438 \u0441 \u043F\u043E\u043B\u0435\u0439\r\n    this._fieldsConfig.forEach((cfg) => {\r\n      const { key, el, events } = cfg;\r\n      if (!el || !Array.isArray(events)) return;\r\n\r\n      const handler = this._fieldHandlers.get(key);\r\n      if (!handler) return;\r\n\r\n      events.forEach((eventName) => {\r\n        el.removeEventListener(eventName, handler);\r\n      });\r\n    });\r\n\r\n    this._fieldHandlers.clear();\r\n\r\n    if (this.searchBtnEl) {\r\n      this.searchBtnEl.removeEventListener('click', this._boundSearchBtn);\r\n    }\r\n    if (this.resetBtnEl) {\r\n      this.resetBtnEl.removeEventListener('click', this._boundReset);\r\n    }\r\n\r\n    this._onChange = null;\r\n  }\r\n\r\n  /** \u0422\u0435\u043A\u0443\u0449\u0435\u0435 \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0444\u0438\u043B\u044C\u0442\u0440\u043E\u0432 */\r\n  getState() {\r\n    // \u0432\u0441\u0435\u0433\u0434\u0430 \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0438\u0440\u0443\u0435\u043C\u0441\u044F \u0438\u0437 DOM, \u0447\u0442\u043E\u0431\u044B state \u0431\u044B\u043B \u0430\u043A\u0442\u0443\u0430\u043B\u0435\u043D\r\n    this._syncFromControls();\r\n    return { ...this._state };\r\n  }\r\n\r\n  /**\r\n   * \u041F\u0440\u0438\u043C\u0435\u043D\u0438\u0442\u044C \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u043A \u043A\u043E\u043D\u0442\u0440\u043E\u043B\u0430\u043C\r\n   * @param {Object} partial\r\n   * @param {boolean} [options.silent=false]\r\n   */\r\n  setState(partial = {}, { silent = false } = {}) {\r\n    this._state = { ...this._state, ...partial };\r\n    this._syncToControls();\r\n    if (!silent) this._emitChange();\r\n  }\r\n\r\n  /** \u0421\u0431\u0440\u043E\u0441 \u0444\u0438\u043B\u044C\u0442\u0440\u043E\u0432 \u043A \u0434\u0435\u0444\u043E\u043B\u0442\u043D\u043E\u043C\u0443 \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u044E */\r\n  reset({ silent = false } = {}) {\r\n    // \u043E\u0441\u043E\u0431\u0430\u044F \u043B\u043E\u0433\u0438\u043A\u0430 \u0434\u043B\u044F sort: \u0435\u0441\u043B\u0438 \u0435\u0441\u0442\u044C select \u2014 \u0431\u0435\u0440\u0451\u043C \u043F\u0435\u0440\u0432\u0443\u044E option \u043A\u0430\u043A \u0434\u0435\u0444\u043E\u043B\u0442\r\n    const sortCfg = this._fieldsConfig.find((f) => f.key === 'sort');\r\n    if (sortCfg && sortCfg.el) {\r\n      const first = sortCfg.el.querySelector('option');\r\n      sortCfg.defaultValue = first ? first.value : '';\r\n    }\r\n\r\n    this._state = this._buildInitialState();\r\n    this._syncToControls();\r\n\r\n    if (!silent) this._emitChange();\r\n  }\r\n\r\n  /** \u041E\u0431\u043D\u043E\u0432\u0438\u0442\u044C \u0432\u0438\u0437\u0443\u0430\u043B\u044C\u043D\u044B\u0439 \u0441\u0447\u0451\u0442\u0447\u0438\u043A \u0442\u043E\u0432\u0430\u0440\u043E\u0432 */\r\n  setCount(count) {\r\n    if (this.productsCountEl) {\r\n      this.productsCountEl.textContent = String(count ?? 0);\r\n    }\r\n  }\r\n\r\n  /* ----------------------------------------------------------------------- */\r\n  /* Internal                                                                */\r\n  /* ----------------------------------------------------------------------- */\r\n\r\n  _buildInitialState() {\r\n    const state = {};\r\n    this._fieldsConfig.forEach((cfg) => {\r\n      const { key, defaultValue } = cfg;\r\n      state[key] = typeof defaultValue === 'function'\r\n        ? defaultValue()\r\n        : defaultValue ?? '';\r\n    });\r\n    return state;\r\n  }\r\n\r\n  _emitChange() {\r\n    if (!this._onChange) return;\r\n    this._onChange(this.getState());\r\n  }\r\n\r\n  _syncFromControls() {\r\n    this._fieldsConfig.forEach((cfg) => {\r\n      const { key, el, getValue } = cfg;\r\n      if (!el || typeof getValue !== 'function') return;\r\n      this._state[key] = getValue(el);\r\n    });\r\n  }\r\n\r\n  _syncToControls() {\r\n    this._fieldsConfig.forEach((cfg) => {\r\n      const { key, el, setValue } = cfg;\r\n      if (!el || typeof setValue !== 'function') return;\r\n      setValue(el, this._state[key]);\r\n    });\r\n  }\r\n\r\n  _handleChange() {\r\n    this._syncFromControls();\r\n    this._emitChange();\r\n  }\r\n\r\n  _handleSearchBtn() {\r\n    this._handleChange();\r\n  }\r\n\r\n  _handleReset() {\r\n    this.reset();\r\n  }\r\n}\r\n", "// Catalog/CatalogView.js\r\n\r\n/**\r\n * \u0427\u0438\u0441\u0442\u043E\u0435 \u043F\u0440\u0435\u0434\u0441\u0442\u0430\u0432\u043B\u0435\u043D\u0438\u0435 \u043A\u0430\u0442\u0430\u043B\u043E\u0433\u0430:\r\n *  - \u0440\u0435\u043D\u0434\u0435\u0440 \u0441\u043F\u0438\u0441\u043A\u0430 \u0442\u043E\u0432\u0430\u0440\u043E\u0432\r\n *  - \u043F\u0443\u0441\u0442\u043E\u0435 \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435\r\n *  - \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u044F \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E\r\n */\r\nexport class CatalogView {\r\n  /**\r\n   * @param {Object} opts\r\n   * @param {HTMLElement|null} opts.root\r\n   * @param {HTMLElement|null} opts.productsCountEl\r\n   * @param {Object}           opts.shop (renderer, favorites, _msg, _syncAllCardsControls)\r\n   * @param {(key:string, fallback?:string)=>string} opts.msg\r\n   */\r\n  constructor({ root, productsCountEl, shop, msg }) {\r\n    this.root = root || null;\r\n    this.productsCountEl = productsCountEl || null;\r\n    this.shop = shop;\r\n    this._msg = typeof msg === 'function'\r\n      ? msg\r\n      : (key, fallback = '') => fallback || key;\r\n  }\r\n\r\n  /**\r\n   * \u041E\u0441\u043D\u043E\u0432\u043D\u043E\u0439 \u043C\u0435\u0442\u043E\u0434 \u0440\u0435\u043D\u0434\u0435\u0440\u0430 \u043A\u0430\u0442\u0430\u043B\u043E\u0433\u0430\r\n   * @param {Array<any>} list\r\n   */\r\n  async render(list = []) {\r\n    const arr = Array.isArray(list) ? list : [];\r\n    if (!this.root) return;\r\n\r\n    if (this.productsCountEl) {\r\n      this.productsCountEl.textContent = String(arr.length);\r\n    }\r\n\r\n    if (!arr.length) {\r\n      this.renderNoResults();\r\n      return;\r\n    }\r\n\r\n    this.clearNoResults();\r\n\r\n    await this.shop.renderer._renderCartVertical(arr, this.root);\r\n    this._updateFavorites(arr);\r\n    this.shop._syncAllCardsControls();\r\n  }\r\n\r\n  /**\r\n   * \u0420\u0435\u043D\u0434\u0435\u0440 \u043F\u0443\u0441\u0442\u043E\u0433\u043E \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u044F\r\n   * @param {string|null} [message]\r\n   */\r\n  renderNoResults(message = null) {\r\n    if (!this.root) return;\r\n    if (this.productsCountEl) this.productsCountEl.textContent = '0';\r\n\r\n    const text = message ?? this._msg('CATALOG_NO_RESULTS', '\u041F\u043E \u0442\u0435\u043A\u0443\u0449\u0438\u043C \u043E\u043F\u0446\u0438\u044F\u043C \u043D\u0435\u0442 \u0442\u043E\u0432\u0430\u0440\u043E\u0432');\r\n    const hintText = this._msg(\r\n      'CATALOG_NO_RESULTS_HINT',\r\n      '\u041F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0438\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0444\u0438\u043B\u044C\u0442\u0440\u044B \u0438\u043B\u0438 \u0441\u0431\u0440\u043E\u0441\u0438\u0442\u044C \u043F\u043E\u0438\u0441\u043A.'\r\n    );\r\n\r\n    const wrapper = document.createElement('div');\r\n    wrapper.className = 'catalog-empty';\r\n\r\n    const icon = document.createElement('div');\r\n    icon.className = 'catalog-empty__icon';\r\n    icon.innerHTML =\r\n      '<svg width=\"48\" height=\"48\" viewBox=\"0 0 24 24\" aria-hidden=\"true\" focusable=\"false\">' +\r\n      '<path fill=\"currentColor\" d=\"M3 6h18v2H3zm0 5h12v2H3zm0 5h6v2H3z\"></path>' +\r\n      '</svg>';\r\n    icon.style.opacity = '0.6';\r\n\r\n    const p = document.createElement('p');\r\n    p.className = 'catalog-empty__text';\r\n    p.textContent = text;\r\n\r\n    const hint = document.createElement('div');\r\n    hint.className = 'catalog-empty__hint';\r\n    hint.textContent = hintText;\r\n\r\n    wrapper.appendChild(icon);\r\n    wrapper.appendChild(p);\r\n    wrapper.appendChild(hint);\r\n\r\n    this.root.innerHTML = '';\r\n    this.root.appendChild(wrapper);\r\n    this.shop._syncAllCardsControls();\r\n  }\r\n\r\n  clearNoResults() {\r\n    const found = this.root?.querySelector('.catalog-empty');\r\n    if (found) found.remove();\r\n  }\r\n\r\n  _updateFavorites(list) {\r\n    if (!this.shop.favorites || !this.root) return;\r\n\r\n    list.forEach(product => {\r\n      const card = this.root.querySelector(`[data-product-id=\"${product.id}\"]`);\r\n      if (!card) return;\r\n      const isFav = this.shop.favorites.isFavorite(product.id);\r\n      this.shop.renderer.updateProductCardFavState(this.root, product.id, isFav);\r\n    });\r\n  }\r\n}\r\n", "// Catalog/CatalogController.js\r\n/**\r\n * Catalog module encapsulates all logic related to displaying and filtering the\r\n * product list. It loads products, categories and brands from the underlying\r\n * ProductService, populates the filter controls, renders product cards via\r\n * Renderer and keeps card controls and favorite state in sync.\r\n * @author Calista Verner\r\n * @date [13.11.25]\r\n */\r\n\r\nimport { FilterController } from './FilterController.js';\r\nimport { CatalogView } from './CatalogView.js';\r\n\r\nexport class CatalogController {\r\n  static UI_MESSAGES = Object.freeze({\r\n    PRODUCT_LIMIT_DEFAULT: '\u0423 \u0432\u0430\u0441 \u0443\u0436\u0435 \u043C\u0430\u043A\u0441\u0438\u043C\u0443\u043C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0435',\r\n    PRODUCT_LIMIT_REACHED: '\u0412\u044B \u0434\u043E\u0441\u0442\u0438\u0433\u043B\u0438 \u043C\u0430\u043A\u0441\u0438\u043C\u0430\u043B\u044C\u043D\u043E\u0433\u043E \u043A\u043E\u043B\u0438\u0447\u0435\u0441\u0442\u0432\u0430 \u044D\u0442\u043E\u0433\u043E \u0442\u043E\u0432\u0430\u0440\u0430',\r\n    NO_STOCK_TEXT: '\u0422\u043E\u0432\u0430\u0440\u0430 \u043D\u0435\u0442 \u0432 \u043D\u0430\u043B\u0438\u0447\u0438\u0438',\r\n    CANNOT_ADD_NO_STOCK: '\u041D\u0435\u0432\u043E\u0437\u043C\u043E\u0436\u043D\u043E \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C: \u043D\u0435\u0442 \u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E\u0433\u043E \u043E\u0441\u0442\u0430\u0442\u043A\u0430.',\r\n    ADDED_PARTIAL: '\u0412 \u043A\u043E\u0440\u0437\u0438\u043D\u0443 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E {added} \u0448\u0442. (\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E {available}).',\r\n    FAVORITES_UNAVAILABLE: '\u041C\u043E\u0434\u0443\u043B\u044C \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D.',\r\n    PRODUCT_LEFT: '\u041E\u0441\u0442\u0430\u0442\u043E\u043A: {left}',\r\n\r\n    CATALOG_LOAD_ERROR: '\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0442\u043E\u0432\u0430\u0440\u044B',\r\n    CATALOG_ALL_OPTION: '\u0412\u0441\u0435',\r\n    CATALOG_NO_RESULTS: '\u041F\u043E \u0442\u0435\u043A\u0443\u0449\u0438\u043C \u043E\u043F\u0446\u0438\u044F\u043C \u043D\u0435\u0442 \u0442\u043E\u0432\u0430\u0440\u043E\u0432',\r\n    CATALOG_NO_RESULTS_HINT: '\u041F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0438\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0444\u0438\u043B\u044C\u0442\u0440\u044B \u0438\u043B\u0438 \u0441\u0431\u0440\u043E\u0441\u0438\u0442\u044C \u043F\u043E\u0438\u0441\u043A.'\r\n  });\r\n\r\n  constructor({\r\n    shop, rootId, catFilterId, brandFilterId, searchId, sortId, searchBtnId, productsCountId\r\n  }) {\r\n    if (!shop) throw new Error('CatalogController requires a shop instance');\r\n\r\n    this.shop = shop;\r\n    this.opts = {\r\n      rootId,\r\n      catFilterId,\r\n      brandFilterId,\r\n      searchId,\r\n      sortId,\r\n      searchBtnId,\r\n      productsCountId\r\n    };\r\n\r\n    this.root = null;\r\n    this.catFilter = null;\r\n    this.brandFilter = null;\r\n    this.search = null;\r\n    this.sort = null;\r\n    this.searchBtn = null;\r\n    this.resetBtn = null;\r\n    this.productsCount = null;\r\n\r\n    this.filters = null;\r\n    this.view = null;\r\n  }\r\n\r\n  // --- utils / i18n --------------------------------------------------------\r\n\r\n  _msg(key, fallback = '') {\r\n    if (this.shop && typeof this.shop._msg === 'function') {\r\n      const val = this.shop._msg(key);\r\n      if (val != null && val !== key) return val;\r\n    }\r\n\r\n    const i18n = this.shop?.i18n;\r\n    if (i18n && typeof i18n.t === 'function') {\r\n      const val = i18n.t(key);\r\n      if (val != null && val !== key) return val;\r\n    }\r\n\r\n    return CatalogController.UI_MESSAGES[key] || fallback;\r\n  }\r\n\r\n  _getProductService() {\r\n    return this.shop?.productService || null;\r\n  }\r\n\r\n  _setLocationHash(hash) {\r\n    if (typeof window !== 'undefined' && window.location) {\r\n      window.location.hash = hash;\r\n    }\r\n  }\r\n\r\n  _showNotification(message) {\r\n    try {\r\n      this.shop.notifications.show(message, {\r\n        duration: this.shop.opts?.notificationDuration ?? 3000\r\n      });\r\n    } catch (_) {}\r\n  }\r\n\r\n  // --- lifecycle -----------------------------------------------------------\r\n\r\n  async init(_request = {}) {\r\n    this._cacheDomElements();\r\n    this._createHelpers();\r\n\r\n    const ps = this._getProductService();\r\n    if (!ps) return;\r\n\r\n    // \u043A\u0430\u043A \u0432 \u043E\u0440\u0438\u0433\u0438\u043D\u0430\u043B\u0435: \u0441\u043D\u0430\u0447\u0430\u043B\u0430 initSelectors (\u043E\u043D \u0436\u0435 applyFilters \u2192 \u043F\u0443\u0441\u0442\u043E\u0439 \u0441\u043F\u0438\u0441\u043E\u043A),\r\n    // \u043F\u043E\u0442\u043E\u043C loadProductsSimple, \u043F\u043E\u0442\u043E\u043C \u0431\u0438\u043D\u0434\u0438\u043C \u0441\u043E\u0431\u044B\u0442\u0438\u044F\r\n    await this.initSelectors();\r\n\r\n    try {\r\n      await ps.loadProductsSimple();\r\n    } catch (err) {\r\n      console.error('Catalog.init: loadProductsSimple failed', err);\r\n      this._showNotification(\r\n        this._msg('CATALOG_LOAD_ERROR', '\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0442\u043E\u0432\u0430\u0440\u044B')\r\n      );\r\n    }\r\n\r\n    this._bindFilterEvents();\r\n  }\r\n\r\n  async initSelectors(brand = '', category = '') {\r\n    await Promise.all([\r\n      this.catFilter\r\n        ? this._populateFilter(\r\n            this.catFilter,\r\n            this._getProductService(),\r\n            'fillCategories',\r\n            'fetchCategories',\r\n            category\r\n          )\r\n        : Promise.resolve(),\r\n      this.brandFilter\r\n        ? this._populateFilter(\r\n            this.brandFilter,\r\n            this._getProductService(),\r\n            'fillBrands',\r\n            'fetchBrands',\r\n            brand\r\n          )\r\n        : Promise.resolve()\r\n    ]);\r\n\r\n    await this.applyFilters();\r\n  }\r\n\r\n  /**\r\n   * \u0417\u0434\u0435\u0441\u044C:\r\n   *  - \u043D\u0430\u043F\u043E\u043B\u043D\u044F\u0435\u043C \u0441\u0435\u043B\u0435\u043A\u0442\u044B (\u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u044F / \u0431\u0440\u0435\u043D\u0434)\r\n   *  - \u0432\u044B\u0441\u0442\u0430\u0432\u043B\u044F\u0435\u043C \u0437\u043D\u0430\u0447\u0435\u043D\u0438\u044F \u0438\u0437 request\r\n   *  - \u043F\u0440\u0438\u043C\u0435\u043D\u044F\u0435\u043C \u0444\u0438\u043B\u044C\u0442\u0440\u0430\u0446\u0438\u044E \u0438 \u0440\u0435\u043D\u0434\u0435\u0440\r\n   */\r\n  async loadCatalog({ request = null } = {}) {\r\n    const ps = this._getProductService();\r\n    if (!ps) return [];\r\n\r\n    const selectedCategory = request?.category ?? '';\r\n    const selectedBrand    = request?.brand ?? '';\r\n    const searchValue      = request?.search ?? '';\r\n    const sortValue        = request?.sort ?? '';\r\n\r\n    this._setLocationHash('#page/catalog');\r\n\r\n    await this.initSelectors(selectedBrand, selectedCategory);\r\n\r\n    // \u043F\u0440\u043E\u0441\u0442\u0430\u0432\u043B\u044F\u0435\u043C \u0437\u043D\u0430\u0447\u0435\u043D\u0438\u044F \u0432 DOM \u0438 \u0432 \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0444\u0438\u043B\u044C\u0442\u0440\u043E\u0432\r\n    this._applyRequestToControls({\r\n      category: selectedCategory,\r\n      brand: selectedBrand,\r\n      search: searchValue,\r\n      sort: sortValue\r\n    });\r\n\r\n    if (this.filters) {\r\n      this.filters.setState({\r\n        category: selectedCategory,\r\n        brand: selectedBrand,\r\n        search: searchValue,\r\n        sort: sortValue\r\n      }, { silent: true });\r\n    }\r\n\r\n    await this.applyFilters();\r\n\r\n    const list = ps.getProducts?.();\r\n    return Array.isArray(list) ? [...list] : [];\r\n  }\r\n\r\n  destroy() {\r\n    if (this.filters) this.filters.unbind();\r\n    this.root = null;\r\n    this.catFilter = null;\r\n    this.brandFilter = null;\r\n    this.search = null;\r\n    this.sort = null;\r\n    this.searchBtn = null;\r\n    this.resetBtn = null;\r\n    this.productsCount = null;\r\n    this.filters = null;\r\n    this.view = null;\r\n  }\r\n\r\n  // --- DOM / helpers -------------------------------------------------------\r\n\r\n  _cacheDomElements() {\r\n    const {\r\n      rootId,\r\n      catFilterId,\r\n      brandFilterId,\r\n      searchId,\r\n      sortId,\r\n      searchBtnId,\r\n      productsCountId\r\n    } = this.opts;\r\n\r\n    this.root          = document.getElementById(rootId) || null;\r\n    this.catFilter     = document.getElementById(catFilterId) || null;\r\n    this.brandFilter   = document.getElementById(brandFilterId) || null;\r\n    this.search        = document.getElementById(searchId) || null;\r\n    this.sort          = document.getElementById(sortId) || null;\r\n    this.searchBtn     = document.getElementById(searchBtnId) || null;\r\n    this.productsCount = document.getElementById(productsCountId) || null;\r\n\r\n    this.resetBtn      = document.getElementById('resetFilters') || null;\r\n  }\r\n\r\n  _createHelpers() {\r\n    this.filters = new FilterController({\r\n      searchEl: this.search,\r\n      catFilterEl: this.catFilter,\r\n      brandFilterEl: this.brandFilter,\r\n      sortEl: this.sort,\r\n      searchBtnEl: this.searchBtn,\r\n      resetBtnEl: this.resetBtn,\r\n      productsCountEl: this.productsCount,\r\n      debounceMs: 300\r\n    });\r\n\r\n    this.view = new CatalogView({\r\n      root: this.root,\r\n      productsCountEl: this.productsCount,\r\n      shop: this.shop,\r\n      msg: this._msg.bind(this)\r\n    });\r\n  }\r\n\r\n  _bindFilterEvents() {\r\n    if (!this.filters) return;\r\n    this.filters.bind(() => {\r\n      this.applyFilters();\r\n    });\r\n  }\r\n\r\n  _applyRequestToControls({ category, brand, search, sort }) {\r\n    if (this.search && typeof search === 'string') {\r\n      this.search.value = search;\r\n    }\r\n    if (this.catFilter && category) {\r\n      this.catFilter.value = category;\r\n    }\r\n    if (this.brandFilter && brand) {\r\n      this.brandFilter.value = brand;\r\n    }\r\n    if (this.sort && sort) {\r\n      this.sort.value = sort;\r\n    }\r\n  }\r\n\r\n  // --- filters / data ------------------------------------------------------\r\n\r\n  async _populateFilter(filterElement, ps, fillMethod, fetchMethod, selectedValue = '') {\r\n    if (!filterElement || !ps) return;\r\n\r\n    try {\r\n      if (typeof ps[fillMethod] === 'function') {\r\n        await ps[fillMethod](filterElement, { selected: selectedValue });\r\n\r\n        if (selectedValue && filterElement.value !== selectedValue) {\r\n          filterElement.value = selectedValue;\r\n        }\r\n        return;\r\n      }\r\n\r\n      if (typeof ps[fetchMethod] === 'function') {\r\n        await ps[fetchMethod]();\r\n      }\r\n\r\n      const getterName = `get${fillMethod.replace('fill', '')}`;\r\n      const items = typeof ps[getterName] === 'function'\r\n        ? (ps[getterName]() || [])\r\n        : [];\r\n\r\n      const allLabel = this._msg('CATALOG_ALL_OPTION', '\u0412\u0441\u0435');\r\n      filterElement.innerHTML = `<option value=\"\">${allLabel}</option>`;\r\n\r\n      for (const item of items) {\r\n        if (!item) continue;\r\n        const option = document.createElement('option');\r\n        option.value = item.id ?? item.name ?? '';\r\n        option.textContent = item.fullname ?? item.name ?? item.id ?? '';\r\n\r\n        if (selectedValue && option.value === selectedValue) {\r\n          option.selected = true;\r\n        }\r\n\r\n        filterElement.appendChild(option);\r\n      }\r\n\r\n      if (selectedValue) {\r\n        filterElement.value = selectedValue;\r\n      }\r\n    } catch (err) {\r\n      console.warn(`CatalogController._populateFilter: ${fillMethod} failed`, err);\r\n    }\r\n  }\r\n\r\n  _getProductList() {\r\n    const ps = this._getProductService();\r\n    const list = ps && typeof ps.getProducts === 'function'\r\n      ? ps.getProducts()\r\n      : [];\r\n    return Array.isArray(list) ? [...list] : [];\r\n  }\r\n\r\n  _filterAndSort(list) {\r\n    const searchTerm = (this.search?.value || '').trim().toLowerCase();\r\n    const category   = this.catFilter?.value || '';\r\n    const brand      = this.brandFilter?.value || '';\r\n    const sortOrder  = this.sort?.value || '';\r\n\r\n    if (searchTerm) {\r\n      list = list.filter(p =>\r\n        (p.fullname || p.title || p.name || '').toLowerCase().includes(searchTerm)\r\n      );\r\n    }\r\n\r\n    if (category) {\r\n      list = list.filter(p => p.category === category);\r\n    }\r\n\r\n    if (brand) {\r\n      const normalized = brand.toLowerCase();\r\n      list = list.filter(\r\n        p => (p.brand ?? p.brandName ?? '').toLowerCase() === normalized\r\n      );\r\n    }\r\n\r\n    if (!sortOrder) return list;\r\n\r\n    const arr = [...list];\r\n    switch (sortOrder) {\r\n      case 'price_asc':\r\n        return arr.sort((a, b) => (a.price || 0) - (b.price || 0));\r\n      case 'price_desc':\r\n        return arr.sort((a, b) => (b.price || 0) - (a.price || 0));\r\n      case 'brand_asc':\r\n        return arr.sort((a, b) =>\r\n          (a.brandName || '').localeCompare(b.brandName || '')\r\n        );\r\n      case 'brand_desc':\r\n        return arr.sort((a, b) =>\r\n          (b.brandName || '').localeCompare(a.brandName || '')\r\n        );\r\n      default:\r\n        return list;\r\n    }\r\n  }\r\n\r\n  async applyFilters() {\r\n    let list = this._getProductList();\r\n    list = this._filterAndSort(list);\r\n\r\n    if (!this.view) return;\r\n    await this.view.render(list);\r\n  }\r\n}\r\n\r\n/**\r\n * \u0414\u043B\u044F \u043E\u0431\u0440\u0430\u0442\u043D\u043E\u0439 \u0441\u043E\u0432\u043C\u0435\u0441\u0442\u0438\u043C\u043E\u0441\u0442\u0438:\r\n * \u043C\u043E\u0436\u043D\u043E \u0438\u043C\u043F\u043E\u0440\u0442\u0438\u0442\u044C \u0442\u0430\u043A \u0436\u0435, \u043A\u0430\u043A \u0441\u0442\u0430\u0440\u044B\u0439 Catalog.\r\n */\r\nexport { CatalogController as Catalog };\r\n", "// Checkout/CheckoutView.js\r\nimport { formatPrice, makeSpecHtmlPreview, pluralize } from '../utils.js';\r\n\r\nexport class CheckoutView {\r\n  constructor() {\r\n    this.container = null;\r\n    this.goodsWordsArr = ['\u0442\u043E\u0432\u0430\u0440', '\u0442\u043E\u0432\u0430\u0440\u0430', '\u0442\u043E\u0432\u0430\u0440\u043E\u0432'];\r\n    this._bound = null;\r\n  }\r\n\r\n  setContainer(container) {\r\n    this.container = container instanceof HTMLElement\r\n      ? container\r\n      : document.querySelector(container) || null;\r\n  }\r\n\r\n  getContainer() {\r\n    return this.container;\r\n  }\r\n\r\n  setGoodsWords(wordsArr) {\r\n    if (Array.isArray(wordsArr) && wordsArr.length) {\r\n      this.goodsWordsArr = wordsArr;\r\n    }\r\n  }\r\n\r\n  bindEvents(handlers) {\r\n    if (!this.container) return;\r\n    this._bound = handlers || {};\r\n\r\n    const { onApplyPromo, onCheckout, onReturnToCart, onContainerClick, onContainerChange } = this._bound;\r\n\r\n    this.container\r\n      .querySelector('.promo-code-apply')\r\n      ?.addEventListener('click', onApplyPromo);\r\n\r\n    this.container\r\n      .querySelector('.btn-checkout')\r\n      ?.addEventListener('click', onCheckout);\r\n\r\n    this.container\r\n      .querySelector('.btn-return-cart')\r\n      ?.addEventListener('click', onReturnToCart);\r\n\r\n    this.container.addEventListener('click', onContainerClick);\r\n    this.container.addEventListener('change', onContainerChange);\r\n  }\r\n\r\n  unbindEvents() {\r\n    if (!this.container || !this._bound) return;\r\n    const { onApplyPromo, onCheckout, onReturnToCart, onContainerClick, onContainerChange } = this._bound;\r\n\r\n    this.container\r\n      .querySelector('.promo-code-apply')\r\n      ?.removeEventListener('click', onApplyPromo);\r\n\r\n    this.container\r\n      .querySelector('.btn-checkout')\r\n      ?.removeEventListener('click', onCheckout);\r\n\r\n    this.container\r\n      .querySelector('.btn-return-cart')\r\n      ?.removeEventListener('click', onReturnToCart);\r\n\r\n    this.container.removeEventListener('click', onContainerClick);\r\n    this.container.removeEventListener('change', onContainerChange);\r\n\r\n    this._bound = null;\r\n  }\r\n\r\n  /* === UI helpers === */\r\n\r\n  toggleReturnToCartButton(isBuyNow, hasCartBackup) {\r\n    if (!this.container) return;\r\n    const btn = this.container.querySelector('.btn-return-cart');\r\n    if (!btn) return;\r\n\r\n    if (isBuyNow && hasCartBackup) {\r\n      btn.style.display = '';\r\n    } else {\r\n      btn.style.display = 'none';\r\n    }\r\n  }\r\n\r\n  updateModeIndicator(isBuyNow) {\r\n    if (!this.container) return;\r\n    const el = this.container.querySelector('#checkoutModeIndicator');\r\n    if (!el) return;\r\n\r\n    if (isBuyNow) {\r\n      el.innerHTML = `\r\n        <i class=\"fa-solid fa-bolt\"></i>\r\n        <span>\u041A\u0443\u043F\u0438\u0442\u044C \u0441\u0435\u0439\u0447\u0430\u0441</span>\r\n      `;\r\n      el.classList.add('buy-now');\r\n      el.classList.remove('cart');\r\n    } else {\r\n      el.innerHTML = `\r\n        <i class=\"fa-solid fa-cart-shopping\"></i>\r\n        <span>\u0412\u0430\u0448\u0430 \u043A\u043E\u0440\u0437\u0438\u043D\u0430</span>\r\n      `;\r\n      el.classList.add('cart');\r\n      el.classList.remove('buy-now');\r\n    }\r\n  }\r\n\r\n  getPromoInputValue() {\r\n    if (!this.container) return '';\r\n    const promoInput = this.container.querySelector('#promo-input');\r\n    return promoInput ? promoInput.value.trim() : '';\r\n  }\r\n\r\n  setPromoInputValue(value) {\r\n    if (!this.container) return;\r\n    const promoInput = this.container.querySelector('#promo-input');\r\n    if (promoInput) promoInput.value = value ?? '';\r\n  }\r\n\r\n  showPromoHint(message) {\r\n    if (!this.container) return;\r\n    const hint = this.container.querySelector('#promo-hint');\r\n    if (hint) hint.textContent = message;\r\n  }\r\n\r\n  buildDeliveryOptions(deliveryOptions = []) {\r\n    if (!this.container) return;\r\n\r\n    const host = this.container.querySelector('#deliveryOptions');\r\n    if (!host) return;\r\n\r\n    const frag = document.createDocumentFragment();\r\n\r\n    deliveryOptions.forEach((opt) => {\r\n      const isChecked = !opt.disabled && !!opt.checked;\r\n\r\n      const card = document.createElement('div');\r\n      card.className = 'delivery-card';\r\n      if (opt.disabled) card.classList.add('disabled');\r\n      if (isChecked) card.classList.add('checked');\r\n\r\n      card.setAttribute('data-zone-name', 'deliveryTypeButton');\r\n      card.setAttribute(\r\n        'data-zone-data',\r\n        JSON.stringify({ label: opt.label, deliveryType: opt.deliveryType })\r\n      );\r\n\r\n      card.innerHTML = `\r\n        <div class=\"delivery-card-header\">\r\n          <label for=\"delivery-type-selector_global_${opt.deliveryType}\"\r\n                 class=\"delivery-label\"\r\n                 data-auto=\"${opt.deliveryType}\">\r\n            <input\r\n              id=\"delivery-type-selector_global_${opt.deliveryType}\"\r\n              name=\"delivery-type-selector_global\"\r\n              class=\"radio-input\"\r\n              type=\"radio\"\r\n              value=\"${opt.deliveryType}\"\r\n              ${isChecked ? 'checked' : ''}\r\n              ${opt.disabled ? 'disabled' : ''}\r\n              aria-disabled=\"${opt.disabled ? 'true' : 'false'}\"\r\n            >\r\n            <div class=\"delivery-info\">\r\n              <div class=\"delivery-title\">\r\n                <h3>${opt.label}</h3>\r\n                <div class=\"delivery-description\">${opt.description}</div>\r\n              </div>\r\n              <div class=\"delivery-details\">\r\n                <div class=\"delivery-time\">${opt.time}</div>\r\n                <div class=\"delivery-price\">${opt.price}</div>\r\n              </div>\r\n            </div>\r\n            <div class=\"checkmark\" aria-hidden=\"true\">\r\n              <i class=\"fa-solid fa-check\"></i>\r\n            </div>\r\n          </label>\r\n        </div>\r\n      `;\r\n\r\n      frag.appendChild(card);\r\n    });\r\n\r\n    host.replaceChildren(frag);\r\n  }\r\n\r\n  handleDeliveryClick(e) {\r\n    if (!this.container) return;\r\n\r\n    const card = e.target.closest('.delivery-card');\r\n    if (!card || !this.container.contains(card)) return;\r\n    if (card.classList.contains('disabled')) return;\r\n\r\n    const radio = card.querySelector('input[type=\"radio\"]');\r\n    if (!radio) return;\r\n\r\n    this.container\r\n      .querySelectorAll('.delivery-card')\r\n      .forEach((c) => c.classList.remove('checked'));\r\n\r\n    radio.checked = true;\r\n    card.classList.add('checked');\r\n  }\r\n\r\n  handleDeliveryChange(e) {\r\n    if (!this.container) return;\r\n\r\n    const radio = e.target.closest('input[type=\"radio\"]');\r\n    if (!radio) return;\r\n\r\n    const card = e.target.closest('.delivery-card');\r\n    if (!card || card.classList.contains('disabled')) return;\r\n\r\n    this.container\r\n      .querySelectorAll('.delivery-card')\r\n      .forEach((c) => c.classList.remove('checked'));\r\n\r\n    card.classList.add('checked');\r\n  }\r\n\r\n  updateTotalsUI(totalPrice, totalQty) {\r\n    if (!this.container) return;\r\n\r\n    const totalEl = this.container.querySelector('#cart-total');\r\n    const qtyEl = this.container.querySelector('#cart-count-inline');\r\n    const wordEl = this.container.querySelector('#goodsNumWord');\r\n\r\n    if (totalEl) totalEl.textContent = formatPrice(totalPrice);\r\n    if (qtyEl) qtyEl.textContent = totalQty;\r\n    if (wordEl) wordEl.textContent = pluralize(totalQty, this.goodsWordsArr);\r\n  }\r\n\r\n  async renderCartItems(cartItems = []) {\r\n    if (!this.container) return { totalPrice: 0, totalQty: 0 };\r\n\r\n    const grid = this.container.querySelector('#checkout-grid');\r\n    if (!grid) {\r\n      console.warn('[CheckoutView] #checkout-grid not found inside container');\r\n      return { totalPrice: 0, totalQty: 0 };\r\n    }\r\n\r\n    grid.innerHTML = '';\r\n\r\n    if (!cartItems.length) {\r\n      grid.innerHTML = '<p>\u0412\u0430\u0448\u0430 \u043A\u043E\u0440\u0437\u0438\u043D\u0430 \u043F\u0443\u0441\u0442\u0430.</p>';\r\n      this.updateTotalsUI(0, 0);\r\n      return { totalPrice: 0, totalQty: 0 };\r\n    }\r\n\r\n    let totalPrice = 0;\r\n    let totalQty = 0;\r\n\r\n    const frag = document.createDocumentFragment();\r\n\r\n    for (const item of cartItems) {\r\n      const qty = Number(item.qty) || 1;\r\n      const price = Number(item.price) || 0;\r\n\r\n      totalPrice += price * qty;\r\n      totalQty += qty;\r\n\r\n      const card = await this._createCartItemCard({ ...item, qty, price });\r\n      frag.appendChild(card);\r\n    }\r\n\r\n    grid.replaceChildren(frag);\r\n    this.updateTotalsUI(totalPrice, totalQty);\r\n\r\n    return { totalPrice, totalQty };\r\n  }\r\n\r\n  async _createCartItemCard(item) {\r\n    const card = document.createElement('div');\r\n    card.classList.add('card', 'mb-3');\r\n\r\n    let pictureUrl = '';\r\n    try {\r\n      const parsed = JSON.parse(item.picture || '[]');\r\n      if (Array.isArray(parsed) && parsed.length) {\r\n        pictureUrl = parsed[0];\r\n      }\r\n    } catch {\r\n      pictureUrl = '';\r\n    }\r\n\r\n    const safeName = item.name || item.fullname || '\u0422\u043E\u0432\u0430\u0440';\r\n\r\n    card.innerHTML = `<div class=\"checkout-item\">\r\n  <div class=\"checkout-item__image\">\r\n    <img \r\n      src=\"${pictureUrl}\" \r\n      alt=\"${safeName}\" \r\n      class=\"checkout-item__img\"\r\n    >\r\n  </div>\r\n\r\n  <div class=\"checkout-item__content\">\r\n    <div class=\"checkout-item__top\">\r\n      <h5 class=\"checkout-item__title\">${item.fullname || safeName}</h5>\r\n      <span class=\"checkout-item__qty\">\u041A\u043E\u043B\u0438\u0447\u0435\u0441\u0442\u0432\u043E: ${item.qty}</span>\r\n    </div>\r\n\r\n    <p class=\"checkout-item__specs\">\r\n      ${makeSpecHtmlPreview(item.specs)}\r\n    </p>\r\n\r\n    <div class=\"checkout-item__price-row\">\r\n      <span>\u0426\u0435\u043D\u0430:</span>\r\n      <span class=\"price-submain\">${formatPrice(item.price)}</span>\r\n    </div>\r\n\r\n    <div class=\"checkout-item__price-row total\">\r\n      <span>\u0418\u0442\u043E\u0433\u043E:</span>\r\n      <span class=\"price-main\">${formatPrice(item.price * item.qty)}</span>\r\n    </div>\r\n  </div>\r\n</div>`;\r\n\r\n    return card;\r\n  }\r\n\r\n  clear() {\r\n    if (!this.container) return;\r\n    this.container.innerHTML = '';\r\n  }\r\n}\r\n", "// Checkout/CheckoutController.js\r\nimport { CheckoutView } from './CheckoutView.js';\r\n\r\nexport class CheckoutController {\r\n  constructor(cartService) {\r\n    this.cartService = cartService;\r\n    this.foxEngine = this.cartService.storage.shopMatic.foxEngine;\r\n\r\n    this.cartItems = [];\r\n    this.totalPrice = 0;\r\n    this.totalQty = 0;\r\n    this.promoCode = '';\r\n    this.goodsWordsArr = ['\u0442\u043E\u0432\u0430\u0440', '\u0442\u043E\u0432\u0430\u0440\u0430', '\u0442\u043E\u0432\u0430\u0440\u043E\u0432'];\r\n\r\n    this.isBuyNow = false;\r\n    this.buyNowStorageKey = 'shopmatic_buy_now_item_v1';\r\n    this._hasCartBackup = false;\r\n\r\n    this.deliveryOptions = [\r\n      {\r\n        label: '\u041F\u043E \u043A\u043B\u0438\u043A\u0443',\r\n        deliveryType: 'ON_DEMAND',\r\n        description: '\u041F\u043E \u043A\u043B\u0438\u043A\u0443 \u0437\u0430 15-30 \u043C\u0438\u043D\u0443\u0442',\r\n        time: '\u0417\u0430\u0432\u0442\u0440\u0430 \u0438\u043B\u0438 \u043F\u043E\u0437\u0436\u0435',\r\n        price: '\u0431\u0435\u0441\u043F\u043B\u0430\u0442\u043D\u043E',\r\n        checked: false,\r\n        disabled: true\r\n      },\r\n      {\r\n        label: '\u041F\u0443\u043D\u043A\u0442 \u0432\u044B\u0434\u0430\u0447\u0438',\r\n        deliveryType: 'PICKUP',\r\n        description: '\u0420\u044F\u0434\u043E\u043C, 7 \u043C\u0438\u043D\u0443\u0442',\r\n        time: '\u0417\u0430\u0432\u0442\u0440\u0430 \u0438\u043B\u0438 \u043F\u043E\u0437\u0436\u0435',\r\n        price: '\u0431\u0435\u0441\u043F\u043B\u0430\u0442\u043D\u043E',\r\n        checked: true,\r\n        disabled: false\r\n      },\r\n      {\r\n        label: '\u041A\u0443\u0440\u044C\u0435\u0440',\r\n        deliveryType: 'COURIER',\r\n        description: '\u0414\u043E\u0441\u0442\u0430\u0432\u043A\u0430 \u043D\u0430 \u0434\u043E\u043C',\r\n        time: '\u0417\u0430\u0432\u0442\u0440\u0430 \u0438\u043B\u0438 \u043F\u043E\u0437\u0436\u0435',\r\n        price: '\u0431\u0435\u0441\u043F\u043B\u0430\u0442\u043D\u043E',\r\n        checked: false,\r\n        disabled: true\r\n      }\r\n    ];\r\n\r\n    this.view = new CheckoutView();\r\n    this.view.setGoodsWords(this.goodsWordsArr);\r\n\r\n    this._bound = {\r\n      onApplyPromo: this._onApplyPromo.bind(this),\r\n      onCheckout: this._onCheckout.bind(this),\r\n      onContainerClick: this._onContainerClick.bind(this),\r\n      onContainerChange: this._onContainerChange.bind(this),\r\n      onReturnToCart: this._onReturnToCart.bind(this)\r\n    };\r\n  }\r\n\r\n  /**\r\n   * \u0418\u043D\u0438\u0446\u0438\u0430\u043B\u0438\u0437\u0430\u0446\u0438\u044F \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B.\r\n   *\r\n   * @param {string|HTMLElement} selector - \u043A\u043E\u0440\u043D\u0435\u0432\u043E\u0439 \u043A\u043E\u043D\u0442\u0435\u0439\u043D\u0435\u0440 (\u043D\u0430\u043F\u0440\u0438\u043C\u0435\u0440 '#checkout-page' \u0438\u043B\u0438 \u0441\u0430\u043C \u044D\u043B\u0435\u043C\u0435\u043D\u0442)\r\n   * @param {Object} [options]\r\n   *  - buyNowItem: \u043E\u0431\u044A\u0435\u043A\u0442 \u0442\u043E\u0432\u0430\u0440\u0430 \u0434\u043B\u044F \u0440\u0435\u0436\u0438\u043C\u0430 \"\u041A\u0443\u043F\u0438\u0442\u044C \u0441\u0435\u0439\u0447\u0430\u0441\"\r\n   */\r\n  async init(selector, options = {}) {\r\n    this.view.setContainer(selector);\r\n    const container = this.view.getContainer();\r\n\r\n    if (!container) {\r\n      console.error('[CheckoutController] Container not found:', selector);\r\n      return;\r\n    }\r\n\r\n    const { buyNowItem } = options;\r\n\r\n    // 1. \u0415\u0441\u043B\u0438 \u044F\u0432\u043D\u043E \u043F\u0435\u0440\u0435\u0434\u0430\u043D buyNowItem \u2014 \u043E\u043D \u0432 \u043F\u0440\u0438\u043E\u0440\u0438\u0442\u0435\u0442\u0435\r\n    if (buyNowItem) {\r\n      this.isBuyNow = true;\r\n      const normalized = this._normalizeItemForCheckout(buyNowItem);\r\n      this.cartItems = [normalized];\r\n      this._saveBuyNowToStorage(normalized);\r\n    } else {\r\n      // 2. \u041F\u0440\u043E\u0431\u0443\u0435\u043C \u0441\u043D\u0430\u0447\u0430\u043B\u0430 \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C buyNow \u0438\u0437 localStorage\r\n      const cached = this._loadBuyNowFromStorage();\r\n\r\n      if (cached) {\r\n        this.isBuyNow = true;\r\n        this.cartItems = [cached];\r\n      } else {\r\n        // 3. buyNow \u043D\u0435\u0442 \u2014 \u043E\u0431\u044B\u0447\u043D\u044B\u0439 \u0440\u0435\u0436\u0438\u043C \u043A\u043E\u0440\u0437\u0438\u043D\u044B\r\n        this.isBuyNow = false;\r\n        this.cartItems = await this.cartService.getCartItems();\r\n        if (!Array.isArray(this.cartItems)) {\r\n          this.cartItems = [];\r\n        }\r\n      }\r\n    }\r\n\r\n    // 4. \u0423\u0437\u043D\u0430\u0451\u043C, \u0435\u0441\u0442\u044C \u043B\u0438 \u0432\u043E\u043E\u0431\u0449\u0435 \u043A\u043E\u0440\u0437\u0438\u043D\u0430, \u043A \u043A\u043E\u0442\u043E\u0440\u043E\u0439 \u043C\u043E\u0436\u043D\u043E \u0432\u0435\u0440\u043D\u0443\u0442\u044C\u0441\u044F\r\n    this._hasCartBackup = await this._checkCartNotEmpty();\r\n\r\n    // \u0420\u0435\u043D\u0434\u0435\u0440\r\n    this.view.buildDeliveryOptions(this.deliveryOptions);\r\n\r\n    const { totalPrice, totalQty } = await this.view.renderCartItems(this.cartItems);\r\n    this.totalPrice = totalPrice;\r\n    this.totalQty = totalQty;\r\n\r\n    this.view.toggleReturnToCartButton(this.isBuyNow, this._hasCartBackup);\r\n    this.view.updateModeIndicator(this.isBuyNow);\r\n\r\n    // \u0421\u043E\u0431\u044B\u0442\u0438\u044F\r\n    this.view.bindEvents(this._bound);\r\n  }\r\n\r\n  /**\r\n   * \u0428\u043E\u0440\u0442\u043A\u0430\u0442 \u0434\u043B\u044F \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u044F checkout \u0441 \u043E\u0434\u043D\u0438\u043C \u0442\u043E\u0432\u0430\u0440\u043E\u043C.\r\n   *\r\n   * @param {string|HTMLElement} containerSelector\r\n   * @param {Object} cartService\r\n   * @param {Object} buyNowItem\r\n   * @returns {CheckoutController}\r\n   */\r\n  static createSingleItem(containerSelector, cartService, buyNowItem) {\r\n    const page = new CheckoutController(cartService);\r\n    const normalized = page._normalizeItemForCheckout(buyNowItem);\r\n    page._saveBuyNowToStorage(normalized);\r\n    page.init(containerSelector, { buyNowItem: normalized });\r\n    return page;\r\n  }\r\n\r\n  /* =======================\r\n     PRIVATE / INTERNAL\r\n     ======================= */\r\n\r\n  _normalizeItemForCheckout(raw) {\r\n    if (!raw || typeof raw !== 'object') {\r\n      return {\r\n        id: null,\r\n        name: '',\r\n        fullname: '',\r\n        price: 0,\r\n        qty: 1,\r\n        picture: '[]',\r\n        specs: ''\r\n      };\r\n    }\r\n\r\n    const price =\r\n      Number(\r\n        raw.price ??\r\n          raw.product_price ??\r\n          raw.cost ??\r\n          0\r\n      ) || 0;\r\n\r\n    const qty =\r\n      Number(\r\n        raw.qty ??\r\n          raw.quantity ??\r\n          1\r\n      ) || 1;\r\n\r\n    let picture;\r\n    if (typeof raw.picture === 'string') {\r\n      try {\r\n        JSON.parse(raw.picture);\r\n        picture = raw.picture; // JSON-\u043C\u0430\u0441\u0441\u0438\u0432\r\n      } catch {\r\n        picture = JSON.stringify([raw.picture]);\r\n      }\r\n    } else if (Array.isArray(raw.picture) || Array.isArray(raw.pictures)) {\r\n      const arr = raw.picture || raw.pictures;\r\n      picture = JSON.stringify(arr);\r\n    } else {\r\n      picture = '[]';\r\n    }\r\n\r\n    return {\r\n      id: raw.id ?? raw.productId ?? null,\r\n      name: raw.name ?? raw.fullname ?? '',\r\n      fullname: raw.fullname ?? raw.name ?? '',\r\n      price,\r\n      qty,\r\n      picture,\r\n      specs: raw.specs ?? raw.description ?? ''\r\n    };\r\n  }\r\n\r\n  async _checkCartNotEmpty() {\r\n    try {\r\n      const items = await this.cartService.getCartItems();\r\n      return Array.isArray(items) && items.length > 0;\r\n    } catch {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /* ===== buy-now storage helpers ===== */\r\n\r\n  _saveBuyNowToStorage(item) {\r\n    if (!item) return;\r\n    try {\r\n      const payload = { mode: 'buyNow', item };\r\n      localStorage.setItem(this.buyNowStorageKey, JSON.stringify(payload));\r\n    } catch (e) {\r\n      console.warn('[CheckoutController] Failed to save buyNow item to storage', e);\r\n    }\r\n  }\r\n\r\n  _loadBuyNowFromStorage() {\r\n    try {\r\n      const raw = localStorage.getItem(this.buyNowStorageKey);\r\n      if (!raw) return null;\r\n      const parsed = JSON.parse(raw);\r\n      if (!parsed || parsed.mode !== 'buyNow' || !parsed.item) return null;\r\n      return this._normalizeItemForCheckout(parsed.item);\r\n    } catch (e) {\r\n      console.warn('[CheckoutController] Failed to load buyNow item from storage', e);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  _clearBuyNowStorage() {\r\n    try {\r\n      localStorage.removeItem(this.buyNowStorageKey);\r\n    } catch (e) {\r\n      console.warn('[CheckoutController] Failed to clear buyNow storage', e);\r\n    }\r\n  }\r\n\r\n  /* ===== events ===== */\r\n\r\n  async _onReturnToCart() {\r\n    this._clearBuyNowStorage();\r\n    this.isBuyNow = false;\r\n\r\n    try {\r\n      const items = await this.cartService.getCartItems();\r\n      this.cartItems = Array.isArray(items) ? items : [];\r\n    } catch {\r\n      this.cartItems = [];\r\n    }\r\n\r\n    this._hasCartBackup = this.cartItems.length > 0;\r\n\r\n    const { totalPrice, totalQty } = await this.view.renderCartItems(\r\n      this.cartItems.map((i) => this._normalizeItemForCheckout(i))\r\n    );\r\n\r\n    this.totalPrice = totalPrice;\r\n    this.totalQty = totalQty;\r\n\r\n    this.view.toggleReturnToCartButton(this.isBuyNow, this._hasCartBackup);\r\n    this.view.updateModeIndicator(this.isBuyNow);\r\n  }\r\n\r\n  _onApplyPromo() {\r\n    this.promoCode = this.view.getPromoInputValue();\r\n    if (!this.promoCode) return;\r\n\r\n    if (this.promoCode === 'DISCOUNT10') {\r\n      this.totalPrice = Math.round(this.totalPrice * 0.9);\r\n      this.view.updateTotalsUI(this.totalPrice, this.totalQty);\r\n      this.view.showPromoHint('\u041F\u0440\u043E\u043C\u043E\u043A\u043E\u0434 \u043F\u0440\u0438\u043C\u0435\u043D\u0435\u043D! \u0421\u043A\u0438\u0434\u043A\u0430 10%');\r\n    } else {\r\n      this.view.showPromoHint('\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u043F\u0440\u043E\u043C\u043E\u043A\u043E\u0434');\r\n    }\r\n  }\r\n\r\n  _onContainerClick(e) {\r\n    this.view.handleDeliveryClick(e);\r\n  }\r\n\r\n  _onContainerChange(e) {\r\n    this.view.handleDeliveryChange(e);\r\n  }\r\n\r\n  _onCheckout() {\r\n    if (this.isBuyNow) {\r\n      alert('\u0420\u0435\u0436\u0438\u043C \"\u041A\u0443\u043F\u0438\u0442\u044C \u0441\u0435\u0439\u0447\u0430\u0441\". \u041F\u043B\u0430\u0442\u0451\u0436\u043D\u0430\u044F \u043B\u043E\u0433\u0438\u043A\u0430 \u0435\u0449\u0451 \u043D\u0435 \u0440\u0435\u0430\u043B\u0438\u0437\u043E\u0432\u0430\u043D\u0430.');\r\n      this._clearBuyNowStorage();\r\n      this.isBuyNow = false;\r\n      this.view.toggleReturnToCartButton(this.isBuyNow, this._hasCartBackup);\r\n      this.view.updateModeIndicator(this.isBuyNow);\r\n    } else {\r\n      alert('\u041F\u043B\u0430\u0442\u0435\u0436\u043D\u0430\u044F \u0438\u043D\u0444\u043E\u0440\u043C\u0430\u0446\u0438\u044F \u0435\u0449\u0451 \u043D\u0435 \u0440\u0435\u0430\u043B\u0438\u0437\u043E\u0432\u0430\u043D\u0430.');\r\n    }\r\n  }\r\n\r\n  destroy() {\r\n    this.view.unbindEvents();\r\n    this.view.clear();\r\n  }\r\n}\r\n\r\n/**\r\n * \u0414\u043B\u044F \u043E\u0431\u0440\u0430\u0442\u043D\u043E\u0439 \u0441\u043E\u0432\u043C\u0435\u0441\u0442\u0438\u043C\u043E\u0441\u0442\u0438:\r\n * \u043C\u043E\u0436\u043D\u043E \u0438\u043C\u043F\u043E\u0440\u0442\u0438\u0442\u044C \u0442\u0430\u043A \u0436\u0435, \u043A\u0430\u043A \u0441\u0442\u0430\u0440\u044B\u0439 CheckoutPage.\r\n */\r\nexport { CheckoutController as CheckoutPage };\r\n", "import { Card } from './modules/Card.js';\r\nimport { ProductService } from './modules/ProductService.js';\r\nimport { StorageService } from './modules/StorageService.js';\r\nimport { Notifications } from './modules/Notifications.js';\r\nimport { Renderer } from './modules/Renderer.js';\r\nimport { CartModule } from './modules/Cart/CartModule.js';\r\nimport { FavoritesModule } from './modules/FavoritesModule.js';\r\nimport { WishlistModule } from './modules/WishlistModule.js';\r\nimport { ProductPage } from './modules/ProductPage.js';\r\nimport { ViewedItemsModule } from './modules/ViewedItemsModule.js';\r\nimport { Catalog } from './modules/Catalog/CatalogController.js';\r\nimport { CheckoutPage } from './modules/Checkout/CheckoutController.js';\r\n\r\n/**\r\n * ShopMatic orchestrates all modules of the shop and exposes a high level API\r\n * for cart management, favourites and product navigation. The actual product\r\n * listing, filtering and rendering logic is delegated to the Catalog class\r\n * which encapsulates all DOM events related to searching and sorting.\r\n */\r\nexport class ShopMatic {\r\n  /**\r\n   * Create a new ShopMatic instance.\r\n   * @param {Object} foxEngine Host engine providing template loading and routing.\r\n   * @param {Object} opts Optional configuration overrides.\r\n   */\r\n  constructor(foxEngine, opts = {}) {\r\n    if (!foxEngine) throw new Error('foxEngine is required');\r\n    this.foxEngine = foxEngine;\r\n    // Merge default options with any overrides\r\n    this.opts = Object.assign({\r\n      itemsId: 'items',\r\n      categoryFilterId: 'categoryFilter',\r\n      brandFilterId: 'brandFilter',\r\n      searchId: 'search',\r\n      sortId: 'sort',\r\n      searchBtnId: 'searchBtn',\r\n      cartGridId: 'cart-grid',\r\n\t  checkoutGridId: 'checkout-grid',\r\n      cartCountInlineId: 'cart-count-inline',\r\n      cartTotalId: 'cart-total',\r\n      miniCartTotalId: 'miniCartTotal',\r\n      miniCartListId: 'miniCart',\r\n      headerCartNumId: 'cartNum',\r\n\t  mobileCartNumId: 'mobileCartNum',\r\n      miniCartHeaderTitleId: 'miniCartHeaderTitle',\r\n      productsCountId: 'productsCount',\r\n      storageKey: 'gribkov_cart_v1',\r\n      favStorageKey: 'gribkov_favs_v1',\r\n      notificationDuration: 3000,\r\n      debug: false\r\n    }, opts);\r\n    // Core modules\r\n    this.productService = new ProductService(this.foxEngine);\r\n    this.card = new Card(this);\r\n    this.storage = new StorageService(this, { storageKey: this.opts.storageKey, favStorageKey: this.opts.favStorageKey });\r\n    this.notifications = new Notifications();\r\n    // Favourites with central sync\r\n    this.favorites = new FavoritesModule({ storage: this.storage, opts: { sync: false } });\r\n    this.renderer = new Renderer({ foxEngine: this.foxEngine, productService: this.productService, favorites: this.favorites });\r\n    this.cart = new CartModule({\r\n      storage: this.storage,\r\n      productService: this.productService,\r\n      renderer: this.renderer,\r\n      notifications: this.notifications,\r\n      favorites: this.favorites,\r\n      opts: this.opts\r\n    });\r\n    this.productPage = new ProductPage(this);\r\n\t\r\n\t\r\n\tthis.viewedModule = new ViewedItemsModule({\r\n      storageService: this.storage,\r\n      renderer: null,\r\n      container: '#viewed-items'\r\n    });\r\n\t\r\n    // Wishlist module (constructed lazily in init)\r\n    this.wishlistModule = null;\r\n    // Create catalog for product list and filters\r\n    this.catalog = new Catalog({\r\n      shop: this,\r\n      rootId: this.opts.itemsId,\r\n      catFilterId: this.opts.categoryFilterId,\r\n      brandFilterId: this.opts.brandFilterId,\r\n      searchId: this.opts.searchId,\r\n      sortId: this.opts.sortId,\r\n      searchBtnId: this.opts.searchBtnId,\r\n      productsCountId: this.opts.productsCountId\r\n    });\r\n\tthis.checkoutPage = new CheckoutPage(this.cart);\r\n    // Subscription handle for favourites updates\r\n    this._favsUnsub = null;\r\n    // Bound handlers for global events\r\n    this._bound = {\r\n      onStorage: this._onStorageEvent.bind(this),\r\n      onCartUpdated: this._onCartUpdated.bind(this)\r\n    };\r\n    // Delegation handlers registry (unused now)\r\n    this._delegationHandlers = new WeakMap();\r\n    // DOM refs (for backwards compatibility; assigned after catalog.init())\r\n    this.root = null;\r\n    this.catFilter = null;\r\n    this.brandFilter = null;\r\n    this.search = null;\r\n    this.sort = null;\r\n    this.searchBtn = null;\r\n    this.productsCount = null;\r\n  }\r\n\r\n  /**\r\n   * Initialise all modules, load persisted state, bind events and perform\r\n   * initial rendering. This should be called once after constructing the\r\n   * ShopMatic instance.\r\n   */\r\n  async init() {\r\n    // Collect cart related DOM elements\r\n    const cartGridEl = document.getElementById(this.opts.cartGridId);\r\n    const cartCountInlineEl = document.getElementById(this.opts.cartCountInlineId);\r\n    const cartTotalEl = document.getElementById(this.opts.cartTotalId);\r\n    const miniCartTotalEl = document.getElementById(this.opts.miniCartTotalId);\r\n    const miniCartListEl = document.getElementById(this.opts.miniCartListId);\r\n    const headerCartNumEl = document.getElementById(this.opts.headerCartNumId);\r\n\tconst mobileCartNumEl = document.getElementById(this.opts.mobileCartNumId);\r\n    const miniCartHeaderTitleEl = document.getElementById(this.opts.miniCartHeaderTitleId);\r\n    // Pass references to cart module\r\n    try {\r\n      this.cart.setDomRefs({\r\n        headerCartNum: headerCartNumEl,\r\n\t\tmobileCartNum: mobileCartNumEl,\r\n        miniCartList: miniCartListEl,\r\n        miniCartHeaderTitle: miniCartHeaderTitleEl,\r\n        cartGrid: cartGridEl,\r\n        cartCountInline: cartCountInlineEl,\r\n        cartTotal: cartTotalEl,\r\n        miniCartTotal: miniCartTotalEl\r\n      });\r\n    } catch (err) {\r\n      console.warn('cart.setDomRefs failed', err);\r\n    }\r\n    // Initialise catalog (loads products, categories & brands, binds filter events, renders)\r\n    await this.catalog.init();\r\n    // Copy references from catalog for backward compatibility\r\n    this.root = this.catalog.root;\r\n    this.catFilter = this.catalog.catFilter;\r\n    this.brandFilter = this.catalog.brandFilter;\r\n    this.search = this.catalog.search;\r\n    this.sort = this.catalog.sort;\r\n    this.searchBtn = this.catalog.searchBtn;\r\n    this.productsCount = this.catalog.productsCount;\r\n    // Load persisted favourites and cart items\r\n    try { await this.favorites.loadFromStorage(); } catch (e) { console.warn('favorites.loadFromStorage failed', e); }\r\n    try { await this.cart.loadFromStorage(); } catch (e) { console.warn('cart.loadFromStorage failed', e); }\r\n    // Sync UI to loaded favourites\r\n    this._updateWishUI();\r\n    // Subscribe to favourites changes\r\n    try {\r\n      this._favsUnsub = this.favorites.subscribe(() => {\r\n        if (this.catalog && this.catalog.root) {\r\n          const allCards = this.catalog.root.querySelectorAll('[data-product-id]');\r\n          allCards.forEach(card => {\r\n            const pid = card.getAttribute('data-product-id');\r\n            this.renderer.updateProductCardFavState(this.catalog.root, pid, this.favorites.isFavorite(pid));\r\n          });\r\n        }\r\n        this._updateWishUI();\r\n      });\r\n    } catch (err) {\r\n      console.warn('favorites.subscribe failed', err);\r\n    }\r\n    // Bind global events\r\n    window.addEventListener('storage', this._bound.onStorage);\r\n    window.addEventListener('cart:updated', this._bound.onCartUpdated);\r\n    // Delegated card actions (favourites toggling, add to cart)\r\n    this.card._bindCardDelegation();\r\n    // Ensure quantity controls reflect initial cart state\r\n    this._syncAllCardsControls();\r\n    // Instantiate wishlist module and load viewed items\r\n    this.wishlistModule = new WishlistModule();\r\n    await this.viewedModule.load();\r\n    // Update cart UI after loading persisted state\r\n    await this.cart.updateCartUI();\r\n  }\r\n\r\n  /**\r\n   * Destroy all event listeners and subordinate modules. Should be called\r\n   * when the ShopMatic instance is no longer used.\r\n   */\r\n  destroy() {\r\n    window.removeEventListener('storage', this._bound.onStorage);\r\n    window.removeEventListener('cart:updated', this._bound.onCartUpdated);\r\n    // Destroy catalog and unbind filter events\r\n    if (this.catalog && typeof this.catalog.destroy === 'function') {\r\n      try { this.catalog.destroy(); } catch (_) {}\r\n    }\r\n    // Unsubscribe favourites\r\n    if (typeof this._favsUnsub === 'function') {\r\n      try { this._favsUnsub(); } catch (e) { /* ignore */ }\r\n      this._favsUnsub = null;\r\n    }\r\n    // Destroy modules\r\n    if (this.favorites && typeof this.favorites.destroy === 'function') {\r\n      try { this.favorites.destroy(); } catch (e) { /* ignore */ }\r\n    }\r\n    if (this.cart && typeof this.cart.destroy === 'function') {\r\n      try { this.cart.destroy(); } catch (e) { /* ignore */ }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update the wish counter in the UI to reflect the number of favourite\r\n   * items. If there are none the element is hidden.\r\n   */\r\n  _updateWishUI() {\r\n    try {\r\n      const wishEl = document.getElementById('wishNum');\r\n\t  const mobileWishEl = document.getElementById('mobileFavorites');\r\n      if (!wishEl) return;\r\n      const count = (this.favorites && typeof this.favorites.getCount === 'function') ? this.favorites.getCount() : 0;\r\n      wishEl.style.display = count > 0 ? 'inline-flex' : 'none';\r\n      wishEl.textContent = String(count);\r\n\r\n      mobileWishEl.style.display = count > 0 ? 'inline-flex' : 'none';\r\n      mobileWishEl.textContent = String(count);\r\n    } catch (e) {\r\n      console.warn('_updateWishUI failed', e);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Synchronise quantity controls and disabled state across all cards. Delegates\r\n   * to Card module for per-card logic. Accepts an optional container; defaults\r\n   * to the catalog root.\r\n   * @param {HTMLElement} container Optional container to sync controls within.\r\n   */\r\n  _syncAllCardsControls(container = null) {\r\n    const root = container || (this.catalog && this.catalog.root);\r\n    if (!root) return;\r\n    const cards = Array.from(root.querySelectorAll('[data-product-id]'));\r\n    cards.forEach(card => this.card._syncCardControlsState(card));\r\n  }\r\n\r\n  /**\r\n   * Handle updates from storage. Re-sync cart/favourites and refresh UI.\r\n   * @param {StorageEvent} e Storage event\r\n   */\r\n  _onStorageEvent(e) {\r\n    if (!e) return;\r\n    // Reload both cart and favourites if storage cleared\r\n    if (e.key === null) {\r\n      try { this.cart.loadFromStorage(); } catch (_) {}\r\n      try { this.favorites.loadFromStorage(); } catch (_) {}\r\n      this._updateWishUI();\r\n      this._syncAllCardsControls();\r\n      return;\r\n    }\r\n    // Cart storage changed\r\n    if (e.key === this.opts.storageKey) {\r\n      try { this.cart.loadFromStorage(); } catch (_) {}\r\n      try { this.cart.updateCartUI(); } catch (_) {}\r\n      this._syncAllCardsControls();\r\n    }\r\n    // Favourites storage changed\r\n    if (e.key === this.opts.favStorageKey) {\r\n      try { this.favorites.loadFromStorage(); } catch (_) {}\r\n      if (this.catalog && this.catalog.root) {\r\n        const allCards = this.catalog.root.querySelectorAll('[data-product-id]');\r\n        allCards.forEach(card => {\r\n          const pid = card.getAttribute('data-product-id');\r\n          this.renderer.updateProductCardFavState(this.catalog.root, pid, this.favorites.isFavorite(pid));\r\n        });\r\n      }\r\n      this._updateWishUI();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * React to cart updates by refreshing quantity controls for affected products.\r\n   * Expects event.detail.changedIds array of ids that changed.\r\n   * @param {CustomEvent} e Event emitted from CartModule\r\n   */\r\n  _onCartUpdated(e) {\r\n    try {\r\n      const detail = e && e.detail ? e.detail : {};\r\n      const changedIds = Array.isArray(detail.changedIds) ? detail.changedIds : [];\r\n      if (!this.catalog || !this.catalog.root || !changedIds.length) {\r\n        this._syncAllCardsControls();\r\n        return;\r\n      }\r\n      changedIds.forEach(id => {\r\n        if (!id) return;\r\n        const selector = `[data-product-id=\"${(typeof CSS !== 'undefined' && CSS.escape) ? CSS.escape(String(id)) : String(id).replace(/\\\"/g, '\\\\\\\"')}\"]`;\r\n        const card = this.catalog.root.querySelector(selector);\r\n        if (card) this.card._syncCardControlsState(card);\r\n      });\r\n    } catch (err) {\r\n      this._syncAllCardsControls();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Navigate to a product page. Sets the location hash and delegates to\r\n   * ProductPage for rendering.\r\n   * @param {string} product ID of the product to show.\r\n   * @param {HTMLElement|string} block Container in which to render.\r\n   */\r\n  openProductPage(product, block) {\r\n    this.foxEngine.loadTemplates();\r\n    location.hash = '#product/' + product;\r\n    this.productPage.render(product, block);\r\n  }\r\n\r\n  /* ================== Public API (delegates) ================== */\r\n\r\n  addToCart(id, qty = 1) {\r\n    const desired = Math.max(1, parseInt(qty || 1, 10));\r\n    const available = this.card._computeAvailableStock(id);\r\n    if (available <= 0) {\r\n      this.notifications.show('\u041D\u0435\u0432\u043E\u0437\u043C\u043E\u0436\u043D\u043E \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C: \u043D\u0435\u0442 \u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E\u0433\u043E \u043E\u0441\u0442\u0430\u0442\u043A\u0430.', { duration: this.opts.notificationDuration });\r\n      this._syncAllCardsControls();\r\n      return false;\r\n    }\r\n    const toAdd = Math.min(desired, available);\r\n    if (toAdd < desired) {\r\n      this.notifications.show(`\u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E ${toAdd} \u0448\u0442. (\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E ${available}).`, { duration: this.opts.notificationDuration });\r\n    }\r\n    return this.cart.add(id, toAdd);\r\n  }\r\n  changeQty(id, qty) { return this.cart.changeQty(id, qty); }\r\n  \r\n  isFavorite(id) { return this.favorites.isFavorite ? this.favorites.isFavorite(id) : false; }\r\n  \r\n  toggleFavorite(id) { return this.favorites.toggle ? this.favorites.toggle(id) : false; }\r\n  \r\n  getFavorites() {\r\n    const ids = (this.favorites.getAll ? this.favorites.getAll() : (this.favorites.exportToArray ? this.favorites.exportToArray() : []));\r\n    return Array.isArray(ids) ? ids.map(id => this.productService.findById(id)).filter(Boolean) : [];\r\n  }\r\n  removeCartItem(id) {\r\n    this.cart.remove(id);\r\n  }\r\n  \r\n  async loadCatalog(brand = \"\", category = \"\"){\r\n\t  await this.catalog.loadCatalog({request: {brand: brand, category: category}});\r\n  }\r\n  \r\n  removeWishlistItem(id) {\r\n    if (this.wishlistModule && typeof this.wishlistModule.removeFromFav === 'function') {\r\n      this.wishlistModule.removeFromFav(id);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Render the cart page. Optionally resets cart DOM references.\r\n   */\r\n  renderCartPage() {\r\n    const cartGridEl = document.getElementById(this.opts.cartGridId);\r\n    const cartCountInlineEl = document.getElementById(this.opts.cartCountInlineId);\r\n    const cartTotalEl = document.getElementById(this.opts.cartTotalId);\r\n    this.cart.setDomRefs({\r\n      cartGrid: cartGridEl,\r\n      cartCountInline: cartCountInlineEl,\r\n      cartTotal: cartTotalEl\r\n    });\r\n    this.cart.loadFromStorage();\r\n    this.cart.updateCartUI();\r\n    this._syncAllCardsControls();\r\n  }\r\n\r\n  /**\r\n   * Wrapper around Catalog.loadCatalog for compatibility with legacy code.\r\n   * Delegates to the Catalog instance.\r\n   */\r\n  async loadCatalog(args = {}) {\r\n    return this.catalog.loadCatalog(args);\r\n  }\r\n\r\n  /**\r\n   * Wrapper around Catalog.applyFilters for compatibility with legacy code.\r\n   */\r\n  async applyFilters() {\r\n    return this.catalog.applyFilters();\r\n  }\r\n\r\n  // Legacy handlers preserved as wrappers around applyFilters. They are not bound\r\n  // in the new architecture but retained for external callers if needed.\r\n  _onSearchInput() { this.applyFilters(); }\r\n  _onCatChange() { this.applyFilters(); }\r\n  _onBrandChange() { this.applyFilters(); }\r\n  _onSortChange() { this.applyFilters(); }\r\n  _onSearchBtn() { this.applyFilters(); }\r\n}"],
  "mappings": "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",
  "names": ["id", "e", "escapeHtml"]
}
